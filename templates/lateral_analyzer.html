{% extends "base_specialized_tool.html" %}

{% block tool_title %}Sewer & Water Lateral Analyzer{% endblock %}
{% block tool_icon %}fas fa-project-diagram{% endblock %}
{% block tool_description %}Lists all properties with lateral connections, zoom-to-feature capability, and clearance analysis tools{% endblock %}

{% block content_layout_class %}tool-complex-layout{% endblock %}

{% block sidebar_content %}
<div class="tool-info-box">
    <div class="tool-name">
        <i class="fas fa-project-diagram"></i>
        <span>Lateral Analyzer</span>
    </div>
    <div class="tool-description">
        Analyze sewer and water lateral connections to properties
    </div>
</div>

<div class="tool-filter-section">
    <h4>Lateral Type</h4>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="filterSewer" checked onchange="applyFilters()">
        <label for="filterSewer">Sewer Laterals</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="filterWater" checked onchange="applyFilters()">
        <label for="filterWater">Water Laterals</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="filterStorm" checked onchange="applyFilters()">
        <label for="filterStorm">Storm Connections</label>
    </div>
</div>

<div class="tool-filter-section">
    <h4>Connection Status</h4>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="statusActive" checked onchange="applyFilters()">
        <label for="statusActive">Active</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="statusProposed" checked onchange="applyFilters()">
        <label for="statusProposed">Proposed</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="statusAbandoned" onchange="applyFilters()">
        <label for="statusAbandoned">Abandoned</label>
    </div>
</div>

<div class="tool-stats-section">
    <h4>Connection Stats</h4>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total Laterals:</span>
        <span class="tool-stat-value" id="sidebarTotalLaterals">0</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Properties Served:</span>
        <span class="tool-stat-value" id="sidebarPropertiesServed">0</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Conflicts Found:</span>
        <span class="tool-stat-value" style="color: var(--danger);" id="sidebarConflicts">0</span>
    </div>
</div>

<button class="tool-action-btn" onclick="analyzeClearances()">
    <i class="fas fa-sync"></i> Analyze Clearances
</button>
<button class="tool-action-btn secondary" onclick="exportReport()">
    <i class="fas fa-file-export"></i> Export Report
</button>
{% endblock %}

{% block main_content %}
<div class="tool-top-area">
    <div id="lateralVisualContainer" style="height: 100%; width: 100%; background: #0a1929; position: relative;">
        <!-- Loading State -->
        <div id="loadingState" style="display:none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--mc-primary); margin-bottom: 1rem;"></i>
            <h3 style="color: var(--mc-text);">Analyzing lateral connections...</h3>
        </div>

        <!-- Empty State -->
        <div id="emptyState" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <i class="fas fa-project-diagram" style="font-size: 64px; color: var(--mc-primary); opacity: 0.3; margin-bottom: 1rem;"></i>
            <h3 style="color: var(--mc-text);">Lateral Connection Map</h3>
            <p style="color: var(--mc-muted); max-width: 400px; margin: 1rem auto;">
                Load project data to visualize lateral connections and property service lines
            </p>
        </div>

        <!-- Success State -->
        <div id="successState" style="display:none; height: 100%; width: 100%;">
            <div style="padding: 1rem; color: var(--mc-text); text-align: center; background: rgba(0,40,80,0.5);">
                <i class="fas fa-map-marked-alt"></i> Lateral Connection Network
            </div>
        </div>
    </div>
</div>

<div class="tool-resizer"></div>

<div class="tool-bottom-area">
    <div class="tool-data-tabs">
        <button class="tool-data-tab active" onclick="showTab('laterals')">
            <i class="fas fa-list"></i> Laterals (<span id="lateralsTabCount">0</span>)
        </button>
        <button class="tool-data-tab" onclick="showTab('conflicts')">
            <i class="fas fa-exclamation-triangle"></i> Conflicts
        </button>
        <button class="tool-data-tab" onclick="showTab('properties')">
            <i class="fas fa-home"></i> Properties
        </button>
    </div>

    <div class="tool-data-content">
        <!-- Laterals Tab -->
        <div id="lateralsTab" class="tab-content">
            <table class="tool-data-table" id="lateralsTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Lateral ID</th>
                        <th>Type</th>
                        <th>Diameter (in)</th>
                        <th>Length (ft)</th>
                        <th>Material</th>
                        <th>Property Address</th>
                        <th>Connected To</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="lateralsTableBody"></tbody>
            </table>
            <div id="lateralsEmpty" style="text-align: center; padding: 3rem; color: var(--mc-text);">
                <i class="fas fa-inbox" style="font-size: 48px; opacity: 0.3; margin-bottom: 1rem;"></i>
                <p>No lateral connection data available</p>
                <p style="color: var(--mc-muted); font-size: 0.9rem; margin-top: 0.5rem;">
                    Load project data to begin analysis
                </p>
            </div>
        </div>

        <!-- Conflicts Tab -->
        <div id="conflictsTab" class="tab-content" style="display:none;">
            <div id="conflictsContainer">
                <div style="background: rgba(255,68,68,0.1); border: 2px solid var(--danger); border-radius: 12px; padding: 2rem; margin-bottom: 1rem;">
                    <h4 style="color: var(--danger); margin: 0 0 1rem 0;">
                        <i class="fas fa-exclamation-circle"></i> Clearance Violations
                    </h4>
                    <div id="violationsList">
                        <p style="color: var(--mc-text);">No clearance violations detected</p>
                    </div>
                </div>

                <div style="background: rgba(255,193,7,0.1); border: 2px solid rgba(255,193,7,0.5); border-radius: 12px; padding: 2rem;">
                    <h4 style="color: rgba(255,193,7,1); margin: 0 0 1rem 0;">
                        <i class="fas fa-exclamation-triangle"></i> Warnings
                    </h4>
                    <div id="warningsList">
                        <p style="color: var(--mc-text);">No warnings</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Properties Tab -->
        <div id="propertiesTab" class="tab-content" style="display:none;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-label">
                        <i class="fas fa-home"></i> Total Properties
                    </div>
                    <div class="stat-value" id="statTotalProperties">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <i class="fas fa-check-circle"></i> Connected
                    </div>
                    <div class="stat-value" style="color: var(--success);" id="statConnected">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <i class="fas fa-times-circle"></i> Unconnected
                    </div>
                    <div class="stat-value" style="color: var(--danger);" id="statUnconnected">0</div>
                </div>
            </div>

            <h4 style="color: var(--mc-accent); margin: 2rem 0 1rem 0;">
                <i class="fas fa-map-marker-alt"></i> Property List
            </h4>
            <table class="tool-data-table" id="propertiesTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Address</th>
                        <th>Parcel ID</th>
                        <th>Sewer Connection</th>
                        <th>Water Connection</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="propertiesTableBody"></tbody>
            </table>
            <div id="propertiesEmpty" style="text-align: center; padding: 2rem; color: var(--mc-muted);">
                No property data available
            </div>
        </div>
    </div>
</div>

<style>
.tab-content { padding: 1rem; }
.stat-card {
    background: rgba(0,255,255,0.05);
    border: 1px solid rgba(0,255,255,0.2);
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
}
.stat-label {
    color: var(--mc-muted);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}
.stat-value {
    color: var(--mc-primary);
    font-size: 1.8rem;
    font-weight: bold;
}
</style>
{% endblock %}

{% block about_tool_description %}
<p>
    The <strong>Sewer & Water Lateral Analyzer</strong> provides comprehensive analysis of service line connections to individual
    properties. This tool lists all lateral connections, provides zoom-to-feature capability for easy navigation, and performs
    automated clearance analysis to identify conflicts between proposed and existing infrastructure.
</p>
<p style="margin-top: 1rem;">
    Analyzes sewer laterals, water service lines, and storm drain connections. Identifies properties without service, detects
    clearance violations, and generates connection inventory reports for utility coordination and construction planning.
</p>
{% endblock %}

{% block about_tool_tags %}
<span class="about-tool-tag">SANIT</span>
<span class="about-tool-tag">WATER</span>
<span class="about-tool-tag">STORM</span>
<span class="about-tool-tag">LATERAL</span>
<span class="about-tool-tag">SERVICE</span>
{% endblock %}

{% block about_tool_examples %}
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-UTIL-SANIT-LAT-NEW-LN</div>
    <div class="about-tool-example-desc">→ Sewer lateral service connection</div>
</div>
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-UTIL-WATER-LAT-NEW-LN</div>
    <div class="about-tool-example-desc">→ Water lateral service connection</div>
</div>
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-UTIL-STORM-LAT-NEW-LN</div>
    <div class="about-tool-example-desc">→ Storm drain lateral connection</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let lateralsData = [];
let propertiesData = [];

function applyFilters() {
    console.log('Filters applied');
    renderLateralsTable(lateralsData);
}

async function analyzeClearances() {
    showState('loading');

    try {
        const activeProject = window.projectContext ?
            await window.projectContext.getActiveProject() : null;

        if (!activeProject) {
            showState('empty');
            alert('No active project selected');
            return;
        }

        const response = await fetch(`/api/specialized-tools/laterals?project_id=${activeProject.project_id}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();

        if (!data.success) {
            showState('empty');
            return;
        }

        lateralsData = data.laterals || [];
        propertiesData = data.properties || [];

        renderLateralsTable(lateralsData);
        renderPropertiesTable(propertiesData);
        renderConflicts(data.conflicts);
        showState('success');

    } catch (error) {
        console.error('Error:', error);
        showState('empty');
    }
}

function renderLateralsTable(laterals) {
    const tbody = document.getElementById('lateralsTableBody');
    const table = document.getElementById('lateralsTable');
    const emptyDiv = document.getElementById('lateralsEmpty');

    if (!laterals || laterals.length === 0) {
        table.style.display = 'none';
        emptyDiv.style.display = 'block';
        return;
    }

    tbody.innerHTML = laterals.map(lateral => `
        <tr>
            <td>${lateral.lateral_id?.substring(0, 8) || 'N/A'}</td>
            <td>${lateral.lateral_type || 'UNKNOWN'}</td>
            <td>${lateral.diameter_in || 'N/A'}</td>
            <td>${lateral.length_ft?.toFixed(1) || 'N/A'}</td>
            <td>${lateral.material || 'N/A'}</td>
            <td>${lateral.address || 'N/A'}</td>
            <td>${lateral.connected_to?.substring(0, 8) || 'N/A'}</td>
            <td>${lateral.status || 'ACTIVE'}</td>
            <td><button class="tool-action-btn" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Zoom</button></td>
        </tr>
    `).join('');

    table.style.display = 'table';
    emptyDiv.style.display = 'none';

    document.getElementById('lateralsTabCount').textContent = laterals.length;
    document.getElementById('sidebarTotalLaterals').textContent = laterals.length;
}

function renderPropertiesTable(properties) {
    const tbody = document.getElementById('propertiesTableBody');
    const table = document.getElementById('propertiesTable');
    const emptyDiv = document.getElementById('propertiesEmpty');

    if (!properties || properties.length === 0) {
        table.style.display = 'none';
        emptyDiv.style.display = 'block';
        return;
    }

    tbody.innerHTML = properties.map(prop => `
        <tr>
            <td>${prop.address || 'N/A'}</td>
            <td>${prop.parcel_id || 'N/A'}</td>
            <td>${prop.has_sewer ? '✓' : '—'}</td>
            <td>${prop.has_water ? '✓' : '—'}</td>
            <td><button class="tool-action-btn" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">View</button></td>
        </tr>
    `).join('');

    table.style.display = 'table';
    emptyDiv.style.display = 'none';

    document.getElementById('sidebarPropertiesServed').textContent = properties.length;
}

function renderConflicts(conflicts) {
    if (!conflicts || conflicts.length === 0) return;

    document.getElementById('sidebarConflicts').textContent = conflicts.length;
}

function showState(state) {
    document.getElementById('loadingState').style.display = state === 'loading' ? 'block' : 'none';
    document.getElementById('emptyState').style.display = state === 'empty' ? 'block' : 'none';
    document.getElementById('successState').style.display = state === 'success' ? 'block' : 'none';
}

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
    document.querySelectorAll('.tool-data-tab').forEach(btn => btn.classList.remove('active'));

    const selectedTab = document.getElementById(tabName + 'Tab');
    if (selectedTab) selectedTab.style.display = 'block';

    event.target.closest('.tool-data-tab').classList.add('active');
}

function exportReport() {
    console.log('Exporting lateral analysis report...');
    alert('Lateral analysis report export functionality will be implemented here');
}

document.addEventListener('DOMContentLoaded', async function() {
    if (window.projectContext) {
        await window.projectContext.init();
        window.projectContext.subscribe(() => analyzeClearances());
    }
});
</script>
{% endblock %}
