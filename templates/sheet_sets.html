{% extends "base.html" %}

{% block title %}Sheet Set Manager - ACAD-GIS{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-1"><i class="fas fa-folder-open me-2"></i>Sheet Set Manager</h1>
                    <p class="text-muted mb-0">Manage construction document sheet sets and deliverables</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="root"></div>
</div>

<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

<script>
const { useState, useEffect, createElement: h } = React;

function SheetSetManager() {
    const [projects, setProjects] = useState([]);
    const [selectedProjectId, setSelectedProjectId] = useState('');
    const [sheetSets, setSheetSets] = useState([]);
    const [selectedSetId, setSelectedSetId] = useState('');
    const [sheets, setSheets] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        loadProjects();
    }, []);

    useEffect(() => {
        if (selectedProjectId) {
            loadSheetSets();
        } else {
            setSheetSets([]);
            setSelectedSetId('');
        }
    }, [selectedProjectId]);

    useEffect(() => {
        if (selectedSetId) {
            loadSheets();
        } else {
            setSheets([]);
        }
    }, [selectedSetId]);

    const loadProjects = async () => {
        try {
            const response = await fetch('/api/projects');
            const data = await response.json();
            console.log('Loaded projects:', data.projects?.length || 0);
            setProjects(data.projects || []);
            setLoading(false);
        } catch (err) {
            console.error('Error:', err);
            setLoading(false);
        }
    };

    const loadSheetSets = async () => {
        try {
            const response = await fetch(`/api/sheet-sets?project_id=${selectedProjectId}`);
            const data = await response.json();
            setSheetSets(data.sheet_sets || []);
        } catch (err) {
            console.error('Error:', err);
        }
    };

    const loadSheets = async () => {
        try {
            const response = await fetch(`/api/sheets?set_id=${selectedSetId}`);
            const data = await response.json();
            setSheets(data.sheets || []);
        } catch (err) {
            console.error('Error:', err);
        }
    };

    const createSet = () => {
        const name = prompt('Enter sheet set name:');
        if (!name) return;

        fetch('/api/sheet-sets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                project_id: selectedProjectId,
                set_name: name,
                phase: '100% Design',
                discipline: 'Civil',
                status: 'draft'
            })
        }).then(() => loadSheetSets());
    };

    const createSheet = () => {
        const code = prompt('Enter sheet code (e.g., C-1.1):');
        if (!code) return;
        const title = prompt('Enter sheet title:');
        if (!title) return;

        fetch('/api/sheets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                set_id: selectedSetId,
                sheet_code: code,
                sheet_title: title,
                sheet_category: 'GRAD',
                sheet_hierarchy_number: 20
            })
        }).then(() => loadSheets());
    };

    if (loading) {
        return h('div', { className: 'alert alert-info' }, 'Loading projects...');
    }

    const projectOptions = [
        h('option', { key: 'empty', value: '' }, 'Select Project...'),
        ...projects.map(p => h('option', {
            key: p.project_id,
            value: p.project_id
        }, `${p.project_number} - ${p.project_name}`))
    ];

    return h('div', { className: 'row' },
        h('div', { className: 'col-12 mb-3' },
            h('div', { className: 'card bg-dark border-primary' },
                h('div', { className: 'card-body' },
                    h('label', { className: 'form-label' }, `Select Project (${projects.length} available)`),
                    h('select', {
                        className: 'form-select bg-dark text-light',
                        value: selectedProjectId,
                        onChange: (e) => setSelectedProjectId(e.target.value)
                    }, projectOptions),
                    h('div', { className: 'mt-2 text-muted small' }, 
                        `Click the dropdown to select from ${projects.length} projects`
                    )
                )
            )
        ),
        selectedProjectId && h('div', { className: 'col-md-6' },
            h('div', { className: 'card bg-dark border-primary' },
                h('div', { className: 'card-header d-flex justify-content-between align-items-center' },
                    h('h5', { className: 'm-0' }, `Sheet Sets (${sheetSets.length})`),
                    h('button', {
                        className: 'btn btn-sm btn-primary',
                        onClick: createSet
                    }, '+ Create Set')
                ),
                h('div', { className: 'card-body', style: { maxHeight: '500px', overflowY: 'auto' } },
                    h('div', { className: 'list-group' },
                        ...sheetSets.map(set => h('button', {
                            key: set.set_id,
                            className: `list-group-item list-group-item-action bg-dark text-light ${selectedSetId === set.set_id ? 'active' : ''}`,
                            onClick: () => setSelectedSetId(set.set_id)
                        },
                            h('div', { className: 'd-flex justify-content-between' },
                                h('strong', null, set.set_name),
                                h('span', { className: 'badge bg-secondary' }, `${set.sheet_count || 0} sheets`)
                            ),
                            h('small', { className: 'text-muted' }, `${set.phase} - ${set.discipline}`)
                        ))
                    )
                )
            )
        ),
        selectedSetId && h('div', { className: 'col-md-6' },
            h('div', { className: 'card bg-dark border-primary' },
                h('div', { className: 'card-header d-flex justify-content-between align-items-center' },
                    h('h5', { className: 'm-0' }, `Sheets (${sheets.length})`),
                    h('button', {
                        className: 'btn btn-sm btn-success',
                        onClick: createSheet
                    }, '+ Add Sheet')
                ),
                h('div', { className: 'card-body', style: { maxHeight: '500px', overflowY: 'auto' } },
                    h('table', { className: 'table table-dark table-striped table-sm' },
                        h('thead',
                            h('tr', null,
                                h('th', null, 'Code'),
                                h('th', null, 'Title'),
                                h('th', null, 'Category'),
                                h('th', null, 'Status')
                            )
                        ),
                        h('tbody', null,
                            ...sheets.map(sheet => h('tr', { key: sheet.sheet_id },
                                h('td', null, sheet.sheet_code),
                                h('td', null, sheet.sheet_title),
                                h('td', null, h('span', { className: 'badge bg-info' }, sheet.sheet_category)),
                                h('td', null, sheet.assigned_drawing_id ? 
                                    h('span', { className: 'badge bg-success' }, 'Assigned') :
                                    h('span', { className: 'badge bg-warning' }, 'Unassigned')
                                )
                            ))
                        )
                    )
                )
            )
        )
    );
}

// Render
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(SheetSetManager));
console.log('Sheet Set Manager loaded successfully');
</script>

{% endblock %}
