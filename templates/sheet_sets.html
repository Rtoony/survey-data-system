{% extends "base.html" %}

{% block title %}Sheet Set Manager - ACAD-GIS Tools{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-folder-open"></i> Sheet Set Manager</h1>
    <p>Manage construction document sheet sets and deliverables</p>
</div>

<div id="sheet-set-app" class="sheet-set-container"></div>

<style>
.sheet-set-container {
    min-height: 600px;
    background: rgba(0, 20, 40, 0.3);
    border-radius: 8px;
    padding: 20px;
}

.loading-message {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 400px;
    color: var(--cyan);
    font-size: 1.2rem;
    gap: 12px;
}

.spinner {
    width: 24px;
    height: 24px;
    border: 3px solid rgba(0, 255, 255, 0.3);
    border-top-color: var(--cyan);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding: 16px;
    background: rgba(0, 60, 120, 0.3);
    border: 1px solid var(--cyan);
    border-radius: 8px;
}

.top-bar-left {
    display: flex;
    gap: 16px;
    align-items: center;
}

.project-selector {
    min-width: 300px;
}

.project-selector label {
    color: var(--cyan);
    font-family: 'Orbitron', sans-serif;
    font-size: 0.9rem;
    margin-bottom: 8px;
    display: block;
}

.project-selector select {
    width: 100%;
    padding: 10px 12px;
    background: rgba(0, 20, 40, 0.8);
    border: 1px solid rgba(0, 255, 255, 0.4);
    border-radius: 4px;
    color: var(--text);
    font-size: 0.95rem;
}

.project-selector select:focus {
    outline: none;
    border-color: var(--cyan);
    box-shadow: 0 0 8px rgba(0, 255, 255, 0.3);
}

.stats-row {
    display: flex;
    gap: 12px;
}

.stat-badge {
    padding: 8px 16px;
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--cyan);
    border-radius: 4px;
}

.stat-badge-label {
    color: var(--gray);
    font-size: 0.75rem;
    margin-bottom: 2px;
}

.stat-badge-value {
    color: var(--cyan);
    font-size: 1.2rem;
    font-weight: bold;
}

.two-panel-layout {
    display: grid;
    grid-template-columns: 45% 55%;
    gap: 20px;
    min-height: 500px;
}

.panel {
    background: rgba(0, 40, 80, 0.5);
    border: 1px solid var(--cyan);
    border-radius: 8px;
    padding: 16px;
    overflow-y: auto;
}

.panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(0, 255, 255, 0.2);
}

.panel-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.1rem;
    color: var(--cyan);
    margin: 0;
}

.btn-create {
    padding: 8px 16px;
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--cyan);
    border-radius: 4px;
    color: var(--cyan);
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.btn-create:hover {
    background: rgba(0, 255, 255, 0.2);
    box-shadow: 0 0 12px rgba(0, 255, 255, 0.3);
}

.set-item {
    padding: 12px;
    margin-bottom: 8px;
    background: rgba(0, 20, 40, 0.5);
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.set-item:hover {
    background: rgba(0, 40, 80, 0.7);
    border-color: var(--cyan);
}

.set-item.selected {
    background: rgba(0, 255, 255, 0.2);
    border-color: var(--gold);
    box-shadow: 0 0 12px rgba(255, 215, 0, 0.2);
}

.set-name {
    font-weight: bold;
    color: var(--text);
    margin-bottom: 4px;
}

.set-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
    color: var(--gray);
}

.sheet-count-badge {
    padding: 2px 8px;
    background: rgba(0, 255, 255, 0.2);
    border: 1px solid var(--cyan);
    border-radius: 3px;
    color: var(--cyan);
    font-size: 0.8rem;
}

.sheet-table {
    width: 100%;
    border-collapse: collapse;
}

.sheet-table th {
    font-family: 'Orbitron', sans-serif;
    color: var(--cyan);
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid rgba(0, 255, 255, 0.3);
    font-size: 0.85rem;
}

.sheet-table td {
    padding: 10px 8px;
    border-bottom: 1px solid rgba(0, 255, 255, 0.1);
    color: var(--text);
}

.sheet-table tr:hover {
    background: rgba(0, 255, 255, 0.05);
}

.sheet-code {
    color: var(--cyan);
    font-weight: bold;
    font-family: 'Courier New', monospace;
}

.category-badge {
    padding: 2px 8px;
    background: rgba(255, 215, 0, 0.1);
    border: 1px solid var(--gold);
    border-radius: 3px;
    color: var(--gold);
    font-size: 0.75rem;
}

.status-badge {
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 0.75rem;
}

.status-unassigned {
    background: rgba(128, 128, 128, 0.2);
    border: 1px solid var(--gray);
    color: var(--gray);
}

.status-assigned {
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid #0f0;
    color: #0f0;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--gray);
}

.empty-state-icon {
    font-size: 4rem;
    color: rgba(0, 255, 255, 0.2);
    margin-bottom: 16px;
}

.empty-state-text {
    font-size: 1.1rem;
    margin-bottom: 8px;
}
</style>

<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

<script>
const { useState, useEffect, createElement: h } = React;

function SheetSetManager() {
    const [projects, setProjects] = useState([]);
    const [selectedProjectId, setSelectedProjectId] = useState('');
    const [sheetSets, setSheetSets] = useState([]);
    const [selectedSetId, setSelectedSetId] = useState('');
    const [sheets, setSheets] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        loadProjects();
    }, []);

    useEffect(() => {
        if (selectedProjectId) {
            loadSheetSets();
        } else {
            setSheetSets([]);
            setSelectedSetId('');
        }
    }, [selectedProjectId]);

    useEffect(() => {
        if (selectedSetId) {
            loadSheets();
        } else {
            setSheets([]);
        }
    }, [selectedSetId]);

    const loadProjects = async () => {
        try {
            const response = await fetch('/api/projects');
            const data = await response.json();
            setProjects(data.projects || []);
            setLoading(false);
        } catch (err) {
            console.error('Error:', err);
            setLoading(false);
        }
    };

    const loadSheetSets = async () => {
        try {
            const response = await fetch(`/api/sheet-sets?project_id=${selectedProjectId}`);
            const data = await response.json();
            setSheetSets(data.sheet_sets || []);
        } catch (err) {
            console.error('Error:', err);
        }
    };

    const loadSheets = async () => {
        try {
            const response = await fetch(`/api/sheets?set_id=${selectedSetId}`);
            const data = await response.json();
            setSheets(data.sheets || []);
        } catch (err) {
            console.error('Error:', err);
        }
    };

    const createSet = () => {
        const name = prompt('Enter sheet set name:');
        if (!name) return;

        fetch('/api/sheet-sets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                project_id: selectedProjectId,
                set_name: name,
                phase: '100% Design',
                discipline: 'Civil',
                status: 'draft'
            })
        }).then(() => loadSheetSets());
    };

    const createSheet = () => {
        const code = prompt('Enter sheet code (e.g., C-1.1):');
        if (!code) return;
        const title = prompt('Enter sheet title:');
        if (!title) return;

        fetch('/api/sheets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                set_id: selectedSetId,
                sheet_code: code,
                sheet_title: title,
                sheet_category: 'GRAD',
                sheet_hierarchy_number: 20
            })
        }).then(() => loadSheets());
    };

    if (loading) {
        return h('div', { className: 'loading-message' },
            h('div', { className: 'spinner' }),
            'Loading Sheet Set Manager...'
        );
    }

    const totalSheets = sheetSets.reduce((sum, set) => sum + (set.sheet_count || 0), 0);
    const selectedSet = sheetSets.find(s => s.set_id === selectedSetId);

    return h('div', null,
        h('div', { className: 'top-bar' },
            h('div', { className: 'top-bar-left' },
                h('div', { className: 'project-selector' },
                    h('label', null, 'Project'),
                    h('select', {
                        value: selectedProjectId,
                        onChange: (e) => setSelectedProjectId(e.target.value)
                    },
                        h('option', { value: '' }, 'Select Project...'),
                        ...projects.map(p => h('option', {
                            key: p.project_id,
                            value: p.project_id
                        }, `${p.project_number || ''} ${p.project_name}`))
                    )
                )
            ),
            selectedProjectId && h('div', { className: 'stats-row' },
                h('div', { className: 'stat-badge' },
                    h('div', { className: 'stat-badge-label' }, 'SETS'),
                    h('div', { className: 'stat-badge-value' }, sheetSets.length)
                ),
                h('div', { className: 'stat-badge' },
                    h('div', { className: 'stat-badge-label' }, 'SHEETS'),
                    h('div', { className: 'stat-badge-value' }, totalSheets)
                )
            )
        ),

        selectedProjectId ? h('div', { className: 'two-panel-layout' },
            h('div', { className: 'panel' },
                h('div', { className: 'panel-header' },
                    h('h3', { className: 'panel-title' }, 'Sheet Sets'),
                    h('button', { className: 'btn-create', onClick: createSet }, '+ Create Set')
                ),
                sheetSets.length === 0 ? 
                    h('div', { className: 'empty-state' },
                        h('div', { className: 'empty-state-icon' }, 'üìÅ'),
                        h('div', { className: 'empty-state-text' }, 'No sheet sets yet'),
                        h('div', { style: { fontSize: '0.9rem' } }, 'Click "+ Create Set" to get started')
                    ) :
                    sheetSets.map(set => h('div', {
                        key: set.set_id,
                        className: `set-item ${selectedSetId === set.set_id ? 'selected' : ''}`,
                        onClick: () => setSelectedSetId(set.set_id)
                    },
                        h('div', { className: 'set-name' }, set.set_name),
                        h('div', { className: 'set-info' },
                            h('span', null, `${set.phase || 'Draft'} - ${set.discipline || 'Civil'}`),
                            h('span', { className: 'sheet-count-badge' }, `${set.sheet_count || 0} sheets`)
                        )
                    ))
            ),

            h('div', { className: 'panel' },
                h('div', { className: 'panel-header' },
                    h('h3', { className: 'panel-title' }, selectedSet ? `Sheets: ${selectedSet.set_name}` : 'Sheets'),
                    selectedSetId && h('button', { className: 'btn-create', onClick: createSheet }, '+ Add Sheet')
                ),
                !selectedSetId ? 
                    h('div', { className: 'empty-state' },
                        h('div', { className: 'empty-state-icon' }, 'üëà'),
                        h('div', { className: 'empty-state-text' }, 'Select a sheet set'),
                        h('div', { style: { fontSize: '0.9rem' } }, 'Choose a set from the left panel')
                    ) :
                sheets.length === 0 ?
                    h('div', { className: 'empty-state' },
                        h('div', { className: 'empty-state-icon' }, 'üìÑ'),
                        h('div', { className: 'empty-state-text' }, 'No sheets in this set'),
                        h('div', { style: { fontSize: '0.9rem' } }, 'Click "+ Add Sheet" to create one')
                    ) :
                    h('table', { className: 'sheet-table' },
                        h('thead', null,
                            h('tr', null,
                                h('th', null, 'Code'),
                                h('th', null, 'Title'),
                                h('th', null, 'Category'),
                                h('th', null, 'Status')
                            )
                        ),
                        h('tbody', null,
                            ...sheets.map(sheet => h('tr', { key: sheet.sheet_id },
                                h('td', null, h('span', { className: 'sheet-code' }, sheet.sheet_code)),
                                h('td', null, sheet.sheet_title),
                                h('td', null, 
                                    sheet.sheet_category ? 
                                        h('span', { className: 'category-badge' }, sheet.sheet_category) : 
                                        '-'
                                ),
                                h('td', null, 
                                    h('span', { 
                                        className: `status-badge status-${sheet.assignment_status}` 
                                    }, sheet.assignment_status || 'unassigned')
                                )
                            ))
                        )
                    )
            )
        ) : h('div', { className: 'empty-state', style: { marginTop: '100px' } },
            h('div', { className: 'empty-state-icon' }, 'üèóÔ∏è'),
            h('div', { className: 'empty-state-text' }, 'Select a project to begin'),
            h('div', { style: { fontSize: '0.9rem' } }, `${projects.length} projects available`)
        )
    );
}

const root = ReactDOM.createRoot(document.getElementById('sheet-set-app'));
root.render(h(SheetSetManager));

console.log('Sheet Set Manager loaded successfully');
</script>

{% endblock %}
