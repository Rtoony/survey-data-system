{% extends "base.html" %}

{% block title %}Map Viewer{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
<!-- Leaflet Draw CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

<style>
    :root {
        --primary-color: #00ffaa;
        --accent-color: #00ffff;
        --bg-dark: rgba(0, 20, 40, 0.98);
        --bg-section: rgba(0, 40, 80, 0.5);
    }

    /* Main container */
    .map-viewer-container {
        display: flex;
        height: calc(100vh - 80px);
        gap: 0;
        position: relative;
    }
    
    /* Left sidebar */
    .map-sidebar {
        width: 350px;
        background: var(--bg-dark);
        border-right: 3px solid var(--accent-color);
        overflow-y: auto;
        padding: 20px;
        box-shadow: 4px 0 20px rgba(0, 255, 255, 0.3);
        z-index: 100;
    }
    
    /* Map container */
    .map-container {
        flex: 1;
        position: relative;
        background: #001428;
        z-index: 1;
    }
    
    #map {
        height: 100%;
        width: 100%;
    }
    
    /* Sidebar sections */
    .sidebar-section {
        background: var(--bg-section);
        border: 1px solid var(--primary-color);
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .sidebar-section h3 {
        font-size: 13px;
        color: var(--accent-color);
        margin: 0 0 12px 0;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 1px solid rgba(0, 255, 255, 0.3);
        padding-bottom: 8px;
    }
    
    /* Buttons */
    .btn-map {
        background: linear-gradient(135deg, #004d7a, #008793);
        border: 1px solid var(--primary-color);
        color: white;
        padding: 8px 12px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s;
        width: 100%;
        margin-bottom: 6px;
        text-align: left;
    }
    
    .btn-map:hover {
        background: linear-gradient(135deg, #006699, #00a8b8);
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }
    
    .btn-map.active {
        background: linear-gradient(135deg, #00a8b8, #00ffff);
        color: #001428;
        font-weight: bold;
    }
    
    .btn-map:disabled {
        background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
        border-color: #555;
        color: #666;
        cursor: not-allowed;
        opacity: 0.5;
    }
    
    /* Search input */
    .search-group {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
    }
    
    .search-group input {
        flex: 1;
        padding: 8px;
        background: rgba(0, 40, 80, 0.8);
        border: 1px solid var(--primary-color);
        color: white;
        border-radius: 3px;
        font-size: 12px;
    }
    
    .search-group button {
        padding: 8px 15px;
        background: linear-gradient(135deg, #004d7a, #008793);
        border: 1px solid var(--primary-color);
        color: white;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .search-group button:hover {
        background: linear-gradient(135deg, #006699, #00a8b8);
    }
    
    /* Basemap selector */
    select {
        width: 100%;
        padding: 8px;
        background: rgba(0, 40, 80, 0.8);
        border: 1px solid var(--primary-color);
        color: white;
        border-radius: 3px;
        font-size: 12px;
        margin-bottom: 10px;
    }
    
    /* Layer group item */
    .layer-group {
        margin-bottom: 10px;
        border: 1px solid rgba(0, 255, 255, 0.2);
        border-radius: 3px;
        background: rgba(0, 30, 60, 0.3);
    }
    
    .layer-group-header {
        padding: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        transition: background 0.2s;
    }
    
    .layer-group-header:hover {
        background: rgba(0, 255, 255, 0.1);
    }
    
    .layer-color-box {
        width: 20px;
        height: 20px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 2px;
    }
    
    .layer-group-label {
        flex: 1;
        color: var(--accent-color);
    }
    
    .layer-count {
        color: rgba(255, 255, 255, 0.5);
        font-size: 11px;
    }
    
    .layer-toggle {
        cursor: pointer;
    }
    
    .layer-group-layers {
        padding: 5px 10px 10px 38px;
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
        display: none;
    }
    
    .layer-group-layers.expanded {
        display: block;
    }
    
    .layer-name-item {
        padding: 2px 0;
    }
    
    /* Coordinate display */
    .coord-display {
        background: rgba(0, 40, 80, 0.9);
        border: 1px solid var(--primary-color);
        padding: 8px;
        border-radius: 3px;
        font-size: 11px;
        font-family: 'Courier New', monospace;
    }
    
    .coord-display div {
        margin: 3px 0;
        color: #a0f0ff;
    }
    
    /* Status messages */
    .status-message {
        padding: 8px;
        border-radius: 3px;
        margin-top: 10px;
        font-size: 11px;
    }
    
    .status-success {
        background: rgba(0, 255, 0, 0.2);
        border: 1px solid #00ff00;
        color: #00ff00;
    }
    
    .status-error {
        background: rgba(255, 0, 0, 0.2);
        border: 1px solid #ff0000;
        color: #ff6666;
    }
    
    .status-info {
        background: rgba(0, 170, 255, 0.2);
        border: 1px solid #00aaff;
        color: #00aaff;
    }
    
    /* Export Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9998;
    }
    
    .modal-overlay.active {
        display: block;
    }
    
    .export-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-dark);
        border: 2px solid var(--accent-color);
        border-radius: 8px;
        padding: 25px;
        min-width: 400px;
        max-width: 500px;
        z-index: 9999;
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
    }
    
    .export-modal.active {
        display: block;
    }
    
    .export-modal h3 {
        color: var(--accent-color);
        margin: 0 0 20px 0;
        font-size: 18px;
    }
    
    .export-option {
        padding: 10px;
        margin: 10px 0;
        background: var(--bg-section);
        border: 1px solid var(--primary-color);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .export-option:hover {
        background: rgba(0, 100, 150, 0.5);
        border-color: var(--accent-color);
    }
    
    .export-option h4 {
        margin: 0 0 5px 0;
        color: var(--accent-color);
        font-size: 14px;
    }
    
    .export-option p {
        margin: 0;
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .modal-close {
        margin-top: 20px;
        background: linear-gradient(135deg, #7a0000, #930000);
        border: 1px solid #ff0000;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
    }
    
    .modal-close:hover {
        background: linear-gradient(135deg, #990000, #bb0000);
    }
    
    /* Measurement result display */
    .measurement-result {
        background: rgba(0, 255, 170, 0.2);
        border: 1px solid var(--primary-color);
        padding: 8px;
        border-radius: 3px;
        margin-top: 10px;
        font-size: 12px;
        color: var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="map-viewer-container">
    <!-- Left Sidebar -->
    <div class="map-sidebar">
        <!-- Project Info -->
        <div class="sidebar-section">
            <h3>Active Project</h3>
            <div id="projectInfo" style="color: #a0f0ff; font-size: 12px;">
                Loading...
            </div>
        </div>
        
        <!-- Map Controls -->
        <div class="sidebar-section">
            <h3>Map Controls</h3>
            <button class="btn-map" onclick="zoomToProject()">üìç Zoom to Project</button>
            <button class="btn-map" onclick="refreshData()">üîÑ Refresh Data</button>
        </div>
        
        <!-- Address Search -->
        <div class="sidebar-section">
            <h3>Address Search</h3>
            <div class="search-group">
                <input type="text" id="addressInput" placeholder="Enter address..." onkeypress="if(event.key==='Enter') searchAddress()">
                <button onclick="searchAddress()">üîç</button>
            </div>
            <div id="searchStatus"></div>
        </div>
        
        <!-- Basemap Selector -->
        <div class="sidebar-section">
            <h3>Basemap</h3>
            <select id="basemapSelector" onchange="changeBasemap()">
                <option value="streets">Streets</option>
                <option value="satellite">Satellite</option>
                <option value="topo">Topographic</option>
                <option value="dark">Dark</option>
            </select>
        </div>
        
        <!-- Layer Control -->
        <div class="sidebar-section">
            <h3>Layers (<span id="layerCount">0</span>)</h3>
            <div id="layerControls">
                <div style="color: rgba(255,255,255,0.5); font-size: 11px; text-align: center;">
                    No layers loaded
                </div>
            </div>
        </div>
        
        <!-- Measuring Tools -->
        <div class="sidebar-section">
            <h3>Measuring Tools</h3>
            <button class="btn-map" id="measureDistanceBtn" onclick="startMeasureDistance()">üìè Measure Distance</button>
            <button class="btn-map" id="measureAreaBtn" onclick="startMeasureArea()">üìê Measure Area</button>
            <button class="btn-map" onclick="clearMeasurements()">üóëÔ∏è Clear Measurements</button>
            <div id="measurementResult"></div>
            <button class="btn-map" id="drawRectBtn" onclick="startDrawingRectangle()">üì¶ Draw Export Rectangle</button>
            <button class="btn-map" id="exportBtn" onclick="openExportModal()">üíæ Create Export</button>
        </div>
        
        <!-- Coordinate Display -->
        <div class="sidebar-section">
            <h3>Coordinates</h3>
            <div class="coord-display">
                <div>Lat: <span id="coordLat">--</span></div>
                <div>Lng: <span id="coordLng">--</span></div>
            </div>
        </div>
    </div>
    
    <!-- Map Area -->
    <div class="map-container">
        <div id="map"></div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal-overlay" id="exportModalOverlay" onclick="closeExportModal()"></div>
<div class="export-modal" id="exportModal">
    <h3>Export Map Data</h3>
    <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">Select format to export visible map data:</p>
    
    <div class="format-section">
        <h4 style="color: var(--accent-color); margin-bottom: 15px; font-size: 14px;">Select Export Formats</h4>
        
        <div class="checkbox-group" style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="format-png" checked>
                <span><i class="fas fa-image"></i> PNG Image</span>
            </label>
            <div class="format-description" style="color: rgba(255,255,255,0.5); font-size: 11px; margin-left: 24px; margin-top: 4px;">
                Map image with optional north arrow and scale bar
            </div>
        </div>
        
        <div class="checkbox-group" style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="format-shp" checked>
                <span><i class="fas fa-file-archive"></i> Shapefile (.shp)</span>
            </label>
            <div class="format-description" style="color: rgba(255,255,255,0.5); font-size: 11px; margin-left: 24px; margin-top: 4px;">
                Standard GIS format compatible with ArcGIS, QGIS
            </div>
        </div>
        
        <div class="checkbox-group" style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="format-dxf">
                <span><i class="fas fa-file-code"></i> DXF (.dxf)</span>
            </label>
            <div class="format-description" style="color: rgba(255,255,255,0.5); font-size: 11px; margin-left: 24px; margin-top: 4px;">
                AutoCAD Drawing Exchange Format
            </div>
        </div>
        
        <div class="checkbox-group" style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="format-kml">
                <span><i class="fas fa-globe"></i> KML (.kml)</span>
            </label>
            <div class="format-description" style="color: rgba(255,255,255,0.5); font-size: 11px; margin-left: 24px; margin-top: 4px;">
                Google Earth / Google Maps format
            </div>
        </div>
    </div>
    
    <div class="format-section" id="png-options-section" style="margin-top: 20px;">
        <h4 style="color: var(--accent-color); margin-bottom: 15px; font-size: 14px;">PNG Options</h4>
        
        <div class="checkbox-group" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="png-north-arrow" checked>
                <span><i class="fas fa-compass"></i> North Arrow</span>
            </label>
        </div>
        
        <div class="checkbox-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="png-scale-bar" checked>
                <span><i class="fas fa-ruler-horizontal"></i> Scale Bar</span>
            </label>
        </div>
    </div>
    
    <div style="margin-top: 20px; display: flex; gap: 10px;">
        <button class="modal-close" onclick="closeExportModal()" style="flex: 1;">
            <i class="fas fa-times"></i> Cancel
        </button>
        <button onclick="startExport()" style="flex: 1; background: linear-gradient(135deg, #00a85a, #00cc66); border: 1px solid #00ff88; color: white; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
            <i class="fas fa-download"></i> Create Export
        </button>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<!-- Leaflet Draw JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
let map;
let activeProjectId = null;
let layerGroups = {};
let layerData = [];
let basemapLayers = {};
let currentBasemap = 'streets';
let measurementLayer;
let drawControl;
let drawnItems;

// Initialize map
function initMap() {
    map = L.map('map', {
        zoomDelta: 0.25,
        zoomSnap: 0.25,
        wheelPxPerZoomLevel: 120,
        maxZoom: 22
    }).setView([37.7749, -122.4194], 13);
    
    // Initialize basemap layers
    basemapLayers.streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    });
    
    basemapLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '¬© Esri'
    });
    
    basemapLayers.topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenTopoMap contributors'
    });
    
    basemapLayers.dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© CartoDB'
    });
    
    // Add default basemap
    basemapLayers.streets.addTo(map);
    
    // Update coordinates on mouse move
    map.on('mousemove', function(e) {
        document.getElementById('coordLat').textContent = e.latlng.lat.toFixed(6);
        document.getElementById('coordLng').textContent = e.latlng.lng.toFixed(6);
    });
    
    // Initialize measurement layer
    drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    
    // Set up draw event listener for export rectangles
    map.on('draw:created', function(e) {
        drawnItems.clearLayers();
        drawnItems.addLayer(e.layer);
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.disabled = false;
        }
    });
}

// Fetch active project
async function fetchActiveProject() {
    try {
        const response = await fetch('/api/active-project');
        const data = await response.json();
        
        if (data.active_project) {
            activeProjectId = data.active_project.project_id;
            document.getElementById('projectInfo').innerHTML = `
                <strong>${data.active_project.project_name}</strong><br>
                <small style="color: rgba(255,255,255,0.6);">${activeProjectId}</small>
            `;
            loadMapData();
        } else {
            document.getElementById('projectInfo').innerHTML = `
                <div style="color: #ffaa00;">No active project selected</div>
                <small style="color: rgba(255,255,255,0.5);">Please select a project first</small>
            `;
        }
    } catch (error) {
        console.error('Error fetching active project:', error);
        document.getElementById('projectInfo').innerHTML = `
            <div style="color: #ff6666;">Error loading project</div>
        `;
    }
}

// Load map data from API
async function loadMapData() {
    if (!activeProjectId) {
        showStatus('error', 'No active project selected');
        return;
    }
    
    try {
        showStatus('info', 'Loading map data...');
        
        const response = await fetch(`/api/projects/${activeProjectId}/drawing-entities-map`);
        const data = await response.json();
        
        if (data.error) {
            showStatus('error', data.error);
            return;
        }
        
        if (!data.has_spatial_data) {
            showStatus('info', data.message || 'No spatial data available');
            return;
        }
        
        layerData = data.layer_groups;
        
        // Clear existing layers
        Object.values(layerGroups).forEach(group => {
            if (group.layer) {
                map.removeLayer(group.layer);
            }
        });
        layerGroups = {};
        
        // Add layer groups to map
        layerData.forEach(groupData => {
            const geoJsonLayer = L.geoJSON(groupData.features, {
                style: {
                    color: groupData.color,
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.3
                },
                pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 5,
                        fillColor: groupData.color,
                        color: groupData.color,
                        weight: 2,
                        opacity: 0.8,
                        fillOpacity: 0.6
                    });
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties) {
                        const popupContent = `
                            <strong>${feature.properties.layer_name}</strong><br>
                            Entity Type: ${feature.properties.entity_type}<br>
                            Entity ID: ${feature.properties.entity_id}
                        `;
                        layer.bindPopup(popupContent);
                    }
                }
            }).addTo(map);
            
            layerGroups[groupData.group_id] = {
                data: groupData,
                layer: geoJsonLayer,
                visible: true
            };
        });
        
        // Update layer control panel
        renderLayerControls();
        
        // Zoom to project extent
        if (data.bbox) {
            const bounds = [
                [data.bbox.min_y, data.bbox.min_x],
                [data.bbox.max_y, data.bbox.max_x]
            ];
            map.fitBounds(bounds, { padding: [50, 50] });
        }
        
        showStatus('success', `Loaded ${data.total_groups} layer groups with ${data.total_features} features`);
        
    } catch (error) {
        console.error('Error loading map data:', error);
        showStatus('error', 'Failed to load map data');
    }
}

// Render layer controls in sidebar
function renderLayerControls() {
    const container = document.getElementById('layerControls');
    const layerCount = document.getElementById('layerCount');
    
    if (layerData.length === 0) {
        container.innerHTML = '<div style="color: rgba(255,255,255,0.5); font-size: 11px; text-align: center;">No layers loaded</div>';
        layerCount.textContent = '0';
        return;
    }
    
    layerCount.textContent = layerData.length;
    
    let html = '';
    layerData.forEach(groupData => {
        const isVisible = layerGroups[groupData.group_id]?.visible ?? true;
        html += `
            <div class="layer-group">
                <div class="layer-group-header" onclick="toggleLayerExpand('${groupData.group_id}')">
                    <div class="layer-color-box" style="background-color: ${groupData.color};"></div>
                    <div class="layer-group-label">${groupData.group_label}</div>
                    <div class="layer-count">${groupData.feature_count}</div>
                    <input type="checkbox" class="layer-toggle" ${isVisible ? 'checked' : ''} 
                           onclick="event.stopPropagation(); toggleLayer('${groupData.group_id}')" />
                </div>
                <div class="layer-group-layers" id="layers-${groupData.group_id}">
                    ${groupData.layer_names.map(name => `<div class="layer-name-item">‚Ä¢ ${name}</div>`).join('')}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Toggle layer visibility
function toggleLayer(groupId) {
    if (!layerGroups[groupId]) return;
    
    const group = layerGroups[groupId];
    group.visible = !group.visible;
    
    if (group.visible) {
        map.addLayer(group.layer);
    } else {
        map.removeLayer(group.layer);
    }
}

// Toggle layer group expansion
function toggleLayerExpand(groupId) {
    const element = document.getElementById(`layers-${groupId}`);
    if (element) {
        element.classList.toggle('expanded');
    }
}

// Change basemap
function changeBasemap() {
    const selector = document.getElementById('basemapSelector');
    const newBasemap = selector.value;
    
    if (basemapLayers[currentBasemap]) {
        map.removeLayer(basemapLayers[currentBasemap]);
    }
    
    if (basemapLayers[newBasemap]) {
        basemapLayers[newBasemap].addTo(map);
        currentBasemap = newBasemap;
    }
}

// Zoom to project
function zoomToProject() {
    loadMapData();
}

// Refresh data
function refreshData() {
    loadMapData();
}

// Address search with Nominatim geocoding
async function searchAddress() {
    const input = document.getElementById('addressInput');
    const address = input.value.trim();
    
    if (!address) {
        showSearchStatus('error', 'Please enter an address');
        return;
    }
    
    try {
        showSearchStatus('info', 'Searching...');
        
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
        const results = await response.json();
        
        if (results.length === 0) {
            showSearchStatus('error', 'Address not found');
            return;
        }
        
        const result = results[0];
        const lat = parseFloat(result.lat);
        const lng = parseFloat(result.lon);
        
        map.setView([lat, lng], 16);
        
        const marker = L.marker([lat, lng])
            .addTo(map)
            .bindPopup(`<strong>${result.display_name}</strong>`)
            .openPopup();
        
        showSearchStatus('success', 'Address found!');
        
    } catch (error) {
        console.error('Error searching address:', error);
        showSearchStatus('error', 'Search failed');
    }
}

// Measurement tools
function startMeasureDistance() {
    clearMeasurements();
    
    const btn = document.getElementById('measureDistanceBtn');
    btn.classList.add('active');
    
    const polyline = new L.Polyline([], { color: '#ff0', weight: 3, dashArray: '5, 10' });
    map.addLayer(polyline);
    
    let points = [];
    let measuring = true;
    
    const clickHandler = function(e) {
        if (!measuring) return;
        
        points.push(e.latlng);
        polyline.addLatLng(e.latlng);
        
        if (points.length > 1) {
            const distance = calculateDistance(points);
            document.getElementById('measurementResult').innerHTML = `
                <div class="measurement-result">
                    Distance: ${distance.toFixed(2)} meters (${(distance * 3.28084).toFixed(2)} feet)
                    <br><small>Click to add points. Double-click to finish.</small>
                </div>
            `;
        }
    };
    
    const dblClickHandler = function() {
        measuring = false;
        map.off('click', clickHandler);
        map.off('dblclick', dblClickHandler);
        btn.classList.remove('active');
        drawnItems.addLayer(polyline);
    };
    
    map.on('click', clickHandler);
    map.on('dblclick', dblClickHandler);
}

function startMeasureArea() {
    clearMeasurements();
    
    const btn = document.getElementById('measureAreaBtn');
    btn.classList.add('active');
    
    const polygon = new L.Polygon([], { color: '#ff0', weight: 3, fillOpacity: 0.2 });
    map.addLayer(polygon);
    
    let points = [];
    let measuring = true;
    
    const clickHandler = function(e) {
        if (!measuring) return;
        
        points.push(e.latlng);
        polygon.addLatLng(e.latlng);
        
        if (points.length > 2) {
            const area = L.GeometryUtil.geodesicArea(points);
            document.getElementById('measurementResult').innerHTML = `
                <div class="measurement-result">
                    Area: ${area.toFixed(2)} m¬≤ (${(area * 10.7639).toFixed(2)} ft¬≤)
                    <br><small>Click to add points. Double-click to finish.</small>
                </div>
            `;
        }
    };
    
    const dblClickHandler = function() {
        measuring = false;
        map.off('click', clickHandler);
        map.off('dblclick', dblClickHandler);
        btn.classList.remove('active');
        drawnItems.addLayer(polygon);
    };
    
    map.on('click', clickHandler);
    map.on('dblclick', dblClickHandler);
}

function calculateDistance(points) {
    let total = 0;
    for (let i = 0; i < points.length - 1; i++) {
        total += points[i].distanceTo(points[i + 1]);
    }
    return total;
}

function clearMeasurements() {
    drawnItems.clearLayers();
    document.getElementById('measurementResult').innerHTML = '';
    document.getElementById('measureDistanceBtn').classList.remove('active');
    document.getElementById('measureAreaBtn').classList.remove('active');
    
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.disabled = true;
    }
}

// Export functions
function startDrawingRectangle() {
    console.log('Starting rectangle drawing...');
    if (!map) {
        alert('Map not ready');
        return;
    }
    
    new L.Draw.Rectangle(map, {
        shapeOptions: {
            color: '#00ffff',
            weight: 2,
            fillOpacity: 0.1
        }
    }).enable();
    console.log('Rectangle drawing enabled');
}

function openExportModal() {
    const layers = drawnItems.getLayers();
    if (layers.length === 0) {
        alert('Please draw a rectangle on the map first using "Draw Export Rectangle" button');
        return;
    }
    
    if (!activeProjectId) {
        alert('No active project selected');
        return;
    }
    
    const loadedLayers = Object.keys(layerGroups);
    if (loadedLayers.length === 0) {
        alert('No project layers are currently loaded to export');
        return;
    }
    
    document.getElementById('exportModalOverlay').classList.add('active');
    document.getElementById('exportModal').classList.add('active');
}

function closeExportModal() {
    document.getElementById('exportModalOverlay').classList.remove('active');
    document.getElementById('exportModal').classList.remove('active');
}

async function startExport() {
    const formats = [];
    if (document.getElementById('format-png').checked) formats.push('png');
    if (document.getElementById('format-shp').checked) formats.push('shp');
    if (document.getElementById('format-dxf').checked) formats.push('dxf');
    if (document.getElementById('format-kml').checked) formats.push('kml');
    
    if (formats.length === 0) {
        alert('Please select at least one export format');
        return;
    }
    
    const pngOptions = {
        north_arrow: document.getElementById('png-north-arrow').checked,
        scale_bar: document.getElementById('png-scale-bar').checked
    };
    
    const layers = drawnItems.getLayers();
    if (layers.length === 0) {
        alert('No export rectangle found. Please draw a rectangle first.');
        return;
    }
    
    const bbox = layers[0].getBounds();
    
    const entityLayers = Object.keys(layerGroups).flatMap(key => layerGroups[key].data.layer_names);
    
    const params = {
        project_id: activeProjectId,
        bbox: {
            minx: bbox.getWest(),
            miny: bbox.getSouth(),
            maxx: bbox.getEast(),
            maxy: bbox.getNorth(),
            crs: 'EPSG:4326'
        },
        entity_layers: entityLayers,
        formats: formats,
        png_options: pngOptions
    };
    
    console.log('Creating multi-format export...');
    console.log('Export params:', params);
    
    closeExportModal();
    
    try {
        showStatus('info', 'Creating export...');
        
        const res = await fetch('/api/map-export/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(params)
        });
        const data = await res.json();
        
        if (data.status === 'complete') {
            let msg = `Export successful!\n\n`;
            msg += `Formats created: ${formats.join(', ').toUpperCase()}\n`;
            
            if (data.feature_counts) {
                msg += `\nFeatures exported:\n`;
                for (const [layer, count] of Object.entries(data.feature_counts)) {
                    msg += `  ${layer}: ${count}\n`;
                }
                msg += `\nTotal: ${Object.values(data.feature_counts).reduce((a,b)=>a+b, 0)} features\n`;
            }
            
            msg += `\nCoordinate System: EPSG:2226 (CA State Plane Zone 2)\n`;
            msg += `\nClick OK to download the ZIP file.`;
            
            showStatus('success', 'Export complete!');
            alert(msg);
            window.location.href = data.download_url;
        } else {
            showStatus('error', 'Export failed: ' + (data.error || 'Unknown error'));
            alert('Export failed: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        console.error('Export error:', e);
        showStatus('error', 'Export error: ' + e.message);
        alert('Export error: ' + e.message);
    }
}

// Status message helpers
function showStatus(type, message) {
    const statusDiv = document.createElement('div');
    statusDiv.className = `status-message status-${type}`;
    statusDiv.textContent = message;
    
    const container = document.querySelector('.map-sidebar');
    container.appendChild(statusDiv);
    
    setTimeout(() => {
        statusDiv.remove();
    }, 5000);
}

function showSearchStatus(type, message) {
    const statusEl = document.getElementById('searchStatus');
    statusEl.className = `status-message status-${type}`;
    statusEl.textContent = message;
    statusEl.style.display = 'block';
    
    setTimeout(() => {
        statusEl.style.display = 'none';
    }, 3000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    fetchActiveProject();
    
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.disabled = true;
    }
});
</script>

<!-- Leaflet GeometryUtil for area calculation -->
<script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.1/src/leaflet.geometryutil.js"></script>

{% endblock %}
