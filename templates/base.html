<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Schema Explorer{% endblock %} - ACAD-GIS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% block extra_head %}{% endblock %}
</head>
{% set embedded_mode = request.args.get('embedded') == 'true' %}
<body class="grid-background{% if embedded_mode %} embedded{% endif %}">
    <div class="sticky-header-container">
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-database neon-blue"></i>
                    <div>
                        <h1 class="orbitron">ACAD-GIS Schema Explorer</h1>
                        <div class="header-subtitle">Database Management & Viewer</div>
                    </div>
                </div>
                <div id="globalProjectSelector" class="global-project-selector" style="display: none;">
                    <div class="project-selector-label">
                        <i class="fas fa-folder-open"></i>
                        <span>Active Project:</span>
                    </div>
                    <select id="globalProjectSelect" class="project-select-control">
                        <option value="">Loading...</option>
                    </select>
                </div>
            </div>
        </header>

        <nav class="mc-navbar" id="navbar">
        <button class="mc-navbar-mobile-toggle" id="mobileToggle" aria-label="Toggle navigation" aria-expanded="false">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="mc-navbar-menu" id="navbarMenu">
            <a href="/" class="mc-nav-item {% if request.path == '/' %}active{% endif %}">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>

            <div class="mc-nav-item mc-has-dropdown {% if request.path in ['/standards-library', '/standards/layer-vocabulary', '/standards/reference-data', '/standards/reference', '/standards/layer-generator', '/tools/dxf-test-generator', '/tools/object-reclassifier', '/tools/batch-cad-import', '/tools/batch-block-import', '/tools/survey-codes'] %}active{% endif %}">
                <button class="mc-nav-link" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-ruler-combined"></i>
                    <span>Standards</span>
                    <i class="fas fa-chevron-down mc-dropdown-icon"></i>
                </button>
                <div class="mc-dropdown">
                    <a href="/standards-library" class="mc-dropdown-item {% if request.path == '/standards-library' %}active{% endif %}">
                        <i class="fas fa-th-large"></i>
                        CAD Standards Portal
                    </a>
                    <a href="/standards/layer-vocabulary" class="mc-dropdown-item {% if request.path == '/standards/layer-vocabulary' %}active{% endif %}">
                        <i class="fas fa-layer-group"></i>
                        Layer Vocabulary
                    </a>
                    <a href="/standards/layer-generator" class="mc-dropdown-item {% if request.path == '/standards/layer-generator' %}active{% endif %}">
                        <i class="fas fa-magic"></i>
                        Layer Generator
                    </a>
                    <a href="/tools/dxf-test-generator" class="mc-dropdown-item {% if request.path == '/tools/dxf-test-generator' %}active{% endif %}">
                        <i class="fas fa-file-code"></i>
                        DXF Test Generator
                    </a>
                    <a href="/standards/reference-data" class="mc-dropdown-item {% if request.path == '/standards/reference-data' %}active{% endif %}">
                        <i class="fas fa-database"></i>
                        Reference Data Hub
                    </a>
                    <a href="/standards/reference" class="mc-dropdown-item {% if request.path == '/standards/reference' %}active{% endif %}">
                        <i class="fas fa-book-open"></i>
                        Layer Standards Reference
                    </a>
                    <div class="mc-dropdown-divider"></div>
                    <div class="mc-dropdown-header">CAD Management Tools</div>
                    <a href="/tools/object-reclassifier" class="mc-dropdown-item {% if request.path == '/tools/object-reclassifier' %}active{% endif %}">
                        <i class="fas fa-random"></i>
                        Object Reclassifier
                    </a>
                    <a href="/tools/batch-cad-import" class="mc-dropdown-item {% if request.path in ['/tools/batch-cad-import', '/tools/batch-block-import'] %}active{% endif %}">
                        <i class="fas fa-cubes"></i>
                        Batch CAD Import
                    </a>
                    <a href="/tools/survey-codes" class="mc-dropdown-item {% if request.path == '/tools/survey-codes' %}active{% endif %}">
                        <i class="fas fa-list-check"></i>
                        Survey Code Library
                    </a>
                </div>
            </div>

            <div class="mc-nav-item mc-has-dropdown {% if request.path in ['/dxf-name-translator', '/project-relationship-manager', '/standards-export'] %}active{% endif %}">
                <button class="mc-nav-link" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-map-signs"></i>
                    <span>Mapping</span>
                    <i class="fas fa-chevron-down mc-dropdown-icon"></i>
                </button>
                <div class="mc-dropdown">
                    <a href="/dxf-name-translator" class="mc-dropdown-item {% if request.path == '/dxf-name-translator' %}active{% endif %}">
                        <i class="fas fa-language"></i>
                        DXF Name Translator
                    </a>
                    <a href="/project-relationship-manager" class="mc-dropdown-item {% if request.path == '/project-relationship-manager' %}active{% endif %}">
                        <i class="fas fa-network-wired"></i>
                        Project Relationship Manager
                    </a>
                    <div class="mc-dropdown-divider"></div>
                    <a href="/standards-export" class="mc-dropdown-item {% if request.path == '/standards-export' %}active{% endif %}">
                        <i class="fas fa-file-export"></i>
                        Export Documentation
                    </a>
                </div>
            </div>

            <div class="mc-nav-item mc-has-dropdown {% if request.path in ['/project-operations', '/projects', '/project-standards-assignment', '/project-compliance'] or request.path.startswith('/projects/') %}active{% endif %}">
                <button class="mc-nav-link" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-folder"></i>
                    <span>Projects</span>
                    <i class="fas fa-chevron-down mc-dropdown-icon"></i>
                </button>
                <div class="mc-dropdown">
                    <a href="/project-operations" class="mc-dropdown-item {% if request.path == '/project-operations' %}active{% endif %}">
                        <i class="fas fa-th-large"></i>
                        Operations Home
                    </a>
                    <a href="/projects" class="mc-dropdown-item {% if request.path == '/projects' or request.path.startswith('/projects/') %}active{% endif %}">
                        <i class="fas fa-briefcase"></i>
                        Projects
                    </a>
                    <div class="mc-dropdown-divider"></div>
                    <a href="/project-standards-assignment" class="mc-dropdown-item {% if request.path == '/project-standards-assignment' %}active{% endif %}">
                        <i class="fas fa-link"></i>
                        Assign Standards
                    </a>
                    <a href="/project-compliance" class="mc-dropdown-item {% if request.path == '/project-compliance' %}active{% endif %}">
                        <i class="fas fa-check-circle"></i>
                        Compliance Dashboard
                    </a>
                </div>
            </div>

            <div class="mc-nav-item mc-has-dropdown {% if request.path in ['/dxf-tools', '/tools/batch-point-import', '/tools/z-stress-test', '/tools/specialized-tools-directory', '/map-viewer', '/map-viewer-v2', '/sheet-notes', '/entity-viewer', '/tools/nl-query'] %}active{% endif %}">
                <button class="mc-nav-link" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-drafting-compass"></i>
                    <span>Tools</span>
                    <i class="fas fa-chevron-down mc-dropdown-icon"></i>
                </button>
                <div class="mc-dropdown">
                    <a href="/tools/nl-query" class="mc-dropdown-item {% if request.path == '/tools/nl-query' %}active{% endif %}">
                        <i class="fas fa-brain"></i>
                        <span style="background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 600;">Natural Language Query</span>
                    </a>
                    <a href="/tools/advanced-search" class="mc-dropdown-item {% if request.path == '/tools/advanced-search' %}active{% endif %}">
                        <i class="fas fa-search"></i>
                        <span>Advanced Search & Filtering</span>
                    </a>
                    <a href="/tools/batch-operations" class="mc-dropdown-item {% if request.path == '/tools/batch-operations' %}active{% endif %}">
                        <i class="fas fa-tasks"></i>
                        <span>Batch Operations</span>
                    </a>
                    <div class="mc-dropdown-divider"></div>
                    <div class="mc-dropdown-header">ðŸ“Š Analysis & Reporting</div>
                    <a href="/tools/report-builder" class="mc-dropdown-item {% if request.path == '/tools/report-builder' %}active{% endif %}">
                        <i class="fas fa-file-pdf"></i>
                        <span>Report Builder</span>
                    </a>
                    <a href="/tools/executive-dashboard" class="mc-dropdown-item {% if request.path == '/tools/executive-dashboard' %}active{% endif %}">
                        <i class="fas fa-chart-line"></i>
                        <span>Executive Dashboard</span>
                    </a>
                    <a href="/tools/validation-engine" class="mc-dropdown-item {% if request.path == '/tools/validation-engine' %}active{% endif %}">
                        <i class="fas fa-shield-check"></i>
                        <span>Validation Engine</span>
                    </a>
                    <div class="mc-dropdown-divider"></div>
                    <a href="/tools/specialized-tools-directory" class="mc-dropdown-item {% if request.path == '/tools/specialized-tools-directory' %}active{% endif %}">
                        <i class="fas fa-tools"></i>
                        Specialized Tools Directory
                    </a>
                    <div class="mc-dropdown-divider"></div>
                    <a href="/dxf-tools" class="mc-dropdown-item {% if request.path == '/dxf-tools' %}active{% endif %}">
                        <i class="fas fa-file-export"></i>
                        DXF Tools
                    </a>
                    <a href="/tools/batch-point-import" class="mc-dropdown-item {% if request.path == '/tools/batch-point-import' %}active{% endif %}">
                        <i class="fas fa-map-pin"></i>
                        Batch Point Import
                    </a>
                    <a href="/tools/z-stress-test" class="mc-dropdown-item {% if request.path == '/tools/z-stress-test' %}active{% endif %}">
                        <i class="fas fa-vial"></i>
                        Z-Value Stress Test
                    </a>
                    <a href="/map-viewer-v2" class="mc-dropdown-item {% if request.path in ['/map-viewer', '/map-viewer-v2'] %}active{% endif %}">
                        <i class="fas fa-map-marked-alt"></i>
                        Map Viewer
                    </a>
                    <a href="/entity-viewer" class="mc-dropdown-item {% if request.path == '/entity-viewer' %}active{% endif %}">
                        <i class="fas fa-eye"></i>
                        Entity Viewer
                    </a>
                    <div class="mc-dropdown-divider"></div>
                    <a href="/sheet-notes" class="mc-dropdown-item {% if request.path == '/sheet-notes' %}active{% endif %}">
                        <i class="fas fa-sticky-note"></i>
                        Sheet Notes
                    </a>
                </div>
            </div>

            <div class="mc-nav-item mc-has-dropdown {% if request.path in ['/usage-dashboard', '/quality-dashboard'] %}active{% endif %}">
                <button class="mc-nav-link" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics</span>
                    <i class="fas fa-chevron-down mc-dropdown-icon"></i>
                </button>
                <div class="mc-dropdown">
                    <a href="/usage-dashboard" class="mc-dropdown-item {% if request.path == '/usage-dashboard' %}active{% endif %}">
                        <i class="fas fa-chart-area"></i>
                        Usage Dashboard
                    </a>
                    <a href="/quality-dashboard" class="mc-dropdown-item {% if request.path == '/quality-dashboard' %}active{% endif %}">
                        <i class="fas fa-star"></i>
                        Quality Dashboard
                    </a>
                </div>
            </div>

            <div class="mc-nav-item mc-has-dropdown {% if request.path in ['/toolkit', '/graph'] %}active{% endif %}">
                <button class="mc-nav-link" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-robot"></i>
                    <span>AI</span>
                    <i class="fas fa-chevron-down mc-dropdown-icon"></i>
                </button>
                <div class="mc-dropdown">
                    <a href="/toolkit" class="mc-dropdown-item {% if request.path == '/toolkit' %}active{% endif %}">
                        <i class="fas fa-tools"></i>
                        AI Toolkit
                    </a>
                    <a href="/graph" class="mc-dropdown-item {% if request.path == '/graph' %}active{% endif %}">
                        <i class="fas fa-network-wired"></i>
                        Knowledge Graph
                    </a>
                </div>
            </div>

            <div class="mc-nav-item mc-has-dropdown {% if request.path.startswith('/schema') %}active{% endif %}">
                <button class="mc-nav-link" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-database"></i>
                    <span>Database</span>
                    <i class="fas fa-chevron-down mc-dropdown-icon"></i>
                </button>
                <div class="mc-dropdown">
                    <a href="/schema" class="mc-dropdown-item {% if request.path == '/schema' %}active{% endif %}">
                        <i class="fas fa-table"></i>
                        Schema
                    </a>
                    <a href="/schema/relationships" class="mc-dropdown-item {% if request.path == '/schema/relationships' %}active{% endif %}">
                        <i class="fas fa-project-diagram"></i>
                        Relationships
                    </a>
                    <a href="/schema/graph" class="mc-dropdown-item {% if request.path == '/schema/graph' %}active{% endif %}">
                        <i class="fas fa-brain"></i>
                        Knowledge Graph
                    </a>
                </div>
            </div>

            <div class="mc-nav-item mc-has-dropdown {% if request.path in ['/about', '/evolution', '/digital-twin', '/why-this-matters', '/architecture'] %}active{% endif %}">
                <button class="mc-nav-link" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-info-circle"></i>
                    <span>About</span>
                    <i class="fas fa-chevron-down mc-dropdown-icon"></i>
                </button>
                <div class="mc-dropdown">
                    <a href="/about" class="mc-dropdown-item {% if request.path == '/about' %}active{% endif %}">
                        <i class="fas fa-book-open"></i>
                        About ACAD-GIS
                    </a>
                    <div class="mc-dropdown-divider"></div>
                    <a href="/evolution" class="mc-dropdown-item {% if request.path == '/evolution' %}active{% endif %}">
                        <i class="fas fa-history"></i>
                        Evolution
                    </a>
                    <a href="/digital-twin" class="mc-dropdown-item {% if request.path == '/digital-twin' %}active{% endif %}">
                        <i class="fas fa-clone"></i>
                        Digital Twin
                    </a>
                    <a href="/why-this-matters" class="mc-dropdown-item {% if request.path == '/why-this-matters' %}active{% endif %}">
                        <i class="fas fa-lightbulb"></i>
                        Why This Matters
                    </a>
                    <a href="/architecture" class="mc-dropdown-item {% if request.path == '/architecture' %}active{% endif %}">
                        <i class="fas fa-sitemap"></i>
                        Architecture
                    </a>
                </div>
            </div>
        </div>
    </nav>
    </div>

    <main class="main-content" id="mainContent">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>

    <script src="{{ url_for('static', filename='js/ProjectContext.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeGlobalProjectSelector();
            
            const navbar = document.getElementById('navbar');
            const mobileToggle = document.getElementById('mobileToggle');
            const navbarMenu = document.getElementById('navbarMenu');
            const dropdownItems = document.querySelectorAll('.mc-has-dropdown');
            
            mobileToggle.addEventListener('click', function() {
                const isExpanded = navbarMenu.classList.toggle('mc-navbar-menu-open');
                mobileToggle.setAttribute('aria-expanded', isExpanded);
            });
            
            dropdownItems.forEach(function(dropdown) {
                const button = dropdown.querySelector('.mc-nav-link');
                const menu = dropdown.querySelector('.mc-dropdown');
                
                if (!button || !menu) return;
                
                button.setAttribute('aria-controls', 'dropdown-' + Array.from(dropdownItems).indexOf(dropdown));
                menu.setAttribute('id', 'dropdown-' + Array.from(dropdownItems).indexOf(dropdown));
                
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const isExpanded = dropdown.classList.toggle('mc-dropdown-open');
                    button.setAttribute('aria-expanded', isExpanded);
                    
                    dropdownItems.forEach(function(other) {
                        if (other !== dropdown && other.classList.contains('mc-dropdown-open')) {
                            other.classList.remove('mc-dropdown-open');
                            const otherButton = other.querySelector('.mc-nav-link');
                            if (otherButton) otherButton.setAttribute('aria-expanded', 'false');
                        }
                    });
                });
                
                dropdown.addEventListener('mouseenter', function() {
                    if (window.innerWidth > 768) {
                        dropdown.classList.add('mc-dropdown-open');
                        button.setAttribute('aria-expanded', 'true');
                    }
                });
                
                dropdown.addEventListener('mouseleave', function() {
                    if (window.innerWidth > 768) {
                        dropdown.classList.remove('mc-dropdown-open');
                        button.setAttribute('aria-expanded', 'false');
                    }
                });
                
                button.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && dropdown.classList.contains('mc-dropdown-open')) {
                        dropdown.classList.remove('mc-dropdown-open');
                        button.setAttribute('aria-expanded', 'false');
                        button.focus();
                    }
                });
            });
            
            document.addEventListener('click', function(e) {
                if (!navbar.contains(e.target)) {
                    dropdownItems.forEach(function(dropdown) {
                        if (dropdown.classList.contains('mc-dropdown-open')) {
                            dropdown.classList.remove('mc-dropdown-open');
                            const button = dropdown.querySelector('.mc-nav-link');
                            if (button) button.setAttribute('aria-expanded', 'false');
                        }
                    });
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    dropdownItems.forEach(function(dropdown) {
                        if (dropdown.classList.contains('mc-dropdown-open')) {
                            dropdown.classList.remove('mc-dropdown-open');
                            const button = dropdown.querySelector('.mc-nav-link');
                            if (button) {
                                button.setAttribute('aria-expanded', 'false');
                                button.focus();
                            }
                        }
                    });
                }
            });
        });

        async function checkHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                return data.status === 'connected';
            } catch {
                return false;
            }
        }

        async function deleteItem(endpoint, id, itemName) {
            if (!confirm(`Are you sure you want to delete ${itemName}?`)) {
                return;
            }

            try {
                const response = await fetch(`${endpoint}/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to delete'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function initializeGlobalProjectSelector() {
            try {
                await window.projectContext.init();
                
                const container = document.getElementById('globalProjectSelector');
                const select = document.getElementById('globalProjectSelect');
                
                const projectList = window.projectContext.getProjectList();
                const activeProject = window.projectContext.getActiveProject();
                
                select.innerHTML = '<option value="">-- Select a Project --</option>';
                
                projectList.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.project_id;
                    option.textContent = `${project.project_name}${project.project_number ? ' (' + project.project_number + ')' : ''}`;
                    select.appendChild(option);
                });
                
                if (activeProject) {
                    select.value = activeProject.project_id;
                }
                
                container.style.display = 'flex';
                
                select.addEventListener('change', async function(e) {
                    const projectId = e.target.value || null;
                    
                    try {
                        await window.projectContext.setActiveProject(projectId);
                        window.location.reload();
                    } catch (error) {
                        console.error('Error changing project:', error);
                    }
                });
            } catch (error) {
                console.error('Error initializing global project selector:', error);
            }
        }
    </script>

    {% block scripts %}{% endblock %}

    <!-- Toast Notification Container -->
    <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>
    <script>
    function showToast(message, type = 'info') {
        // type: 'success', 'error', 'warning', 'info'
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `mc-toast mc-toast-${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
        container.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }
    </script>
</body>
</html>
