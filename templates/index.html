{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-rocket"></i>
            Welcome to Schema Explorer
        </h2>
        <span id="status" class="status-offline">
            <span class="status-dot"></span>
            Checking...
        </span>
    </div>
    <div>
        <p style="color: var(--mc-muted); margin-bottom: var(--mc-spacing-lg);">
            A companion tool for viewing and managing your ACAD-GIS Supabase database.
            This tool connects directly to your database and provides real-time visibility into your data.
        </p>

        <div class="grid grid-4 mb-lg">
            <div class="stat-card">
                <div class="stat-value" id="projectCount">-</div>
                <div class="stat-label">Projects</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="drawingCount">-</div>
                <div class="stat-label">Drawings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="layerCount">-</div>
                <div class="stat-label">Layer Standards</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="blockCount">-</div>
                <div class="stat-label">Block Standards</div>
            </div>
        </div>

        <div class="grid grid-2 mb-lg">
            <div class="card">
                <h3 style="margin-bottom: var(--mc-spacing-md); color: var(--mc-accent);">
                    <i class="fas fa-clock"></i> Recent Projects
                </h3>
                <div id="recentProjects" style="color: var(--mc-muted);">
                    Loading...
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: var(--mc-spacing-md); color: var(--mc-accent);">
                    <i class="fas fa-file"></i> Recent Drawings
                </h3>
                <div id="recentDrawings" style="color: var(--mc-muted);">
                    Loading...
                </div>
            </div>
        </div>

        <div class="grid grid-2">
            <div class="card">
                <h3 style="margin-bottom: var(--mc-spacing-md); color: var(--mc-accent);">
                    <i class="fas fa-table"></i> Schema Viewer
                </h3>
                <p style="color: var(--mc-muted); margin-bottom: var(--mc-spacing-md);">
                    Explore your database structure, view table schemas, column types, and row counts.
                </p>
                <a href="/schema" class="btn btn-primary">
                    <i class="fas fa-eye"></i> View Schema
                </a>
            </div>

            <div class="card">
                <h3 style="margin-bottom: var(--mc-spacing-md); color: var(--mc-accent);">
                    <i class="fas fa-folder"></i> Projects Manager
                </h3>
                <p style="color: var(--mc-muted); margin-bottom: var(--mc-spacing-md);">
                    View and manage your projects, delete test data, and see drawing counts.
                </p>
                <a href="/projects" class="btn btn-primary">
                    <i class="fas fa-cog"></i> Manage Projects
                </a>
            </div>

            <div class="card">
                <h3 style="margin-bottom: var(--mc-spacing-md); color: var(--mc-accent);">
                    <i class="fas fa-file-image"></i> Drawings Manager
                </h3>
                <p style="color: var(--mc-muted); margin-bottom: var(--mc-spacing-md);">
                    Browse all drawings, filter by project, and clean up test drawings.
                </p>
                <a href="/drawings" class="btn btn-primary">
                    <i class="fas fa-cog"></i> Manage Drawings
                </a>
            </div>

            <div class="card">
                <h3 style="margin-bottom: var(--mc-spacing-md); color: var(--mc-accent);">
                    <i class="fas fa-ruler-combined"></i> CAD Standards Portal
                </h3>
                <p style="color: var(--mc-muted); margin-bottom: var(--mc-spacing-md);">
                    Browse your CAD standards in a human-friendly format: layers, blocks, colors, and more.
                </p>
                <div style="display: flex; gap: 0.5rem;">
                    <a href="/standards" class="btn btn-primary">
                        <i class="fas fa-book"></i> View Standards
                    </a>
                    <a href="/standards/reference" class="btn btn-secondary">
                        <i class="fas fa-layer-group"></i> Layer Reference
                    </a>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: var(--mc-spacing-md); color: var(--mc-accent);">
                    <i class="fas fa-info-circle"></i> About This Tool
                </h3>
                <p style="color: var(--mc-muted);">
                    Built as a companion to your main ACAD-GIS tool. Connects directly to Supabase
                    and auto-updates whenever you make changes elsewhere.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
    }

    async function loadStats() {
        try {
            const healthResponse = await fetch('/api/health');
            const health = await healthResponse.json();
            
            const statusEl = document.getElementById('status');
            if (health.status === 'connected') {
                statusEl.className = 'status-online';
                statusEl.innerHTML = '<span class="status-dot"></span> Connected';
            } else {
                statusEl.className = 'status-offline';
                statusEl.innerHTML = '<span class="status-dot"></span> Offline';
                return;
            }

            const activityResponse = await fetch('/api/recent-activity');
            const activity = await activityResponse.json();

            if (activity.error) {
                throw new Error(activity.error);
            }

            const stats = activity.stats || {};
            document.getElementById('projectCount').textContent = stats.total_projects || 0;
            document.getElementById('drawingCount').textContent = stats.total_drawings || 0;
            document.getElementById('layerCount').textContent = stats.total_layers || 0;
            document.getElementById('blockCount').textContent = stats.total_blocks || 0;

            const recentProjects = activity.recent_projects || [];
            const recentProjectsEl = document.getElementById('recentProjects');
            if (recentProjects.length === 0) {
                recentProjectsEl.innerHTML = '<p style="color: var(--mc-muted); font-style: italic;">No projects yet</p>';
            } else {
                recentProjectsEl.innerHTML = recentProjects.map(project => `
                    <div style="padding: var(--mc-spacing-sm) 0; border-bottom: 1px solid rgba(0, 255, 255, 0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="color: var(--mc-primary); font-weight: 500;">${project.project_name || 'Untitled'}</div>
                                <div style="font-size: 0.85rem; color: var(--mc-muted); margin-top: 4px;">
                                    ${project.client_name || 'No client'} • ${project.drawing_count || 0} drawing${project.drawing_count === 1 ? '' : 's'}
                                </div>
                            </div>
                            <div style="font-size: 0.8rem; color: var(--mc-muted); white-space: nowrap;">
                                ${formatDate(project.created_at)}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            const recentDrawings = activity.recent_drawings || [];
            const recentDrawingsEl = document.getElementById('recentDrawings');
            if (recentDrawings.length === 0) {
                recentDrawingsEl.innerHTML = '<p style="color: var(--mc-muted); font-style: italic;">No drawings yet</p>';
            } else {
                recentDrawingsEl.innerHTML = recentDrawings.map(drawing => `
                    <div style="padding: var(--mc-spacing-sm) 0; border-bottom: 1px solid rgba(0, 255, 255, 0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="color: var(--mc-primary); font-weight: 500;">${drawing.drawing_name || 'Untitled'}</div>
                                <div style="font-size: 0.85rem; color: var(--mc-muted); margin-top: 4px;">
                                    ${drawing.project_name || 'No project'} ${drawing.drawing_type ? `• ${drawing.drawing_type}` : ''}
                                </div>
                            </div>
                            <div style="font-size: 0.8rem; color: var(--mc-muted); white-space: nowrap;">
                                ${formatDate(drawing.created_at)}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

        } catch (error) {
            console.error('Error loading stats:', error);
            document.getElementById('status').className = 'status-offline';
            document.getElementById('status').innerHTML = '<span class="status-dot"></span> Error';
            document.getElementById('recentProjects').innerHTML = '<p style="color: var(--mc-danger);">Error loading data</p>';
            document.getElementById('recentDrawings').innerHTML = '<p style="color: var(--mc-danger);">Error loading data</p>';
        }
    }

    loadStats();
</script>
{% endblock %}
