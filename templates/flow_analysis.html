{% extends "base_specialized_tool.html" %}

{% block tool_title %}Flow Analysis{% endblock %}
{% block tool_icon %}fas fa-water{% endblock %}
{% block tool_description %}Analyzes storm sewer systems for detailed flow calculations similar to industry standard software{% endblock %}

{% block content_layout_class %}tool-complex-layout{% endblock %}

{% block map_navigation_links %}
<div class="map-navigation-panel">
    <a href="/project-command-center" class="map-nav-link" title="View full project overview with interactive map">
        <i class="fas fa-th-large"></i> Command Center
    </a>
    <a href="/map-viewer" class="map-nav-link" title="Access full interactive map with pan and zoom">
        <i class="fas fa-map-marked-alt"></i> Map Viewer
    </a>
</div>
{% endblock %}

{% block sidebar_content %}
<div class="tool-info-box">
    <div class="tool-name">
        <i class="fas fa-water"></i>
        <span>Flow Analysis</span>
    </div>
    <div class="tool-description">
        Detailed storm sewer flow calculations and hydraulic analysis
    </div>
</div>

<div class="tool-filter-section">
    <h4>Analysis Method</h4>
    <div class="tool-checkbox-item">
        <input type="radio" name="method" id="rational" checked onchange="updateMethod()">
        <label for="rational">Rational Method</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="radio" name="method" id="hydrograph" onchange="updateMethod()">
        <label for="hydrograph">Unit Hydrograph</label>
    </div>
</div>

<div class="tool-filter-section">
    <h4>Design Storm</h4>
    <div class="tool-filter-item">
        <label>Return Period:</label>
        <select id="returnPeriod" onchange="updateDesignStorm()">
            <option value="10">10-Year</option>
            <option value="25" selected>25-Year</option>
            <option value="50">50-Year</option>
            <option value="100">100-Year</option>
        </select>
    </div>
    <div class="tool-filter-item" style="margin-top: 0.5rem;">
        <label>Intensity (in/hr):</label>
        <input type="number" id="intensity" value="3.5" step="0.1" min="0" onchange="updateIntensity()">
    </div>
</div>

<div class="tool-stats-section">
    <h4>System Summary</h4>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total Pipes:</span>
        <span class="tool-stat-value" id="sidebarTotalPipes">0</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Peak Flow:</span>
        <span class="tool-stat-value" id="sidebarPeakFlow">0 CFS</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Avg Capacity:</span>
        <span class="tool-stat-value" id="sidebarAvgCapacity">--</span>
    </div>
</div>

<button class="tool-action-btn" onclick="runAnalysis()">
    <i class="fas fa-calculator"></i> Run Analysis
</button>
<button class="tool-action-btn secondary" onclick="exportReport()">
    <i class="fas fa-file-export"></i> Export Report
</button>
{% endblock %}

{% block main_content %}
<div class="tool-top-area">
    <div id="flowVisualContainer" style="height: 100%; width: 100%; background: #0a1929; position: relative;">
        <!-- Loading State -->
        <div id="loadingState" style="display:none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--mc-primary); margin-bottom: 1rem;"></i>
            <h3 style="color: var(--mc-text);">Running flow analysis...</h3>
        </div>

        <!-- Empty State -->
        <div id="emptyState" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <i class="fas fa-water" style="font-size: 64px; color: var(--mc-primary); opacity: 0.3; margin-bottom: 1rem;"></i>
            <h3 style="color: var(--mc-text);">Flow Network Visualization</h3>
            <p style="color: var(--mc-muted); max-width: 400px; margin: 1rem auto;">
                Load project data and run analysis to view hydraulic calculations
            </p>
        </div>

        <!-- Success State -->
        <div id="successState" style="display:none; height: 100%; width: 100%;">
            <div style="padding: 1rem; color: var(--mc-text); text-align: center; background: rgba(0,40,80,0.5);">
                <i class="fas fa-project-diagram"></i> Flow Network Map
            </div>
        </div>
    </div>
</div>

<div class="tool-resizer"></div>

<div class="tool-bottom-area">
    <div class="tool-data-tabs">
        <button class="tool-data-tab active" onclick="showTab('pipes')">
            <i class="fas fa-grip-lines"></i> Pipes (<span id="pipesTabCount">0</span>)
        </button>
        <button class="tool-data-tab" onclick="showTab('nodes')">
            <i class="fas fa-circle-notch"></i> Nodes
        </button>
        <button class="tool-data-tab" onclick="showTab('results')">
            <i class="fas fa-chart-line"></i> Results
        </button>
    </div>

    <div class="tool-data-content">
        <!-- Pipes Tab -->
        <div id="pipesTab" class="tab-content">
            <table class="tool-data-table" id="pipesTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Line #</th>
                        <th>Type</th>
                        <th>Diameter (in)</th>
                        <th>Material</th>
                        <th>Length (ft)</th>
                        <th>Slope (%)</th>
                        <th>Capacity (CFS)</th>
                        <th>Velocity (FPS)</th>
                        <th>Flow (CFS)</th>
                    </tr>
                </thead>
                <tbody id="pipesTableBody"></tbody>
            </table>
            <div id="pipesEmpty" style="text-align: center; padding: 3rem; color: var(--mc-text);">
                <i class="fas fa-inbox" style="font-size: 48px; opacity: 0.3; margin-bottom: 1rem;"></i>
                <p>No pipe flow data available</p>
                <p style="color: var(--mc-muted); font-size: 0.9rem; margin-top: 0.5rem;">
                    Load project data and run analysis
                </p>
            </div>
        </div>

        <!-- Nodes Tab -->
        <div id="nodesTab" class="tab-content" style="display:none;">
            <table class="tool-data-table" id="nodesTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Node ID</th>
                        <th>Type</th>
                        <th>Rim Elevation (ft)</th>
                        <th>Invert Elevation (ft)</th>
                        <th>HGL (ft)</th>
                        <th>EGL (ft)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="nodesTableBody"></tbody>
            </table>
            <div id="nodesEmpty" style="text-align: center; padding: 3rem; color: var(--mc-text);">
                <i class="fas fa-inbox" style="font-size: 48px; opacity: 0.3; margin-bottom: 1rem;"></i>
                <p>No node data available</p>
            </div>
        </div>

        <!-- Results Tab -->
        <div id="resultsTab" class="tab-content" style="display:none;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-label">Total System Flow</div>
                    <div class="stat-value" id="statSystemFlow">0 CFS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Capacity</div>
                    <div class="stat-value" id="statTotalCapacity">0 CFS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Velocity</div>
                    <div class="stat-value" id="statAvgVelocity">0 FPS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">System Status</div>
                    <div class="stat-value" id="statSystemStatus" style="font-size: 1.2rem;">--</div>
                </div>
            </div>

            <h4 style="color: var(--mc-accent); margin: 2rem 0 1rem 0;">
                <i class="fas fa-exclamation-triangle"></i> Warnings & Alerts
            </h4>
            <div id="warningsContainer" style="background: rgba(0,40,80,0.4); border-radius: 8px; padding: 1.5rem;">
                <p style="color: var(--mc-muted); text-align: center;">No warnings - Run analysis to check system</p>
            </div>
        </div>
    </div>
</div>

<style>
.tab-content { padding: 1rem; }
.stat-card {
    background: rgba(0,255,255,0.05);
    border: 1px solid rgba(0,255,255,0.2);
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
}
.stat-label {
    color: var(--mc-muted);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}
.stat-value {
    color: var(--mc-primary);
    font-size: 1.8rem;
    font-weight: bold;
}
</style>
{% endblock %}

{% block about_tool_description %}
<p>
    The <strong>Flow Analysis</strong> tool performs comprehensive hydraulic analysis of storm sewer systems using industry-standard
    methods including Rational Method and Unit Hydrograph approaches. Calculate hydraulic grade lines (HGL), energy grade lines (EGL),
    and verify pipe capacity for various design storms.
</p>
<p style="margin-top: 1rem;">
    Analyzes flow rates, velocities, and capacities throughout the drainage network. Identifies potential capacity issues, computes
    pressure conditions, and generates detailed hydraulic reports for engineering review and regulatory submittal.
</p>
{% endblock %}

{% block about_tool_tags %}
<span class="about-tool-tag">STORM</span>
<span class="about-tool-tag">GRAV</span>
<span class="about-tool-tag">SANIT</span>
<span class="about-tool-tag">FLOW</span>
<span class="about-tool-tag">HYDRAULICS</span>
{% endblock %}

{% block about_tool_examples %}
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-UTIL-STORM-12IN-NEW-LN</div>
    <div class="about-tool-example-desc">→ Storm drain pipe for flow analysis</div>
</div>
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-UTIL-GRAV-MH-NEW-PT</div>
    <div class="about-tool-example-desc">→ Manhole node for hydraulic calculations</div>
</div>
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-UTIL-STORM-INLET-NEW-PT</div>
    <div class="about-tool-example-desc">→ Inlet structure for runoff collection</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let pipesData = [];
let nodesData = [];

function updateMethod() {
    console.log('Analysis method updated');
}

function updateDesignStorm() {
    console.log('Design storm updated');
}

function updateIntensity() {
    console.log('Rainfall intensity updated');
}

async function runAnalysis() {
    showState('loading');

    try {
        const activeProject = window.projectContext ?
            await window.projectContext.getActiveProject() : null;

        if (!activeProject) {
            showState('empty');
            alert('No active project selected');
            return;
        }

        const response = await fetch(`/api/specialized-tools/flow-analysis?project_id=${activeProject.project_id}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();

        if (!data.success) {
            showState('empty');
            return;
        }

        pipesData = data.pipes || [];
        nodesData = data.nodes || [];

        renderPipesTable(pipesData);
        renderNodesTable(nodesData);
        renderResults(data.results);
        showState('success');

    } catch (error) {
        console.error('Error:', error);
        showState('empty');
    }
}

function renderPipesTable(pipes) {
    const tbody = document.getElementById('pipesTableBody');
    const table = document.getElementById('pipesTable');
    const emptyDiv = document.getElementById('pipesEmpty');

    if (!pipes || pipes.length === 0) {
        table.style.display = 'none';
        emptyDiv.style.display = 'block';
        return;
    }

    tbody.innerHTML = pipes.map(pipe => `
        <tr>
            <td>${pipe.line_number || 'N/A'}</td>
            <td>${pipe.line_type || 'UNKNOWN'}</td>
            <td>${pipe.diameter_in?.toFixed(1) || 'N/A'}</td>
            <td>${pipe.material || 'N/A'}</td>
            <td>${pipe.length_ft?.toFixed(1) || 'N/A'}</td>
            <td>${(pipe.slope * 100)?.toFixed(2) || 'N/A'}</td>
            <td>${pipe.capacity_cfs?.toFixed(2) || 'N/A'}</td>
            <td>${pipe.velocity_fps?.toFixed(2) || 'N/A'}</td>
            <td>${pipe.flow_cfs?.toFixed(2) || 'N/A'}</td>
        </tr>
    `).join('');

    table.style.display = 'table';
    emptyDiv.style.display = 'none';
    document.getElementById('pipesTabCount').textContent = pipes.length;
    document.getElementById('sidebarTotalPipes').textContent = pipes.length;
}

function renderNodesTable(nodes) {
    const tbody = document.getElementById('nodesTableBody');
    const table = document.getElementById('nodesTable');
    const emptyDiv = document.getElementById('nodesEmpty');

    if (!nodes || nodes.length === 0) {
        table.style.display = 'none';
        emptyDiv.style.display = 'block';
        return;
    }

    tbody.innerHTML = nodes.map(node => `
        <tr>
            <td>${node.node_id?.substring(0, 8) || 'N/A'}</td>
            <td>${node.node_type || 'UNKNOWN'}</td>
            <td>${node.rim_elev?.toFixed(2) || 'N/A'}</td>
            <td>${node.invert_elev?.toFixed(2) || 'N/A'}</td>
            <td>${node.hgl?.toFixed(2) || 'N/A'}</td>
            <td>${node.egl?.toFixed(2) || 'N/A'}</td>
            <td>${node.status || 'OK'}</td>
        </tr>
    `).join('');

    table.style.display = 'table';
    emptyDiv.style.display = 'none';
}

function renderResults(results) {
    if (!results) return;

    document.getElementById('statSystemFlow').textContent = `${results.total_flow_cfs?.toFixed(2) || 0} CFS`;
    document.getElementById('statTotalCapacity').textContent = `${results.total_capacity_cfs?.toFixed(2) || 0} CFS`;
    document.getElementById('statAvgVelocity').textContent = `${results.avg_velocity_fps?.toFixed(2) || 0} FPS`;
    document.getElementById('statSystemStatus').textContent = results.system_status || 'OK';
}

function showState(state) {
    document.getElementById('loadingState').style.display = state === 'loading' ? 'block' : 'none';
    document.getElementById('emptyState').style.display = state === 'empty' ? 'block' : 'none';
    document.getElementById('successState').style.display = state === 'success' ? 'block' : 'none';
}

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
    document.querySelectorAll('.tool-data-tab').forEach(btn => btn.classList.remove('active'));

    const selectedTab = document.getElementById(tabName + 'Tab');
    if (selectedTab) selectedTab.style.display = 'block';

    event.target.closest('.tool-data-tab').classList.add('active');
}

function exportReport() {
    console.log('Exporting flow analysis report...');
    alert('Flow analysis report export functionality will be implemented here');
}

document.addEventListener('DOMContentLoaded', async function() {
    if (window.projectContext) {
        await window.projectContext.init();
        window.projectContext.subscribe(() => runAnalysis());
    }
});
</script>
{% endblock %}
