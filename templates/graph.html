{% extends "base.html" %}

{% block title %}Knowledge Graph{% endblock %}

{% block content %}
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<style>
    #graphViz {
        width: 100%;
        height: 600px;
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: var(--radius-lg);
        background: rgba(15, 23, 42, 0.5);
    }

    .graph-controls {
        display: flex;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
    }

    .filter-group label {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm) var(--spacing-md);
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all var(--transition-base);
        font-size: 0.875rem;
    }

    .filter-group label:hover {
        background: rgba(59, 130, 246, 0.2);
    }

    .filter-group input[type="checkbox"] {
        cursor: pointer;
    }

    .spatial-indicator {
        width: 12px;
        height: 12px;
        background: #4169e1;
        border-radius: 2px;
        display: inline-block;
    }

    .semantic-indicator {
        width: 12px;
        height: 12px;
        background: #10b981;
        border-radius: 2px;
        display: inline-block;
    }

    .engineering-indicator {
        width: 12px;
        height: 12px;
        background: #f59e0b;
        border-radius: 2px;
        display: inline-block;
    }

    .detail-panel {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        margin-top: var(--spacing-lg);
        display: none;
    }

    .detail-panel h3 {
        color: var(--color-accent-cyan);
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }

    .detail-item {
        background: rgba(59, 130, 246, 0.1);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        border-left: 3px solid var(--color-accent-blue);
    }

    .detail-label {
        color: var(--color-text-secondary);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: var(--spacing-xs);
    }

    .detail-value {
        color: var(--color-text-primary);
        font-weight: 600;
    }

    .relationship-list {
        background: rgba(59, 130, 246, 0.05);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        max-height: 300px;
        overflow-y: auto;
    }

    .relationship-item {
        padding: var(--spacing-sm);
        border-left: 3px solid;
        margin-bottom: var(--spacing-sm);
        background: rgba(15, 23, 42, 0.6);
        border-radius: var(--radius-sm);
    }

    .relationship-item.spatial {
        border-left-color: #4169e1;
    }

    .relationship-item.semantic {
        border-left-color: #10b981;
    }

    .relationship-item.engineering {
        border-left-color: #f59e0b;
    }

    .empty-state {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--color-text-secondary);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: var(--spacing-md);
        color: var(--color-accent-blue);
        opacity: 0.5;
    }
</style>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-project-diagram"></i>
            Knowledge Graph Visualization
        </h2>
        <button onclick="loadGraph()" class="btn btn-ghost">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>

    <div class="graph-controls">
        <div class="filter-group">
            <label>
                <input type="checkbox" id="filterSpatial" checked onchange="updateGraph()">
                <span class="spatial-indicator"></span>
                Spatial
            </label>
            <label>
                <input type="checkbox" id="filterSemantic" checked onchange="updateGraph()">
                <span class="semantic-indicator"></span>
                Semantic
            </label>
            <label>
                <input type="checkbox" id="filterEngineering" checked onchange="updateGraph()">
                <span class="engineering-indicator"></span>
                Engineering
            </label>
        </div>
        <button class="btn btn-ghost" onclick="network && network.fit()">
            <i class="fas fa-expand"></i> Fit to View
        </button>
    </div>

    <div id="graphViz"></div>

    <div id="detailPanel" class="detail-panel">
        <h3><i class="fas fa-info-circle"></i> Entity Details</h3>
        <div id="detailContent"></div>
    </div>
</div>

<script>
    let network = null;
    let allNodes = [];
    let allEdges = [];

    async function loadGraph() {
        try {
            const response = await fetch('/api/toolkit/graph/data');
            const data = await response.json();

            if (!data.success) {
                showError(data.error);
                return;
            }

            allNodes = data.nodes || [];
            allEdges = data.edges || [];

            if (allNodes.length === 0) {
                showEmptyState();
                return;
            }

            updateGraph();
        } catch (error) {
            console.error('Error loading graph:', error);
            showError(error.message);
        }
    }

    function updateGraph() {
        const spatialEnabled = document.getElementById('filterSpatial').checked;
        const semanticEnabled = document.getElementById('filterSemantic').checked;
        const engineeringEnabled = document.getElementById('filterEngineering').checked;

        const filteredEdges = allEdges.filter(edge => {
            if (edge.category === 'spatial' && !spatialEnabled) return false;
            if (edge.category === 'semantic' && !semanticEnabled) return false;
            if (edge.category === 'engineering' && !engineeringEnabled) return false;
            return true;
        });

        const connectedNodeIds = new Set();
        filteredEdges.forEach(edge => {
            connectedNodeIds.add(edge.from);
            connectedNodeIds.add(edge.to);
        });

        const filteredNodes = allNodes.filter(node => connectedNodeIds.has(node.id));

        const nodes = new vis.DataSet(filteredNodes);
        const edges = new vis.DataSet(filteredEdges);

        const container = document.getElementById('graphViz');
        const graphData = { nodes, edges };

        const options = {
            nodes: {
                shape: 'dot',
                size: 16,
                font: {
                    size: 12,
                    color: '#e0e7ff'
                },
                borderWidth: 2,
                shadow: true
            },
            edges: {
                width: 2,
                shadow: true,
                smooth: {
                    type: 'continuous'
                }
            },
            physics: {
                stabilization: true,
                barnesHut: {
                    gravitationalConstant: -8000,
                    springConstant: 0.04,
                    springLength: 95
                }
            },
            interaction: {
                hover: true,
                tooltipDelay: 200
            }
        };

        if (network) {
            network.destroy();
        }

        network = new vis.Network(container, graphData, options);

        network.on('click', function(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                showNodeDetails(nodeId);
            }
        });
    }

    async function showNodeDetails(nodeId) {
        try {
            const response = await fetch('/api/toolkit/graph/data');
            const data = await response.json();

            const node = data.nodes.find(n => n.id === nodeId);
            if (!node) return;

            const relationships = data.edges.filter(e => e.from === nodeId || e.to === nodeId);

            let html = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Entity ID</div>
                        <div class="detail-value">${node.id}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Entity Type</div>
                        <div class="detail-value">${node.entity_type}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Quality Score</div>
                        <div class="detail-value">${node.quality_score || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Has Embedding</div>
                        <div class="detail-value">${node.has_embedding ? 'Yes' : 'No'}</div>
                    </div>
                </div>
            `;

            if (relationships.length > 0) {
                html += '<h4 style="margin-top: var(--spacing-lg); margin-bottom: var(--spacing-md); color: var(--color-accent-cyan);">Relationships</h4>';
                html += '<div class="relationship-list">';
                relationships.forEach(rel => {
                    const otherNodeId = rel.from === nodeId ? rel.to : rel.from;
                    const direction = rel.from === nodeId ? '→' : '←';
                    html += `
                        <div class="relationship-item ${rel.category}">
                            <strong>${rel.type}</strong> ${direction} ${otherNodeId}
                            <br><small style="color: var(--color-text-secondary);">${rel.category}</small>
                        </div>
                    `;
                });
                html += '</div>';
            }

            document.getElementById('detailContent').innerHTML = html;
            document.getElementById('detailPanel').style.display = 'block';

        } catch (error) {
            console.error('Error loading node details:', error);
        }
    }

    function showEmptyState() {
        document.getElementById('graphViz').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-project-diagram"></i>
                <p>No entities or relationships found in the database yet.</p>
                <p style="font-size: 0.875rem; margin-top: var(--spacing-sm);">
                    Use the AI Toolkit to import data and generate relationships.
                </p>
            </div>
        `;
    }

    function showError(message) {
        document.getElementById('graphViz').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle" style="color: var(--color-accent-red);"></i>
                <p>Error loading graph: ${message}</p>
            </div>
        `;
    }

    window.addEventListener('load', loadGraph);
</script>
{% endblock %}
