<!DOCTYPE html>
<html>
<head>
    <title>Map Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #001428;
            color: white;
        }
        
        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }
        
        .sidebar {
            width: 300px;
            background: #002040;
            border-right: 3px solid #00ffff;
            padding: 20px;
            overflow-y: auto;
        }
        
        .map-area {
            flex: 1;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .section {
            background: #003060;
            border: 1px solid #0080ff;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .section h3 {
            color: #00ffff;
            font-size: 13px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: #0066cc;
            border: 1px solid #0080ff;
            color: white;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }
        
        button:hover { background: #0088ff; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        button.active { background: #00ffff; color: #000; }
        
        input, select {
            width: 100%;
            padding: 8px;
            background: #001428;
            border: 1px solid #0080ff;
            color: white;
            border-radius: 3px;
            margin-bottom: 10px;
        }
        
        .coord-display {
            background: #001428;
            border: 1px solid #0080ff;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2 style="color: #00ffff; margin-bottom: 20px;">Map Viewer</h2>
            
            <div class="section">
                <h3><i class="fas fa-map"></i> Basemap</h3>
                <select id="basemap-select" onchange="changeBasemap(this.value)">
                    <option value="osm">OpenStreetMap</option>
                    <option value="topo">USGS Topo</option>
                    <option value="imagery">ESRI Imagery</option>
                </select>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-search"></i> Search</h3>
                <input type="text" id="search-input" placeholder="Address in Sonoma County"
                       onkeypress="if(event.key==='Enter') searchAddress()">
                <button onclick="searchAddress()"><i class="fas fa-search"></i> Search</button>
                <div id="search-status"></div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-ruler"></i> Measurements</h3>
                <button id="btn-distance" onclick="measureDistance()">
                    <i class="fas fa-ruler-horizontal"></i> Distance
                </button>
                <button id="btn-area" onclick="measureArea()">
                    <i class="fas fa-draw-polygon"></i> Area
                </button>
                <button onclick="clearMeasurements()">
                    <i class="fas fa-trash"></i> Clear
                </button>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-file-export"></i> Export</h3>
                <button id="export-btn" onclick="openExportModal()" disabled>
                    <i class="fas fa-download"></i> Create Export
                </button>
                <small style="color: #888;">Draw rectangle on map first</small>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-crosshairs"></i> Coordinates</h3>
                <div class="coord-display" id="coords">
                    Move mouse over map...
                </div>
            </div>
        </div>
        
        <div class="map-area">
            <div id="map"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    
    <script>
        let map, basemaps, drawnItems;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing simple map...');
            
            // Define State Plane projection
            proj4.defs("EPSG:2226", "+proj=lcc +lat_1=39.83333333333334 +lat_2=38.33333333333334 +lat_0=37.66666666666666 +lon_0=-122 +x_0=2000000.0001016 +y_0=500000.0001016001 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048006096012192 +no_defs");
            
            // Create map
            map = L.map('map').setView([38.5, -122.8], 10);
            
            // Basemaps
            basemaps = {
                osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap',
                    maxZoom: 19
                }),
                topo: L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'USGS',
                    maxZoom: 16
                }),
                imagery: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'ESRI',
                    maxZoom: 19
                })
            };
            
            basemaps.osm.addTo(map);
            
            // Drawing layer
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // Draw controls
            const drawControl = new L.Control.Draw({
                position: 'topright',
                draw: {
                    rectangle: true,
                    polygon: false,
                    polyline: false,
                    circle: false,
                    marker: false,
                    circlemarker: false
                },
                edit: {
                    featureGroup: drawnItems
                }
            });
            map.addControl(drawControl);
            
            // Draw events
            map.on('draw:created', function(e) {
                drawnItems.clearLayers();
                drawnItems.addLayer(e.layer);
                document.getElementById('export-btn').disabled = false;
                console.log('Rectangle drawn');
            });
            
            // Coordinate display
            map.on('mousemove', function(e) {
                const [x, y] = proj4('EPSG:4326', 'EPSG:2226', [e.latlng.lng, e.latlng.lat]);
                document.getElementById('coords').innerHTML = `
                    Lat/Lng: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}<br>
                    State Plane: ${x.toFixed(2)}, ${y.toFixed(2)} ft
                `;
            });
            
            console.log('Map initialized!');
            setTimeout(() => {
                map.invalidateSize();
                console.log('Map tiles should be visible now');
            }, 100);
        });
        
        function changeBasemap(id) {
            Object.values(basemaps).forEach(l => map.removeLayer(l));
            basemaps[id].addTo(map);
        }
        
        async function searchAddress() {
            const addr = document.getElementById('search-input').value;
            const status = document.getElementById('search-status');
            if (!addr) return;
            
            status.innerHTML = 'Searching...';
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr + ', Sonoma County, CA')}`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.length > 0) {
                    map.setView([parseFloat(data[0].lat), parseFloat(data[0].lon)], 16);
                    L.marker([parseFloat(data[0].lat), parseFloat(data[0].lon)])
                        .addTo(map)
                        .bindPopup(data[0].display_name)
                        .openPopup();
                    status.innerHTML = '<span style="color: #0f0;">Found!</span>';
                } else {
                    status.innerHTML = '<span style="color: #f00;">Not found</span>';
                }
            } catch (e) {
                status.innerHTML = '<span style="color: #f00;">Error</span>';
            }
        }
        
        function measureDistance() {
            alert('Click points on map to measure. Double-click to finish.');
        }
        
        function measureArea() {
            alert('Click points to draw polygon. Double-click to finish.');
        }
        
        function clearMeasurements() {
            console.log('Clear measurements');
        }
        
        function openExportModal() {
            alert('Export functionality will open a modal here');
        }
    </script>
</body>
</html>
