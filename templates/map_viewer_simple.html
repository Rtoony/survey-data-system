<!DOCTYPE html>
<!-- Version: {{ cache_bust }} -->
<html>
<head>
    <title>Map Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #001428;
            color: white;
        }
        
        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }
        
        .sidebar {
            width: 300px;
            background: #002040;
            border-right: 3px solid #00ffff;
            padding: 20px;
            overflow-y: auto;
        }
        
        .map-area {
            flex: 1;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .section {
            background: #003060;
            border: 1px solid #0080ff;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .section h3 {
            color: #00ffff;
            font-size: 13px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: #0066cc;
            border: 1px solid #0080ff;
            color: white;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }
        
        button:hover { background: #0088ff; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        button.active { background: #00ffff; color: #000; }
        button.warning { background: #ff9900; color: #000; border-color: #ffaa00; }
        button.error { background: #ff3333; color: #fff; border-color: #ff0000; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            background: #001428;
            border: 1px solid #0080ff;
            color: white;
            border-radius: 3px;
            margin-bottom: 10px;
        }
        
        .coord-display {
            background: #001428;
            border: 1px solid #0080ff;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
        }
        
        .project-info {
            background: #001a33;
            border: 2px solid #00ffff;
            padding: 12px;
            border-radius: 5px;
            font-size: 11px;
            line-height: 1.6;
        }
        
        .project-info strong {
            color: #00ffff;
            display: block;
            margin-bottom: 2px;
        }
        
        .project-info .value {
            color: #fff;
            margin-bottom: 8px;
        }
        
        .coming-soon {
            color: #888;
            font-size: 10px;
            font-style: italic;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #002040;
            border: 3px solid #00ffff;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content h2 {
            color: #00ffff;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .format-section {
            background: #003060;
            border: 1px solid #0080ff;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .format-section h4 {
            color: #00ffff;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .checkbox-group {
            margin-bottom: 10px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            padding: 8px;
            border-radius: 3px;
        }
        
        .checkbox-group label:hover {
            background: rgba(0, 255, 255, 0.1);
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            margin-bottom: 0;
            cursor: pointer;
        }
        
        .format-description {
            color: #aaa;
            font-size: 11px;
            margin-left: 28px;
            margin-top: -5px;
            margin-bottom: 10px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            flex: 1;
        }
        
        /* Accordion styles for drawings */
        .drawing-item {
            margin-bottom: 8px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .drawing-header {
            background: rgba(0, 255, 255, 0.1);
            padding: 8px 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .drawing-header:hover {
            background: rgba(0, 255, 255, 0.2);
        }
        
        .drawing-title {
            font-weight: bold;
            color: #00ffff;
            font-size: 12px;
        }
        
        .drawing-count {
            color: #888;
            font-size: 10px;
        }
        
        .drawing-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 10px;
        }
        
        .drawing-content.open {
            max-height: 500px;
            padding: 10px;
        }
        
        .entity-type-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
            font-size: 11px;
        }
        
        .entity-type-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .entity-type-label {
            flex: 1;
            cursor: pointer;
        }
        
        .entity-type-count {
            color: #888;
            font-size: 10px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2 style="color: #00ffff; margin-bottom: 20px;">Map Viewer</h2>
            
            <div class="section">
                <h3><i class="fas fa-map-marked-alt"></i> Project Location</h3>
                <div class="project-info">
                    <strong>State Plane Zone</strong>
                    <div class="value">CA Zone 2 (EPSG:2226)</div>
                    
                    <strong>County</strong>
                    <div class="value">Sonoma County</div>
                    
                    <strong>Units</strong>
                    <div class="value">US Survey Feet</div>
                    
                    <div class="coming-soon">
                        <i class="fas fa-lock"></i> Zone/County selection coming soon
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-map"></i> Basemap</h3>
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" id="basemap-toggle" checked onchange="toggleBasemap()" 
                           style="margin-right: 8px;">
                    <span>Show Basemap</span>
                </label>
                <select id="basemap-select" onchange="changeBasemap(this.value)">
                    <option value="osm">OpenStreetMap</option>
                    <option value="topo">USGS Topo</option>
                    <option value="imagery">ESRI Imagery</option>
                </select>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-folder-open"></i> Project Viewer</h3>
                
                <!-- Project Selector -->
                <label style="color: #aaa; font-size: 11px; margin-bottom: 5px; display: block;">Select Project:</label>
                <select id="project-select" onchange="selectProject(this.value)" style="margin-bottom: 10px; width: 100%;">
                    <option value="">Loading projects...</option>
                </select>
                
                <!-- Zoom to Project Button -->
                <button id="btn-zoom-project" onclick="zoomToProject()" disabled style="margin-bottom: 10px; width: 100%;">
                    <i class="fas fa-search-location"></i> Zoom to Project
                </button>
                
                <!-- Project Areas Toggle -->
                <div style="margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                    <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="show-project-areas" onchange="toggleProjectAreas(this.checked)" style="margin-right: 8px;">
                        <span style="color: #aaa; font-size: 11px;">Show Project Areas</span>
                    </label>
                </div>
                
                <!-- Drawings Container -->
                <div id="drawings-container" style="font-size: 11px; max-height: 300px; overflow-y: auto;">
                    <div style="color: #888; text-align: center; padding: 10px;">
                        Select a project to view drawings
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-layer-group"></i> Sonoma County Layers</h3>
                <div id="gis-layers-container" style="font-size: 11px; max-height: 150px; overflow-y: auto;">
                    Loading layers...
                </div>
                <div id="gis-status" style="color: #888; font-size: 10px; margin-top: 5px;">
                    Ready to load layers
                </div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-search"></i> Search</h3>
                <input type="text" id="search-input" placeholder="Address in Sonoma County"
                       onkeypress="if(event.key==='Enter') searchAddress()">
                <button onclick="searchAddress()"><i class="fas fa-search"></i> Search</button>
                <div id="search-status"></div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-ruler"></i> Measurements</h3>
                <button id="btn-distance" onclick="measureDistance()">
                    <i class="fas fa-ruler-horizontal"></i> Distance
                </button>
                <button id="btn-area" onclick="measureArea()">
                    <i class="fas fa-draw-polygon"></i> Area
                </button>
                <button onclick="clearMeasurements()">
                    <i class="fas fa-trash"></i> Clear
                </button>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-file-export"></i> Export</h3>
                <button id="draw-rect-btn" onclick="startDrawingRectangle()">
                    <i class="fas fa-vector-square"></i> Draw Rectangle
                </button>
                <button id="export-btn" onclick="openExportModal()" disabled>
                    <i class="fas fa-download"></i> Create Export
                </button>
                <small style="color: #888;">Step 1: Draw, Step 2: Export</small>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-crosshairs"></i> Coordinates</h3>
                <div class="coord-display" id="coords">
                    Move mouse over map...
                </div>
            </div>
        </div>
        
        <div class="map-area">
            <div id="map"></div>
        </div>
    </div>
    
    <!-- Export Format Selection Modal -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-file-export"></i> Export Map Data</h2>
            
            <div class="format-section">
                <h4>Select Export Formats</h4>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="format-png" checked>
                        <span><i class="fas fa-image"></i> PNG Image</span>
                    </label>
                    <div class="format-description">Map image with optional north arrow and scale bar</div>
                </div>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="format-shp" checked>
                        <span><i class="fas fa-file-archive"></i> Shapefile (.shp)</span>
                    </label>
                    <div class="format-description">Standard GIS format compatible with ArcGIS, QGIS</div>
                </div>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="format-dxf">
                        <span><i class="fas fa-file-code"></i> DXF (.dxf)</span>
                    </label>
                    <div class="format-description">AutoCAD Drawing Exchange Format</div>
                </div>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="format-kml">
                        <span><i class="fas fa-globe"></i> KML (.kml)</span>
                    </label>
                    <div class="format-description">Google Earth / Google Maps format</div>
                </div>
            </div>
            
            <div class="format-section" id="png-options-section">
                <h4>PNG Options</h4>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="png-north-arrow" checked>
                        <span><i class="fas fa-compass"></i> North Arrow</span>
                    </label>
                </div>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="png-scale-bar" checked>
                        <span><i class="fas fa-ruler-horizontal"></i> Scale Bar</span>
                    </label>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button onclick="closeExportModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button onclick="startExport()" style="background: #00cc66;">
                    <i class="fas fa-download"></i> Create Export
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    
    <script>
        let map, basemaps, drawnItems, measureLayer, measureMode, measurePoints;
        
        // Project Viewer global variables
        let projectsData = [];
        let selectedProject = null;
        let activeEntityLayers = {};
        let projectAreasLayer = null;
        
        // GIS Layers global variables
        let gisLayersData = [];
        let activeGISLayers = {};
        let projectsLayer = null;
        let projectsVisible = true;
        let projectColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#95afc0', '#c56cf0', '#ffbe76'];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing simple map...');
            
            // Define State Plane projection
            proj4.defs("EPSG:2226", "+proj=lcc +lat_1=39.83333333333334 +lat_2=38.33333333333334 +lat_0=37.66666666666666 +lon_0=-122 +x_0=2000000.0001016 +y_0=500000.0001016001 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048006096012192 +no_defs");
            
            // Create map
            map = L.map('map', {
                zoomDelta: 0.25,  // Finer zoom control (default is 1)
                zoomSnap: 0.25,   // Allows fractional zoom levels
                wheelPxPerZoomLevel: 120,  // Slower scroll zoom (default is 60)
                boxZoom: true  // Enable shift+drag zoom box (default is true, explicit for clarity)
            }).setView([38.5, -122.8], 10);
            
            // Initialize measurement variables
            measureMode = null;
            measurePoints = [];
            measureLayer = new L.FeatureGroup().addTo(map);
            
            // Basemaps
            basemaps = {
                osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap',
                    maxZoom: 22,  // Increased for CAD detail viewing
                    maxNativeZoom: 19  // OSM only has tiles up to 19, but we can overzoom
                }),
                topo: L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'USGS',
                    maxZoom: 22,
                    maxNativeZoom: 16
                }),
                imagery: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'ESRI',
                    maxZoom: 22,
                    maxNativeZoom: 19
                })
            };
            
            currentBasemap = basemaps.osm;
            currentBasemap.addTo(map);
            
            // Drawing layer
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // Draw controls
            console.log('Creating draw control...');
            try {
                const drawControl = new L.Control.Draw({
                    position: 'topright',
                    draw: {
                        rectangle: true,
                        polygon: false,
                        polyline: false,
                        circle: false,
                        marker: false,
                        circlemarker: false
                    },
                    edit: {
                        featureGroup: drawnItems
                    }
                });
                map.addControl(drawControl);
                console.log('Draw control added successfully');
            } catch(err) {
                console.error('Error creating draw control:', err);
            }
            
            // Draw events
            map.on('draw:created', function(e) {
                drawnItems.clearLayers();
                drawnItems.addLayer(e.layer);
                
                // Calculate area for validation
                const bounds = e.layer.getBounds();
                const sw = bounds.getSouthWest();
                const ne = bounds.getNorthEast();
                
                // Convert to State Plane (EPSG:2226) for accurate area calculation
                const [swX, swY] = proj4('EPSG:4326', 'EPSG:2226', [sw.lng, sw.lat]);
                const [neX, neY] = proj4('EPSG:4326', 'EPSG:2226', [ne.lng, ne.lat]);
                
                // Calculate area in square feet
                const widthFt = Math.abs(neX - swX);
                const heightFt = Math.abs(neY - swY);
                const areaSqFt = widthFt * heightFt;
                const acres = areaSqFt / 43560;
                
                // Maximum area: 2,000,000 sq ft (~46 acres)
                const MAX_AREA_SQ_FT = 2000000;
                const warningThreshold = MAX_AREA_SQ_FT * 0.8; // Warn at 80%
                
                let buttonHTML = '<i class="fas fa-check-circle"></i> Rectangle Drawn';
                let buttonClass = 'active';
                let exportDisabled = false;
                
                if (areaSqFt > MAX_AREA_SQ_FT) {
                    // Area too large - prevent export
                    buttonHTML = `<i class="fas fa-exclamation-triangle"></i> Area Too Large (${acres.toFixed(1)} ac)`;
                    buttonClass = 'error';
                    exportDisabled = true;
                    alert(`⚠️ Export Area Too Large!\n\nYour selection is ${acres.toFixed(1)} acres (${areaSqFt.toLocaleString()} sq ft).\n\nMaximum allowed: 46 acres (2,000,000 sq ft)\n\nPlease draw a smaller rectangle.`);
                } else if (areaSqFt > warningThreshold) {
                    // Close to limit - show warning
                    buttonHTML = `<i class="fas fa-exclamation-circle"></i> Large Area (${acres.toFixed(1)} ac)`;
                    buttonClass = 'warning';
                    const percent = ((areaSqFt / MAX_AREA_SQ_FT) * 100).toFixed(0);
                    console.warn(`Area is ${percent}% of maximum allowed`);
                } else {
                    // Normal size - show area
                    if (acres >= 0.1) {
                        buttonHTML = `<i class="fas fa-check-circle"></i> ${acres.toFixed(2)} acres`;
                    } else {
                        buttonHTML = `<i class="fas fa-check-circle"></i> ${Math.round(areaSqFt).toLocaleString()} sq ft`;
                    }
                }
                
                document.getElementById('export-btn').disabled = exportDisabled;
                document.getElementById('draw-rect-btn').innerHTML = buttonHTML;
                document.getElementById('draw-rect-btn').className = buttonClass;
                console.log(`Rectangle drawn: ${areaSqFt.toLocaleString()} sq ft (${acres.toFixed(2)} acres)`);
            });
            
            map.on('draw:drawstart', function(e) {
                console.log('Drawing started');
            });
            
            // Coordinate display
            map.on('mousemove', function(e) {
                const [x, y] = proj4('EPSG:4326', 'EPSG:2226', [e.latlng.lng, e.latlng.lat]);
                document.getElementById('coords').innerHTML = `
                    Lat/Lng: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}<br>
                    State Plane: ${x.toFixed(2)}, ${y.toFixed(2)} ft
                `;
            });
            
            // Measurement click handler
            map.on('click', function(e) {
                if (!measureMode) return;
                
                measurePoints.push(e.latlng);
                
                if (measureMode === 'distance' && measurePoints.length > 1) {
                    const line = turf.lineString(measurePoints.map(p => [p.lng, p.lat]));
                    const meters = turf.length(line, {units: 'meters'});
                    const feet = meters * 3.28084;
                    const miles = feet / 5280;
                    const label = miles > 0.1 ? `${miles.toFixed(2)} mi` : `${feet.toFixed(0)} ft`;
                    
                    L.polyline(measurePoints, {color: '#00ff00', weight: 3})
                        .addTo(measureLayer)
                        .bindPopup(label)
                        .openPopup();
                }
                
                if (measureMode === 'area' && measurePoints.length >= 3) {
                    const coords = measurePoints.map(p => [p.lng, p.lat]);
                    coords.push(coords[0]);
                    const poly = turf.polygon([coords]);
                    const sqm = turf.area(poly);
                    const sqft = sqm * 10.7639;
                    const acres = sqft / 43560;
                    const label = acres > 0.1 ? `${acres.toFixed(2)} acres` : `${sqft.toFixed(0)} sq ft`;
                    
                    L.polygon(measurePoints, {color: '#00ff00', fillOpacity: 0.2})
                        .addTo(measureLayer)
                        .bindPopup(label)
                        .openPopup();
                }
            });
            
            map.on('dblclick', function() {
                if (measureMode) {
                    setTimeout(clearMeasurements, 100);
                }
            });
            
            // Load data
            loadProjectStructure();
            loadGISLayers();
            
            console.log('Map initialized!');
            setTimeout(() => {
                map.invalidateSize();
                console.log('Map tiles should be visible now');
            }, 100);
        });
        
        async function loadGISLayers() {
            try {
                const res = await fetch('/api/map-viewer/layers');
                const data = await res.json();
                gisLayersData = data.layers || [];
                
                const container = document.getElementById('gis-layers-container');
                if (gisLayersData.length === 0) {
                    container.innerHTML = '<div style="color: #888;">No layers available</div>';
                    return;
                }
                
                container.innerHTML = gisLayersData
                    .filter(layer => layer.enabled)
                    .map(layer => `
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="layer-${layer.id}" 
                                   style="margin: 0; margin-right: 8px; flex-shrink: 0;"
                                   onchange="toggleLayerSelection('${layer.id}', this.checked)">
                            <span id="label-${layer.id}">${layer.name}</span>
                        </label>
                    `).join('');
                
            } catch (error) {
                console.error('Error loading GIS layers:', error);
                document.getElementById('gis-layers-container').innerHTML = 
                    '<div style="color: #ff4444;">Error loading layers</div>';
            }
        }
        
        
        async function toggleLayerSelection(layerId, checked) {
            console.log(`Layer ${layerId} ${checked ? 'loading...' : 'removing...'}`);
            
            const label = document.getElementById(`label-${layerId}`);
            
            if (checked) {
                // Load and display the layer
                label.innerHTML = label.textContent + ' <i class="fas fa-spinner fa-spin"></i>';
                await loadGISLayer(layerId);
            } else {
                // Remove the layer from map
                if (activeGISLayers[layerId]) {
                    map.removeLayer(activeGISLayers[layerId]);
                    delete activeGISLayers[layerId];
                    console.log(`Layer ${layerId} removed from map`);
                }
            }
        }
        
        // Professional GIS layer color schemes (industry standard)
        function getLayerStyle(layerId) {
            const styles = {
                // Parcels - Red/Orange (property boundaries)
                'sonoma_parcels_public': {
                    color: '#FF5733',
                    weight: 2,
                    fillColor: '#FF5733',
                    fillOpacity: 0.05,
                    pointColor: '#FF5733'
                },
                // Buildings - Dark Gray (structures)
                'sonoma_buildings': {
                    color: '#333333',
                    weight: 1,
                    fillColor: '#555555',
                    fillOpacity: 0.4,
                    pointColor: '#333333'
                },
                // Administrative Boundaries - Purple
                'sonoma_city_limits': {
                    color: '#9B59B6',
                    weight: 3,
                    fillColor: '#9B59B6',
                    fillOpacity: 0.05,
                    dashArray: '10, 5',
                    pointColor: '#9B59B6'
                },
                'sonoma_county_boundary': {
                    color: '#8E44AD',
                    weight: 4,
                    fillColor: '#8E44AD',
                    fillOpacity: 0.02,
                    dashArray: '15, 10',
                    pointColor: '#8E44AD'
                },
                'sonoma_fire_districts': {
                    color: '#C0392B',
                    weight: 2,
                    fillColor: '#E74C3C',
                    fillOpacity: 0.1,
                    dashArray: '5, 5',
                    pointColor: '#C0392B'
                },
                'sonoma_school_districts': {
                    color: '#2980B9',
                    weight: 2,
                    fillColor: '#3498DB',
                    fillOpacity: 0.08,
                    dashArray: '8, 4',
                    pointColor: '#2980B9'
                },
                // Water/Drainage - Blue
                'sonoma_drainage_lines': {
                    color: '#0066CC',
                    weight: 2,
                    fillColor: '#0066CC',
                    fillOpacity: 0.3,
                    pointColor: '#0066CC'
                },
                'sonoma_drainage_points': {
                    color: '#0066CC',
                    weight: 1,
                    fillColor: '#0066CC',
                    fillOpacity: 0.7,
                    pointColor: '#0066CC'
                },
                // Parks/Recreation - Green
                'sonoma_parks_boundaries': {
                    color: '#27AE60',
                    weight: 2,
                    fillColor: '#2ECC71',
                    fillOpacity: 0.15,
                    pointColor: '#27AE60'
                },
                'sonoma_parks_trails': {
                    color: '#16A085',
                    weight: 3,
                    fillColor: '#16A085',
                    fillOpacity: 0.5,
                    pointColor: '#16A085'
                },
                // Schools - Orange (points)
                'sonoma_schools': {
                    color: '#E67E22',
                    weight: 1,
                    fillColor: '#E67E22',
                    fillOpacity: 0.8,
                    pointColor: '#E67E22'
                }
            };
            
            // Default style if layer not found
            return styles[layerId] || {
                color: '#0080ff',
                weight: 2,
                fillColor: '#0080ff',
                fillOpacity: 0.1,
                pointColor: '#0080ff'
            };
        }
        
        
        async function loadGISLayer(layerId) {
            try {
                const layerConfig = gisLayersData.find(l => l.id === layerId);
                if (!layerConfig) {
                    console.error(`Layer config not found for ${layerId}`);
                    return;
                }
                
                // Get current map bounds for query
                const bounds = map.getBounds();
                const bbox = {
                    minx: bounds.getWest(),
                    miny: bounds.getSouth(),
                    maxx: bounds.getEast(),
                    maxy: bounds.getNorth()
                };
                
                console.log(`Fetching ${layerConfig.name} data...`);
                
                // Use backend API to fetch and convert layer data
                const apiUrl = `/api/map-viewer/layer-data/${layerId}`;
                const params = new URLSearchParams({
                    'minx': bbox.minx,
                    'miny': bbox.miny,
                    'maxx': bbox.maxx,
                    'maxy': bbox.maxy
                });
                
                const response = await fetch(`${apiUrl}?${params}`);
                const geojson = await response.json();
                
                // Get professional styling for this layer
                const layerStyle = getLayerStyle(layerId);
                
                // Create Leaflet layer from GeoJSON
                const layerGroup = L.geoJSON(geojson, {
                    style: function(feature) {
                        return {
                            color: layerStyle.color,
                            weight: layerStyle.weight,
                            fillColor: layerStyle.fillColor,
                            fillOpacity: layerStyle.fillOpacity,
                            dashArray: layerStyle.dashArray || null
                        };
                    },
                    pointToLayer: function(feature, latlng) {
                        return L.circleMarker(latlng, {
                            radius: layerId === 'sonoma_schools' ? 6 : 4,
                            fillColor: layerStyle.pointColor,
                            color: '#fff',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: layerStyle.fillOpacity || 0.7
                        });
                    },
                    onEachFeature: function(feature, layer) {
                        // Add popup with properties
                        if (feature.properties) {
                            const props = feature.properties;
                            let popupContent = `<div style="font-size: 11px; max-width: 200px;">`;
                            popupContent += `<strong>${layerConfig.name}</strong><br>`;
                            
                            // Show first 5 properties
                            const keys = Object.keys(props).slice(0, 5);
                            keys.forEach(key => {
                                if (props[key] !== null && props[key] !== '') {
                                    popupContent += `<strong>${key}:</strong> ${props[key]}<br>`;
                                }
                            });
                            popupContent += `</div>`;
                            layer.bindPopup(popupContent);
                        }
                    }
                });
                
                layerGroup.addTo(map);
                activeGISLayers[layerId] = layerGroup;
                
                const featureCount = geojson.features ? geojson.features.length : 0;
                console.log(`${layerConfig.name}: Loaded ${featureCount} features`);
                
                // Update label
                const label = document.getElementById(`label-${layerId}`);
                label.innerHTML = `${layerConfig.name} <span style="color: #888;">(${featureCount})</span>`;
                
            } catch (error) {
                console.error(`Error loading layer ${layerId}:`, error);
                const label = document.getElementById(`label-${layerId}`);
                const layerConfig = gisLayersData.find(l => l.id === layerId);
                label.innerHTML = `${layerConfig.name} <span style="color: #ff4444;">⚠</span>`;
                
                // Uncheck the box
                document.getElementById(`layer-${layerId}`).checked = false;
            }
        }
        
        async function loadProjectStructure() {
            try {
                const res = await fetch('/api/map-viewer/project-structure');
                const data = await res.json();
                
                projectsData = data.projects || [];
                
                const select = document.getElementById('project-select');
                if (projectsData.length === 0) {
                    select.innerHTML = '<option value="">No projects available</option>';
                    return;
                }
                
                select.innerHTML = '<option value="">Select a project...</option>' +
                    projectsData.map(project => 
                        `<option value="${project.project_id}">${project.project_name} (${project.drawings.length} drawings)</option>`
                    ).join('');
                
                console.log(`Loaded ${projectsData.length} projects`);
            } catch (e) {
                console.error('Error loading project structure:', e);
                document.getElementById('project-select').innerHTML = '<option value="">Error loading projects</option>';
            }
        }
        
        function changeBasemap(id) {
            Object.values(basemaps).forEach(l => map.removeLayer(l));
            currentBasemap = basemaps[id];
            currentBasemap.addTo(map);
        }
        
        function toggleBasemap() {
            const checked = document.getElementById('basemap-toggle').checked;
            if (checked) {
                if (currentBasemap) {
                    currentBasemap.addTo(map);
                }
            } else {
                if (currentBasemap && map.hasLayer(currentBasemap)) {
                    map.removeLayer(currentBasemap);
                }
            }
        }
        
        function selectProject(projectId) {
            if (!projectId) {
                selectedProject = null;
                document.getElementById('btn-zoom-project').disabled = true;
                document.getElementById('drawings-container').innerHTML = 
                    '<div style="color: #888; text-align: center; padding: 10px;">Select a project to view drawings</div>';
                return;
            }
            
            selectedProject = projectsData.find(p => p.project_id === projectId);
            if (!selectedProject) return;
            
            document.getElementById('btn-zoom-project').disabled = false;
            buildDrawingsAccordion(selectedProject.drawings);
        }
        
        function buildDrawingsAccordion(drawings) {
            const container = document.getElementById('drawings-container');
            
            if (!drawings || drawings.length === 0) {
                container.innerHTML = '<div style="color: #888; text-align: center; padding: 10px;">No drawings in this project</div>';
                return;
            }
            
            container.innerHTML = drawings.map(drawing => {
                const totalEntities = drawing.total_entities || 0;
                
                return `
                    <div class="drawing-item">
                        <div class="drawing-header" onclick="toggleDrawing('${drawing.drawing_id}')">
                            <div>
                                <div class="drawing-title">${drawing.drawing_name}</div>
                                <div class="drawing-count">${totalEntities} entities</div>
                            </div>
                            <i class="fas fa-chevron-down" id="chevron-${drawing.drawing_id}"></i>
                        </div>
                        <div class="drawing-content" id="content-${drawing.drawing_id}">
                            ${drawing.entity_types.map(et => `
                                <div class="entity-type-item">
                                    <input type="checkbox" id="entity-${drawing.drawing_id}-${et.type}" 
                                           onchange="toggleEntityType('${drawing.drawing_id}', '${et.type}', this.checked)">
                                    <label class="entity-type-label" for="entity-${drawing.drawing_id}-${et.type}">
                                        ${et.type}
                                        <span class="entity-type-count">(${et.count})</span>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleDrawing(drawingId) {
            const content = document.getElementById(`content-${drawingId}`);
            const chevron = document.getElementById(`chevron-${drawingId}`);
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                chevron.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('open');
                chevron.style.transform = 'rotate(180deg)';
            }
        }
        
        function stripZCoordinates(geojson) {
            const processCoordinates = (coords) => {
                if (typeof coords[0] === 'number') {
                    return [coords[0], coords[1]];
                }
                return coords.map(processCoordinates);
            };
            
            const cleanedGeoJSON = JSON.parse(JSON.stringify(geojson));
            cleanedGeoJSON.features.forEach(feature => {
                if (feature.geometry && feature.geometry.coordinates) {
                    feature.geometry.coordinates = processCoordinates(feature.geometry.coordinates);
                }
            });
            
            return cleanedGeoJSON;
        }
        
        async function toggleEntityType(drawingId, entityType, checked) {
            const layerKey = `${drawingId}_${entityType}`;
            
            if (checked) {
                try {
                    console.log(`Loading ${entityType} entities for drawing ${drawingId}...`);
                    
                    const res = await fetch(`/api/map-viewer/project-entities/${drawingId}?entity_type=${entityType}`);
                    const geojson = await res.json();
                    
                    if (!geojson.features || geojson.features.length === 0) {
                        console.log(`No ${entityType} entities found`);
                        document.getElementById(`entity-${drawingId}-${entityType}`).checked = false;
                        return;
                    }
                    
                    const cleanedGeoJSON = stripZCoordinates(geojson);
                    
                    // CAD color mapping (AutoCAD Color Index to hex)
                    const aciColors = {
                        1: '#FF0000',  // Red
                        2: '#FFFF00',  // Yellow
                        3: '#00FF00',  // Green
                        4: '#00FFFF',  // Cyan
                        5: '#0000FF',  // Blue
                        6: '#FF00FF',  // Magenta
                        7: '#FFFFFF',  // White
                        8: '#808080',  // Gray
                        9: '#C0C0C0'   // Light Gray
                    };
                    
                    const entitiesLayer = L.geoJSON(cleanedGeoJSON, {
                        style: function(feature) {
                            const props = feature.properties;
                            const color = aciColors[props.color_aci] || props.layer_color || '#FFFFFF';
                            
                            return {
                                color: color,
                                weight: props.lineweight ? Math.max(1, props.lineweight / 100) : 1,
                                opacity: props.transparency ? 1 - (props.transparency / 255) : 1
                            };
                        },
                        pointToLayer: function(feature, latlng) {
                            const props = feature.properties;
                            const color = aciColors[props.color_aci] || props.layer_color || '#FFFFFF';
                            
                            return L.circleMarker(latlng, {
                                radius: 3,
                                fillColor: color,
                                color: color,
                                weight: 1,
                                opacity: props.transparency ? 1 - (props.transparency / 255) : 1,
                                fillOpacity: 0.8
                            });
                        },
                        onEachFeature: function(feature, layer) {
                            const props = feature.properties;
                            layer.bindPopup(`
                                <div style="font-size: 11px;">
                                    <strong>Entity: ${props.entity_type}</strong><br>
                                    <strong>Layer:</strong> ${props.layer_name || 'N/A'}<br>
                                    ${props.linetype ? `<strong>Linetype:</strong> ${props.linetype}<br>` : ''}
                                    ${props.color_aci ? `<strong>Color:</strong> ACI ${props.color_aci}<br>` : ''}
                                </div>
                            `);
                        }
                    });
                    
                    entitiesLayer.addTo(map);
                    activeEntityLayers[layerKey] = entitiesLayer;
                    
                    console.log(`Loaded ${geojson.features.length} ${entityType} entities`);
                    
                } catch (error) {
                    console.error(`Error loading ${entityType} entities:`, error);
                    document.getElementById(`entity-${drawingId}-${entityType}`).checked = false;
                }
            } else {
                if (activeEntityLayers[layerKey]) {
                    map.removeLayer(activeEntityLayers[layerKey]);
                    delete activeEntityLayers[layerKey];
                    console.log(`Removed ${entityType} entities for drawing ${drawingId}`);
                }
            }
        }
        
        function zoomToProject() {
            if (!selectedProject) {
                console.error('No project selected');
                alert('Please select a project first');
                return;
            }
            
            if (!selectedProject.bbox) {
                console.error('Project has no bounding box defined');
                alert(`Project "${selectedProject.project_name}" has no spatial extent defined. Add drawings with geometry first.`);
                return;
            }
            
            const bbox = selectedProject.bbox;
            
            // Validate bbox values are numeric
            const minX = parseFloat(bbox.min_x);
            const minY = parseFloat(bbox.min_y);
            const maxX = parseFloat(bbox.max_x);
            const maxY = parseFloat(bbox.max_y);
            
            if (!isFinite(minX) || !isFinite(minY) || !isFinite(maxX) || !isFinite(maxY)) {
                console.error('Invalid bbox values:', bbox);
                alert(`Project "${selectedProject.project_name}" has invalid spatial coordinates.`);
                return;
            }
            
            // Transform EPSG:2226 coordinates to WGS84
            const sw = proj4('EPSG:2226', 'EPSG:4326', [minX, minY]);
            const ne = proj4('EPSG:2226', 'EPSG:4326', [maxX, maxY]);
            
            // Fit map to bounds
            map.fitBounds([
                [sw[1], sw[0]],  // [lat, lon]
                [ne[1], ne[0]]
            ]);
            
            console.log(`Zoomed to project: ${selectedProject.project_name}`);
        }
        
        function drawProjectAreas() {
            const rectangles = [];
            
            projectsData.forEach(project => {
                if (!project.bbox) return;
                
                const bbox = project.bbox;
                const minX = parseFloat(bbox.min_x);
                const minY = parseFloat(bbox.min_y);
                const maxX = parseFloat(bbox.max_x);
                const maxY = parseFloat(bbox.max_y);
                
                if (!isFinite(minX) || !isFinite(minY) || !isFinite(maxX) || !isFinite(maxY)) {
                    return;
                }
                
                const sw = proj4('EPSG:2226', 'EPSG:4326', [minX, minY]);
                const ne = proj4('EPSG:2226', 'EPSG:4326', [maxX, maxY]);
                
                const rectangle = L.rectangle(
                    [[sw[1], sw[0]], [ne[1], ne[0]]],
                    {
                        color: '#FF8C00',
                        weight: 2,
                        dashArray: '5, 10',
                        fillOpacity: 0.1,
                        fillColor: '#FF8C00'
                    }
                );
                
                rectangle.bindPopup(`
                    <div style="font-size: 11px;">
                        <strong>${project.project_name}</strong><br>
                        Drawings: ${project.drawings.length}
                    </div>
                `);
                
                rectangles.push(rectangle);
            });
            
            return L.layerGroup(rectangles);
        }
        
        function toggleProjectAreas(checked) {
            if (checked) {
                if (!projectAreasLayer) {
                    projectAreasLayer = drawProjectAreas();
                }
                projectAreasLayer.addTo(map);
            } else {
                if (projectAreasLayer) {
                    map.removeLayer(projectAreasLayer);
                }
            }
        }
        
        async function searchAddress() {
            const addr = document.getElementById('search-input').value;
            const status = document.getElementById('search-status');
            if (!addr) return;
            
            status.innerHTML = 'Searching...';
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr + ', Sonoma County, CA')}`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.length > 0) {
                    map.setView([parseFloat(data[0].lat), parseFloat(data[0].lon)], 16);
                    status.innerHTML = '<span style="color: #0f0;">Found!</span>';
                } else {
                    status.innerHTML = '<span style="color: #f00;">Not found</span>';
                }
            } catch (e) {
                status.innerHTML = '<span style="color: #f00;">Error</span>';
            }
        }
        
        function measureDistance() {
            if (!map || !measureLayer) return;
            measureMode = 'distance';
            measurePoints = [];
            document.getElementById('btn-distance').classList.add('active');
            document.getElementById('btn-area').classList.remove('active');
            map.getContainer().style.cursor = 'crosshair';
        }
        
        function measureArea() {
            if (!map || !measureLayer) return;
            measureMode = 'area';
            measurePoints = [];
            document.getElementById('btn-area').classList.add('active');
            document.getElementById('btn-distance').classList.remove('active');
            map.getContainer().style.cursor = 'crosshair';
        }
        
        function startDrawingRectangle() {
            console.log('Starting rectangle drawing...');
            if (!map) {
                alert('Map not ready');
                return;
            }
            // Enable rectangle drawing programmatically
            new L.Draw.Rectangle(map, {
                shapeOptions: {
                    color: '#00ffff',
                    weight: 2,
                    fillOpacity: 0.1
                }
            }).enable();
            console.log('Rectangle drawing enabled');
        }
        
        function clearMeasurements() {
            if (!measureLayer) return;
            measureLayer.clearLayers();
            measureMode = null;
            measurePoints = [];
            if (map) map.getContainer().style.cursor = '';
            document.getElementById('btn-distance').classList.remove('active');
            document.getElementById('btn-area').classList.remove('active');
        }
        
        function openExportModal() {
            const layers = drawnItems.getLayers();
            if (layers.length === 0) {
                alert('Please draw a rectangle on the map first');
                return;
            }
            
            const selectedLayers = [];
            gisLayersData.forEach(layer => {
                const checkbox = document.getElementById(`layer-${layer.id}`);
                if (checkbox && checkbox.checked) {
                    selectedLayers.push(layer.id);
                }
            });
            
            if (selectedLayers.length === 0) {
                alert('Please select at least one GIS layer to export');
                return;
            }
            
            // Show the modal
            document.getElementById('export-modal').classList.add('active');
        }
        
        function closeExportModal() {
            document.getElementById('export-modal').classList.remove('active');
        }
        
        async function startExport() {
            // Get selected formats
            const formats = [];
            if (document.getElementById('format-png').checked) formats.push('png');
            if (document.getElementById('format-shp').checked) formats.push('shp');
            if (document.getElementById('format-dxf').checked) formats.push('dxf');
            if (document.getElementById('format-kml').checked) formats.push('kml');
            
            if (formats.length === 0) {
                alert('Please select at least one export format');
                return;
            }
            
            // Get PNG options
            const pngOptions = {
                north_arrow: document.getElementById('png-north-arrow').checked,
                scale_bar: document.getElementById('png-scale-bar').checked
            };
            
            // Get bounding box
            const layers = drawnItems.getLayers();
            const bbox = layers[0].getBounds();
            
            // Get selected GIS layers
            const selectedLayers = [];
            gisLayersData.forEach(layer => {
                const checkbox = document.getElementById(`layer-${layer.id}`);
                if (checkbox && checkbox.checked) {
                    selectedLayers.push(layer.id);
                }
            });
            
            const params = {
                bbox: {
                    minx: bbox.getWest(),
                    miny: bbox.getSouth(),
                    maxx: bbox.getEast(),
                    maxy: bbox.getNorth(),
                    crs: 'EPSG:4326'
                },
                layers: selectedLayers,
                formats: formats,
                png_options: pngOptions
            };
            
            console.log('Creating multi-format export...');
            console.log('Export params:', params);
            
            // Close modal
            closeExportModal();
            
            try {
                const res = await fetch('/api/map-export/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });
                const data = await res.json();
                
                if (data.status === 'complete') {
                    let msg = `Export successful!\n\n`;
                    msg += `Formats created: ${formats.join(', ').toUpperCase()}\n`;
                    
                    if (data.feature_counts) {
                        msg += `\nFeatures exported:\n`;
                        for (const [layer, count] of Object.entries(data.feature_counts)) {
                            msg += `  ${layer}: ${count}\n`;
                        }
                        msg += `\nTotal: ${Object.values(data.feature_counts).reduce((a,b)=>a+b, 0)} features\n`;
                    }
                    
                    msg += `\nCoordinate System: EPSG:2226 (CA State Plane Zone 2)\n`;
                    msg += `\nClick OK to download the ZIP file.`;
                    
                    alert(msg);
                    window.location.href = data.download_url;
                } else {
                    alert('Export failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Export error:', e);
                alert('Export error: ' + e.message);
            }
        }
        
        async function pollExport(jobId) {
            const check = async () => {
                const res = await fetch(`/api/map-export/status/${jobId}`);
                const data = await res.json();
                
                if (data.status === 'complete') {
                    console.log('Export complete! Download:', data.download_url);
                    alert('Export complete!\n\nDownload: ' + data.download_url);
                    window.open(data.download_url, '_blank');
                } else if (data.status === 'failed') {
                    alert('Export failed: ' + data.error);
                } else {
                    console.log('Export processing...');
                    setTimeout(check, 2000);
                }
            };
            check();
        }
    </script>
</body>
</html>
