{% extends 'base.html' %}

{% block title %}Map Viewer{% endblock %}

{% block content %}
<!-- Version: {{ cache_bust }} -->
    <div class="map-viewer-wrapper">
        <!-- Collapse Toggle Button -->
        <button class="sidebar-collapse-btn" onclick="toggleSidebar()" title="Toggle Sidebar (Ctrl+B)">
            <i class="fas fa-bars" id="collapse-icon"></i>
        </button>
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 style="color: #00ffff; margin: 0; font-size: 18px;">
                    <i class="fas fa-map-marked-alt"></i> Map Viewer
                </h2>
                <div style="font-size: 10px; color: #888; margin-top: 4px;">
                    Press <kbd>L</kbd> for Layers, <kbd>M</kbd> for Tools
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('map-controls')" data-tab="map-controls">
                    <i class="fas fa-map"></i>
                    <span>Map</span>
                </button>
                <button class="tab-btn" onclick="switchTab('tools')" data-tab="tools">
                    <i class="fas fa-tools"></i>
                    <span>Tools</span>
                </button>
                <button class="tab-btn" onclick="switchTab('layers')" data-tab="layers">
                    <i class="fas fa-layer-group"></i>
                    <span>Layers</span>
                </button>
            </div>
            
            <!-- Tab Content Container -->
            <div class="tab-content-wrapper">
                <!-- MAP CONTROLS TAB -->
                <div id="tab-map-controls" class="tab-content active">
                    <div class="section">
                        <h3><i class="fas fa-map-marked-alt"></i> Project Location</h3>
                        <div class="project-info">
                            <strong>State Plane Zone</strong>
                            <div class="value">CA Zone 2 (EPSG:2226)</div>
                            
                            <strong>County</strong>
                            <div class="value">Sonoma County</div>
                            
                            <strong>Units</strong>
                            <div class="value">US Survey Feet</div>
                            
                            <div class="coming-soon">
                                <i class="fas fa-lock"></i> Zone/County selection coming soon
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3><i class="fas fa-map"></i> Basemap</h3>
                        <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                            <input type="checkbox" id="basemap-toggle" checked onchange="toggleBasemap()" 
                                   style="margin-right: 8px;">
                            <span>Show Basemap</span>
                        </label>
                        <select id="basemap-select" onchange="changeBasemap(this.value)">
                            <option value="osm">OpenStreetMap</option>
                            <option value="topo">USGS Topo</option>
                            <option value="imagery">ESRI Imagery</option>
                        </select>
                    </div>
                    
                    <div class="section">
                        <h3><i class="fas fa-search"></i> Search</h3>
                        <input type="text" id="search-input" placeholder="Address in Sonoma County"
                               onkeypress="if(event.key==='Enter') searchAddress()">
                        <button onclick="searchAddress()"><i class="fas fa-search"></i> Search</button>
                        <div id="search-status"></div>
                    </div>
                    
                    <div class="section">
                        <h3><i class="fas fa-crosshairs"></i> Coordinates</h3>
                        <div class="coord-display" id="coords">
                            Move mouse over map...
                        </div>
                    </div>
                </div>
                
                <!-- TOOLS TAB -->
                <div id="tab-tools" class="tab-content">
                    <div class="section">
                        <h3><i class="fas fa-ruler"></i> Measurements</h3>
                        <button id="btn-distance" onclick="measureDistance()">
                            <i class="fas fa-ruler-horizontal"></i> Distance
                        </button>
                        <button id="btn-area" onclick="measureArea()">
                            <i class="fas fa-draw-polygon"></i> Area
                        </button>
                        <button onclick="clearMeasurements()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                    
                    <div class="section">
                        <h3><i class="fas fa-file-export"></i> Export</h3>
                        <button id="draw-rect-btn" onclick="startDrawingRectangle()">
                            <i class="fas fa-vector-square"></i> Draw Rectangle
                        </button>
                        <button id="export-btn" onclick="openExportModal()" disabled>
                            <i class="fas fa-download"></i> Create Export
                        </button>
                        <small style="color: #888;">Step 1: Draw, Step 2: Export</small>
                    </div>
                </div>
                
                <!-- LAYERS TAB -->
                <div id="tab-layers" class="tab-content">
                    <div class="section">
                        <h3><i class="fas fa-folder-open"></i> Active Project Entities</h3>

                        <div id="active-project-info" style="margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; font-size: 11px; color: #aaa;">
                            <i class="fas fa-info-circle"></i> Select a project from the header above
                        </div>

                        <button id="btn-zoom-project" onclick="zoomToProject()" disabled style="margin-bottom: 10px; width: 100%;">
                            <i class="fas fa-search-location"></i> Zoom to Active Project
                        </button>
                        
                        <div style="margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                            <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                                <input type="checkbox" id="show-project-areas" onchange="toggleProjectAreas(this.checked)" style="margin-right: 8px;">
                                <span style="color: #aaa; font-size: 11px;">Show Project Areas</span>
                            </label>
                        </div>
                        
                        <div id="project-layers-container" style="font-size: 11px; max-height: 300px; overflow-y: auto;">
                            <div style="color: #888; text-align: center; padding: 10px;">Select a project to view layers</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3><i class="fas fa-layer-group"></i> Sonoma County Layers</h3>
                        <div id="gis-layers-container" style="font-size: 11px; max-height: 200px; overflow-y: auto;">
                            <div class="skeleton-loader">
                                <div class="skeleton-line"></div>
                                <div class="skeleton-line"></div>
                                <div class="skeleton-line"></div>
                            </div>
                        </div>
                        <div id="gis-status" style="color: #888; font-size: 10px; margin-top: 5px;">
                            Ready to load layers
                        </div>
                    </div>
                    
                    <!-- Layer Legend -->
                    <div class="section" id="layer-legend" style="display: none;">
                        <h3><i class="fas fa-palette"></i> Layer Legend</h3>
                        <div id="legend-items"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="map-area">
            <!-- Map Control Buttons -->
            <div class="map-controls-overlay">
                <button class="map-control-btn" onclick="findMyLocation()" title="Find My Location">
                    <i class="fas fa-location-arrow"></i>
                </button>
                <button class="map-control-btn" onclick="toggleFullscreen()" title="Fullscreen (F11)">
                    <i class="fas fa-expand" id="fullscreen-icon"></i>
                </button>
            </div>
            
            <!-- Active Layer Pills -->
            <div class="active-layers-pills" id="active-layers-pills"></div>
            
            <!-- Scale Bar -->
            <div class="scale-bar" id="scale-bar">
                <div class="scale-bar-line"></div>
                <div class="scale-bar-label" id="scale-bar-label">1000 ft</div>
            </div>
            
            <div id="map"></div>
        </div>
    </div>
    
    <!-- Export Format Selection Modal -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-file-export"></i> Export Map Data</h2>
            
            <div class="format-section">
                <h4>Select Export Formats</h4>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="format-png" checked>
                        <span><i class="fas fa-image"></i> PNG Image</span>
                    </label>
                    <div class="format-description">Map image with optional north arrow and scale bar</div>
                </div>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="format-shp" checked>
                        <span><i class="fas fa-file-archive"></i> Shapefile (.shp)</span>
                    </label>
                    <div class="format-description">Standard GIS format compatible with ArcGIS, QGIS</div>
                </div>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="format-dxf">
                        <span><i class="fas fa-file-code"></i> DXF (.dxf)</span>
                    </label>
                    <div class="format-description">AutoCAD Drawing Exchange Format</div>
                </div>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="format-kml">
                        <span><i class="fas fa-globe"></i> KML (.kml)</span>
                    </label>
                    <div class="format-description">Google Earth / Google Maps format</div>
                </div>
            </div>
            
            <div class="format-section" id="png-options-section">
                <h4>PNG Options</h4>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="png-north-arrow" checked>
                        <span><i class="fas fa-compass"></i> North Arrow</span>
                    </label>
                </div>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="png-scale-bar" checked>
                        <span><i class="fas fa-ruler-horizontal"></i> Scale Bar</span>
                    </label>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button onclick="closeExportModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button onclick="startExport()" style="background: #00cc66;">
                    <i class="fas fa-download"></i> Create Export
                </button>
            </div>
        </div>
    </div>
    
    <!-- Layer Preview Tooltip -->
    <div id="layer-preview-tooltip" class="layer-preview-tooltip"></div>
{% endblock %}

{% block scripts %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #001428;
            color: white;
        }
        
        .map-viewer-wrapper {
            display: flex;
            width: 100vw;
            height: calc(100vh - 140px);
            position: relative;
            margin-top: 0;
        }
        
        kbd {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.4);
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 9px;
            font-family: monospace;
        }
        
        /* Collapse Toggle Button */
        .sidebar-collapse-btn {
            position: fixed;
            left: 10px;
            top: 150px;
            z-index: 2000;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #004d7a, #008793);
            border: 2px solid #00ffff;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.4);
        }
        
        .sidebar-collapse-btn:hover {
            background: linear-gradient(135deg, #006699, #00a8b8);
            box-shadow: 0 6px 16px rgba(0, 255, 255, 0.6);
            transform: scale(1.05);
        }
        
        .sidebar-collapse-btn i {
            font-size: 18px;
        }
        
        .sidebar {
            width: 340px;
            background: linear-gradient(180deg, #002040 0%, #001428 100%);
            border-right: 3px solid #00ffff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 4px 0 20px rgba(0, 255, 255, 0.3);
        }
        
        .sidebar.collapsed {
            width: 0;
            border-right-width: 0;
            box-shadow: none;
        }
        
        .sidebar-header {
            padding: 15px 20px;
            background: rgba(0, 255, 255, 0.1);
            border-bottom: 2px solid rgba(0, 255, 255, 0.3);
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: rgba(0, 40, 80, 0.5);
            border-bottom: 2px solid rgba(0, 255, 255, 0.2);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 11px;
        }
        
        .tab-btn i {
            font-size: 18px;
        }
        
        .tab-btn:hover {
            background: rgba(0, 255, 255, 0.1);
            color: #00ffff;
        }
        
        .tab-btn.active {
            color: #00ffff;
            border-bottom-color: #00ffff;
            background: rgba(0, 255, 255, 0.15);
        }
        
        /* Tab Content */
        .tab-content-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .map-area {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Map Control Buttons Overlay */
        .map-controls-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #004d7a, #008793);
            border: 2px solid #00ffff;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.4);
        }
        
        .map-control-btn:hover {
            background: linear-gradient(135deg, #006699, #00a8b8);
            box-shadow: 0 6px 16px rgba(0, 255, 255, 0.6);
            transform: scale(1.1);
        }
        
        .map-control-btn i {
            font-size: 16px;
        }
        
        /* Active Layer Pills */
        .active-layers-pills {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 80%;
        }
        
        .layer-pill {
            background: rgba(0, 40, 80, 0.95);
            border: 2px solid;
            border-radius: 20px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            animation: pillSlideIn 0.3s ease;
        }
        
        @keyframes pillSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .layer-pill-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .layer-pill-remove {
            background: none;
            border: none;
            color: #ff4444;
            cursor: pointer;
            padding: 0;
            margin-left: 4px;
            font-size: 14px;
            transition: color 0.2s;
        }
        
        .layer-pill-remove:hover {
            color: #ff0000;
        }
        
        /* Scale Bar */
        .scale-bar {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 40, 80, 0.95);
            border: 2px solid #00ffff;
            border-radius: 4px;
            padding: 8px 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }
        
        .scale-bar-line {
            height: 4px;
            background: #00ffff;
            margin-bottom: 4px;
            width: 100px;
            border-radius: 2px;
        }
        
        .scale-bar-label {
            font-size: 11px;
            color: #00ffff;
            font-weight: bold;
            text-align: center;
        }
        
        /* Layer Preview Tooltip */
        .layer-preview-tooltip {
            position: absolute;
            background: rgba(0, 20, 40, 0.98);
            border: 2px solid #00ffff;
            border-radius: 6px;
            padding: 10px;
            font-size: 11px;
            z-index: 10000;
            display: none;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.5);
            max-width: 250px;
        }
        
        .layer-preview-tooltip.show {
            display: block;
        }
        
        .layer-preview-color {
            width: 100%;
            height: 20px;
            border-radius: 3px;
            margin: 5px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Skeleton Loader */
        .skeleton-loader {
            padding: 10px 0;
        }
        
        .skeleton-line {
            height: 12px;
            background: linear-gradient(90deg, 
                rgba(0, 255, 255, 0.1) 25%, 
                rgba(0, 255, 255, 0.2) 50%, 
                rgba(0, 255, 255, 0.1) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .skeleton-line:nth-child(1) { width: 80%; }
        .skeleton-line:nth-child(2) { width: 60%; }
        .skeleton-line:nth-child(3) { width: 70%; }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .section {
            background: rgba(0, 60, 100, 0.4);
            border: 1px solid rgba(0, 128, 255, 0.4);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .section h3 {
            color: #00ffff;
            font-size: 13px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
            padding-bottom: 6px;
        }
        
        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #004d7a, #008793);
            border: 1px solid #0080ff;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        button:hover { 
            background: linear-gradient(135deg, #006699, #00a8b8);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        button.active { 
            background: linear-gradient(135deg, #00a8b8, #00ffff);
            color: #000;
            font-weight: bold;
        }
        button.warning { background: #ff9900; color: #000; border-color: #ffaa00; }
        button.error { background: #ff3333; color: #fff; border-color: #ff0000; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid #0080ff;
            color: white;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .coord-display {
            background: rgba(0, 20, 40, 0.9);
            border: 1px solid #0080ff;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
        }
        
        .project-info {
            background: rgba(0, 26, 51, 0.8);
            border: 1px solid #00ffff;
            padding: 12px;
            border-radius: 5px;
            font-size: 11px;
            line-height: 1.6;
        }
        
        .project-info strong {
            color: #00ffff;
            display: block;
            margin-bottom: 2px;
        }
        
        .project-info .value {
            color: #fff;
            margin-bottom: 8px;
        }
        
        .coming-soon {
            color: #888;
            font-size: 10px;
            font-style: italic;
            margin-top: 8px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #002040;
            border: 3px solid #00ffff;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content h2 {
            color: #00ffff;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .format-section {
            background: rgba(0, 48, 96, 0.5);
            border: 1px solid rgba(0, 128, 255, 0.3);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .format-section h4 {
            color: #00ffff;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .checkbox-group {
            margin-bottom: 10px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            padding: 8px;
            border-radius: 3px;
        }
        
        .checkbox-group label:hover {
            background: rgba(0, 255, 255, 0.1);
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            margin-bottom: 0;
            cursor: pointer;
        }
        
        .format-description {
            color: #aaa;
            font-size: 11px;
            margin-left: 28px;
            margin-top: -5px;
            margin-bottom: 10px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            flex: 1;
        }
        
        /* Layer item styles */
        .layer-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 4px;
            font-size: 11px;
            transition: background 0.2s;
        }
        
        .layer-item:hover {
            background: rgba(0, 255, 255, 0.15);
        }
        
        .layer-item input[type="checkbox"] {
            margin: 0;
            margin-right: 8px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .layer-item-label {
            flex: 1;
            cursor: pointer;
            color: #fff;
        }
        
        .layer-item-count {
            color: #888;
            font-size: 10px;
            margin-left: 5px;
        }
        
        .layer-loading {
            color: #00ffff;
            font-size: 10px;
        }
        
        /* Legend Items */
        #legend-items {
            font-size: 11px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
        }
        
        .legend-color {
            width: 20px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .legend-label {
            flex: 1;
            color: #aaa;
        }
        
        /* Scrollbar styling */
        .tab-content-wrapper::-webkit-scrollbar,
        #project-layers-container::-webkit-scrollbar,
        #gis-layers-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .tab-content-wrapper::-webkit-scrollbar-track,
        #project-layers-container::-webkit-scrollbar-track,
        #gis-layers-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .tab-content-wrapper::-webkit-scrollbar-thumb,
        #project-layers-container::-webkit-scrollbar-thumb,
        #gis-layers-container::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        .tab-content-wrapper::-webkit-scrollbar-thumb:hover,
        #project-layers-container::-webkit-scrollbar-thumb:hover,
        #gis-layers-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 255, 0.5);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 320px;
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                z-index: 1500;
            }
            
            .sidebar.collapsed {
                left: -100%;
            }
            
            .sidebar-collapse-btn {
                left: 10px;
            }
            
            .active-layers-pills {
                max-width: 90%;
                top: 60px;
            }
        }
    </style>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script>
let map, basemaps, drawnItems, measureLayer, measureMode, measurePoints;
        
        // Project Viewer global variables
        let projectsData = [];
        let selectedProject = null;
        let activeEntityLayers = {};
        let projectAreasLayer = null;
        
        // GIS Layers global variables
        let gisLayersData = [];
        let activeGISLayers = {};
        let projectsLayer = null;
        let projectsVisible = true;
        let projectColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#95afc0', '#c56cf0', '#ffbe76'];
        
        // Sidebar collapse state
        let sidebarCollapsed = false;
        let isFullscreen = false;
        
        // Layer preview tooltip
        let layerPreviewTooltip;
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }
        
        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('collapse-icon');
            
            sidebarCollapsed = !sidebarCollapsed;
            
            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                icon.className = 'fas fa-chevron-right';
            } else {
                sidebar.classList.remove('collapsed');
                icon.className = 'fas fa-bars';
            }
            
            setTimeout(() => {
                if (map) map.invalidateSize();
            }, 300);
        }
        
        // Geolocation
        function findMyLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }
            
            const btn = event.target.closest('.map-control-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    map.setView([lat, lng], 16);
                    
                    L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'location-marker',
                            html: '<i class="fas fa-circle" style="color: #00ffff; font-size: 16px;"></i>',
                            iconSize: [16, 16]
                        })
                    }).addTo(map).bindPopup('You are here').openPopup();
                    
                    btn.innerHTML = '<i class="fas fa-location-arrow"></i>';
                },
                (error) => {
                    alert('Unable to retrieve your location: ' + error.message);
                    btn.innerHTML = '<i class="fas fa-location-arrow"></i>';
                }
            );
        }
        
        // Fullscreen toggle
        function toggleFullscreen() {
            const elem = document.documentElement;
            const icon = document.getElementById('fullscreen-icon');
            
            if (!isFullscreen) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
                icon.className = 'fas fa-compress';
                isFullscreen = true;
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                icon.className = 'fas fa-expand';
                isFullscreen = false;
            }
        }
        
        // Update scale bar
        function updateScaleBar() {
            if (!map) return;
            
            const bounds = map.getBounds();
            const centerLat = map.getCenter().lat;
            const mapWidth = map.getSize().x;
            
            const point1 = L.latLng(centerLat, bounds.getWest());
            const point2 = L.latLng(centerLat, bounds.getEast());
            const distanceMeters = point1.distanceTo(point2);
            const distanceFeet = distanceMeters * 3.28084;
            const distanceMiles = distanceFeet / 5280;
            
            const pixelsPerFoot = mapWidth / distanceFeet;
            
            let scaleDistance, scaleLabel;
            
            if (distanceMiles > 5) {
                scaleDistance = Math.round(distanceMiles / 2);
                scaleLabel = scaleDistance + ' mi';
            } else if (distanceFeet > 5000) {
                scaleDistance = Math.round(distanceFeet / 1000) * 500;
                scaleLabel = scaleDistance + ' ft';
            } else {
                scaleDistance = Math.round(distanceFeet / 100) * 50;
                scaleLabel = scaleDistance + ' ft';
            }
            
            const scaleWidth = scaleDistance * pixelsPerFoot;
            document.querySelector('.scale-bar-line').style.width = Math.min(scaleWidth, 200) + 'px';
            document.getElementById('scale-bar-label').textContent = scaleLabel;
        }
        
        // Add active layer pill
        function addLayerPill(layerId, layerName, layerColor) {
            const pillsContainer = document.getElementById('active-layers-pills');
            
            const pill = document.createElement('div');
            pill.className = 'layer-pill';
            pill.id = 'pill-' + layerId;
            pill.style.borderColor = layerColor;
            pill.innerHTML = `
                <div class="layer-pill-color" style="background: ${layerColor};"></div>
                <span>${layerName}</span>
                <button class="layer-pill-remove" onclick="removeLayerFromPill('${layerId}')" title="Remove layer">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            pillsContainer.appendChild(pill);
            updateLayerLegend();
        }
        
        // Remove layer pill
        function removeLayerPill(layerId) {
            const pill = document.getElementById('pill-' + layerId);
            if (pill) {
                pill.remove();
                updateLayerLegend();
            }
        }
        
        // Remove layer from pill click
        function removeLayerFromPill(layerId) {
            const checkbox = document.getElementById('layer-' + layerId);
            if (checkbox) {
                checkbox.checked = false;
                toggleLayerSelection(layerId, false);
            }
        }
        
        // Update layer legend
        function updateLayerLegend() {
            const legendSection = document.getElementById('layer-legend');
            const legendItems = document.getElementById('legend-items');
            
            const activeLayers = Object.keys(activeGISLayers);
            
            if (activeLayers.length === 0) {
                legendSection.style.display = 'none';
                return;
            }
            
            legendSection.style.display = 'block';
            legendItems.innerHTML = activeLayers.map(layerId => {
                const layer = gisLayersData.find(l => l.id === layerId);
                const style = getLayerStyle(layerId);
                return `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${style.color};"></div>
                        <div class="legend-label">${layer.name}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Show layer preview on hover
        function showLayerPreview(layerId, event) {
            const layer = gisLayersData.find(l => l.id === layerId);
            if (!layer) return;
            
            const style = getLayerStyle(layerId);
            const tooltip = layerPreviewTooltip;
            
            tooltip.innerHTML = `
                <strong>${layer.name}</strong>
                <div class="layer-preview-color" style="background: ${style.color};"></div>
                <div style="margin-top: 5px; color: #aaa;">
                    <div>Weight: ${style.weight}px</div>
                    <div>Opacity: ${(style.fillOpacity * 100).toFixed(0)}%</div>
                </div>
            `;
            
            tooltip.style.left = (event.pageX + 15) + 'px';
            tooltip.style.top = (event.pageY + 15) + 'px';
            tooltip.classList.add('show');
        }
        
        function hideLayerPreview() {
            layerPreviewTooltip.classList.remove('show');
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            if (e.key === 'Escape') {
                closeExportModal();
                clearMeasurements();
            } else if (e.key.toLowerCase() === 'l') {
                document.querySelector('[data-tab="layers"]').click();
            } else if (e.key.toLowerCase() === 'm') {
                document.querySelector('[data-tab="tools"]').click();
            } else if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            } else if (e.ctrlKey && e.key.toLowerCase() === 'b') {
                e.preventDefault();
                toggleSidebar();
            }
        });
        
        // Listen for fullscreen change
        document.addEventListener('fullscreenchange', function() {
            isFullscreen = !!document.fullscreenElement;
            document.getElementById('fullscreen-icon').className = isFullscreen ? 'fas fa-compress' : 'fas fa-expand';
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing simple map...');
            
            layerPreviewTooltip = document.getElementById('layer-preview-tooltip');
            
            proj4.defs("EPSG:2226", "+proj=lcc +lat_1=39.83333333333334 +lat_2=38.33333333333334 +lat_0=37.66666666666666 +lon_0=-122 +x_0=2000000.0001016 +y_0=500000.0001016001 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048006096012192 +no_defs");
            
            map = L.map('map', {
                zoomDelta: 0.25,
                zoomSnap: 0.25,
                wheelPxPerZoomLevel: 120,
                boxZoom: true
            }).setView([38.5, -122.8], 10);
            
            measureMode = null;
            measurePoints = [];
            measureLayer = new L.FeatureGroup().addTo(map);
            
            basemaps = {
                osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap',
                    maxZoom: 22,
                    maxNativeZoom: 19
                }),
                topo: L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'USGS',
                    maxZoom: 22,
                    maxNativeZoom: 16
                }),
                imagery: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'ESRI',
                    maxZoom: 22,
                    maxNativeZoom: 19
                })
            };
            
            currentBasemap = basemaps.osm;
            currentBasemap.addTo(map);
            
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            console.log('Creating draw control...');
            try {
                const drawControl = new L.Control.Draw({
                    position: 'topright',
                    draw: {
                        rectangle: true,
                        polygon: false,
                        polyline: false,
                        circle: false,
                        marker: false,
                        circlemarker: false
                    },
                    edit: {
                        featureGroup: drawnItems
                    }
                });
                map.addControl(drawControl);
                console.log('Draw control added successfully');
            } catch(err) {
                console.error('Error creating draw control:', err);
            }
            
            map.on('draw:created', function(e) {
                drawnItems.clearLayers();
                drawnItems.addLayer(e.layer);
                
                const bounds = e.layer.getBounds();
                const sw = bounds.getSouthWest();
                const ne = bounds.getNorthEast();
                
                const [swX, swY] = proj4('EPSG:4326', 'EPSG:2226', [sw.lng, sw.lat]);
                const [neX, neY] = proj4('EPSG:4326', 'EPSG:2226', [ne.lng, ne.lat]);
                
                const widthFt = Math.abs(neX - swX);
                const heightFt = Math.abs(neY - swY);
                const areaSqFt = widthFt * heightFt;
                const acres = areaSqFt / 43560;
                
                const MAX_AREA_SQ_FT = 2000000;
                const warningThreshold = MAX_AREA_SQ_FT * 0.8;
                
                let buttonHTML = '<i class="fas fa-check-circle"></i> Rectangle Drawn';
                let buttonClass = 'active';
                let exportDisabled = false;
                
                if (areaSqFt > MAX_AREA_SQ_FT) {
                    buttonHTML = `<i class="fas fa-exclamation-triangle"></i> Area Too Large (${acres.toFixed(1)} ac)`;
                    buttonClass = 'error';
                    exportDisabled = true;
                    alert(`⚠️ Export Area Too Large!\n\nYour selection is ${acres.toFixed(1)} acres (${areaSqFt.toLocaleString()} sq ft).\n\nMaximum allowed: 46 acres (2,000,000 sq ft)\n\nPlease draw a smaller rectangle.`);
                } else if (areaSqFt > warningThreshold) {
                    buttonHTML = `<i class="fas fa-exclamation-circle"></i> Large Area (${acres.toFixed(1)} ac)`;
                    buttonClass = 'warning';
                    const percent = ((areaSqFt / MAX_AREA_SQ_FT) * 100).toFixed(0);
                    console.warn(`Area is ${percent}% of maximum allowed`);
                } else {
                    if (acres >= 0.1) {
                        buttonHTML = `<i class="fas fa-check-circle"></i> ${acres.toFixed(2)} acres`;
                    } else {
                        buttonHTML = `<i class="fas fa-check-circle"></i> ${Math.round(areaSqFt).toLocaleString()} sq ft`;
                    }
                }
                
                document.getElementById('export-btn').disabled = exportDisabled;
                document.getElementById('draw-rect-btn').innerHTML = buttonHTML;
                document.getElementById('draw-rect-btn').className = buttonClass;
                console.log(`Rectangle drawn: ${areaSqFt.toLocaleString()} sq ft (${acres.toFixed(2)} acres)`);
            });
            
            map.on('draw:drawstart', function(e) {
                console.log('Drawing started');
            });
            
            map.on('mousemove', function(e) {
                const [x, y] = proj4('EPSG:4326', 'EPSG:2226', [e.latlng.lng, e.latlng.lat]);
                document.getElementById('coords').innerHTML = `
                    Lat/Lng: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}<br>
                    State Plane: ${x.toFixed(2)}, ${y.toFixed(2)} ft
                `;
            });
            
            map.on('click', function(e) {
                if (!measureMode) return;
                
                measurePoints.push(e.latlng);
                
                if (measureMode === 'distance' && measurePoints.length > 1) {
                    const line = turf.lineString(measurePoints.map(p => [p.lng, p.lat]));
                    const meters = turf.length(line, {units: 'meters'});
                    const feet = meters * 3.28084;
                    const miles = feet / 5280;
                    const label = miles > 0.1 ? `${miles.toFixed(2)} mi` : `${feet.toFixed(0)} ft`;
                    
                    L.polyline(measurePoints, {color: '#00ff00', weight: 3})
                        .addTo(measureLayer)
                        .bindPopup(label)
                        .openPopup();
                }
                
                if (measureMode === 'area' && measurePoints.length >= 3) {
                    const coords = measurePoints.map(p => [p.lng, p.lat]);
                    coords.push(coords[0]);
                    const poly = turf.polygon([coords]);
                    const sqm = turf.area(poly);
                    const sqft = sqm * 10.7639;
                    const acres = sqft / 43560;
                    const label = acres > 0.1 ? `${acres.toFixed(2)} acres` : `${sqft.toFixed(0)} sq ft`;
                    
                    L.polygon(measurePoints, {color: '#00ff00', fillOpacity: 0.2})
                        .addTo(measureLayer)
                        .bindPopup(label)
                        .openPopup();
                }
            });
            
            map.on('dblclick', function() {
                if (measureMode) {
                    setTimeout(clearMeasurements, 100);
                }
            });
            
            map.on('zoomend', updateScaleBar);
            map.on('moveend', updateScaleBar);
            
            loadProjectStructure();
            loadGISLayers();

            // Listen for active project changes from global header
            window.addEventListener('activeProjectChanged', (event) => {
                console.log('Active project changed in map viewer:', event.detail);
                handleActiveProjectChange(event.detail);
            });

            console.log('Map initialized!');
            setTimeout(() => {
                map.invalidateSize();
                updateScaleBar();
                console.log('Map tiles should be visible now');
            }, 100);
        });
        
        async function loadGISLayers() {
            try {
                const res = await fetch('/api/map-viewer/layers');
                const data = await res.json();
                gisLayersData = data.layers || [];
                
                const container = document.getElementById('gis-layers-container');
                if (gisLayersData.length === 0) {
                    container.innerHTML = '<div style="color: #888;">No layers available</div>';
                    return;
                }
                
                container.innerHTML = gisLayersData
                    .filter(layer => layer.enabled)
                    .map(layer => `
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;"
                               onmouseenter="showLayerPreview('${layer.id}', event)"
                               onmouseleave="hideLayerPreview()">
                            <input type="checkbox" id="layer-${layer.id}" 
                                   style="margin: 0; margin-right: 8px; flex-shrink: 0;"
                                   onchange="toggleLayerSelection('${layer.id}', this.checked)">
                            <span id="label-${layer.id}">${layer.name}</span>
                        </label>
                    `).join('');
                
            } catch (error) {
                console.error('Error loading GIS layers:', error);
                document.getElementById('gis-layers-container').innerHTML = 
                    '<div style="color: #ff4444;">Error loading layers</div>';
            }
        }
        
        
        async function toggleLayerSelection(layerId, checked) {
            console.log(`Layer ${layerId} ${checked ? 'loading...' : 'removing...'}`);
            
            const label = document.getElementById(`label-${layerId}`);
            const originalText = label.textContent;
            
            if (checked) {
                label.innerHTML = originalText + ' <i class="fas fa-spinner fa-spin"></i>';
                await loadGISLayer(layerId);
            } else {
                if (activeGISLayers[layerId]) {
                    map.removeLayer(activeGISLayers[layerId]);
                    delete activeGISLayers[layerId];
                    removeLayerPill(layerId);
                    console.log(`Layer ${layerId} removed from map`);
                }
            }
        }
        
        function getLayerStyle(layerId) {
            const styles = {
                'sonoma_parcels_public': {
                    color: '#FF5733',
                    weight: 2,
                    fillColor: '#FF5733',
                    fillOpacity: 0.05,
                    pointColor: '#FF5733'
                },
                'sonoma_buildings': {
                    color: '#333333',
                    weight: 1,
                    fillColor: '#555555',
                    fillOpacity: 0.4,
                    pointColor: '#333333'
                },
                'sonoma_city_limits': {
                    color: '#9B59B6',
                    weight: 3,
                    fillColor: '#9B59B6',
                    fillOpacity: 0.05,
                    dashArray: '10, 5',
                    pointColor: '#9B59B6'
                },
                'sonoma_county_boundary': {
                    color: '#8E44AD',
                    weight: 4,
                    fillColor: '#8E44AD',
                    fillOpacity: 0.02,
                    dashArray: '15, 10',
                    pointColor: '#8E44AD'
                },
                'sonoma_fire_districts': {
                    color: '#C0392B',
                    weight: 2,
                    fillColor: '#E74C3C',
                    fillOpacity: 0.1,
                    dashArray: '5, 5',
                    pointColor: '#C0392B'
                },
                'sonoma_school_districts': {
                    color: '#2980B9',
                    weight: 2,
                    fillColor: '#3498DB',
                    fillOpacity: 0.08,
                    dashArray: '8, 4',
                    pointColor: '#2980B9'
                },
                'sonoma_drainage_lines': {
                    color: '#0066CC',
                    weight: 2,
                    fillColor: '#0066CC',
                    fillOpacity: 0.3,
                    pointColor: '#0066CC'
                },
                'sonoma_drainage_points': {
                    color: '#0066CC',
                    weight: 1,
                    fillColor: '#0066CC',
                    fillOpacity: 0.7,
                    pointColor: '#0066CC'
                },
                'sonoma_parks_boundaries': {
                    color: '#27AE60',
                    weight: 2,
                    fillColor: '#2ECC71',
                    fillOpacity: 0.15,
                    pointColor: '#27AE60'
                },
                'sonoma_parks_trails': {
                    color: '#16A085',
                    weight: 3,
                    fillColor: '#16A085',
                    fillOpacity: 0.5,
                    pointColor: '#16A085'
                },
                'sonoma_schools': {
                    color: '#E67E22',
                    weight: 1,
                    fillColor: '#E67E22',
                    fillOpacity: 0.8,
                    pointColor: '#E67E22'
                }
            };
            
            return styles[layerId] || {
                color: '#0080ff',
                weight: 2,
                fillColor: '#0080ff',
                fillOpacity: 0.1,
                pointColor: '#0080ff'
            };
        }
        
        
        async function loadGISLayer(layerId) {
            try {
                const layerConfig = gisLayersData.find(l => l.id === layerId);
                if (!layerConfig) {
                    console.error(`Layer config not found for ${layerId}`);
                    return;
                }
                
                const bounds = map.getBounds();
                const bbox = {
                    minx: bounds.getWest(),
                    miny: bounds.getSouth(),
                    maxx: bounds.getEast(),
                    maxy: bounds.getNorth()
                };
                
                console.log(`Fetching ${layerConfig.name} data...`);
                
                const apiUrl = `/api/map-viewer/layer-data/${layerId}`;
                const params = new URLSearchParams({
                    'minx': bbox.minx,
                    'miny': bbox.miny,
                    'maxx': bbox.maxx,
                    'maxy': bbox.maxy
                });
                
                const response = await fetch(`${apiUrl}?${params}`);
                const geojson = await response.json();
                
                const layerStyle = getLayerStyle(layerId);
                
                const layerGroup = L.geoJSON(geojson, {
                    style: function(feature) {
                        return {
                            color: layerStyle.color,
                            weight: layerStyle.weight,
                            fillColor: layerStyle.fillColor,
                            fillOpacity: layerStyle.fillOpacity,
                            dashArray: layerStyle.dashArray || null
                        };
                    },
                    pointToLayer: function(feature, latlng) {
                        return L.circleMarker(latlng, {
                            radius: layerId === 'sonoma_schools' ? 6 : 4,
                            fillColor: layerStyle.pointColor,
                            color: '#fff',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: layerStyle.fillOpacity || 0.7
                        });
                    },
                    onEachFeature: function(feature, layer) {
                        if (feature.properties) {
                            const props = feature.properties;
                            let popupContent = `<div style="font-size: 11px; max-width: 200px;">`;
                            popupContent += `<strong>${layerConfig.name}</strong><br>`;
                            
                            const keys = Object.keys(props).slice(0, 5);
                            keys.forEach(key => {
                                if (props[key] !== null && props[key] !== '') {
                                    popupContent += `<strong>${key}:</strong> ${props[key]}<br>`;
                                }
                            });
                            popupContent += `</div>`;
                            layer.bindPopup(popupContent);
                        }
                    }
                });
                
                layerGroup.addTo(map);
                activeGISLayers[layerId] = layerGroup;
                
                const featureCount = geojson.features ? geojson.features.length : 0;
                console.log(`${layerConfig.name}: Loaded ${featureCount} features`);
                
                const label = document.getElementById(`label-${layerId}`);
                label.innerHTML = layerConfig.name;
                
                addLayerPill(layerId, layerConfig.name, layerStyle.color);
                
            } catch (error) {
                console.error(`Error loading layer ${layerId}:`, error);
                const label = document.getElementById(`label-${layerId}`);
                const layerConfig = gisLayersData.find(l => l.id === layerId);
                label.innerHTML = `${layerConfig.name} <span style="color: #ff4444;">⚠</span>`;
                
                document.getElementById(`layer-${layerId}`).checked = false;
            }
        }
        
        async function loadProjectStructure() {
            try {
                const res = await fetch('/api/map-viewer/project-structure');
                const data = await res.json();

                projectsData = data.projects || [];

                console.log(`Loaded ${projectsData.length} projects`);

                // Check if there's an active project and load it
                const activeProject = projectContext.getActiveProject();
                if (activeProject) {
                    handleActiveProjectChange(activeProject);
                }
            } catch (e) {
                console.error('Error loading project structure:', e);
                document.getElementById('active-project-info').innerHTML =
                    '<i class="fas fa-exclamation-triangle"></i> Error loading projects';
                document.getElementById('project-layers-container').innerHTML =
                    '<div style="color: #ff4444; text-align: center; padding: 10px;">Error loading projects</div>';
            }
        }

        function handleActiveProjectChange(project) {
            const infoDiv = document.getElementById('active-project-info');

            if (!project || !project.project_id) {
                infoDiv.innerHTML = '<i class="fas fa-info-circle"></i> Select a project from the header above';
                selectProject(null);
                return;
            }

            infoDiv.innerHTML = `<strong>${project.project_name || 'Unnamed Project'}</strong>`;
            selectProject(project.project_id);
        }
        
        function changeBasemap(id) {
            Object.values(basemaps).forEach(l => map.removeLayer(l));
            currentBasemap = basemaps[id];
            currentBasemap.addTo(map);
        }
        
        function toggleBasemap() {
            const checked = document.getElementById('basemap-toggle').checked;
            if (checked) {
                if (currentBasemap) {
                    currentBasemap.addTo(map);
                }
            } else {
                if (currentBasemap && map.hasLayer(currentBasemap)) {
                    map.removeLayer(currentBasemap);
                }
            }
        }
        
        async function selectProject(projectId) {
            if (!projectId) {
                selectedProject = null;
                document.getElementById('btn-zoom-project').disabled = true;
                document.getElementById('project-layers-container').innerHTML = 
                    '<div style="color: #888; text-align: center; padding: 10px;">Select a project to view layers</div>';
                
                Object.values(activeEntityLayers).forEach(layer => map.removeLayer(layer));
                activeEntityLayers = {};
                return;
            }
            
            selectedProject = projectsData.find(p => p.project_id === projectId);
            if (!selectedProject) return;
            
            document.getElementById('btn-zoom-project').disabled = false;
            
            Object.values(activeEntityLayers).forEach(layer => map.removeLayer(layer));
            activeEntityLayers = {};
            
            await loadProjectLayers(projectId);
        }
        
        async function loadProjectLayers(projectId) {
            const container = document.getElementById('project-layers-container');
            
            try {
                container.innerHTML = '<div style="text-align: center; padding: 10px;"><i class="fas fa-spinner fa-spin"></i> Loading layers...</div>';
                
                const res = await fetch(`/api/map-viewer/project-layers/${projectId}`);
                const data = await res.json();
                
                if (!data.layers || data.layers.length === 0) {
                    container.innerHTML = '<div style="color: #888; text-align: center; padding: 10px;">No layers found in this project</div>';
                    return;
                }
                
                container.innerHTML = data.layers.map(layer => `
                    <div class="layer-item">
                        <input type="checkbox" id="layer-${layer.layer_name}" 
                               onchange="toggleProjectLayer('${projectId}', '${layer.layer_name}', this.checked)">
                        <label class="layer-item-label" for="layer-${layer.layer_name}">
                            ${layer.layer_name}
                            <span class="layer-item-count">(${layer.entity_count})</span>
                        </label>
                    </div>
                `).join('');
                
                console.log(`Loaded ${data.layers.length} layers for project ${projectId}`);
            } catch (error) {
                console.error('Error loading project layers:', error);
                container.innerHTML = '<div style="color: #ff4444; text-align: center; padding: 10px;">Error loading layers</div>';
            }
        }
        
        function stripZCoordinates(geojson) {
            const processCoordinates = (coords) => {
                if (typeof coords[0] === 'number') {
                    return [coords[0], coords[1]];
                }
                return coords.map(processCoordinates);
            };
            
            const cleanedGeoJSON = JSON.parse(JSON.stringify(geojson));
            cleanedGeoJSON.features.forEach(feature => {
                if (feature.geometry && feature.geometry.coordinates) {
                    feature.geometry.coordinates = processCoordinates(feature.geometry.coordinates);
                }
            });
            
            return cleanedGeoJSON;
        }
        
        async function toggleProjectLayer(projectId, layerName, checked) {
            const layerKey = `${projectId}_${layerName}`;
            
            if (checked) {
                try {
                    console.log(`Loading layer ${layerName} for project ${projectId}...`);
                    
                    const checkbox = document.getElementById(`layer-${layerName}`);
                    const label = checkbox.nextElementSibling;
                    const originalHTML = label.innerHTML;
                    label.innerHTML = originalHTML.replace('</span>', ' <i class="fas fa-spinner fa-spin layer-loading"></i></span>');
                    
                    const res = await fetch(`/api/map-viewer/project-entities/${projectId}?layer=${encodeURIComponent(layerName)}`);
                    const geojson = await res.json();
                    
                    label.innerHTML = originalHTML;
                    
                    if (!geojson.features || geojson.features.length === 0) {
                        console.log(`No entities found in layer ${layerName}`);
                        checkbox.checked = false;
                        alert(`No entities found in layer "${layerName}"`);
                        return;
                    }
                    
                    const firstFeature = geojson.features[0];
                    if (firstFeature && firstFeature.properties && firstFeature.properties.srid === 0) {
                        alert(`⚠️ Local CAD Coordinates Detected\n\nLayer "${layerName}" uses local CAD coordinates (SRID 0) and cannot be displayed on a geographic map.\n\nFound ${geojson.features.length} entities.\n\nTo view these entities:\n• Export to DXF and open in AutoCAD\n• Or use a CAD viewer that supports local coordinates`);
                        console.log(`Layer ${layerName} uses SRID 0 (local coordinates) - cannot display on geographic map`);
                        checkbox.checked = false;
                        return;
                    }
                    
                    const cleanedGeoJSON = stripZCoordinates(geojson);
                    
                    const aciColors = {
                        1: '#FF0000',
                        2: '#FFFF00',
                        3: '#00FF00',
                        4: '#00FFFF',
                        5: '#0000FF',
                        6: '#FF00FF',
                        7: '#FFFFFF',
                        8: '#808080',
                        9: '#C0C0C0',
                        256: '#FF00FF'
                    };
                    
                    const entitiesLayer = L.geoJSON(cleanedGeoJSON, {
                        style: function(feature) {
                            const props = feature.properties;
                            let color = aciColors[props.color_aci];
                            
                            if (!color && props.layer_color) {
                                color = aciColors[props.layer_color];
                            }
                            
                            if (!color || color === '#FFFFFF') {
                                color = '#FF00FF';
                            }
                            
                            return {
                                color: color,
                                weight: props.lineweight ? Math.max(1, props.lineweight / 100) : 1,
                                opacity: props.transparency ? 1 - (props.transparency / 255) : 1
                            };
                        },
                        pointToLayer: function(feature, latlng) {
                            const props = feature.properties;
                            let color = aciColors[props.color_aci];
                            
                            if (!color && props.layer_color) {
                                color = aciColors[props.layer_color];
                            }
                            
                            if (!color || color === '#FFFFFF') {
                                color = '#FF00FF';
                            }
                            
                            return L.circleMarker(latlng, {
                                radius: 3,
                                fillColor: color,
                                color: color,
                                weight: 1,
                                opacity: props.transparency ? 1 - (props.transparency / 255) : 1,
                                fillOpacity: 0.8
                            });
                        },
                        onEachFeature: function(feature, layer) {
                            const props = feature.properties;
                            layer.bindPopup(`
                                <div style="font-size: 11px;">
                                    <strong>Entity: ${props.entity_type}</strong><br>
                                    <strong>Layer:</strong> ${props.layer_name || 'N/A'}<br>
                                    ${props.linetype ? `<strong>Linetype:</strong> ${props.linetype}<br>` : ''}
                                    ${props.color_aci ? `<strong>Color:</strong> ACI ${props.color_aci}<br>` : ''}
                                </div>
                            `);
                        }
                    });
                    
                    entitiesLayer.addTo(map);
                    activeEntityLayers[layerKey] = entitiesLayer;
                    
                    console.log(`Loaded ${geojson.features.length} entities from layer ${layerName}`);
                    
                } catch (error) {
                    console.error(`Error loading layer ${layerName}:`, error);
                    const checkbox = document.getElementById(`layer-${layerName}`);
                    checkbox.checked = false;
                    alert(`Error loading layer "${layerName}": ${error.message}`);
                }
            } else {
                if (activeEntityLayers[layerKey]) {
                    map.removeLayer(activeEntityLayers[layerKey]);
                    delete activeEntityLayers[layerKey];
                    console.log(`Removed layer ${layerName}`);
                }
            }
        }
        
        function zoomToProject() {
            if (!selectedProject) {
                console.error('No project selected');
                alert('Please select a project first');
                return;
            }
            
            if (!selectedProject.bbox) {
                console.error('Project has no bounding box defined');
                alert(`Project "${selectedProject.project_name}" has no spatial extent defined. Add drawings with geometry first.`);
                return;
            }
            
            const bbox = selectedProject.bbox;
            
            const minX = parseFloat(bbox.min_x);
            const minY = parseFloat(bbox.min_y);
            const maxX = parseFloat(bbox.max_x);
            const maxY = parseFloat(bbox.max_y);
            
            if (!isFinite(minX) || !isFinite(minY) || !isFinite(maxX) || !isFinite(maxY)) {
                console.error('Invalid bbox values:', bbox);
                alert(`Project "${selectedProject.project_name}" has invalid spatial coordinates.`);
                return;
            }
            
            const sw = proj4('EPSG:2226', 'EPSG:4326', [minX, minY]);
            const ne = proj4('EPSG:2226', 'EPSG:4326', [maxX, maxY]);
            
            map.fitBounds([
                [sw[1], sw[0]],
                [ne[1], ne[0]]
            ]);
            
            console.log(`Zoomed to project: ${selectedProject.project_name}`);
        }
        
        function drawProjectAreas() {
            const rectangles = [];
            
            projectsData.forEach(project => {
                if (!project.bbox) return;
                
                const bbox = project.bbox;
                const minX = parseFloat(bbox.min_x);
                const minY = parseFloat(bbox.min_y);
                const maxX = parseFloat(bbox.max_x);
                const maxY = parseFloat(bbox.max_y);
                
                if (!isFinite(minX) || !isFinite(minY) || !isFinite(maxX) || !isFinite(maxY)) {
                    return;
                }
                
                const sw = proj4('EPSG:2226', 'EPSG:4326', [minX, minY]);
                const ne = proj4('EPSG:2226', 'EPSG:4326', [maxX, maxY]);
                
                const rectangle = L.rectangle(
                    [[sw[1], sw[0]], [ne[1], ne[0]]],
                    {
                        color: '#FF8C00',
                        weight: 2,
                        dashArray: '5, 10',
                        fillOpacity: 0.1,
                        fillColor: '#FF8C00'
                    }
                );
                
                rectangle.bindPopup(`
                    <div style="font-size: 11px;">
                        <strong>${project.project_name}</strong><br>
                        Drawings: ${project.drawings.length}
                    </div>
                `);
                
                rectangles.push(rectangle);
            });
            
            return L.layerGroup(rectangles);
        }
        
        function toggleProjectAreas(checked) {
            if (checked) {
                if (!projectAreasLayer) {
                    projectAreasLayer = drawProjectAreas();
                }
                projectAreasLayer.addTo(map);
            } else {
                if (projectAreasLayer) {
                    map.removeLayer(projectAreasLayer);
                }
            }
        }
        
        async function searchAddress() {
            const addr = document.getElementById('search-input').value;
            const status = document.getElementById('search-status');
            if (!addr) return;
            
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr + ', Sonoma County, CA')}`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.length > 0) {
                    map.setView([parseFloat(data[0].lat), parseFloat(data[0].lon)], 16);
                    status.innerHTML = '<span style="color: #0f0;"><i class="fas fa-check"></i> Found!</span>';
                    setTimeout(() => status.innerHTML = '', 3000);
                } else {
                    status.innerHTML = '<span style="color: #f00;"><i class="fas fa-times"></i> Not found</span>';
                }
            } catch (e) {
                status.innerHTML = '<span style="color: #f00;"><i class="fas fa-exclamation-triangle"></i> Error</span>';
            }
        }
        
        function measureDistance() {
            if (!map || !measureLayer) return;
            measureMode = 'distance';
            measurePoints = [];
            document.getElementById('btn-distance').classList.add('active');
            document.getElementById('btn-area').classList.remove('active');
            map.getContainer().style.cursor = 'crosshair';
        }
        
        function measureArea() {
            if (!map || !measureLayer) return;
            measureMode = 'area';
            measurePoints = [];
            document.getElementById('btn-area').classList.add('active');
            document.getElementById('btn-distance').classList.remove('active');
            map.getContainer().style.cursor = 'crosshair';
        }
        
        function startDrawingRectangle() {
            console.log('Starting rectangle drawing...');
            if (!map) {
                alert('Map not ready');
                return;
            }
            new L.Draw.Rectangle(map, {
                shapeOptions: {
                    color: '#00ffff',
                    weight: 2,
                    fillOpacity: 0.1
                }
            }).enable();
            console.log('Rectangle drawing enabled');
        }
        
        function clearMeasurements() {
            if (!measureLayer) return;
            measureLayer.clearLayers();
            measureMode = null;
            measurePoints = [];
            if (map) map.getContainer().style.cursor = '';
            document.getElementById('btn-distance').classList.remove('active');
            document.getElementById('btn-area').classList.remove('active');
        }
        
        function openExportModal() {
            const layers = drawnItems.getLayers();
            if (layers.length === 0) {
                alert('Please draw a rectangle on the map first');
                return;
            }
            
            const selectedLayers = [];
            gisLayersData.forEach(layer => {
                const checkbox = document.getElementById(`layer-${layer.id}`);
                if (checkbox && checkbox.checked) {
                    selectedLayers.push(layer.id);
                }
            });
            
            if (selectedLayers.length === 0) {
                alert('Please select at least one GIS layer to export');
                return;
            }
            
            document.getElementById('export-modal').classList.add('active');
        }
        
        function closeExportModal() {
            document.getElementById('export-modal').classList.remove('active');
        }
        
        async function startExport() {
            const formats = [];
            if (document.getElementById('format-png').checked) formats.push('png');
            if (document.getElementById('format-shp').checked) formats.push('shp');
            if (document.getElementById('format-dxf').checked) formats.push('dxf');
            if (document.getElementById('format-kml').checked) formats.push('kml');
            
            if (formats.length === 0) {
                alert('Please select at least one export format');
                return;
            }
            
            const pngOptions = {
                north_arrow: document.getElementById('png-north-arrow').checked,
                scale_bar: document.getElementById('png-scale-bar').checked
            };
            
            const layers = drawnItems.getLayers();
            const bbox = layers[0].getBounds();
            
            const selectedLayers = [];
            gisLayersData.forEach(layer => {
                const checkbox = document.getElementById(`layer-${layer.id}`);
                if (checkbox && checkbox.checked) {
                    selectedLayers.push(layer.id);
                }
            });
            
            const activeEntityLayersList = Object.keys(activeEntityLayers).map(key => {
                const [drawingId, entityType] = key.split('_');
                return { drawingId, entityType };
            });
            
            const params = {
                bbox: {
                    minx: bbox.getWest(),
                    miny: bbox.getSouth(),
                    maxx: bbox.getEast(),
                    maxy: bbox.getNorth(),
                    crs: 'EPSG:4326'
                },
                layers: selectedLayers,
                entity_layers: activeEntityLayersList,
                formats: formats,
                png_options: pngOptions
            };
            
            console.log('Creating multi-format export...');
            console.log('Export params:', params);
            
            closeExportModal();
            
            try {
                const res = await fetch('/api/map-export/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });
                const data = await res.json();
                
                if (data.status === 'complete') {
                    let msg = `Export successful!\n\n`;
                    msg += `Formats created: ${formats.join(', ').toUpperCase()}\n`;
                    
                    if (data.feature_counts) {
                        msg += `\nFeatures exported:\n`;
                        for (const [layer, count] of Object.entries(data.feature_counts)) {
                            msg += `  ${layer}: ${count}\n`;
                        }
                        msg += `\nTotal: ${Object.values(data.feature_counts).reduce((a,b)=>a+b, 0)} features\n`;
                    }
                    
                    msg += `\nCoordinate System: EPSG:2226 (CA State Plane Zone 2)\n`;
                    msg += `\nClick OK to download the ZIP file.`;
                    
                    alert(msg);
                    window.location.href = data.download_url;
                } else {
                    alert('Export failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Export error:', e);
                alert('Export error: ' + e.message);
            }
        }
        
        async function pollExport(jobId) {
            const check = async () => {
                const res = await fetch(`/api/map-export/status/${jobId}`);
                const data = await res.json();
                
                if (data.status === 'complete') {
                    console.log('Export complete! Download:', data.download_url);
                    alert('Export complete!\n\nDownload: ' + data.download_url);
                    window.open(data.download_url, '_blank');
                } else if (data.status === 'failed') {
                    alert('Export failed: ' + data.error);
                } else {
                    console.log('Export processing...');
                    setTimeout(check, 2000);
                }
            };
            check();
        }
    </script>
{% endblock %}
