<!DOCTYPE html>
<html>
<head>
    <title>Map Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #001428;
            color: white;
        }
        
        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }
        
        .sidebar {
            width: 300px;
            background: #002040;
            border-right: 3px solid #00ffff;
            padding: 20px;
            overflow-y: auto;
        }
        
        .map-area {
            flex: 1;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .section {
            background: #003060;
            border: 1px solid #0080ff;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .section h3 {
            color: #00ffff;
            font-size: 13px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: #0066cc;
            border: 1px solid #0080ff;
            color: white;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }
        
        button:hover { background: #0088ff; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        button.active { background: #00ffff; color: #000; }
        
        input, select {
            width: 100%;
            padding: 8px;
            background: #001428;
            border: 1px solid #0080ff;
            color: white;
            border-radius: 3px;
            margin-bottom: 10px;
        }
        
        .coord-display {
            background: #001428;
            border: 1px solid #0080ff;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
        }
        
        .project-info {
            background: #001a33;
            border: 2px solid #00ffff;
            padding: 12px;
            border-radius: 5px;
            font-size: 11px;
            line-height: 1.6;
        }
        
        .project-info strong {
            color: #00ffff;
            display: block;
            margin-bottom: 2px;
        }
        
        .project-info .value {
            color: #fff;
            margin-bottom: 8px;
        }
        
        .coming-soon {
            color: #888;
            font-size: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2 style="color: #00ffff; margin-bottom: 20px;">Map Viewer</h2>
            
            <div class="section">
                <h3><i class="fas fa-map-marked-alt"></i> Project Location</h3>
                <div class="project-info">
                    <strong>State Plane Zone</strong>
                    <div class="value">CA Zone 2 (EPSG:2226)</div>
                    
                    <strong>County</strong>
                    <div class="value">Sonoma County</div>
                    
                    <strong>Units</strong>
                    <div class="value">US Survey Feet</div>
                    
                    <div class="coming-soon">
                        <i class="fas fa-lock"></i> Zone/County selection coming soon
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-map"></i> Basemap</h3>
                <select id="basemap-select" onchange="changeBasemap(this.value)">
                    <option value="osm">OpenStreetMap</option>
                    <option value="topo">USGS Topo</option>
                    <option value="imagery">ESRI Imagery</option>
                </select>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-project-diagram"></i> DXF Projects</h3>
                <button id="btn-toggle-projects" onclick="toggleProjects()" class="active">
                    <i class="fas fa-eye"></i> Show Projects
                </button>
                <div id="project-count" style="color: #888; font-size: 11px; margin-top: 5px;">
                    Loading projects...
                </div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-layer-group"></i> GIS Layers</h3>
                <div id="gis-layers-container" style="font-size: 11px; max-height: 200px; overflow-y: auto;">
                    Loading layers...
                </div>
                <div id="gis-status" style="color: #888; font-size: 10px; margin-top: 5px;">
                    Ready to load layers
                </div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-search"></i> Search</h3>
                <input type="text" id="search-input" placeholder="Address in Sonoma County"
                       onkeypress="if(event.key==='Enter') searchAddress()">
                <button onclick="searchAddress()"><i class="fas fa-search"></i> Search</button>
                <div id="search-status"></div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-ruler"></i> Measurements</h3>
                <button id="btn-distance" onclick="measureDistance()">
                    <i class="fas fa-ruler-horizontal"></i> Distance
                </button>
                <button id="btn-area" onclick="measureArea()">
                    <i class="fas fa-draw-polygon"></i> Area
                </button>
                <button onclick="clearMeasurements()">
                    <i class="fas fa-trash"></i> Clear
                </button>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-file-export"></i> Export</h3>
                <button id="export-btn" onclick="openExportModal()" disabled>
                    <i class="fas fa-download"></i> Create Export
                </button>
                <small style="color: #888;">Draw rectangle on map first</small>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-crosshairs"></i> Coordinates</h3>
                <div class="coord-display" id="coords">
                    Move mouse over map...
                </div>
            </div>
        </div>
        
        <div class="map-area">
            <div id="map"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    
    <script>
        let map, basemaps, drawnItems, measureLayer, measureMode, measurePoints;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing simple map...');
            
            // Define State Plane projection
            proj4.defs("EPSG:2226", "+proj=lcc +lat_1=39.83333333333334 +lat_2=38.33333333333334 +lat_0=37.66666666666666 +lon_0=-122 +x_0=2000000.0001016 +y_0=500000.0001016001 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048006096012192 +no_defs");
            
            // Create map
            map = L.map('map').setView([38.5, -122.8], 10);
            
            // Initialize measurement variables
            measureMode = null;
            measurePoints = [];
            measureLayer = new L.FeatureGroup().addTo(map);
            
            // Basemaps
            basemaps = {
                osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap',
                    maxZoom: 19
                }),
                topo: L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'USGS',
                    maxZoom: 16
                }),
                imagery: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'ESRI',
                    maxZoom: 19
                })
            };
            
            basemaps.osm.addTo(map);
            
            // Drawing layer
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // Draw controls
            const drawControl = new L.Control.Draw({
                position: 'topright',
                draw: {
                    rectangle: true,
                    polygon: false,
                    polyline: false,
                    circle: false,
                    marker: false,
                    circlemarker: false
                },
                edit: {
                    featureGroup: drawnItems
                }
            });
            map.addControl(drawControl);
            
            // Draw events
            map.on('draw:created', function(e) {
                drawnItems.clearLayers();
                drawnItems.addLayer(e.layer);
                document.getElementById('export-btn').disabled = false;
                console.log('Rectangle drawn');
            });
            
            // Coordinate display
            map.on('mousemove', function(e) {
                const [x, y] = proj4('EPSG:4326', 'EPSG:2226', [e.latlng.lng, e.latlng.lat]);
                document.getElementById('coords').innerHTML = `
                    Lat/Lng: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}<br>
                    State Plane: ${x.toFixed(2)}, ${y.toFixed(2)} ft
                `;
            });
            
            // Measurement click handler
            map.on('click', function(e) {
                if (!measureMode) return;
                
                measurePoints.push(e.latlng);
                
                if (measureMode === 'distance' && measurePoints.length > 1) {
                    const line = turf.lineString(measurePoints.map(p => [p.lng, p.lat]));
                    const meters = turf.length(line, {units: 'meters'});
                    const feet = meters * 3.28084;
                    const miles = feet / 5280;
                    const label = miles > 0.1 ? `${miles.toFixed(2)} mi` : `${feet.toFixed(0)} ft`;
                    
                    L.polyline(measurePoints, {color: '#00ff00', weight: 3})
                        .addTo(measureLayer)
                        .bindPopup(label)
                        .openPopup();
                }
                
                if (measureMode === 'area' && measurePoints.length >= 3) {
                    const coords = measurePoints.map(p => [p.lng, p.lat]);
                    coords.push(coords[0]);
                    const poly = turf.polygon([coords]);
                    const sqm = turf.area(poly);
                    const sqft = sqm * 10.7639;
                    const acres = sqft / 43560;
                    const label = acres > 0.1 ? `${acres.toFixed(2)} acres` : `${sqft.toFixed(0)} sq ft`;
                    
                    L.polygon(measurePoints, {color: '#00ff00', fillOpacity: 0.2})
                        .addTo(measureLayer)
                        .bindPopup(label)
                        .openPopup();
                }
            });
            
            map.on('dblclick', function() {
                if (measureMode) {
                    setTimeout(clearMeasurements, 100);
                }
            });
            
            // Load data
            loadProjects();
            loadGISLayers();
            
            console.log('Map initialized!');
            setTimeout(() => {
                map.invalidateSize();
                console.log('Map tiles should be visible now');
            }, 100);
        });
        
        let projectsLayer = null;
        let projectsVisible = true;
        let projectColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#95afc0', '#c56cf0', '#ffbe76'];
        let gisLayersData = [];
        
        async function loadGISLayers() {
            try {
                const res = await fetch('/api/map-viewer/layers');
                const data = await res.json();
                gisLayersData = data.layers || [];
                
                const container = document.getElementById('gis-layers-container');
                if (gisLayersData.length === 0) {
                    container.innerHTML = '<div style="color: #888;">No layers available</div>';
                    return;
                }
                
                container.innerHTML = gisLayersData
                    .filter(layer => layer.enabled)
                    .map(layer => `
                        <label style="display: block; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="layer-${layer.id}" 
                                   onchange="toggleLayerSelection('${layer.id}', this.checked)" 
                                   ${layer.id === 'sonoma_parcels_public' || layer.id === 'sonoma_buildings' ? 'checked' : ''}>
                            <span style="margin-left: 5px;">${layer.name}</span>
                        </label>
                    `).join('');
                
            } catch (error) {
                console.error('Error loading GIS layers:', error);
                document.getElementById('gis-layers-container').innerHTML = 
                    '<div style="color: #ff4444;">Error loading layers</div>';
            }
        }
        
        function toggleLayerSelection(layerId, checked) {
            console.log(`Layer ${layerId} ${checked ? 'selected' : 'deselected'}`);
        }
        
        async function loadProjects() {
            try {
                const res = await fetch('/api/map-viewer/projects');
                const data = await res.json();
                
                if (data.features && data.features.length > 0) {
                    projectsLayer = L.featureGroup();
                    
                    data.features.forEach((feature, idx) => {
                        const coords = feature.geometry.coordinates[0];
                        const color = projectColors[idx % projectColors.length];
                        
                        // Transform State Plane to WGS84
                        const transformedCoords = coords.map(([x, y]) => {
                            const [lng, lat] = proj4('EPSG:2226', 'EPSG:4326', [x, y]);
                            return [lat, lng];
                        });
                        
                        const polygon = L.polygon(transformedCoords, {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.3,
                            weight: 2
                        });
                        
                        const props = feature.properties;
                        polygon.bindPopup(`
                            <div style="font-size: 12px;">
                                <strong style="color: ${color};">${props.drawing_name || 'Untitled'}</strong><br>
                                <strong>Project:</strong> ${props.project_name || 'N/A'}<br>
                                ${props.client_name ? `<strong>Client:</strong> ${props.client_name}<br>` : ''}
                                ${props.drawing_number ? `<strong>Number:</strong> ${props.drawing_number}<br>` : ''}
                                <strong>EPSG:</strong> ${props.epsg_code}<br>
                                <strong>Georeferenced:</strong> ${props.is_georeferenced ? 'Yes' : 'No'}
                            </div>
                        `);
                        
                        projectsLayer.addLayer(polygon);
                    });
                    
                    projectsLayer.addTo(map);
                    document.getElementById('project-count').textContent = 
                        `${data.features.length} project${data.features.length !== 1 ? 's' : ''} found`;
                } else {
                    document.getElementById('project-count').textContent = 'No projects with spatial data';
                }
            } catch (e) {
                console.error('Error loading projects:', e);
                document.getElementById('project-count').textContent = 'Error loading projects';
            }
        }
        
        function toggleProjects() {
            if (!projectsLayer) return;
            
            projectsVisible = !projectsVisible;
            const btn = document.getElementById('btn-toggle-projects');
            
            if (projectsVisible) {
                projectsLayer.addTo(map);
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-eye"></i> Show Projects';
            } else {
                map.removeLayer(projectsLayer);
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Projects';
            }
        }
        
        function changeBasemap(id) {
            Object.values(basemaps).forEach(l => map.removeLayer(l));
            basemaps[id].addTo(map);
        }
        
        async function searchAddress() {
            const addr = document.getElementById('search-input').value;
            const status = document.getElementById('search-status');
            if (!addr) return;
            
            status.innerHTML = 'Searching...';
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr + ', Sonoma County, CA')}`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.length > 0) {
                    map.setView([parseFloat(data[0].lat), parseFloat(data[0].lon)], 16);
                    L.marker([parseFloat(data[0].lat), parseFloat(data[0].lon)])
                        .addTo(map)
                        .bindPopup(data[0].display_name)
                        .openPopup();
                    status.innerHTML = '<span style="color: #0f0;">Found!</span>';
                } else {
                    status.innerHTML = '<span style="color: #f00;">Not found</span>';
                }
            } catch (e) {
                status.innerHTML = '<span style="color: #f00;">Error</span>';
            }
        }
        
        function measureDistance() {
            if (!map || !measureLayer) return;
            measureMode = 'distance';
            measurePoints = [];
            document.getElementById('btn-distance').classList.add('active');
            document.getElementById('btn-area').classList.remove('active');
            map.getContainer().style.cursor = 'crosshair';
        }
        
        function measureArea() {
            if (!map || !measureLayer) return;
            measureMode = 'area';
            measurePoints = [];
            document.getElementById('btn-area').classList.add('active');
            document.getElementById('btn-distance').classList.remove('active');
            map.getContainer().style.cursor = 'crosshair';
        }
        
        function clearMeasurements() {
            if (!measureLayer) return;
            measureLayer.clearLayers();
            measureMode = null;
            measurePoints = [];
            if (map) map.getContainer().style.cursor = '';
            document.getElementById('btn-distance').classList.remove('active');
            document.getElementById('btn-area').classList.remove('active');
        }
        
        async function openExportModal() {
            const layers = drawnItems.getLayers();
            if (layers.length === 0) {
                alert('Please draw a rectangle on the map first');
                return;
            }
            
            const selectedLayers = [];
            gisLayersData.forEach(layer => {
                const checkbox = document.getElementById(`layer-${layer.id}`);
                if (checkbox && checkbox.checked) {
                    selectedLayers.push(layer.id);
                }
            });
            
            if (selectedLayers.length === 0) {
                alert('Please select at least one GIS layer to export');
                return;
            }
            
            const bbox = layers[0].getBounds();
            const params = {
                bbox: {
                    minx: bbox.getWest(),
                    miny: bbox.getSouth(),
                    maxx: bbox.getEast(),
                    maxy: bbox.getNorth(),
                    crs: 'EPSG:4326'
                },
                layers: selectedLayers
            };
            
            console.log('Creating simple shapefile export...');
            
            try {
                const res = await fetch('/api/map-export/create-simple', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });
                const data = await res.json();
                
                if (data.status === 'complete') {
                    let msg = `Export successful!\n\n`;
                    
                    if (data.feature_counts) {
                        msg += `Features exported:\n`;
                        for (const [layer, count] of Object.entries(data.feature_counts)) {
                            msg += `  ${layer}: ${count}\n`;
                        }
                        msg += `\nTotal: ${Object.values(data.feature_counts).reduce((a,b)=>a+b, 0)} features\n`;
                    }
                    
                    msg += `\nCoordinate System: EPSG:2226 (CA State Plane Zone 2)\n`;
                    msg += `\nClick OK to download the ZIP file.`;
                    
                    alert(msg);
                    window.location.href = data.download_url;
                } else {
                    alert('Export failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Export error:', e);
                alert('Export error: ' + e.message);
            }
        }
        
        async function pollExport(jobId) {
            const check = async () => {
                const res = await fetch(`/api/map-export/status/${jobId}`);
                const data = await res.json();
                
                if (data.status === 'complete') {
                    console.log('Export complete! Download:', data.download_url);
                    alert('Export complete!\n\nDownload: ' + data.download_url);
                    window.open(data.download_url, '_blank');
                } else if (data.status === 'failed') {
                    alert('Export failed: ' + data.error);
                } else {
                    console.log('Export processing...');
                    setTimeout(check, 2000);
                }
            };
            check();
        }
    </script>
</body>
</html>
