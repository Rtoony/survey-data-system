{% extends "base_specialized_tool.html" %}

{% block tool_title %}Pavement Zone Analyzer{% endblock %}
{% block tool_icon %}fas fa-layer-group{% endblock %}
{% block tool_description %}Display overlay of distinct pavement zones with colorful hatches. Reports square footage and area numbers.{% endblock %}

{% block content_layout_class %}tool-complex-layout{% endblock %}

{% block sidebar_content %}
<div class="tool-info-card">
    <h3><i class="fas fa-layer-group"></i> Pavement Zone Analyzer</h3>
    <p>Analyze pavement zones with area calculations and specification links.</p>
</div>

<div class="tool-filter-section">
    <h4>Pavement Types</h4>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="pavAC" checked>
        <label for="pavAC">Asphalt Concrete</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="pavPCC" checked>
        <label for="pavPCC">Portland Concrete</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="pavGravel" checked>
        <label for="pavGravel">Gravel/Aggregate</label>
    </div>
</div>

<div class="tool-stats-section">
    <h4>Area Summary</h4>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total SF:</span>
        <span class="tool-stat-value">0</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total Acres:</span>
        <span class="tool-stat-value">0.00</span>
    </div>
</div>
{% endblock %}

{% block main_content %}
<div class="tool-top-area">
    <!-- Loading State -->
    <div id="loadingState" class="tool-empty-state" style="display:none;">
        <div class="empty-state-icon"><i class="fas fa-spinner fa-spin"></i></div>
        <h3>Loading pavement zones...</h3>
    </div>

    <!-- Error State -->
    <div id="errorState" class="tool-empty-state" style="display:none;">
        <div class="empty-state-icon"><i class="fas fa-exclamation-triangle" style="color: #ff6b6b;"></i></div>
        <h3>Error Loading Data</h3>
        <p id="errorMessage"></p>
        <button class="tool-action-btn" onclick="loadZones()">Retry</button>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="tool-empty-state">
        <div class="empty-state-icon"><i class="fas fa-layer-group"></i></div>
        <h3>No Pavement Zones Found</h3>
        <p>Generate test data or import a DXF file with pavement zone entities.</p>
        <a href="/tools/dxf-test-generator" class="tool-action-btn">Generate Test DXF</a>
    </div>

    <!-- Success State with Map -->
    <div id="successState" style="display:none; padding: 2rem;">
        <h3 style="margin-bottom: 1rem;"><i class="fas fa-map"></i> Pavement Zone Map</h3>
        <div style="background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.2); padding: 1rem; border-radius: 4px;">
            <p style="margin: 0;">Interactive map visualization coming soon...</p>
        </div>
    </div>
</div>

<div class="tool-resizer"></div>

<div class="tool-bottom-area">
    <div class="tool-data-tabs">
        <button class="tool-data-tab active" onclick="showTab('zones')">Zones</button>
        <button class="tool-data-tab" onclick="showTab('stats')">Statistics</button>
    </div>
    <div class="tool-data-content">
        <!-- Zones Tab -->
        <div id="zonesTab" class="tab-content">
            <table id="zonesTable" class="mc-table" style="display:none;">
                <thead>
                    <tr>
                        <th>Zone Name</th>
                        <th>Type</th>
                        <th>Area (sqft)</th>
                        <th>Thickness (in)</th>
                        <th>Material Spec</th>
                        <th>Traffic Category</th>
                        <th>Condition</th>
                    </tr>
                </thead>
                <tbody id="zonesTableBody"></tbody>
            </table>
        </div>

        <!-- Stats Tab -->
        <div id="statsTab" class="tab-content" style="display:none;">
            <div id="statsContent" style="padding: 2rem;">
                <h4 style="margin-bottom: 1rem;">Summary Statistics</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="stat-card">
                        <div class="stat-label">Total Zones</div>
                        <div class="stat-value" id="statTotalZones">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Area (sqft)</div>
                        <div class="stat-value" id="statTotalArea">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Area (acres)</div>
                        <div class="stat-value" id="statTotalAcres">0.00</div>
                    </div>
                </div>
                <h4 style="margin: 2rem 0 1rem 0;">By Pavement Type</h4>
                <div id="byType"></div>
            </div>
        </div>
    </div>
</div>

<style>
.tab-content { padding: 1rem; }
.stat-card {
    background: rgba(0,255,255,0.05);
    border: 1px solid rgba(0,255,255,0.2);
    padding: 1.5rem;
    border-radius: 4px;
    text-align: center;
}
.stat-label {
    font-size: 0.9rem;
    color: var(--text-dim);
    margin-bottom: 0.5rem;
}
.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--accent-color);
}
</style>

<script>
let currentData = [];
let currentTab = 'zones';

// Show specific tab
function showTab(tabName) {
    currentTab = tabName;
    document.getElementById('zonesTab').style.display = tabName === 'zones' ? 'block' : 'none';
    document.getElementById('statsTab').style.display = tabName === 'stats' ? 'block' : 'none';

    // Update active tab button
    const tabs = document.querySelectorAll('.tool-data-tab');
    tabs.forEach((tab, i) => {
        tab.classList.toggle('active', (i === 0 && tabName === 'zones') || (i === 1 && tabName === 'stats'));
    });
}

// Load zones data
async function loadZones() {
    showState('loading');

    try {
        // Get active project from global context
        const activeProject = window.projectContext ?
            await window.projectContext.getActiveProject() : null;

        if (!activeProject) {
            showError('No active project selected. Please select a project from the dashboard.');
            showState('error', 'No active project selected');
            return;
        }

        const response = await fetch(`/api/specialized-tools/pavement-zones?project_id=${activeProject.project_id}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

        const data = await response.json();

        if (!data.success) {
            showError(data.error || 'Failed to load pavement zones');
            showState('error', data.error || 'Failed to load data');
            return;
        }

        currentData = data;

        if (!data.zones || data.zones.length === 0) {
            showState('empty');
            return;
        }

        renderZonesTable(data.zones);
        renderStats(data.stats);
        showState('success');

    } catch (error) {
        console.error('Error loading zones:', error);
        showError('Failed to load pavement zones: ' + error.message);
        showState('error', error.message);
    }
}

// Render zones table
function renderZonesTable(zones) {
    const tbody = document.getElementById('zonesTableBody');
    tbody.innerHTML = zones.map(zone => `
        <tr>
            <td>${zone.zone_name || 'N/A'}</td>
            <td>${zone.pavement_type || 'UNKNOWN'}</td>
            <td>${zone.area_sqft?.toFixed(0) || 'N/A'}</td>
            <td>${zone.thickness_inches || 'N/A'}</td>
            <td>${zone.material_spec || 'N/A'}</td>
            <td>${zone.traffic_category || 'N/A'}</td>
            <td>${zone.condition || 'UNKNOWN'}</td>
        </tr>
    `).join('');
    document.getElementById('zonesTable').style.display = 'table';
}

// Render statistics
function renderStats(stats) {
    document.getElementById('statTotalZones').textContent = stats.total_count || 0;
    document.getElementById('statTotalArea').textContent = `${stats.total_area_sqft?.toFixed(0) || 0}`;
    document.getElementById('statTotalAcres').textContent = `${stats.total_area_acres?.toFixed(2) || 0}`;

    // Render by type
    const byType = stats.by_type || {};
    const typeHtml = Object.entries(byType).map(([type, area]) => `
        <div style="padding: 0.75rem; background: rgba(0,255,255,0.03); margin-bottom: 0.5rem; border-radius: 4px; display: flex; justify-content: space-between;">
            <span>${type}</span>
            <span style="color: var(--accent-color); font-weight: bold;">${area.toFixed(0)} sqft</span>
        </div>
    `).join('');
    document.getElementById('byType').innerHTML = typeHtml || '<p>No data</p>';
}

// Show state
function showState(state, message = '') {
    document.getElementById('loadingState').style.display = state === 'loading' ? 'flex' : 'none';
    document.getElementById('errorState').style.display = state === 'error' ? 'flex' : 'none';
    document.getElementById('emptyState').style.display = state === 'empty' ? 'flex' : 'none';
    document.getElementById('successState').style.display = state === 'success' ? 'block' : 'none';

    if (state === 'error') {
        document.getElementById('errorMessage').textContent = message;
    }
}

// Error display function
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: rgba(255,0,0,0.9); color: white; padding: 20px; border-radius: 8px; z-index: 10000; max-width: 400px;';
    errorDiv.innerHTML = `
        <strong>Error:</strong><br>
        ${message}<br><br>
        <button onclick="this.parentElement.remove()" style="background: white; color: black; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Dismiss</button>
    `;
    document.body.appendChild(errorDiv);
}

// Initialize
document.addEventListener('DOMContentLoaded', async function() {
    // Wait for ProjectContext to initialize
    if (window.projectContext) {
        await window.projectContext.init();

        // Subscribe to project changes
        window.projectContext.subscribe(() => {
            console.log('Active project changed, reloading data...');
            loadZones();
        });
    }

    // Initial load
    loadZones();
});
</script>
{% endblock %}

{% block about_tool_description %}
Interactive pavement zone analysis tool that displays visual overlays with colorful hatches for distinct pavement zones. 
Calculates areas in square footage and acres, links to specifications, and generates quantity reports.
{% endblock %}

{% block about_tool_tags %}
<span class="about-tool-tag">PERV</span>
<span class="about-tool-tag">AREA</span>
{% endblock %}

{% block about_tool_examples %}
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-SITE-PERV-PROP-AR</div>
    <div class="about-tool-example-desc">â†’ Proposed Pervious Areas - Civil/Site</div>
</div>
{% endblock %}
