{% extends "base_specialized_tool.html" %}

{% block tool_title %}Street Light Analyzer{% endblock %}
{% block tool_icon %}fas fa-lightbulb{% endblock %}
{% block tool_description %}Analyze distance between lights, generate light radius maps, depicts electrical system underground.{% endblock %}

{% block content_layout_class %}tool-complex-layout{% endblock %}

{% block sidebar_content %}
<div class="tool-info-card">
    <h3><i class="fas fa-lightbulb"></i> Street Light Analyzer</h3>
    <p>Analyze street light spacing, coverage, and electrical infrastructure.</p>
</div>

<div class="tool-filter-section">
    <h4>Analysis Options</h4>
    <div class="tool-filter-item">
        <label>Light Radius (ft):</label>
        <input type="number" value="50" min="10" max="200" style="width: 100%; padding: 0.5rem;">
    </div>
    <div class="tool-filter-item">
        <label>Min Spacing (ft):</label>
        <input type="number" value="100" min="50" max="500" style="width: 100%; padding: 0.5rem;">
    </div>
</div>

<div class="tool-stats-section">
    <h4>Light Stats</h4>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total Lights:</span>
        <span class="tool-stat-value">0</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Avg Spacing:</span>
        <span class="tool-stat-value">0 ft</span>
    </div>
</div>

<button class="tool-action-btn" disabled>
    <i class="fas fa-sync"></i> Analyze Coverage
</button>
{% endblock %}

{% block main_content %}
<div class="tool-top-area">
    <!-- Loading State -->
    <div id="loadingState" class="tool-empty-state" style="display:none;">
        <div class="empty-state-icon"><i class="fas fa-spinner fa-spin"></i></div>
        <h3>Loading street lights...</h3>
    </div>

    <!-- Error State -->
    <div id="errorState" class="tool-empty-state" style="display:none;">
        <div class="empty-state-icon"><i class="fas fa-exclamation-triangle" style="color: #ff6b6b;"></i></div>
        <h3>Error Loading Data</h3>
        <p id="errorMessage"></p>
        <button class="tool-action-btn" onclick="loadLights()">Retry</button>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="tool-empty-state">
        <div class="empty-state-icon"><i class="fas fa-lightbulb"></i></div>
        <h3>No Street Lights Found</h3>
        <p>Generate test data or import a DXF file with street light entities.</p>
        <a href="/tools/dxf-test-generator" class="tool-action-btn">Generate Test DXF</a>
    </div>

    <!-- Success State with Map -->
    <div id="successState" style="display:none; padding: 2rem;">
        <h3 style="margin-bottom: 1rem;"><i class="fas fa-map"></i> Light Coverage Map</h3>
        <div style="background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.2); padding: 1rem; border-radius: 4px;">
            <p style="margin: 0;">Interactive map visualization coming soon...</p>
        </div>
    </div>
</div>

<div class="tool-resizer"></div>

<div class="tool-bottom-area">
    <div class="tool-data-tabs">
        <button class="tool-data-tab active" onclick="showTab('lights')">Lights</button>
        <button class="tool-data-tab" onclick="showTab('stats')">Statistics</button>
    </div>
    <div class="tool-data-content">
        <!-- Lights Tab -->
        <div id="lightsTab" class="tab-content">
            <table id="lightsTable" class="mc-table" style="display:none;">
                <thead>
                    <tr>
                        <th>Pole #</th>
                        <th>Type</th>
                        <th>Wattage</th>
                        <th>Height (ft)</th>
                        <th>Circuit</th>
                        <th>Condition</th>
                        <th>Location (X, Y)</th>
                    </tr>
                </thead>
                <tbody id="lightsTableBody"></tbody>
            </table>
        </div>

        <!-- Stats Tab -->
        <div id="statsTab" class="tab-content" style="display:none;">
            <div id="statsContent" style="padding: 2rem;">
                <h4 style="margin-bottom: 1rem;">Summary Statistics</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="stat-card">
                        <div class="stat-label">Total Lights</div>
                        <div class="stat-value" id="statTotalLights">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Wattage</div>
                        <div class="stat-value" id="statTotalWattage">0 W</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Average Spacing</div>
                        <div class="stat-value" id="statAvgSpacing">0 ft</div>
                    </div>
                </div>
                <h4 style="margin: 2rem 0 1rem 0;">By Lamp Type</h4>
                <div id="byLampType"></div>
            </div>
        </div>
    </div>
</div>

<style>
.tab-content { padding: 1rem; }
.stat-card {
    background: rgba(0,255,255,0.05);
    border: 1px solid rgba(0,255,255,0.2);
    padding: 1.5rem;
    border-radius: 4px;
    text-align: center;
}
.stat-label {
    font-size: 0.9rem;
    color: var(--text-dim);
    margin-bottom: 0.5rem;
}
.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--accent-color);
}
</style>

<script>
let currentData = [];
let currentTab = 'lights';

// Show specific tab
function showTab(tabName) {
    currentTab = tabName;
    document.getElementById('lightsTab').style.display = tabName === 'lights' ? 'block' : 'none';
    document.getElementById('statsTab').style.display = tabName === 'stats' ? 'block' : 'none';

    // Update active tab button
    const tabs = document.querySelectorAll('.tool-data-tab');
    tabs.forEach((tab, i) => {
        tab.classList.toggle('active', (i === 0 && tabName === 'lights') || (i === 1 && tabName === 'stats'));
    });
}

// Load lights data
async function loadLights() {
    showState('loading');

    try {
        const response = await fetch('/api/specialized-tools/street-lights');
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

        const data = await response.json();
        currentData = data;

        if (!data.lights || data.lights.length === 0) {
            showState('empty');
            return;
        }

        renderLightsTable(data.lights);
        renderStats(data.stats);
        showState('success');

    } catch (error) {
        console.error('Error loading lights:', error);
        showState('error', error.message);
    }
}

// Render lights table
function renderLightsTable(lights) {
    const tbody = document.getElementById('lightsTableBody');
    tbody.innerHTML = lights.map(light => `
        <tr>
            <td>${light.pole_number || 'N/A'}</td>
            <td>${light.lamp_type || 'UNKNOWN'}</td>
            <td>${light.wattage || 'N/A'}</td>
            <td>${light.pole_height_ft || 'N/A'}</td>
            <td>${light.circuit_id || 'N/A'}</td>
            <td>${light.condition || 'UNKNOWN'}</td>
            <td>${light.x?.toFixed(1) || 'N/A'}, ${light.y?.toFixed(1) || 'N/A'}</td>
        </tr>
    `).join('');
    document.getElementById('lightsTable').style.display = 'table';
}

// Render statistics
function renderStats(stats) {
    document.getElementById('statTotalLights').textContent = stats.total_count || 0;
    document.getElementById('statTotalWattage').textContent = `${stats.total_wattage || 0} W`;
    document.getElementById('statAvgSpacing').textContent = `${stats.average_spacing_ft || 0} ft`;

    // Render by lamp type
    const byType = stats.by_lamp_type || {};
    const typeHtml = Object.entries(byType).map(([type, count]) => `
        <div style="padding: 0.75rem; background: rgba(0,255,255,0.03); margin-bottom: 0.5rem; border-radius: 4px; display: flex; justify-content: space-between;">
            <span>${type}</span>
            <span style="color: var(--accent-color); font-weight: bold;">${count}</span>
        </div>
    `).join('');
    document.getElementById('byLampType').innerHTML = typeHtml || '<p>No data</p>';
}

// Show state
function showState(state, message = '') {
    document.getElementById('loadingState').style.display = state === 'loading' ? 'flex' : 'none';
    document.getElementById('errorState').style.display = state === 'error' ? 'flex' : 'none';
    document.getElementById('emptyState').style.display = state === 'empty' ? 'flex' : 'none';
    document.getElementById('successState').style.display = state === 'success' ? 'block' : 'none';

    if (state === 'error') {
        document.getElementById('errorMessage').textContent = message;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', loadLights);
</script>
{% endblock %}

{% block about_tool_description %}
Comprehensive street light analysis tool that calculates spacing between lights, generates visual radius coverage maps, 
identifies coverage gaps, and depicts underground electrical infrastructure including conduits and circuits.
{% endblock %}

{% block about_tool_tags %}
<span class="about-tool-tag">POLE</span>
{% endblock %}

{% block about_tool_examples %}
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-SITE-POLE-PROP-PT</div>
    <div class="about-tool-example-desc">â†’ Proposed Light Poles - Civil/Site</div>
</div>
{% endblock %}
