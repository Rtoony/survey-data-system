{% extends "base.html" %}

{% block title %}Blocks Manager - Data Manager{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div>
            <h1><i class="fas fa-cube"></i> Blocks Manager</h1>
            <p class="subtitle">Manage CAD block symbols and definitions</p>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-cube"></i> Block Symbols Library</h2>
            <div class="button-group">
                <button onclick="addNewBlock()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add New
                </button>
                <label for="csvUpload" class="btn btn-secondary">
                    <i class="fas fa-file-upload"></i> Import CSV
                </label>
                <input type="file" id="csvUpload" accept=".csv" style="display: none;" onchange="uploadCSV(event)">
                <button onclick="exportCSV()" class="btn btn-secondary">
                    <i class="fas fa-file-download"></i> Export CSV
                </button>
            </div>
        </div>
        
        <div class="card-body">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search blocks, categories, or descriptions..." onkeyup="filterTable()">
            </div>

            <div id="loadingMessage" class="loading-indicator">
                <i class="fas fa-spinner fa-spin"></i> Loading blocks...
            </div>

            <div id="errorMessage" class="alert alert-error" style="display: none;"></div>

            <div id="tableContainer" style="display: none; overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Preview</th>
                            <th>Block Name</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="blocksTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2 id="previewModalTitle">Block Preview</h2>
            <span class="close" onclick="closePreviewModal()">&times;</span>
        </div>
        <div style="padding: 20px;">
            <div id="previewModalContent" style="background: rgba(0,0,0,0.5); border: 1px solid rgba(0,255,255,0.3); border-radius: 8px; padding: 20px; min-height: 200px; display: flex; align-items: center; justify-content: center;">
            </div>
            <div id="previewModalInfo" style="margin-top: 15px; padding: 15px; background: rgba(0,255,255,0.05); border-radius: 8px;">
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Modal -->
<div id="blockModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add New Block</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form id="blockForm" onsubmit="saveBlock(event)">
            <input type="hidden" id="blockId">
            
            <div class="form-group">
                <label for="blockName">Block Name</label>
                <input type="text" id="blockName" required placeholder="e.g., SYM_STRM_MNHL_24IN">
            </div>

            <div class="form-group">
                <label for="category">Category</label>
                <select id="category" required>
                    <option value="">-- Select Category --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="discipline">Discipline</label>
                <select id="discipline">
                    <option value="">-- Select Discipline (optional) --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" rows="3" placeholder="Description of block symbol"></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.search-box {
    margin-bottom: 20px;
    position: relative;
}

.search-box i {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--mc-muted);
}

.search-box input {
    width: 100%;
    padding: 12px 15px 12px 45px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(0,255,255,0.2);
    border-radius: 8px;
    color: var(--mc-text);
    font-size: 16px;
}

.search-box input:focus {
    outline: none;
    border-color: var(--mc-primary);
    background: rgba(255,255,255,0.08);
}

.svg-preview {
    width: 60px;
    height: 60px;
    border: 1px solid rgba(0,255,255,0.3);
    border-radius: 4px;
    background: rgba(255,255,255,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
}

.svg-preview svg {
    max-width: 50px;
    max-height: 50px;
}

.no-preview {
    color: var(--mc-muted);
    font-size: 12px;
    text-align: center;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 14px;
}

.loading-indicator {
    text-align: center;
    padding: 40px;
    color: var(--mc-primary);
    font-size: 18px;
}

.alert {
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.alert-error {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.3);
    color: #ff6b6b;
}

.alert-success {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.3);
    color: #51cf66;
}
</style>

<script>
let blocksData = [];
let categoriesData = [];
let disciplinesData = [];

// Load categories and disciplines for dropdowns
async function loadDropdownOptions() {
    try {
        const [catResponse, discResponse] = await Promise.all([
            fetch('/api/categories?standard_type=blocks'),
            fetch('/api/disciplines?standard_type=blocks')
        ]);
        
        const catData = await catResponse.json();
        const discData = await discResponse.json();
        
        categoriesData = catData.categories || [];
        disciplinesData = discData.disciplines || [];
        
        populateDropdowns();
    } catch (error) {
        console.error('Error loading dropdown options:', error);
    }
}

function populateDropdowns() {
    // Populate categories dropdown
    const categorySelect = document.getElementById('category');
    categorySelect.innerHTML = '<option value="">-- Select Category --</option>';
    categoriesData.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.category_code;
        option.textContent = `${cat.category_code} - ${cat.category_name}`;
        categorySelect.appendChild(option);
    });
    
    // Populate disciplines dropdown
    const disciplineSelect = document.getElementById('discipline');
    disciplineSelect.innerHTML = '<option value="">-- Select Discipline (optional) --</option>';
    disciplinesData.forEach(disc => {
        const option = document.createElement('option');
        option.value = disc.discipline_code;
        option.textContent = `${disc.discipline_code} - ${disc.discipline_name}`;
        disciplineSelect.appendChild(option);
    });
}

async function loadBlocks() {
    try {
        const response = await fetch('/api/data-manager/blocks');
        if (!response.ok) throw new Error('Failed to load blocks');
        
        const data = await response.json();
        blocksData = data.blocks || [];
        
        renderTable();
        
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'block';
    } catch (error) {
        showError('Error loading blocks: ' + error.message);
    }
}

function showError(message) {
    document.getElementById('loadingMessage').style.display = 'none';
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type}`;
    notification.textContent = message;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '2000';
    notification.style.minWidth = '300px';
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 4000);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function sanitizeSVG(svgContent) {
    // Basic sanitization: remove script tags and event handlers
    if (!svgContent) return '';
    return svgContent
        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
        .replace(/on\w+\s*=\s*"[^"]*"/gi, '')
        .replace(/on\w+\s*=\s*'[^']*'/gi, '');
}

function renderTable() {
    const tbody = document.getElementById('blocksTableBody');
    tbody.innerHTML = '';
    
    blocksData.forEach(item => {
        const row = tbody.insertRow();
        
        // SVG Preview Cell
        const svgCell = row.insertCell();
        const svgPreview = document.createElement('div');
        svgPreview.className = 'svg-preview';
        svgPreview.style.cursor = 'pointer';
        svgPreview.title = 'Click to enlarge';
        
        if (item.svg_content) {
            svgPreview.innerHTML = sanitizeSVG(item.svg_content);
            svgPreview.onclick = () => openPreviewModal(item);
        } else if (item.preview_image_path) {
            const img = document.createElement('img');
            img.src = item.preview_image_path;
            img.style.maxWidth = '50px';
            img.style.maxHeight = '50px';
            img.onerror = () => { svgPreview.innerHTML = '<div class="no-preview">Image Error</div>'; };
            svgPreview.appendChild(img);
            svgPreview.onclick = () => openPreviewModal(item);
        } else {
            svgPreview.innerHTML = '<div class="no-preview">No Preview</div>';
            svgPreview.style.cursor = 'default';
        }
        svgCell.appendChild(svgPreview);
        
        // Block Name Cell
        const nameCell = row.insertCell();
        const nameStrong = document.createElement('strong');
        nameStrong.textContent = item.block_name || '';
        nameCell.appendChild(nameStrong);
        
        // Category Cell
        const catCell = row.insertCell();
        catCell.textContent = item.category || '';
        
        // Description Cell
        const descCell = row.insertCell();
        descCell.textContent = item.description || '';
        
        // Actions Cell
        const actionsCell = row.insertCell();
        
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-secondary btn-sm';
        editBtn.title = 'Edit';
        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
        editBtn.onclick = () => editBlock(item.block_id);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger btn-sm';
        deleteBtn.title = 'Delete';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.onclick = () => deleteBlock(item.block_id, item.block_name);
        
        actionsCell.appendChild(editBtn);
        actionsCell.appendChild(document.createTextNode(' '));
        actionsCell.appendChild(deleteBtn);
    });
}

function openPreviewModal(block) {
    document.getElementById('previewModalTitle').textContent = block.block_name || 'Block Preview';
    
    const contentDiv = document.getElementById('previewModalContent');
    contentDiv.innerHTML = '';
    
    if (block.svg_content) {
        contentDiv.innerHTML = sanitizeSVG(block.svg_content);
        const svgEl = contentDiv.querySelector('svg');
        if (svgEl) {
            svgEl.style.maxWidth = '100%';
            svgEl.style.maxHeight = '400px';
        }
    } else if (block.preview_image_path) {
        const img = document.createElement('img');
        img.src = block.preview_image_path;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '400px';
        img.onerror = () => { contentDiv.innerHTML = '<div class="no-preview">Failed to load image</div>'; };
        contentDiv.appendChild(img);
    } else {
        contentDiv.innerHTML = '<div class="no-preview">No preview available</div>';
    }
    
    const infoDiv = document.getElementById('previewModalInfo');
    infoDiv.innerHTML = `
        <div><strong>Block Name:</strong> ${escapeHtml(block.block_name || 'N/A')}</div>
        <div><strong>Category:</strong> ${escapeHtml(block.category || 'N/A')}</div>
        <div><strong>Description:</strong> ${escapeHtml(block.description || 'No description')}</div>
    `;
    
    document.getElementById('previewModal').style.display = 'block';
}

function closePreviewModal() {
    document.getElementById('previewModal').style.display = 'none';
}

function filterTable() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const tbody = document.getElementById('blocksTableBody');
    const rows = tbody.getElementsByTagName('tr');
    
    for (let row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
    }
}

async function addNewBlock() {
    document.getElementById('modalTitle').textContent = 'Add New Block';
    document.getElementById('blockForm').reset();
    document.getElementById('blockId').value = '';
    await loadDropdownOptions();
    document.getElementById('blockModal').style.display = 'block';
}

async function editBlock(id) {
    const item = blocksData.find(b => b.block_id == id);
    if (!item) return;
    
    document.getElementById('modalTitle').textContent = 'Edit Block';
    document.getElementById('blockId').value = item.block_id;
    document.getElementById('blockName').value = item.block_name || '';
    await loadDropdownOptions();
    document.getElementById('category').value = item.category || '';
    document.getElementById('discipline').value = item.block_type || '';
    document.getElementById('description').value = item.description || '';
    document.getElementById('blockModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('blockModal').style.display = 'none';
}

async function saveBlock(event) {
    event.preventDefault();
    
    const blockId = document.getElementById('blockId').value;
    const blockData = {
        block_name: document.getElementById('blockName').value,
        category: document.getElementById('category').value,
        block_type: document.getElementById('discipline').value,
        description: document.getElementById('description').value
    };
    
    try {
        const url = blockId 
            ? `/api/data-manager/blocks/${blockId}`
            : '/api/data-manager/blocks';
        const method = blockId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(blockData)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to save block');
        }
        
        closeModal();
        await loadBlocks();
        showNotification(`Block ${blockId ? 'updated' : 'created'} successfully!`);
    } catch (error) {
        alert('Error saving block: ' + error.message);
    }
}

async function deleteBlock(id, name) {
    if (!confirm(`Are you sure you want to delete block "${name}"?`)) return;
    
    try {
        const response = await fetch(`/api/data-manager/blocks/${id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete block');
        }
        
        await loadBlocks();
        showNotification('Block deleted successfully!');
    } catch (error) {
        alert('Error deleting block: ' + error.message);
    }
}

async function uploadCSV(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/data-manager/blocks/import-csv', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to import CSV');
        }
        
        const result = await response.json();
        await loadBlocks();
        showNotification(`CSV imported successfully! ${result.imported || 0} new records, ${result.updated || 0} updated.`, 'success');
    } catch (error) {
        alert('Error importing CSV: ' + error.message);
    } finally {
        event.target.value = '';
    }
}

async function exportCSV() {
    try {
        window.location.href = '/api/data-manager/blocks/export-csv';
    } catch (error) {
        alert('Error exporting CSV: ' + error.message);
    }
}

// Load blocks on page load
document.addEventListener('DOMContentLoaded', loadBlocks);

// Close modals when clicking outside
window.onclick = function(event) {
    const blockModal = document.getElementById('blockModal');
    const previewModal = document.getElementById('previewModal');
    
    if (event.target == blockModal) {
        closeModal();
    }
    if (event.target == previewModal) {
        closePreviewModal();
    }
}
</script>
{% endblock %}
