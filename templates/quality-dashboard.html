{% extends "base.html" %}

{% block title %}Quality Dashboard{% endblock %}

{% block content %}
<style>
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .metric-card {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        position: relative;
        overflow: hidden;
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, var(--color-accent-blue), var(--color-accent-cyan));
    }

    .metric-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
    }

    .metric-title {
        color: var(--color-text-secondary);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .metric-icon {
        font-size: 1.5rem;
        color: var(--color-accent-blue);
    }

    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--color-accent-cyan);
        margin-bottom: var(--spacing-xs);
    }

    .metric-subtitle {
        color: var(--color-text-muted);
        font-size: 0.875rem;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .quality-bars {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .quality-bar-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .quality-label {
        width: 80px;
        color: var(--color-text-primary);
        font-weight: 600;
        font-size: 0.875rem;
    }

    .quality-bar-container {
        flex: 1;
        height: 30px;
        background: rgba(15, 23, 42, 0.6);
        border-radius: var(--radius-sm);
        overflow: hidden;
        position: relative;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .quality-bar-fill {
        height: 100%;
        display: flex;
        align-items: center;
        padding-left: var(--spacing-sm);
        color: white;
        font-weight: 700;
        font-size: 0.875rem;
        transition: width 0.5s ease;
    }

    .quality-bar-fill.excellent {
        background: linear-gradient(90deg, #10b981, #059669);
    }

    .quality-bar-fill.good {
        background: linear-gradient(90deg, #06b6d4, #0891b2);
    }

    .quality-bar-fill.fair {
        background: linear-gradient(90deg, #f59e0b, #d97706);
    }

    .quality-bar-fill.poor {
        background: linear-gradient(90deg, #ef4444, #dc2626);
    }

    .quality-count {
        width: 60px;
        text-align: right;
        color: var(--color-text-primary);
        font-weight: 600;
    }

    .relationship-chart {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .relationship-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .relationship-label {
        width: 100px;
        color: var(--color-text-primary);
        font-weight: 600;
        font-size: 0.875rem;
    }

    .relationship-bar-container {
        flex: 1;
        height: 25px;
        background: rgba(15, 23, 42, 0.6);
        border-radius: var(--radius-sm);
        overflow: hidden;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .relationship-bar-fill {
        height: 100%;
        display: flex;
        align-items: center;
        padding-left: var(--spacing-sm);
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
        transition: width 0.5s ease;
    }

    .relationship-bar-fill.spatial {
        background: linear-gradient(90deg, #4169e1, #1e50c8);
    }

    .relationship-bar-fill.semantic {
        background: linear-gradient(90deg, #10b981, #059669);
    }

    .relationship-bar-fill.engineering {
        background: linear-gradient(90deg, #f59e0b, #d97706);
    }

    .issue-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }

    .issue-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        background: rgba(59, 130, 246, 0.05);
        border-radius: var(--radius-md);
        border-left: 3px solid var(--color-accent-orange);
    }

    .issue-name {
        color: var(--color-text-primary);
        font-weight: 500;
    }

    .issue-count {
        color: var(--color-accent-orange);
        font-weight: 700;
        font-size: 1.1rem;
    }

    .empty-state {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--color-text-secondary);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: var(--spacing-md);
        color: var(--color-accent-green);
    }
</style>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-chart-line"></i>
            Quality & Health Dashboard
        </h2>
        <button onclick="loadMetrics()" class="btn btn-ghost">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>

    <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-xl);">
        Monitor embedding coverage, relationship density, and data quality metrics for your AI-optimized database.
    </p>

    <!-- Top Metrics -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Embedding Coverage</div>
                <div class="metric-icon"><i class="fas fa-brain"></i></div>
            </div>
            <div class="metric-value" id="embeddingCoverage">--%</div>
            <div class="metric-subtitle" id="embeddingSubtitle">Loading...</div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Relationship Density</div>
                <div class="metric-icon"><i class="fas fa-project-diagram"></i></div>
            </div>
            <div class="metric-value" id="relationshipDensity">--</div>
            <div class="metric-subtitle">avg relationships per entity</div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Orphaned Entities</div>
                <div class="metric-icon"><i class="fas fa-unlink"></i></div>
            </div>
            <div class="metric-value" id="orphanedCount">--</div>
            <div class="metric-subtitle">entities with no relationships</div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Total Entities</div>
                <div class="metric-icon"><i class="fas fa-database"></i></div>
            </div>
            <div class="metric-value" id="totalEntities">--</div>
            <div class="metric-subtitle" id="totalRelationships">-- relationships</div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
        <!-- Quality Distribution -->
        <div class="card">
            <h3 style="color: var(--color-accent-cyan); margin-bottom: var(--spacing-lg); display: flex; align-items: center; gap: var(--spacing-sm);">
                <i class="fas fa-star"></i> Quality Score Distribution
            </h3>
            <div class="quality-bars" id="qualityBars">
                <div class="empty-state">Loading...</div>
            </div>
        </div>

        <!-- Relationship Breakdown -->
        <div class="card">
            <h3 style="color: var(--color-accent-cyan); margin-bottom: var(--spacing-lg); display: flex; align-items: center; gap: var(--spacing-sm);">
                <i class="fas fa-link"></i> Relationship Breakdown
            </h3>
            <div class="relationship-chart" id="relationshipChart">
                <div class="empty-state">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Issues Section -->
    <div class="card">
        <h3 style="color: var(--color-accent-cyan); margin-bottom: var(--spacing-lg); display: flex; align-items: center; gap: var(--spacing-sm);">
            <i class="fas fa-exclamation-triangle"></i> Missing Embeddings by Entity Type
        </h3>
        <div class="issue-list" id="missingEmbeddings">
            <div class="empty-state">Loading...</div>
        </div>
    </div>
</div>

<script>
    async function loadMetrics() {
        try {
            const response = await fetch('/api/toolkit/quality/metrics');
            const data = await response.json();

            if (!data.success) {
                alert('Error loading metrics: ' + data.error);
                return;
            }

            const metrics = data.metrics;

            // Update embedding coverage
            const coverage = metrics.embedding_coverage;
            document.getElementById('embeddingCoverage').textContent = 
                coverage.coverage_percent ? coverage.coverage_percent + '%' : '0%';
            document.getElementById('embeddingSubtitle').textContent = 
                `${coverage.entities_with_embeddings || 0} of ${coverage.total_entities || 0} entities`;

            // Update relationship density
            const density = metrics.relationship_density;
            document.getElementById('relationshipDensity').textContent = 
                density.avg_relationships_per_entity || '0';

            // Update orphaned count
            document.getElementById('orphanedCount').textContent = 
                metrics.orphaned_entities.count || '0';

            // Update total entities
            document.getElementById('totalEntities').textContent = 
                density.total_entities || '0';
            document.getElementById('totalRelationships').textContent = 
                `${density.total_relationships || 0} relationships`;

            // Update quality distribution chart
            displayQualityDistribution(metrics.quality_distribution);

            // Update relationship breakdown chart
            displayRelationshipBreakdown(metrics.relationship_breakdown);

            // Update missing embeddings list
            displayMissingEmbeddings(metrics.missing_embeddings_by_type);

        } catch (error) {
            console.error('Error loading metrics:', error);
            alert('Failed to load metrics: ' + error.message);
        }
    }

    function displayQualityDistribution(distribution) {
        const container = document.getElementById('qualityBars');
        
        if (!distribution || distribution.length === 0) {
            container.innerHTML = '<div class="empty-state">No quality data available</div>';
            return;
        }

        // Calculate total for percentages
        const total = distribution.reduce((sum, item) => sum + item.count, 0);

        const tierOrder = ['excellent', 'good', 'fair', 'poor'];
        const tierLabels = {
            'excellent': 'Excellent',
            'good': 'Good',
            'fair': 'Fair',
            'poor': 'Poor'
        };

        // Create a map for quick lookup
        const distMap = {};
        distribution.forEach(item => {
            distMap[item.quality_tier] = item.count;
        });

        let html = '';
        tierOrder.forEach(tier => {
            const count = distMap[tier] || 0;
            const percentage = total > 0 ? (count / total * 100) : 0;
            
            html += `
                <div class="quality-bar-item">
                    <div class="quality-label">${tierLabels[tier]}</div>
                    <div class="quality-bar-container">
                        <div class="quality-bar-fill ${tier}" style="width: ${percentage}%">
                            ${percentage > 10 ? count : ''}
                        </div>
                    </div>
                    <div class="quality-count">${count}</div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function displayRelationshipBreakdown(breakdown) {
        const container = document.getElementById('relationshipChart');
        
        if (!breakdown || breakdown.length === 0) {
            container.innerHTML = '<div class="empty-state">No relationships yet</div>';
            return;
        }

        const total = breakdown.reduce((sum, item) => sum + item.count, 0);

        let html = '';
        breakdown.forEach(item => {
            const percentage = total > 0 ? (item.count / total * 100) : 0;
            const category = item.relationship_category || 'unknown';
            
            html += `
                <div class="relationship-item">
                    <div class="relationship-label">${category}</div>
                    <div class="relationship-bar-container">
                        <div class="relationship-bar-fill ${category}" style="width: ${percentage}%">
                            ${item.count}
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function displayMissingEmbeddings(missing) {
        const container = document.getElementById('missingEmbeddings');
        
        if (!missing || missing.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>All entities have embeddings!</p></div>';
            return;
        }

        let html = '';
        missing.forEach(item => {
            html += `
                <div class="issue-item">
                    <div class="issue-name">${item.entity_type}</div>
                    <div class="issue-count">${item.count}</div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Load metrics on page load
    window.addEventListener('load', () => {
        loadMetrics();
    });
</script>
{% endblock %}
