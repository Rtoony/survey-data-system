<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Toolkit - ACAD-GIS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .toolkit-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .toolkit-header {
            margin-bottom: 30px;
        }

        .toolkit-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .toolkit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .toolkit-card {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .toolkit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .toolkit-card h2 {
            color: var(--primary-color);
            font-size: 1.5em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolkit-card p {
            color: var(--text-color);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .tool-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tool-button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--bg-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .tool-button:hover {
            background: var(--accent-color);
            transform: scale(1.05);
        }

        .tool-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .status-panel {
            background: rgba(0, 255, 136, 0.05);
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid var(--primary-color);
        }

        .status-item h3 {
            color: var(--primary-color);
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .status-item .value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-color);
        }

        .output-panel {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .output-panel h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .output-line {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--text-color);
            margin: 5px 0;
            padding: 5px;
            border-left: 2px solid var(--primary-color);
            padding-left: 10px;
        }

        .output-line.success {
            border-left-color: #00ff88;
            color: #00ff88;
        }

        .output-line.error {
            border-left-color: #ff4444;
            color: #ff4444;
        }

        .output-line.info {
            border-left-color: #00bfff;
            color: #00bfff;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <div class="nav-brand">
            <i class="fas fa-brain"></i>
            <span>AI TOOLKIT</span>
        </div>
        <div class="nav-links">
            <a href="/"><i class="fas fa-home"></i> Home</a>
            <a href="/schema"><i class="fas fa-sitemap"></i> Schema</a>
            <a href="/data-manager"><i class="fas fa-database"></i> Data Manager</a>
        </div>
    </nav>

    <div class="toolkit-container">
        <div class="toolkit-header">
            <h1><i class="fas fa-robot"></i> AI-First Database Toolkit</h1>
            <p>Manage embeddings, relationships, quality scores, and database maintenance for your AI-optimized ACAD-GIS database.</p>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
            <h2><i class="fas fa-chart-line"></i> Database Statistics</h2>
            <div class="status-grid" id="statsGrid">
                <div class="status-item">
                    <h3>Total Entities</h3>
                    <div class="value" id="totalEntities">-</div>
                </div>
                <div class="status-item">
                    <h3>Current Embeddings</h3>
                    <div class="value" id="currentEmbeddings">-</div>
                </div>
                <div class="status-item">
                    <h3>Relationships</h3>
                    <div class="value" id="totalRelationships">-</div>
                </div>
                <div class="status-item">
                    <h3>Avg Quality Score</h3>
                    <div class="value" id="avgQuality">-</div>
                </div>
            </div>
            <button class="tool-button" onclick="loadStats()" style="margin-top: 15px;">
                <i class="fas fa-sync-alt"></i> Refresh Stats
            </button>
        </div>

        <!-- Toolkit Cards -->
        <div class="toolkit-grid">
            <!-- Ingestion -->
            <div class="toolkit-card">
                <h2><i class="fas fa-upload"></i> Data Ingestion</h2>
                <p>Load CAD standards from JSON/CSV files into the database with automatic entity registration and quality scoring.</p>
                <div class="tool-buttons">
                    <button class="tool-button" onclick="showExampleData('layers')">
                        <i class="fas fa-layer-group"></i> Load Example Layers
                    </button>
                    <button class="tool-button" onclick="showExampleData('blocks')">
                        <i class="fas fa-cubes"></i> Load Example Blocks
                    </button>
                </div>
            </div>

            <!-- Embeddings -->
            <div class="toolkit-card">
                <h2><i class="fas fa-vector-square"></i> Embedding Generation</h2>
                <p>Generate vector embeddings using OpenAI for semantic search and AI reasoning across all entities.</p>
                <div class="tool-buttons">
                    <button class="tool-button" onclick="generateEmbeddings('layer_standards', 10)">
                        <i class="fas fa-magic"></i> Generate (Layers, 10)
                    </button>
                    <button class="tool-button" onclick="refreshEmbeddings()">
                        <i class="fas fa-redo"></i> Refresh Old
                    </button>
                </div>
                <p style="margin-top: 10px; font-size: 0.85em; color: #ffaa00;">
                    <i class="fas fa-exclamation-triangle"></i> Requires OPENAI_API_KEY
                </p>
            </div>

            <!-- Relationships -->
            <div class="toolkit-card">
                <h2><i class="fas fa-project-diagram"></i> Relationship Building</h2>
                <p>Automatically detect and create spatial, engineering, and semantic relationships for GraphRAG queries.</p>
                <div class="tool-buttons">
                    <button class="tool-button" onclick="buildSemanticRelationships()">
                        <i class="fas fa-brain"></i> Semantic (Embeddings)
                    </button>
                    <button class="tool-button" onclick="buildCompleteGraph()">
                        <i class="fas fa-network-wired"></i> Complete Graph
                    </button>
                </div>
            </div>

            <!-- Validation -->
            <div class="toolkit-card">
                <h2><i class="fas fa-check-circle"></i> Data Validation</h2>
                <p>Check data quality, find missing fields, detect duplicates, and validate PostGIS geometries.</p>
                <div class="tool-buttons">
                    <button class="tool-button" onclick="validateAll()">
                        <i class="fas fa-tasks"></i> Validate All
                    </button>
                    <button class="tool-button" onclick="checkQuality()">
                        <i class="fas fa-star"></i> Quality Check
                    </button>
                </div>
            </div>

            <!-- Maintenance -->
            <div class="toolkit-card">
                <h2><i class="fas fa-wrench"></i> Database Maintenance</h2>
                <p>Refresh materialized views, recompute quality scores, run VACUUM, and optimize database performance.</p>
                <div class="tool-buttons">
                    <button class="tool-button" onclick="refreshViews()">
                        <i class="fas fa-eye"></i> Refresh Views
                    </button>
                    <button class="tool-button" onclick="recomputeQuality()">
                        <i class="fas fa-calculator"></i> Recompute Quality
                    </button>
                    <button class="tool-button" onclick="runFullMaintenance()">
                        <i class="fas fa-toolbox"></i> Full Maintenance
                    </button>
                </div>
            </div>

            <!-- Examples -->
            <div class="toolkit-card">
                <h2><i class="fas fa-book"></i> Example Scripts</h2>
                <p>Python example scripts demonstrating how to use the toolkit for data ingestion, embeddings, and more.</p>
                <div class="tool-buttons">
                    <button class="tool-button" onclick="window.open('/examples/README.md', '_blank')">
                        <i class="fas fa-file-alt"></i> View Examples
                    </button>
                </div>
                <p style="margin-top: 10px; font-size: 0.85em;">
                    Location: <code>/examples/</code>
                </p>
            </div>
        </div>

        <!-- Output Panel -->
        <div class="output-panel" id="outputPanel" style="display: none;">
            <h3><i class="fas fa-terminal"></i> Operation Output</h3>
            <div id="outputContent"></div>
        </div>
    </div>

    <script>
        let outputPanel = document.getElementById('outputPanel');
        let outputContent = document.getElementById('outputContent');

        function showOutput() {
            outputPanel.style.display = 'block';
        }

        function addOutput(message, type = 'info') {
            showOutput();
            const line = document.createElement('div');
            line.className = `output-line ${type}`;
            line.textContent = message;
            outputContent.appendChild(line);
            outputPanel.scrollTop = outputPanel.scrollHeight;
        }

        function clearOutput() {
            outputContent.innerHTML = '';
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/toolkit/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.entity_stats;
                    document.getElementById('totalEntities').textContent = stats.total_entities || 0;
                    document.getElementById('currentEmbeddings').textContent = stats.embeddings?.current || 0;
                    document.getElementById('totalRelationships').textContent = stats.relationships || 0;
                    
                    const avgQuality = stats.quality?.avg_quality;
                    document.getElementById('avgQuality').textContent = avgQuality ? avgQuality.toFixed(3) : '-';
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function generateEmbeddings(table, limit) {
            // Confirmation prompt
            if (!confirm(`⚠️ This will use your OpenAI API key to generate embeddings.\n\nTable: ${table}\nLimit: ${limit} entities\nEstimated cost: $0.01-0.10\n\nProceed?`)) {
                addOutput('Operation cancelled by user.', 'info');
                return;
            }
            
            clearOutput();
            addOutput(`Generating embeddings for ${table} (limit: ${limit})...`, 'info');
            addOutput('⚠️ This operation uses OpenAI API ($100 budget cap enforced)', 'info');
            
            const textColumns = {
                'layer_standards': ['name', 'description'],
                'block_definitions': ['name', 'description'],
                'detail_standards': ['detail_number', 'title', 'description']
            };
            
            try {
                const response = await fetch('/api/toolkit/embeddings/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        table_name: table,
                        text_columns: textColumns[table],
                        limit: limit
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addOutput(`✓ Generated: ${data.stats.generated}`, 'success');
                    addOutput(`  API calls: ${data.stats.api_calls}`, 'info');
                    addOutput(`  Tokens used: ${data.stats.tokens_used}`, 'info');
                    addOutput(`  Cost: ~$${(data.stats.tokens_used * 0.00002).toFixed(4)}`, 'info');
                    if (data.stats.errors && data.stats.errors.length > 0) {
                        addOutput(`  Errors: ${data.stats.errors.length}`, 'error');
                    }
                    loadStats();
                } else {
                    addOutput(`✗ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                addOutput(`✗ Failed: ${error.message}`, 'error');
            }
        }

        async function buildSemanticRelationships() {
            clearOutput();
            addOutput('Building semantic relationships from embeddings...', 'info');
            
            try {
                const response = await fetch('/api/toolkit/relationships/semantic', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        similarity_threshold: 0.80,
                        limit_per_entity: 5
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addOutput(`✓ Created ${data.count} semantic relationships`, 'success');
                    loadStats();
                } else {
                    addOutput(`✗ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                addOutput(`✗ Failed: ${error.message}`, 'error');
            }
        }

        async function buildCompleteGraph() {
            clearOutput();
            addOutput('Building complete knowledge graph (all relationship types)...', 'info');
            addOutput('This may take a few minutes...', 'info');
            
            try {
                const response = await fetch('/api/toolkit/relationships/build-complete', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addOutput(`✓ Graph built successfully!`, 'success');
                    addOutput(`  Spatial: ${data.stats.spatial_relationships}`, 'info');
                    addOutput(`  Engineering: ${data.stats.engineering_relationships}`, 'info');
                    addOutput(`  Semantic: ${data.stats.semantic_relationships}`, 'info');
                    loadStats();
                } else {
                    addOutput(`✗ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                addOutput(`✗ Failed: ${error.message}`, 'error');
            }
        }

        async function validateAll() {
            clearOutput();
            addOutput('Running comprehensive validation...', 'info');
            
            try {
                const response = await fetch('/api/toolkit/validate/all');
                const data = await response.json();
                
                if (data.success) {
                    const results = data.results;
                    addOutput(`✓ Validation complete!`, 'success');
                    addOutput(`  Total issues: ${results.total_issues}`, 'info');
                    
                    for (const [severity, count] of Object.entries(results.issues_by_severity)) {
                        const type = severity === 'error' || severity === 'high' ? 'error' : 'info';
                        addOutput(`  ${severity.toUpperCase()}: ${count}`, type);
                    }
                } else {
                    addOutput(`✗ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                addOutput(`✗ Failed: ${error.message}`, 'error');
            }
        }

        async function refreshViews() {
            clearOutput();
            addOutput('Refreshing materialized views...', 'info');
            
            try {
                const response = await fetch('/api/toolkit/maintenance/refresh-views', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addOutput(`✓ Views refreshed in ${data.duration.toFixed(2)}s`, 'success');
                } else {
                    addOutput(`✗ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                addOutput(`✗ Failed: ${error.message}`, 'error');
            }
        }

        async function recomputeQuality() {
            clearOutput();
            addOutput('Recomputing quality scores for all entities...', 'info');
            
            try {
                const response = await fetch('/api/toolkit/maintenance/recompute-quality', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addOutput(`✓ Quality scores recomputed in ${data.duration.toFixed(2)}s`, 'success');
                    if (data.stats) {
                        addOutput(`  Total entities: ${data.stats.total}`, 'info');
                        addOutput(`  Avg quality: ${parseFloat(data.stats.avg_quality).toFixed(3)}`, 'info');
                    }
                    loadStats();
                } else {
                    addOutput(`✗ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                addOutput(`✗ Failed: ${error.message}`, 'error');
            }
        }

        async function runFullMaintenance() {
            clearOutput();
            addOutput('Running full maintenance routine...', 'info');
            addOutput('This will take several minutes...', 'info');
            
            try {
                const response = await fetch('/api/toolkit/maintenance/full', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addOutput(`✓ Full maintenance complete!`, 'success');
                    if (data.log) {
                        data.log.slice(-20).forEach(line => {
                            addOutput(line, 'info');
                        });
                    }
                    loadStats();
                } else {
                    addOutput(`✗ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                addOutput(`✗ Failed: ${error.message}`, 'error');
            }
        }

        function showExampleData(type) {
            alert(`To load ${type} data:\n\n1. Use Python script: examples/load_standards_example.py\n2. Or call API: POST /api/toolkit/load/${type}\n\nSee examples/README.md for detailed instructions.`);
        }

        function checkQuality() {
            validateAll();
        }

        function refreshEmbeddings() {
            alert('To refresh embeddings:\n\n1. Use Python script: examples/generate_embeddings_example.py\n2. Or call API: POST /api/toolkit/embeddings/refresh\n\nNote: Requires OPENAI_API_KEY');
        }

        // Load stats on page load
        loadStats();
    </script>
</body>
</html>
