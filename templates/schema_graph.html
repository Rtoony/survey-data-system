{% extends "base.html" %}

{% block title %}Schema Knowledge Graph - Schema Explorer{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div>
            <h1><i class="fas fa-project-diagram"></i> Schema Knowledge Graph</h1>
            <p class="subtitle">Interactive knowledge graph visualization optimized for large schemas</p>
        </div>
        <div class="button-group">
            <a href="/schema/relationships" class="btn btn-secondary">
                <i class="fas fa-network-wired"></i> Classic View
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-brain"></i> Database Knowledge Graph</h2>
            <div class="button-group">
                <button onclick="toggleFullscreen()" class="btn btn-secondary" id="fullscreenBtn">
                    <i class="fas fa-expand"></i> Full Screen
                </button>
                <button onclick="resetGraph()" class="btn btn-secondary">
                    <i class="fas fa-undo"></i> Reset
                </button>
                <button onclick="fitGraph()" class="btn btn-secondary">
                    <i class="fas fa-compress-arrows-alt"></i> Fit
                </button>
            </div>
        </div>
        
        <div class="card-body">
            <div id="loadingMessage" class="loading-indicator">
                <i class="fas fa-spinner fa-spin"></i> Loading schema knowledge graph...
            </div>

            <div id="errorMessage" class="alert alert-error" style="display: none;"></div>

            <div id="controls" style="display: none; margin-bottom: 20px; padding: 20px; background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.2); border-radius: 8px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: bold;">
                            <i class="fas fa-search"></i> Search Tables
                        </label>
                        <input type="text" id="searchInput" placeholder="Type table name..." 
                               style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(0,255,255,0.3); border-radius: 4px; color: var(--text-primary);">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: bold;">
                            <i class="fas fa-filter"></i> Filter by Category
                        </label>
                        <select id="categoryFilter" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(0,255,255,0.3); border-radius: 4px; color: var(--text-primary);">
                            <option value="all">All Tables</option>
                            <option value="projects">Projects</option>
                            <option value="drawings">Drawings</option>
                            <option value="standards">Standards</option>
                            <option value="blocks">Blocks & Layers</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: bold;">
                            <i class="fas fa-project-diagram"></i> Layout
                        </label>
                        <select id="layoutSelect" onchange="changeLayout()" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(0,255,255,0.3); border-radius: 4px; color: var(--text-primary);">
                            <option value="cose">Force-Directed (COSE)</option>
                            <option value="circle">Circle</option>
                            <option value="concentric">Concentric</option>
                            <option value="breadthfirst">Hierarchical (BFS)</option>
                            <option value="grid">Grid</option>
                            <option value="cose-bilkent">Force-Directed (Advanced)</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,255,255,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 8px; color: var(--text-dim); cursor: pointer;">
                                <input type="checkbox" id="showLabels" checked onchange="toggleLabels()">
                                <span>Show Labels</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; color: var(--text-dim); cursor: pointer;">
                                <input type="checkbox" id="showEdgeLabels" onchange="toggleEdgeLabels()">
                                <span>Show Relationship Labels</span>
                            </label>
                        </div>
                        <div id="statsDisplay" style="color: var(--text-dim); font-size: 14px;">
                            <i class="fas fa-database"></i> <span id="visibleNodes">0</span> tables, 
                            <i class="fas fa-link"></i> <span id="visibleEdges">0</span> relationships
                        </div>
                    </div>
                </div>
            </div>

            <div id="graphContainer" style="display: none; width: 100%; height: 700px; border: 1px solid rgba(0,255,255,0.3); border-radius: 8px; background: rgba(0,0,0,0.3);"></div>

            <div id="nodeDetails" style="display: none; margin-top: 20px; padding: 20px; background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.2); border-radius: 8px;">
                <h3 style="margin: 0 0 15px 0; color: var(--accent-cyan);"><i class="fas fa-table"></i> <span id="detailTableName"></span></h3>
                <div id="detailContent"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/layout-base@2.0.1/layout-base.js"></script>
<script src="https://unpkg.com/cose-base@2.2.0/cose-base.js"></script>
<script src="https://unpkg.com/cytoscape-cose-bilkent@4.1.0/cytoscape-cose-bilkent.js"></script>

<style>
.loading-indicator {
    text-align: center;
    padding: 40px;
    color: var(--accent-cyan);
    font-size: 18px;
}

.alert {
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.alert-error {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.3);
    color: #ff6b6b;
}

#graphContainer.fullscreen {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 9999 !important;
    background: #000000 !important;
    border: none !important;
    border-radius: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
}

.column-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 10px;
    margin-top: 15px;
}

.column-item {
    padding: 8px 12px;
    background: rgba(255,255,255,0.05);
    border-left: 3px solid rgba(0,255,255,0.5);
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
}

.column-item.primary-key {
    border-left-color: #ffd700;
}

.column-name {
    font-weight: bold;
    color: var(--accent-cyan);
}

.column-type {
    color: var(--text-dim);
    font-size: 12px;
}

.stats-row {
    display: flex;
    gap: 30px;
    margin: 15px 0;
    padding: 15px;
    background: rgba(0,0,0,0.2);
    border-radius: 6px;
}

.stat-item {
    display: flex;
    flex-direction: column;
}

.stat-label {
    font-size: 12px;
    color: var(--text-dim);
    text-transform: uppercase;
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: var(--accent-cyan);
}

.table-description {
    margin: 20px 0;
    padding: 20px;
    background: linear-gradient(135deg, rgba(0,255,255,0.1) 0%, rgba(0,100,255,0.05) 100%);
    border-left: 4px solid var(--accent-cyan);
    border-radius: 8px;
}

.table-description p {
    color: var(--text-primary);
    line-height: 1.8;
    font-size: 15px;
    margin: 0;
    text-align: justify;
}
</style>

<script>
let cy = null;
let schemaData = null;
let allNodes = [];
let allEdges = [];

const tableCategories = {
    'projects': ['projects'],
    'drawings': ['drawings', 'drawing_entities', 'drawing_text', 'drawing_dimensions', 'drawing_hatches', 'layout_viewports'],
    'standards': ['layer_standards', 'block_standards', 'dimension_styles', 'hatch_patterns', 'text_styles', 'linetypes', 'colors', 'materials', 'abbreviations', 'details', 'standard_notes', 'code_references', 'plotstyles', 'sheet_templates'],
    'blocks': ['layers', 'block_inserts', 'drawing_layer_usage', 'drawing_linetype_usage']
};

const tableDescriptions = {
    'projects': 'Top-level container for organizing CAD work by client or project',
    'drawings': 'Individual CAD files with units, scale, and coordinate information',
    'layer_standards': 'Organization rulebook for CAD layers with approved colors and linetypes',
    'block_standards': 'Library of reusable symbols and components',
    'dimension_styles': 'Templates controlling dimension appearance',
    'hatch_patterns': 'Repetitive fills representing different materials',
    'layers': 'Actual layers in specific drawings with properties',
    'block_inserts': 'Symbol placements in drawings with location and rotation',
    'drawing_entities': 'Geometric content - lines, circles, arcs, polylines',
    'drawing_text': 'Text labels, notes, and callouts in drawings',
    'drawing_dimensions': 'Measurement annotations in drawings',
    'drawing_hatches': 'Patterned area fills in drawings',
    'layout_viewports': 'Paper space windows showing model at specific scales',
    'drawing_layer_usage': 'Analytics tracking layer usage by drawing',
    'drawing_linetype_usage': 'Analytics tracking linetype usage by drawing',
    'export_jobs': 'Audit trail of DXF/DWG export operations'
};

function getCategoryColor(tableName) {
    for (const [category, tables] of Object.entries(tableCategories)) {
        if (tables.includes(tableName)) {
            switch(category) {
                case 'projects': return '#ff6b6b';
                case 'drawings': return '#51cf66';
                case 'standards': return '#ffd700';
                case 'blocks': return '#ff9800';
            }
        }
    }
    return '#00ffff';
}

function getTableCategory(tableName) {
    for (const [category, tables] of Object.entries(tableCategories)) {
        if (tables.includes(tableName)) {
            return category;
        }
    }
    return 'other';
}

async function loadSchemaData() {
    console.log('Starting to load schema data...');
    try {
        console.log('Fetching from /api/schema/relationships');
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const response = await fetch('/api/schema/relationships', {
            signal: controller.signal
        }).finally(() => clearTimeout(timeoutId));
        
        console.log('Response received:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        console.log('Parsing JSON...');
        schemaData = await response.json();
        console.log('Schema data loaded successfully');
        console.log('Tables:', schemaData.tables ? schemaData.tables.length : 0);
        console.log('Relationships:', schemaData.relationships ? schemaData.relationships.length : 0);
        
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('controls').style.display = 'block';
        document.getElementById('graphContainer').style.display = 'block';
        
        console.log('Initializing graph...');
        initializeGraph();
        console.log('Graph initialized successfully');
    } catch (error) {
        console.error('Error in loadSchemaData:', error);
        console.error('Error type:', error.name);
        console.error('Error message:', error.message);
        console.error('Stack trace:', error.stack);
        document.getElementById('loadingMessage').style.display = 'none';
        const errorMsg = document.getElementById('errorMessage');
        errorMsg.textContent = `Error loading schema: ${error.message}`;
        errorMsg.style.display = 'block';
    }
}

function initializeGraph() {
    console.log('initializeGraph called');
    console.log('Cytoscape available?', typeof cytoscape !== 'undefined');
    
    allNodes = schemaData.tables.map(table => ({
        data: {
            id: table.table_name,
            label: table.table_name,
            rowCount: table.row_count || 0,
            columnCount: table.column_count || 0,
            category: getTableCategory(table.table_name),
            description: tableDescriptions[table.table_name] || 'Database table'
        }
    }));
    console.log('Created nodes:', allNodes.length);

    allEdges = schemaData.relationships.map((rel, idx) => ({
        data: {
            id: `edge-${idx}`,
            source: rel.source_table,
            target: rel.target_table,
            label: `${rel.source_column} â†’ ${rel.target_column}`,
            sourceColumn: rel.source_column,
            targetColumn: rel.target_column
        }
    }));
    console.log('Created edges:', allEdges.length);

    console.log('Creating Cytoscape instance...');
    cy = cytoscape({
        container: document.getElementById('graphContainer'),
        
        elements: {
            nodes: allNodes,
            edges: allEdges
        },
        
        style: [
            {
                selector: 'node',
                style: {
                    'background-color': function(ele) {
                        return getCategoryColor(ele.data('id'));
                    },
                    'label': 'data(label)',
                    'color': '#ffffff',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': '12px',
                    'font-weight': 'bold',
                    'text-outline-color': '#000000',
                    'text-outline-width': 2,
                    'width': function(ele) {
                        return Math.max(30, Math.min(80, 30 + Math.log(ele.data('rowCount') + 1) * 5));
                    },
                    'height': function(ele) {
                        return Math.max(30, Math.min(80, 30 + Math.log(ele.data('rowCount') + 1) * 5));
                    },
                    'border-width': 3,
                    'border-color': '#ffffff',
                    'border-opacity': 0.8
                }
            },
            {
                selector: 'node:selected',
                style: {
                    'border-width': 5,
                    'border-color': '#00ffff',
                    'box-shadow': '0 0 20px #00ffff'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': 'rgba(0, 255, 255, 0.4)',
                    'target-arrow-color': 'rgba(0, 255, 255, 0.6)',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier',
                    'arrow-scale': 1.5
                }
            },
            {
                selector: 'edge[label]',
                style: {
                    'label': 'data(label)',
                    'font-size': '10px',
                    'color': '#00ffff',
                    'text-rotation': 'autorotate',
                    'text-background-color': '#000000',
                    'text-background-opacity': 0.8,
                    'text-background-padding': '3px',
                    'display': 'none'
                }
            },
            {
                selector: 'edge.show-label',
                style: {
                    'label': 'data(label)',
                    'display': 'element'
                }
            },
            {
                selector: 'edge:selected',
                style: {
                    'line-color': '#00ffff',
                    'target-arrow-color': '#00ffff',
                    'width': 4
                }
            },
            {
                selector: '.hidden',
                style: {
                    'display': 'none'
                }
            },
            {
                selector: '.highlighted',
                style: {
                    'background-color': '#00ffff',
                    'border-color': '#00ffff',
                    'line-color': '#00ffff',
                    'target-arrow-color': '#00ffff'
                }
            }
        ],
        
        layout: {
            name: 'cose',
            animate: true,
            animationDuration: 1000,
            nodeRepulsion: 8000,
            idealEdgeLength: 100,
            edgeElasticity: 100,
            nestingFactor: 5,
            gravity: 80,
            numIter: 1000,
            initialTemp: 200,
            coolingFactor: 0.95,
            minTemp: 1.0
        }
    });

    cy.on('tap', 'node', function(evt) {
        const node = evt.target;
        showTableDetails(node.data('id'));
    });

    cy.on('mouseover', 'node', function(evt) {
        const node = evt.target;
        node.addClass('highlighted');
        node.connectedEdges().addClass('highlighted');
    });

    cy.on('mouseout', 'node', function(evt) {
        const node = evt.target;
        node.removeClass('highlighted');
        node.connectedEdges().removeClass('highlighted');
    });

    setupEventListeners();
    updateStats();
}

function setupEventListeners() {
    document.getElementById('searchInput').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        
        cy.nodes().forEach(node => {
            if (searchTerm === '' || node.data('id').toLowerCase().includes(searchTerm)) {
                node.removeClass('hidden');
            } else {
                node.addClass('hidden');
            }
        });
        
        cy.edges().forEach(edge => {
            const sourceVisible = !edge.source().hasClass('hidden');
            const targetVisible = !edge.target().hasClass('hidden');
            if (sourceVisible && targetVisible) {
                edge.removeClass('hidden');
            } else {
                edge.addClass('hidden');
            }
        });
        
        updateStats();
    });

    document.getElementById('categoryFilter').addEventListener('change', function(e) {
        const category = e.target.value;
        
        cy.nodes().forEach(node => {
            if (category === 'all' || node.data('category') === category) {
                node.removeClass('hidden');
            } else {
                node.addClass('hidden');
            }
        });
        
        cy.edges().forEach(edge => {
            const sourceVisible = !edge.source().hasClass('hidden');
            const targetVisible = !edge.target().hasClass('hidden');
            if (sourceVisible && targetVisible) {
                edge.removeClass('hidden');
            } else {
                edge.addClass('hidden');
            }
        });
        
        updateStats();
        cy.fit();
    });
}

function changeLayout() {
    const layoutName = document.getElementById('layoutSelect').value;
    
    let layoutOptions = {
        name: layoutName,
        animate: true,
        animationDuration: 1000
    };
    
    if (layoutName === 'cose') {
        layoutOptions = {
            ...layoutOptions,
            nodeRepulsion: 8000,
            idealEdgeLength: 100,
            edgeElasticity: 100,
            nestingFactor: 5,
            gravity: 80,
            numIter: 1000
        };
    } else if (layoutName === 'cose-bilkent') {
        layoutOptions = {
            ...layoutOptions,
            quality: 'default',
            nodeRepulsion: 4500,
            idealEdgeLength: 100,
            edgeElasticity: 0.45,
            nestingFactor: 0.1,
            gravity: 0.25,
            numIter: 2500
        };
    } else if (layoutName === 'breadthfirst') {
        layoutOptions = {
            ...layoutOptions,
            directed: true,
            spacingFactor: 1.5
        };
    } else if (layoutName === 'concentric') {
        layoutOptions = {
            ...layoutOptions,
            concentric: function(node) {
                return node.data('rowCount');
            },
            levelWidth: function(nodes) {
                return 2;
            }
        };
    }
    
    const layout = cy.layout(layoutOptions);
    layout.run();
}

function toggleLabels() {
    const showLabels = document.getElementById('showLabels').checked;
    if (showLabels) {
        cy.style().selector('node').style({'label': 'data(label)'}).update();
    } else {
        cy.style().selector('node').style({'label': ''}).update();
    }
}

function toggleEdgeLabels() {
    const showEdgeLabels = document.getElementById('showEdgeLabels').checked;
    if (showEdgeLabels) {
        cy.edges().addClass('show-label');
    } else {
        cy.edges().removeClass('show-label');
    }
}

function updateStats() {
    const visibleNodes = cy.nodes().not('.hidden').length;
    const visibleEdges = cy.edges().not('.hidden').length;
    
    document.getElementById('visibleNodes').textContent = visibleNodes;
    document.getElementById('visibleEdges').textContent = visibleEdges;
}

function fitGraph() {
    cy.fit(cy.nodes().not('.hidden'), 50);
}

function resetGraph() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = 'all';
    document.getElementById('layoutSelect').value = 'cose';
    
    cy.nodes().removeClass('hidden');
    cy.edges().removeClass('hidden');
    
    changeLayout();
    updateStats();
}

function toggleFullscreen() {
    const container = document.getElementById('graphContainer');
    const btn = document.getElementById('fullscreenBtn');
    
    if (container.classList.contains('fullscreen')) {
        container.classList.remove('fullscreen');
        btn.innerHTML = '<i class="fas fa-expand"></i> Full Screen';
    } else {
        container.classList.add('fullscreen');
        btn.innerHTML = '<i class="fas fa-compress"></i> Exit Full Screen';
    }
    
    setTimeout(() => {
        cy.resize();
        cy.fit();
    }, 100);
}

async function showTableDetails(tableName) {
    try {
        const response = await fetch(`/api/schema/table/${tableName}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        const table = schemaData.tables.find(t => t.table_name === tableName);
        
        let html = `
            <div class="stats-row">
                <div class="stat-item">
                    <span class="stat-label">Total Rows</span>
                    <span class="stat-value">${(table?.row_count || 0).toLocaleString()}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Columns</span>
                    <span class="stat-value">${data.columns.length}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Category</span>
                    <span class="stat-value">${getTableCategory(tableName)}</span>
                </div>
            </div>
        `;
        
        if (tableDescriptions[tableName]) {
            html += `
                <div class="table-description">
                    <p>${tableDescriptions[tableName]}</p>
                </div>
            `;
        }
        
        html += '<h4 style="margin: 20px 0 10px 0; color: var(--accent-cyan);">Columns</h4>';
        html += '<div class="column-list">';
        
        data.columns.forEach(col => {
            const isPrimaryKey = col.column_name === data.primary_key;
            html += `
                <div class="column-item ${isPrimaryKey ? 'primary-key' : ''}">
                    <div class="column-name">
                        ${isPrimaryKey ? '<i class="fas fa-key"></i> ' : ''}${col.column_name}
                    </div>
                    <div class="column-type">${col.data_type}</div>
                </div>
            `;
        });
        
        html += '</div>';
        
        document.getElementById('detailTableName').textContent = tableName;
        document.getElementById('detailContent').innerHTML = html;
        document.getElementById('nodeDetails').style.display = 'block';
        
        document.getElementById('nodeDetails').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
    } catch (error) {
        console.error('Error fetching table details:', error);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    console.log('Cytoscape available?', typeof cytoscape);
    
    if (typeof cytoscape === 'undefined') {
        console.error('Cytoscape library not loaded!');
        document.getElementById('loadingMessage').style.display = 'none';
        const errorMsg = document.getElementById('errorMessage');
        errorMsg.textContent = 'Error: Cytoscape library failed to load. Please check your internet connection.';
        errorMsg.style.display = 'block';
        return;
    }
    
    loadSchemaData();
});
</script>
{% endblock %}
