{% extends 'base.html' %}

{% block title %}Specifications Library{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <div style="margin-bottom: 1rem;">
        <nav style="color: var(--mc-muted); font-size: 0.9rem;">
            <i class="fas fa-home"></i>
            <a href="/standards-library" style="color: var(--mc-primary); text-decoration: none;">Standards Library</a>
            <span style="margin: 0 0.5rem;">/</span>
            <span>Specifications</span>
        </nav>
    </div>

    <div class="panel">
        <div class="panel-header">
            <div>
                <i class="fas fa-file-alt neon-cyan"></i>
                <h2>Specifications Library</h2>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <span id="spec-count" style="font-size: 0.9rem; color: var(--mc-muted);"></span>
                <button class="btn" onclick="openAddSpecModal()" style="background: linear-gradient(135deg, var(--mc-primary), var(--mc-accent));">
                    <i class="fas fa-plus"></i> Add Specification
                </button>
            </div>
        </div>
        <div class="panel-body" style="padding: 0;">
            <div style="display: grid; grid-template-columns: 300px 1fr; height: calc(100vh - 250px); min-height: 600px;">
                <!-- Left Sidebar -->
                <div style="border-right: 1px solid var(--mc-primary); padding: 1.5rem; overflow-y: auto; background: rgba(0, 0, 0, 0.2);">
                    <h3 class="orbitron" style="color: var(--mc-accent); font-size: 1rem; margin-bottom: 1rem;">
                        <i class="fas fa-sitemap"></i> Spec Standards
                    </h3>
                    <div id="standards-tree">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin neon-cyan"></i>
                            <p>Loading standards...</p>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div style="display: flex; flex-direction: column;">
                    <!-- Toolbar -->
                    <div style="padding: 1.5rem; border-bottom: 1px solid rgba(0, 255, 255, 0.2); display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <select id="standardFilter" class="project-select-control" style="min-width: 200px;" onchange="filterSpecs()">
                            <option value="">All Standards</option>
                        </select>
                        <div style="flex: 1; position: relative;">
                            <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--mc-muted);"></i>
                            <input type="text" id="searchBox" placeholder="Search spec number, title, or content..."
                                   style="width: 100%; padding: 8px 12px 8px 36px; background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 8px; color: var(--mc-text); font-family: 'Rajdhani', sans-serif;"
                                   oninput="filterSpecs()">
                        </div>
                        <button class="btn" onclick="openCSIBrowserModal()" style="background: rgba(0, 255, 136, 0.2); border: 1px solid var(--mc-accent);">
                            <i class="fas fa-book-open"></i> Import from CSI
                        </button>
                    </div>

                    <!-- Spec List Table -->
                    <div style="flex: 1; overflow-y: auto; padding: 1.5rem;">
                        <div id="specs-container">
                            <div class="loading-spinner">
                                <i class="fas fa-spinner fa-spin neon-cyan"></i>
                                <p>Loading specifications...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div id="pagination" style="padding: 1rem 1.5rem; border-top: 1px solid rgba(0, 255, 255, 0.2); display: flex; justify-content: center; gap: 0.5rem;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Specification Modal -->
<div id="specModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 id="specModalTitle">Add Specification</h3>
            <button class="close-btn" onclick="closeSpecModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="specForm">
                <input type="hidden" id="specLibraryId">

                <div class="form-group">
                    <label for="specStandardId"><i class="fas fa-bookmark"></i> Spec Standard *</label>
                    <select id="specStandardId" class="project-select-control" style="width: 100%;" required>
                        <option value="">-- Select Standard --</option>
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="specNumber"><i class="fas fa-hashtag"></i> Spec Number *</label>
                        <input type="text" id="specNumber" placeholder="e.g., 03 30 00"
                               style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 8px; color: var(--mc-text); font-family: 'Rajdhani', sans-serif;" required>
                    </div>

                    <div class="form-group">
                        <label for="specTitle"><i class="fas fa-heading"></i> Spec Title *</label>
                        <input type="text" id="specTitle" placeholder="e.g., Cast-in-Place Concrete"
                               style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 8px; color: var(--mc-text); font-family: 'Rajdhani', sans-serif;" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="csiCode"><i class="fas fa-book-open"></i> CSI Code</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="csiCode" placeholder="Select CSI Code..." readonly
                               style="flex: 1; padding: 10px; background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 8px; color: var(--mc-text); font-family: 'Rajdhani', sans-serif;">
                        <button type="button" class="btn" onclick="openCSISelector()" style="background: rgba(0, 255, 136, 0.2); border: 1px solid var(--mc-accent);">
                            <i class="fas fa-search"></i> Browse
                        </button>
                        <button type="button" class="btn" onclick="clearCSICode()" style="background: rgba(255, 68, 68, 0.2); border: 1px solid var(--mc-danger);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="specContent"><i class="fas fa-file-alt"></i> Content</label>
                    <textarea id="specContent" rows="8" placeholder="Enter specification content..."
                              style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 8px; color: var(--mc-text); font-family: 'Rajdhani', sans-serif; resize: vertical;"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="specVersion"><i class="fas fa-code-branch"></i> Version</label>
                        <input type="text" id="specVersion" placeholder="e.g., 1.0"
                               style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 8px; color: var(--mc-text); font-family: 'Rajdhani', sans-serif;">
                    </div>

                    <div class="form-group">
                        <label for="effectiveDate"><i class="fas fa-calendar"></i> Effective Date</label>
                        <input type="date" id="effectiveDate"
                               style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 8px; color: var(--mc-text); font-family: 'Rajdhani', sans-serif;">
                    </div>
                </div>

                <div class="modal-footer" style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(0, 255, 255, 0.2);">
                    <button type="button" class="btn" onclick="closeSpecModal()" style="background: rgba(136, 146, 176, 0.2); border: 1px solid var(--mc-muted);">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn" style="background: linear-gradient(135deg, var(--mc-primary), var(--mc-accent));">
                        <i class="fas fa-save"></i> Save Specification
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- CSI Code Browser Modal -->
<div id="csiBrowserModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3>CSI MasterFormat Browser</h3>
            <button class="close-btn" onclick="closeCSIBrowserModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <input type="text" id="csiSearchBox" placeholder="Search CSI codes..."
                       style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 8px; color: var(--mc-text); font-family: 'Rajdhani', sans-serif;"
                       oninput="filterCSICodes()">
            </div>
            <div id="csiTree" style="max-height: 400px; overflow-y: auto; border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 8px; padding: 1rem; background: rgba(0, 0, 0, 0.2);">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin neon-cyan"></i>
                    <p>Loading CSI codes...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 style="color: var(--mc-danger);"><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h3>
            <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="confirm-dialog">
                <p id="deleteMessage">Are you sure you want to delete this specification?</p>
                <div id="deleteWarnings" style="margin: 1rem 0; padding: 1rem; background: rgba(255, 68, 68, 0.1); border: 1px solid var(--mc-danger); border-radius: 8px; display: none;">
                    <p style="color: var(--mc-danger); font-weight: bold; margin-bottom: 0.5rem;">
                        <i class="fas fa-exclamation-triangle"></i> Warning
                    </p>
                    <p id="deleteWarningText"></p>
                </div>
                <div class="confirm-actions">
                    <button class="btn" onclick="closeDeleteModal()" style="background: rgba(136, 146, 176, 0.2); border: 1px solid var(--mc-muted);">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn" onclick="confirmDelete()" style="background: linear-gradient(135deg, #ff4444, #cc0000);">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.spec-row {
    padding: 1rem;
    border: 1px solid rgba(0, 255, 255, 0.2);
    border-radius: 8px;
    margin-bottom: 0.5rem;
    background: rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    cursor: pointer;
}

.spec-row:hover {
    background: rgba(0, 255, 255, 0.05);
    border-color: var(--mc-primary);
    transform: translateX(4px);
}

.spec-row.expanded {
    background: rgba(0, 255, 255, 0.1);
    border-color: var(--mc-accent);
}

.spec-header {
    display: grid;
    grid-template-columns: 150px 1fr 200px 150px 120px;
    gap: 1rem;
    align-items: center;
}

.spec-detail {
    display: none;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(0, 255, 255, 0.2);
}

.spec-row.expanded .spec-detail {
    display: block;
}

.standard-item {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border: 1px solid rgba(0, 255, 255, 0.2);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(0, 0, 0, 0.2);
}

.standard-item:hover {
    background: rgba(0, 255, 255, 0.1);
    border-color: var(--mc-primary);
    transform: translateX(4px);
}

.standard-item.active {
    background: rgba(0, 255, 136, 0.2);
    border-color: var(--mc-accent);
}

.csi-division {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border: 1px solid rgba(0, 255, 255, 0.2);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(0, 0, 0, 0.2);
}

.csi-division:hover {
    background: rgba(0, 255, 255, 0.1);
    border-color: var(--mc-primary);
}

.csi-code {
    padding: 0.5rem 0.75rem;
    margin-left: 1rem;
    margin-bottom: 0.25rem;
    border-left: 2px solid rgba(0, 255, 136, 0.3);
    cursor: pointer;
    transition: all 0.3s ease;
}

.csi-code:hover {
    background: rgba(0, 255, 136, 0.1);
    border-left-color: var(--mc-accent);
}

.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 600;
}

.badge-primary {
    background: rgba(0, 255, 255, 0.2);
    color: var(--mc-primary);
    border: 1px solid var(--mc-primary);
}

.badge-success {
    background: rgba(0, 255, 136, 0.2);
    color: var(--mc-accent);
    border: 1px solid var(--mc-accent);
}

.action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    transition: all 0.3s ease;
    background: rgba(0, 255, 255, 0.2);
    color: var(--mc-primary);
    border: 1px solid var(--mc-primary);
}

.action-btn:hover {
    background: rgba(0, 255, 255, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 255, 255, 0.3);
}

.action-btn.danger {
    background: rgba(255, 68, 68, 0.2);
    color: var(--mc-danger);
    border-color: var(--mc-danger);
}

.action-btn.danger:hover {
    background: rgba(255, 68, 68, 0.3);
    box-shadow: 0 4px 8px rgba(255, 68, 68, 0.3);
}

.pagination-btn {
    padding: 8px 16px;
    border: 1px solid var(--mc-primary);
    background: rgba(0, 255, 255, 0.1);
    color: var(--mc-primary);
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    transition: all 0.3s ease;
}

.pagination-btn:hover:not(:disabled) {
    background: rgba(0, 255, 255, 0.2);
    transform: translateY(-2px);
}

.pagination-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.pagination-btn.active {
    background: var(--mc-primary);
    color: var(--mc-black);
}
</style>

{% endblock %}

{% block scripts %}
<script>
// State
let allSpecs = [];
let allStandards = [];
let allCSICodes = [];
let filteredSpecs = [];
let currentPage = 1;
let selectedStandardId = null;
let selectedCSICode = null;
let deleteTargetId = null;
const ITEMS_PER_PAGE = 50;

// API Helper
async function apiCall(endpoint, method = 'GET', data = null) {
    const options = { method, headers: { 'Content-Type': 'application/json' } };
    if (data) options.body = JSON.stringify(data);

    const response = await fetch(endpoint, options);
    if (!response.ok) {
        const error = await response.text();
        throw new Error(error);
    }
    return response.json();
}

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    await loadStandards();
    await loadSpecs();
    await loadCSICodes();
});

// Load Standards
async function loadStandards() {
    try {
        allStandards = await apiCall('/api/spec-standards');
        renderStandardsTree();

        // Populate filter dropdown
        const filterSelect = document.getElementById('standardFilter');
        const modalSelect = document.getElementById('specStandardId');
        allStandards.forEach(standard => {
            const option1 = document.createElement('option');
            option1.value = standard.spec_standard_id;
            option1.textContent = `${standard.standard_name} (${standard.abbreviation || ''})`;
            filterSelect.appendChild(option1);

            const option2 = option1.cloneNode(true);
            modalSelect.appendChild(option2);
        });
    } catch (error) {
        console.error('Failed to load standards:', error);
        showToast('Failed to load standards', 'error');
    }
}

// Render Standards Tree
function renderStandardsTree() {
    const tree = document.getElementById('standards-tree');
    tree.innerHTML = `
        <div class="standard-item ${selectedStandardId === null ? 'active' : ''}" onclick="selectStandard(null)">
            <i class="fas fa-list"></i> All Standards
        </div>
        ${allStandards.map(standard => `
            <div class="standard-item ${selectedStandardId === standard.spec_standard_id ? 'active' : ''}" onclick="selectStandard(${standard.spec_standard_id})">
                <i class="fas fa-bookmark"></i> ${standard.standard_name}
                <div style="font-size: 0.85rem; color: var(--mc-muted); margin-top: 0.25rem;">
                    ${standard.abbreviation || ''}
                </div>
            </div>
        `).join('')}
    `;
}

// Select Standard
function selectStandard(standardId) {
    selectedStandardId = standardId;
    renderStandardsTree();
    filterSpecs();
}

// Load Specifications
async function loadSpecs() {
    try {
        allSpecs = await apiCall('/api/spec-library');
        filterSpecs();
        document.getElementById('spec-count').textContent = `${allSpecs.length} specifications`;
    } catch (error) {
        console.error('Failed to load specs:', error);
        document.getElementById('specs-container').innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Failed to load specifications: ${error.message}</p>
            </div>
        `;
    }
}

// Filter Specifications
function filterSpecs() {
    const searchTerm = document.getElementById('searchBox').value.toLowerCase();
    const standardFilter = document.getElementById('standardFilter').value;

    filteredSpecs = allSpecs.filter(spec => {
        const matchesSearch = !searchTerm ||
            spec.spec_number.toLowerCase().includes(searchTerm) ||
            spec.spec_title.toLowerCase().includes(searchTerm) ||
            (spec.content_structure && JSON.stringify(spec.content_structure).toLowerCase().includes(searchTerm));

        const matchesStandard = !standardFilter || spec.spec_standard_id == standardFilter;
        const matchesSelected = selectedStandardId === null || spec.spec_standard_id == selectedStandardId;

        return matchesSearch && matchesStandard && matchesSelected;
    });

    currentPage = 1;
    renderSpecs();
}

// Render Specifications
function renderSpecs() {
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageSpecs = filteredSpecs.slice(start, end);

    const container = document.getElementById('specs-container');

    if (pageSpecs.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--mc-muted);">
                <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <p>No specifications found</p>
            </div>
        `;
        document.getElementById('pagination').innerHTML = '';
        return;
    }

    container.innerHTML = pageSpecs.map(spec => {
        const standard = allStandards.find(s => s.spec_standard_id === spec.spec_standard_id);
        return `
            <div class="spec-row" onclick="toggleSpecDetail(${spec.spec_library_id})">
                <div class="spec-header">
                    <div>
                        <strong style="color: var(--mc-primary);">${spec.spec_number}</strong>
                    </div>
                    <div>
                        <strong>${spec.spec_title}</strong>
                    </div>
                    <div>
                        <span class="badge badge-primary">${standard ? standard.abbreviation : 'N/A'}</span>
                    </div>
                    <div>
                        ${spec.csi_code ? `<span class="badge badge-success">CSI: ${spec.csi_code}</span>` : '-'}
                    </div>
                    <div style="display: flex; gap: 0.5rem;" onclick="event.stopPropagation();">
                        <button class="action-btn" onclick="openEditSpecModal(${spec.spec_library_id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn danger" onclick="openDeleteModal(${spec.spec_library_id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="spec-detail" id="detail-${spec.spec_library_id}">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4 class="orbitron" style="color: var(--mc-accent); font-size: 0.9rem; margin-bottom: 0.5rem;">Details</h4>
                            <div style="color: var(--mc-muted); line-height: 1.8;">
                                <div><strong>Version:</strong> ${spec.version || 'N/A'}</div>
                                <div><strong>Effective Date:</strong> ${spec.effective_date || 'N/A'}</div>
                                <div><strong>Created:</strong> ${formatDate(spec.created_at)}</div>
                            </div>
                        </div>
                        <div>
                            <h4 class="orbitron" style="color: var(--mc-accent); font-size: 0.9rem; margin-bottom: 0.5rem;">Content Preview</h4>
                            <div style="max-height: 150px; overflow-y: auto; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 6px; color: var(--mc-muted); font-size: 0.9rem;">
                                ${spec.content_structure ? JSON.stringify(spec.content_structure, null, 2) : 'No content'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    renderPagination();
}

// Toggle Spec Detail
function toggleSpecDetail(id) {
    const row = event.currentTarget;
    row.classList.toggle('expanded');
}

// Render Pagination
function renderPagination() {
    const totalPages = Math.ceil(filteredSpecs.length / ITEMS_PER_PAGE);
    const pagination = document.getElementById('pagination');

    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = `
        <button class="pagination-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i> Previous
        </button>
    `;

    for (let i = 1; i <= Math.min(totalPages, 10); i++) {
        html += `
            <button class="pagination-btn ${currentPage === i ? 'active' : ''}" onclick="changePage(${i})">
                ${i}
            </button>
        `;
    }

    html += `
        <button class="pagination-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
            Next <i class="fas fa-chevron-right"></i>
        </button>
    `;

    pagination.innerHTML = html;
}

// Change Page
function changePage(page) {
    const totalPages = Math.ceil(filteredSpecs.length / ITEMS_PER_PAGE);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderSpecs();
}

// Load CSI Codes
async function loadCSICodes() {
    try {
        allCSICodes = await apiCall('/api/csi-masterformat');
    } catch (error) {
        console.error('Failed to load CSI codes:', error);
    }
}

// Modal Functions
function openAddSpecModal() {
    document.getElementById('specModalTitle').textContent = 'Add Specification';
    document.getElementById('specForm').reset();
    document.getElementById('specLibraryId').value = '';
    document.getElementById('specModal').classList.add('active');
}

function openEditSpecModal(id) {
    const spec = allSpecs.find(s => s.spec_library_id === id);
    if (!spec) return;

    document.getElementById('specModalTitle').textContent = 'Edit Specification';
    document.getElementById('specLibraryId').value = spec.spec_library_id;
    document.getElementById('specStandardId').value = spec.spec_standard_id || '';
    document.getElementById('specNumber').value = spec.spec_number || '';
    document.getElementById('specTitle').value = spec.spec_title || '';
    document.getElementById('csiCode').value = spec.csi_code || '';
    selectedCSICode = spec.csi_code || null;
    document.getElementById('specContent').value = spec.content_structure ? JSON.stringify(spec.content_structure, null, 2) : '';
    document.getElementById('specVersion').value = spec.version || '';
    document.getElementById('effectiveDate').value = spec.effective_date || '';

    document.getElementById('specModal').classList.add('active');
}

function closeSpecModal() {
    document.getElementById('specModal').classList.remove('active');
}

// Save Specification
document.getElementById('specForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = document.getElementById('specLibraryId').value;
    const data = {
        spec_standard_id: parseInt(document.getElementById('specStandardId').value),
        spec_number: document.getElementById('specNumber').value,
        spec_title: document.getElementById('specTitle').value,
        csi_code: selectedCSICode,
        content_structure: document.getElementById('specContent').value ? JSON.parse(document.getElementById('specContent').value) : {},
        version: document.getElementById('specVersion').value || null,
        effective_date: document.getElementById('effectiveDate').value || null
    };

    try {
        if (id) {
            await apiCall(`/api/spec-library/${id}`, 'PUT', data);
            showToast('Specification updated successfully', 'success');
        } else {
            await apiCall('/api/spec-library', 'POST', data);
            showToast('Specification created successfully', 'success');
        }
        closeSpecModal();
        await loadSpecs();
    } catch (error) {
        showToast('Failed to save specification: ' + error.message, 'error');
    }
});

// CSI Code Functions
function openCSIBrowserModal() {
    renderCSITree();
    document.getElementById('csiBrowserModal').classList.add('active');
}

function closeCSIBrowserModal() {
    document.getElementById('csiBrowserModal').classList.remove('active');
}

function openCSISelector() {
    renderCSITree();
    document.getElementById('csiBrowserModal').classList.add('active');
}

function clearCSICode() {
    selectedCSICode = null;
    document.getElementById('csiCode').value = '';
}

function renderCSITree() {
    const tree = document.getElementById('csiTree');

    if (allCSICodes.length === 0) {
        tree.innerHTML = '<p style="color: var(--mc-muted); text-align: center;">No CSI codes available</p>';
        return;
    }

    // Group by division
    const divisions = {};
    allCSICodes.forEach(code => {
        const division = code.division || 'Other';
        if (!divisions[division]) divisions[division] = [];
        divisions[division].push(code);
    });

    tree.innerHTML = Object.keys(divisions).sort().map(division => `
        <div class="csi-division">
            <strong style="color: var(--mc-primary);">${division}</strong>
            ${divisions[division].map(code => `
                <div class="csi-code" onclick="selectCSICode('${code.code_number}', '${code.title}')">
                    <strong>${code.code_number}</strong> - ${code.title}
                </div>
            `).join('')}
        </div>
    `).join('');
}

function selectCSICode(code, title) {
    selectedCSICode = code;
    document.getElementById('csiCode').value = `${code} - ${title}`;
    closeCSIBrowserModal();
    showToast('CSI code selected', 'success');
}

function filterCSICodes() {
    const searchTerm = document.getElementById('csiSearchBox').value.toLowerCase();

    const filtered = allCSICodes.filter(code =>
        code.code_number.toLowerCase().includes(searchTerm) ||
        code.title.toLowerCase().includes(searchTerm)
    );

    const tree = document.getElementById('csiTree');
    tree.innerHTML = filtered.map(code => `
        <div class="csi-code" onclick="selectCSICode('${code.code_number}', '${code.title}')">
            <strong>${code.code_number}</strong> - ${code.title}
        </div>
    `).join('');
}

// Delete Functions
function openDeleteModal(id) {
    deleteTargetId = id;
    const spec = allSpecs.find(s => s.spec_library_id === id);

    document.getElementById('deleteMessage').textContent =
        `Are you sure you want to delete "${spec.spec_number} - ${spec.spec_title}"?`;

    // TODO: Check project usage via API
    // For now, just show the modal
    document.getElementById('deleteModal').classList.add('active');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('active');
    deleteTargetId = null;
}

async function confirmDelete() {
    if (!deleteTargetId) return;

    try {
        await apiCall(`/api/spec-library/${deleteTargetId}`, 'DELETE');
        showToast('Specification deleted successfully', 'success');
        closeDeleteModal();
        await loadSpecs();
    } catch (error) {
        showToast('Failed to delete specification: ' + error.message, 'error');
    }
}

// Utility Functions
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}
</script>
{% endblock %}
