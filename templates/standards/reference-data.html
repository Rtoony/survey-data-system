{% extends 'base.html' %}

{% block title %}Reference Data Hub{% endblock %}

{% block content %}
<div class="container">
    <h1><i class="fas fa-database"></i> Reference Data Hub</h1>
    <p class="subtitle">System Configuration & Reference Tables</p>
    
    <div class="tabs">
        <div class="tab active" data-tab="clients">Clients</div>
        <div class="tab" data-tab="vendors">Vendors</div>
        <div class="tab" data-tab="municipalities">Municipalities</div>
        <div class="tab" data-tab="coordinate-systems">Coordinate Systems</div>
        <div class="tab" data-tab="survey-points">Survey Point Descriptions</div>
        <div class="tab" data-tab="gis-layers">GIS Data Layers</div>
        <div class="tab" data-tab="naming-templates">Naming Templates</div>
        <div class="tab" data-tab="cad-standards">CAD Standards</div>
    </div>
    
    <div class="tab-content active" id="clients">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-briefcase"></i> Clients</h2>
                <button class="btn btn-add" onclick="openAddClientModal()">
                    <i class="fas fa-plus"></i> Add New Client
                </button>
            </div>
            <p style="color: var(--muted); margin-bottom: 20px;">
                Manage client organizations and contact information.
            </p>
            <div id="clientsContainer"></div>
        </div>
    </div>
    
    <div class="tab-content" id="vendors">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-truck"></i> Vendors</h2>
                <button class="btn btn-add" onclick="openAddVendorModal()">
                    <i class="fas fa-plus"></i> Add New Vendor
                </button>
            </div>
            <p style="color: var(--muted); margin-bottom: 20px;">
                Manage vendor companies, specialties, and certifications.
            </p>
            <div id="vendorsContainer"></div>
        </div>
    </div>
    
    <div class="tab-content" id="municipalities">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-city"></i> Municipalities</h2>
                <button class="btn btn-add" onclick="openAddMunicipalityModal()">
                    <i class="fas fa-plus"></i> Add New Municipality
                </button>
            </div>
            <p style="color: var(--muted); margin-bottom: 20px;">
                Manage municipalities, contacts, and CAD standards requirements.
            </p>
            <div id="municipalitiesContainer"></div>
        </div>
    </div>
    
    <div class="tab-content" id="coordinate-systems">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-globe"></i> Coordinate Systems</h2>
                <button class="btn btn-add" onclick="openAddCoordinateSystemModal()">
                    <i class="fas fa-plus"></i> Add New Coordinate System
                </button>
            </div>
            <p style="color: var(--muted); margin-bottom: 20px;">
                Manage coordinate reference systems and projections.
            </p>
            <div id="coordinateSystemsContainer"></div>
        </div>
    </div>
    
    <div class="tab-content" id="survey-points">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-map-pin"></i> Survey Point Descriptions</h2>
                <button class="btn btn-add" onclick="openAddSurveyPointModal()">
                    <i class="fas fa-plus"></i> Add New Description
                </button>
            </div>
            <p style="color: var(--muted); margin-bottom: 20px;">
                Manage standard survey point description codes and categories.
            </p>
            <div id="surveyPointsContainer"></div>
        </div>
    </div>
    
    <div class="tab-content" id="gis-layers">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-layer-group"></i> GIS Data Layers</h2>
                <button class="btn btn-add" onclick="openAddGISLayerModal()">
                    <i class="fas fa-plus"></i> Add New Layer
                </button>
            </div>
            <p style="color: var(--muted); margin-bottom: 20px;">
                Manage GIS data layers from external services with server links and configuration.
            </p>
            <div id="gisLayersContainer"></div>
        </div>
    </div>
    
    <div class="tab-content" id="naming-templates">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-tags"></i> Relationship Set Naming Templates</h2>
                <button class="btn btn-add" onclick="openAddNamingTemplateModal()">
                    <i class="fas fa-plus"></i> Add New Template
                </button>
            </div>
            <p style="color: var(--muted); margin-bottom: 20px;">
                Manage standard naming conventions for Project Relationship Sets. Templates enforce truth-driven architecture by preventing free-text naming and ensuring consistency across projects.
            </p>
            <div id="namingTemplatesContainer"></div>
        </div>
    </div>
    
    <div class="tab-content" id="cad-standards">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-drafting-compass"></i> CAD Standards</h2>
                <p style="color: var(--muted); margin: 0;">
                    Manage CAD element libraries and standards
                </p>
            </div>
            
            <div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; margin-top: 20px;">
                <div class="cad-standards-nav">
                    <div class="cad-standards-nav-item active" data-cad-tab="blocks">
                        <i class="fas fa-cube"></i> Blocks
                    </div>
                    <div class="cad-standards-nav-item" data-cad-tab="hatches">
                        <i class="fas fa-fill-drip"></i> Hatches
                    </div>
                    <div class="cad-standards-nav-item" data-cad-tab="linetypes">
                        <i class="fas fa-minus"></i> Linetypes
                    </div>
                    <div class="cad-standards-nav-item" data-cad-tab="text-styles">
                        <i class="fas fa-font"></i> Text Styles
                    </div>
                    <div class="cad-standards-nav-item" data-cad-tab="dimension-styles">
                        <i class="fas fa-ruler-combined"></i> Dimension Styles
                    </div>
                    <div class="cad-standards-nav-item" data-cad-tab="materials">
                        <i class="fas fa-tools"></i> Materials
                    </div>
                    <div class="cad-standards-nav-item" data-cad-tab="details">
                        <i class="fas fa-file-alt"></i> Details
                    </div>
                    <div class="cad-standards-nav-item" data-cad-tab="standard-notes">
                        <i class="fas fa-sticky-note"></i> Standard Notes
                    </div>
                    <div class="cad-standards-nav-item" data-cad-tab="abbreviations">
                        <i class="fas fa-font"></i> Abbreviations
                    </div>
                </div>
                
                <div class="cad-standards-content">
                    <iframe id="cad-blocks-content" class="cad-sub-content cad-iframe active" src="/data-manager/blocks?embedded=true" frameborder="0"></iframe>
                    <iframe id="cad-hatches-content" class="cad-sub-content cad-iframe" data-src="/data-manager/hatches?embedded=true" frameborder="0"></iframe>
                    <iframe id="cad-linetypes-content" class="cad-sub-content cad-iframe" data-src="/data-manager/linetypes?embedded=true" frameborder="0"></iframe>
                    <iframe id="cad-text-styles-content" class="cad-sub-content cad-iframe" data-src="/data-manager/text-styles?embedded=true" frameborder="0"></iframe>
                    <iframe id="cad-dimension-styles-content" class="cad-sub-content cad-iframe" data-src="/data-manager/dimension-styles?embedded=true" frameborder="0"></iframe>
                    <iframe id="cad-materials-content" class="cad-sub-content cad-iframe" data-src="/data-manager/materials?embedded=true" frameborder="0"></iframe>
                    <iframe id="cad-details-content" class="cad-sub-content cad-iframe" data-src="/data-manager/details?embedded=true" frameborder="0"></iframe>
                    <iframe id="cad-standard-notes-content" class="cad-sub-content cad-iframe" data-src="/data-manager/standard-notes?embedded=true" frameborder="0"></iframe>
                    <iframe id="cad-abbreviations-content" class="cad-sub-content cad-iframe" data-src="/data-manager/abbreviations?embedded=true" frameborder="0"></iframe>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="clientModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="clientModalTitle">Add New Client</h3>
            <button class="close-btn" onclick="closeClientModal()">&times;</button>
        </div>
        <form id="clientForm" onsubmit="handleClientSubmit(event)">
            <div class="form-group">
                <label>Client Name <span style="color: #ff4444;">*</span></label>
                <input type="text" name="client_name" required placeholder="e.g., Acme Corporation">
            </div>
            <div class="form-group">
                <label>Short Name</label>
                <input type="text" name="short_name" placeholder="e.g., ACME">
                <div class="help-text">Abbreviated name for reports and labels</div>
            </div>
            <div class="form-group">
                <label>Contact Name</label>
                <input type="text" name="contact_name" placeholder="John Doe">
            </div>
            <div class="form-group">
                <label>Contact Email</label>
                <input type="email" name="contact_email" placeholder="john@example.com">
            </div>
            <div class="form-group">
                <label>Contact Phone</label>
                <input type="tel" name="contact_phone" placeholder="(555) 123-4567">
            </div>
            <div class="form-group">
                <label>Address</label>
                <input type="text" name="address" placeholder="123 Main Street">
            </div>
            <div class="form-group">
                <label>City</label>
                <input type="text" name="city" placeholder="Springfield">
            </div>
            <div class="form-group">
                <label>State</label>
                <input type="text" name="state" placeholder="IL">
            </div>
            <div class="form-group">
                <label>Zip Code</label>
                <input type="text" name="zip_code" placeholder="12345">
            </div>
            <div class="form-group">
                <label>Website</label>
                <input type="url" name="website" placeholder="https://example.com">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea name="notes" placeholder="Additional notes about this client..."></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="closeClientModal()">Cancel</button>
                <button type="submit" class="btn btn-submit">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="vendorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="vendorModalTitle">Add New Vendor</h3>
            <button class="close-btn" onclick="closeVendorModal()">&times;</button>
        </div>
        <form id="vendorForm" onsubmit="handleVendorSubmit(event)">
            <div class="form-group">
                <label>Vendor Name <span style="color: #ff4444;">*</span></label>
                <input type="text" name="vendor_name" required placeholder="e.g., ABC Utility Supply">
            </div>
            <div class="form-group">
                <label>Vendor Type</label>
                <select name="vendor_type">
                    <option value="">Select Type</option>
                    <option value="Manufacturer">Manufacturer</option>
                    <option value="Distributor">Distributor</option>
                    <option value="Contractor">Contractor</option>
                    <option value="Consultant">Consultant</option>
                    <option value="Service Provider">Service Provider</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Specialty</label>
                <input type="text" name="specialty" placeholder="e.g., Water Infrastructure">
                <div class="help-text">Primary area of specialization</div>
            </div>
            <div class="form-group">
                <label>Contact Name</label>
                <input type="text" name="contact_name" placeholder="Jane Smith">
            </div>
            <div class="form-group">
                <label>Contact Email</label>
                <input type="email" name="contact_email" placeholder="jane@vendor.com">
            </div>
            <div class="form-group">
                <label>Contact Phone</label>
                <input type="tel" name="contact_phone" placeholder="(555) 987-6543">
            </div>
            <div class="form-group">
                <label>Address</label>
                <input type="text" name="address" placeholder="456 Industry Blvd">
            </div>
            <div class="form-group">
                <label>City</label>
                <input type="text" name="city" placeholder="Chicago">
            </div>
            <div class="form-group">
                <label>State</label>
                <input type="text" name="state" placeholder="IL">
            </div>
            <div class="form-group">
                <label>Zip Code</label>
                <input type="text" name="zip_code" placeholder="60601">
            </div>
            <div class="form-group">
                <label>Website</label>
                <input type="url" name="website" placeholder="https://vendor.com">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea name="notes" placeholder="Additional notes about this vendor..."></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="closeVendorModal()">Cancel</button>
                <button type="submit" class="btn btn-submit">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="municipalityModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="municipalityModalTitle">Add New Municipality</h3>
            <button class="close-btn" onclick="closeMunicipalityModal()">&times;</button>
        </div>
        <form id="municipalityForm" onsubmit="handleMunicipalitySubmit(event)">
            <div class="form-group">
                <label>Municipality Name <span style="color: #ff4444;">*</span></label>
                <input type="text" name="municipality_name" required placeholder="e.g., City of Springfield">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select name="municipality_type">
                    <option value="">Select Type</option>
                    <option value="City">City</option>
                    <option value="Town">Town</option>
                    <option value="Village">Village</option>
                    <option value="County">County</option>
                    <option value="Township">Township</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>County</label>
                <input type="text" name="county" placeholder="Sangamon County">
            </div>
            <div class="form-group">
                <label>State <span style="color: #ff4444;">*</span></label>
                <input type="text" name="state" required placeholder="IL">
            </div>
            <div class="form-group">
                <label>FIPS Code</label>
                <input type="text" name="fips_code" placeholder="17167">
                <div class="help-text">Federal Information Processing Standards code</div>
            </div>
            <div class="form-group">
                <label>Contact Department</label>
                <input type="text" name="contact_department" placeholder="e.g., Engineering Department">
            </div>
            <div class="form-group">
                <label>Contact Name</label>
                <input type="text" name="contact_name" placeholder="City Engineer">
            </div>
            <div class="form-group">
                <label>Contact Email</label>
                <input type="email" name="contact_email" placeholder="engineering@city.gov">
            </div>
            <div class="form-group">
                <label>Contact Phone</label>
                <input type="tel" name="contact_phone" placeholder="(555) 555-1234">
            </div>
            <div class="form-group">
                <label>Address</label>
                <input type="text" name="address" placeholder="City Hall, 1 Municipal Drive">
            </div>
            <div class="form-group">
                <label>Website</label>
                <input type="url" name="website" placeholder="https://springfield.gov">
            </div>
            <div class="form-group">
                <label>Permit Portal URL</label>
                <input type="url" name="permit_portal_url" placeholder="https://permits.springfield.gov">
            </div>
            <div class="form-group">
                <label>CAD Standards URL</label>
                <input type="url" name="cad_standards_url" placeholder="https://springfield.gov/standards">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea name="notes" placeholder="Additional notes about this municipality..."></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="closeMunicipalityModal()">Cancel</button>
                <button type="submit" class="btn btn-submit">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="coordinateSystemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="coordinateSystemModalTitle">Add New Coordinate System</h3>
            <button class="close-btn" onclick="closeCoordinateSystemModal()">&times;</button>
        </div>
        <form id="coordinateSystemForm" onsubmit="handleCoordinateSystemSubmit(event)">
            <div class="form-group">
                <label>System Name <span style="color: #ff4444;">*</span></label>
                <input type="text" name="system_name" required placeholder="e.g., NAD83 Illinois State Plane East">
            </div>
            <div class="form-group">
                <label>EPSG Code <span style="color: #ff4444;">*</span></label>
                <input type="text" name="epsg_code" required placeholder="e.g., EPSG:3435">
                <div class="help-text">EPSG identifier for this coordinate system</div>
            </div>
            <div class="form-group">
                <label>Region</label>
                <input type="text" name="region" placeholder="e.g., Illinois - East">
            </div>
            <div class="form-group">
                <label>Datum</label>
                <input type="text" name="datum" placeholder="e.g., NAD83">
            </div>
            <div class="form-group">
                <label>Units</label>
                <select name="units">
                    <option value="">Select Units</option>
                    <option value="US Survey Feet">US Survey Feet</option>
                    <option value="International Feet">International Feet</option>
                    <option value="Meters">Meters</option>
                    <option value="Degrees">Degrees</option>
                </select>
            </div>
            <div class="form-group">
                <label>Zone Number</label>
                <input type="number" name="zone_number" placeholder="e.g., 16">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea name="notes" placeholder="Additional notes about this coordinate system..."></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="closeCoordinateSystemModal()">Cancel</button>
                <button type="submit" class="btn btn-submit">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="surveyPointModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="surveyPointModalTitle">Add New Survey Point Description</h3>
            <button class="close-btn" onclick="closeSurveyPointModal()">&times;</button>
        </div>
        <form id="surveyPointForm" onsubmit="handleSurveyPointSubmit(event)">
            <div class="form-group">
                <label>Code <span style="color: #ff4444;">*</span></label>
                <input type="text" name="code" required placeholder="e.g., IP" maxlength="10" style="text-transform: uppercase;">
                <div class="help-text">Short code for this point type (will be converted to uppercase)</div>
            </div>
            <div class="form-group">
                <label>Description <span style="color: #ff4444;">*</span></label>
                <input type="text" name="description" required placeholder="e.g., Iron Pin">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select name="category">
                    <option value="">Select Category</option>
                    <option value="Control">Control</option>
                    <option value="Boundary">Boundary</option>
                    <option value="Topographic">Topographic</option>
                    <option value="Utility">Utility</option>
                    <option value="Structure">Structure</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Discipline</label>
                <select name="discipline">
                    <option value="">Select Discipline</option>
                    <option value="Survey">Survey</option>
                    <option value="Civil">Civil</option>
                    <option value="Utilities">Utilities</option>
                    <option value="General">General</option>
                </select>
            </div>
            <div class="form-group">
                <label>Symbol Reference</label>
                <input type="text" name="symbol_reference" placeholder="e.g., SYM-001">
                <div class="help-text">CAD symbol or block reference</div>
            </div>
            <div class="form-group">
                <label>Layer Suggestion</label>
                <input type="text" name="layer_suggestion" placeholder="e.g., V-NODE-CTRL">
                <div class="help-text">Recommended layer name for this point type</div>
            </div>
            <div class="form-group">
                <label>Sort Order</label>
                <input type="number" name="sort_order" min="0" placeholder="100">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea name="notes" placeholder="Additional notes about this point description..."></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="closeSurveyPointModal()">Cancel</button>
                <button type="submit" class="btn btn-submit">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="gisLayerModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="gisLayerModalTitle">Add New GIS Data Layer</h3>
            <button class="close-btn" onclick="closeGISLayerModal()">&times;</button>
        </div>
        <form id="gisLayerForm" onsubmit="handleGISLayerSubmit(event)">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 14px;">Basic Information</h4>
                    <div class="form-group">
                        <label>Service ID <span style="color: #ff4444;">*</span></label>
                        <input type="text" name="service_id" required placeholder="e.g., sonoma_parcels_public">
                        <div class="help-text">Unique identifier for this layer service</div>
                    </div>
                    <div class="form-group">
                        <label>Layer Name <span style="color: #ff4444;">*</span></label>
                        <input type="text" name="name" required placeholder="e.g., Parcels Public">
                    </div>
                    <div class="form-group">
                        <label>Jurisdiction</label>
                        <input type="text" name="jurisdiction" placeholder="e.g., SonomaCounty">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select name="category">
                            <option value="">Select Category</option>
                            <option value="Parcels">Parcels</option>
                            <option value="Boundaries">Boundaries</option>
                            <option value="Roads">Roads</option>
                            <option value="Drainage">Drainage</option>
                            <option value="Addresses">Addresses</option>
                            <option value="Structures">Structures</option>
                            <option value="Facilities">Facilities</option>
                            <option value="Parks">Parks</option>
                            <option value="Imagery">Imagery</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>REST URL <span style="color: #ff4444;">*</span></label>
                        <textarea name="rest_url" required placeholder="https://..." rows="3"></textarea>
                        <div class="help-text">ArcGIS REST service URL</div>
                    </div>
                </div>
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 14px;">Configuration</h4>
                    <div class="form-group">
                        <label>Layer Index</label>
                        <input type="number" name="layer" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Behavior</label>
                        <select name="behavior">
                            <option value="">Select Behavior</option>
                            <option value="dynamic">Dynamic</option>
                            <option value="static">Static</option>
                            <option value="tile">Tile</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Coordinate System (WKID)</label>
                        <input type="number" name="cs_wkid" placeholder="2226">
                    </div>
                    <div class="form-group">
                        <label>Query Where Clause</label>
                        <input type="text" name="query_where" placeholder="1=1">
                    </div>
                    <div class="form-group">
                        <label>Extent Mode</label>
                        <select name="extent_mode">
                            <option value="">Select Extent Mode</option>
                            <option value="project_area">Project Area</option>
                            <option value="full">Full</option>
                            <option value="viewport">Viewport</option>
                        </select>
                    </div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 14px;">Display Settings</h4>
                    <div class="form-group">
                        <label>Label Field</label>
                        <input type="text" name="label_field" placeholder="e.g., APN">
                    </div>
                    <div class="form-group">
                        <label>Label Format</label>
                        <input type="text" name="label_format" placeholder="e.g., APN {APN}">
                    </div>
                    <div class="form-group">
                        <label>Symbol Preset</label>
                        <input type="text" name="sym_preset" placeholder="e.g., BGD_Parcels">
                    </div>
                    <div class="form-group">
                        <label>Block Name</label>
                        <input type="text" name="block_name" placeholder="CAD block reference">
                    </div>
                </div>
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 14px;">Scale & Status</h4>
                    <div class="form-group">
                        <label>Min Scale</label>
                        <input type="number" name="min_scale" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Max Scale</label>
                        <input type="number" name="max_scale" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="testing">Testing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Last Verified</label>
                        <input type="date" name="last_verified">
                    </div>
                </div>
            </div>
            <div class="form-group" style="margin-top: 20px;">
                <label>Notes</label>
                <textarea name="notes" placeholder="Additional notes about this layer..." rows="3"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="closeGISLayerModal()">Cancel</button>
                <button type="submit" class="btn btn-submit">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="namingTemplateModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="namingTemplateModalTitle">Add New Naming Template</h3>
            <button class="close-btn" onclick="closeNamingTemplateModal()">&times;</button>
        </div>
        <form id="namingTemplateForm" onsubmit="handleNamingTemplateSubmit(event)">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 14px;">Basic Information</h4>
                    <div class="form-group">
                        <label>Template Name <span style="color: #ff4444;">*</span></label>
                        <input type="text" name="template_name" required placeholder="e.g., Storm System Compliance">
                        <div class="help-text">Descriptive name for this naming pattern</div>
                    </div>
                    <div class="form-group">
                        <label>Category <span style="color: #ff4444;">*</span></label>
                        <select name="category" required>
                            <option value="">Select Category</option>
                            <option value="Compliance">Compliance</option>
                            <option value="Network">Network</option>
                            <option value="Materials">Materials</option>
                            <option value="Survey">Survey</option>
                            <option value="Construction">Construction</option>
                            <option value="Accessibility">Accessibility</option>
                            <option value="Pavement">Pavement</option>
                            <option value="General">General</option>
                            <option value="BMP">BMP</option>
                            <option value="Cross-Reference">Cross-Reference</option>
                        </select>
                        <div class="help-text">Category for organizing templates</div>
                    </div>
                    <div class="form-group">
                        <label>Name Format <span style="color: #ff4444;">*</span></label>
                        <input type="text" name="name_format" required placeholder="e.g., {DISCIPLINE} {FEATURE_TYPE} for {PROJECT}">
                        <div class="help-text">Format string with {TOKEN} placeholders</div>
                    </div>
                    <div class="form-group">
                        <label>Short Code Format <span style="color: #ff4444;">*</span></label>
                        <input type="text" name="short_code_format" required placeholder="e.g., {DISC}-{TYPE}-{PROJ}">
                        <div class="help-text">Abbreviated format for compact display</div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" placeholder="Describe when to use this template..." rows="3"></textarea>
                    </div>
                </div>
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 14px;">Examples & Tokens</h4>
                    <div class="form-group">
                        <label>Example Name</label>
                        <input type="text" name="example_name" placeholder="e.g., Storm Drainage System for Main Street">
                        <div class="help-text">Filled-in example of name_format</div>
                    </div>
                    <div class="form-group">
                        <label>Example Code</label>
                        <input type="text" name="example_code" placeholder="e.g., STORM-DRAIN-MAIN">
                        <div class="help-text">Filled-in example of short_code_format</div>
                    </div>
                    <div class="form-group">
                        <label>Example Tokens (JSON)</label>
                        <textarea name="example_tokens" placeholder='{"DISCIPLINE": "Storm", "FEATURE_TYPE": "Drainage System", "PROJECT": "Main Street"}' rows="3"></textarea>
                        <div class="help-text">JSON object showing token values for examples</div>
                    </div>
                    <div class="form-group">
                        <label>Required Tokens (JSON Array)</label>
                        <textarea name="required_tokens" placeholder='["DISCIPLINE", "FEATURE_TYPE", "PROJECT"]' rows="2"></textarea>
                        <div class="help-text">Array of token names that must be filled</div>
                    </div>
                    <div class="form-group">
                        <label>Optional Tokens (JSON Array)</label>
                        <textarea name="optional_tokens" placeholder='["LOCATION", "PHASE"]' rows="2"></textarea>
                        <div class="help-text">Array of optional token names</div>
                    </div>
                </div>
            </div>
            <div class="form-group" style="margin-top: 20px;">
                <label>Usage Instructions</label>
                <textarea name="usage_instructions" placeholder="Step-by-step guide for using this template..." rows="4"></textarea>
                <div class="help-text">Detailed instructions for users</div>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" name="is_default">
                    <span>Set as Default Template for this Category</span>
                </label>
                <div class="help-text">Default templates are pre-selected when creating new relationship sets</div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="closeNamingTemplateModal()">Cancel</button>
                <button type="submit" class="btn btn-submit">Save Template</button>
            </div>
        </form>
    </div>
</div>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Delete</h3>
            <button class="close-btn" onclick="closeConfirmModal()">&times;</button>
        </div>
        <div class="confirm-dialog">
            <p id="confirmMessage">Are you sure you want to delete this item?</p>
            <div class="confirm-actions">
                <button class="btn btn-cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.cad-standards-nav {
    display: flex;
    flex-direction: column;
    gap: 4px;
    background: rgba(0,20,40,0.4);
    border-radius: 8px;
    padding: 12px;
}

.cad-standards-nav-item {
    padding: 12px 16px;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-color);
    background: transparent;
    border: 1px solid transparent;
}

.cad-standards-nav-item:hover {
    background: rgba(0,255,255,0.1);
    border-color: rgba(0,255,255,0.3);
}

.cad-standards-nav-item.active {
    background: rgba(0,255,255,0.15);
    border-color: var(--mc-primary);
    color: var(--mc-primary);
}

.cad-standards-nav-item i {
    width: 20px;
    text-align: center;
}

.cad-standards-content {
    min-height: 600px;
}

.cad-sub-content {
    display: none;
}

.cad-sub-content.active {
    display: block;
}

.cad-iframe {
    width: 100%;
    height: 800px;
    border: none;
    border-radius: 8px;
    background: rgba(0,20,40,0.3);
}

@media (max-width: 768px) {
    .cad-standards-nav {
        flex-direction: row;
        overflow-x: auto;
        white-space: nowrap;
    }
    
    .card > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
    }
    
    .cad-iframe {
        height: 600px;
    }
}
</style>

<script>
    let entities = [];
    let clients = [];
    let vendors = [];
    let municipalities = [];
    let coordinateSystems = [];
    let surveyPoints = [];
    let gisLayers = [];
    let namingTemplates = [];
    
    let currentEdit = {
        id: null,
        data: null,
        type: null
    };
    
    let deleteTarget = {
        id: null,
        name: null,
        type: null
    };
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            switch(tabName) {
                case 'clients':
                    if (clients.length === 0) loadClients();
                    break;
                case 'vendors':
                    if (vendors.length === 0) loadVendors();
                    break;
                case 'municipalities':
                    if (municipalities.length === 0) loadMunicipalities();
                    break;
                case 'naming-templates':
                    if (namingTemplates.length === 0) loadNamingTemplates();
                    break;
                case 'coordinate-systems':
                    if (coordinateSystems.length === 0) loadCoordinateSystems();
                    break;
                case 'survey-points':
                    if (surveyPoints.length === 0) loadSurveyPoints();
                    break;
                case 'gis-layers':
                    if (gisLayers.length === 0) loadGISLayers();
                    break;
            }
        });
    });
    
    document.querySelectorAll('.cad-standards-nav-item').forEach(navItem => {
        navItem.addEventListener('click', () => {
            const cadTab = navItem.dataset.cadTab;
            
            document.querySelectorAll('.cad-standards-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.cad-sub-content').forEach(content => {
                content.classList.remove('active');
            });
            
            navItem.classList.add('active');
            const iframe = document.getElementById(`cad-${cadTab}-content`);
            iframe.classList.add('active');
            
            if (iframe.dataset.src && !iframe.hasAttribute('src')) {
                iframe.src = iframe.dataset.src;
            }
        });
    });
    
    async function loadClients() {
        try {
            const response = await fetch('/api/clients');
            const data = await response.json();
            clients = data.clients || [];
            renderClients();
        } catch (error) {
            console.error('Error loading clients:', error);
            showToast('Failed to load clients', 'error');
        }
    }
    
    function renderClients() {
        const container = document.getElementById('clientsContainer');
        
        if (clients.length === 0) {
            container.innerHTML = `
                <div class="placeholder-message">
                    <i class="fas fa-briefcase"></i>
                    <h3>No clients yet</h3>
                    <p>Click "Add New Client" to register your first client.</p>
                </div>
            `;
            return;
        }
        
        const html = `
            <div class="grid">
                ${clients.map(client => `
                    <div class="entity-item">
                        <div class="entity-header">
                            <div style="display: flex; align-items: start;">
                                <i class="fas fa-briefcase entity-icon"></i>
                                <div class="entity-title">
                                    <div class="entity-name">${client.client_name}</div>
                                    ${client.short_name ? `<div class="entity-table">${client.short_name}</div>` : ''}
                                    ${client.contact_name ? `<div style="font-size: 0.85em; color: var(--muted); margin-top: 4px;"><i class="fas fa-user"></i> ${client.contact_name}</div>` : ''}
                                </div>
                            </div>
                        </div>
                        ${client.contact_email || client.contact_phone || client.city ? `
                            <div class="entity-desc">
                                ${client.contact_email ? `<div><i class="fas fa-envelope"></i> ${client.contact_email}</div>` : ''}
                                ${client.contact_phone ? `<div><i class="fas fa-phone"></i> ${client.contact_phone}</div>` : ''}
                                ${client.city && client.state ? `<div><i class="fas fa-map-marker-alt"></i> ${client.city}, ${client.state}</div>` : ''}
                            </div>
                        ` : ''}
                        <div class="item-actions">
                            <button class="icon-btn" onclick='openEditClientModal(${client.client_id}, ${JSON.stringify(client).replace(/'/g, "&apos;")})' title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="icon-btn delete" onclick='openDeleteModal(${client.client_id}, "${client.client_name}", "client")' title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    async function loadVendors() {
        try {
            const response = await fetch('/api/vendors');
            const data = await response.json();
            vendors = data.vendors || [];
            renderVendors();
        } catch (error) {
            console.error('Error loading vendors:', error);
            showToast('Failed to load vendors', 'error');
        }
    }
    
    function renderVendors() {
        const container = document.getElementById('vendorsContainer');
        
        if (vendors.length === 0) {
            container.innerHTML = `
                <div class="placeholder-message">
                    <i class="fas fa-truck"></i>
                    <h3>No vendors yet</h3>
                    <p>Click "Add New Vendor" to register your first vendor.</p>
                </div>
            `;
            return;
        }
        
        const html = `
            <div class="grid">
                ${vendors.map(vendor => `
                    <div class="entity-item">
                        <div class="entity-header">
                            <div style="display: flex; align-items: start;">
                                <i class="fas fa-truck entity-icon"></i>
                                <div class="entity-title">
                                    <div class="entity-name">${vendor.vendor_name}</div>
                                    ${vendor.vendor_type ? `<span class="entity-category">${vendor.vendor_type}</span>` : ''}
                                    ${vendor.specialty ? `<div style="font-size: 0.85em; color: var(--muted); margin-top: 4px;">${vendor.specialty}</div>` : ''}
                                </div>
                            </div>
                        </div>
                        ${vendor.contact_email || vendor.contact_phone || vendor.city ? `
                            <div class="entity-desc">
                                ${vendor.contact_name ? `<div><i class="fas fa-user"></i> ${vendor.contact_name}</div>` : ''}
                                ${vendor.contact_email ? `<div><i class="fas fa-envelope"></i> ${vendor.contact_email}</div>` : ''}
                                ${vendor.contact_phone ? `<div><i class="fas fa-phone"></i> ${vendor.contact_phone}</div>` : ''}
                                ${vendor.city && vendor.state ? `<div><i class="fas fa-map-marker-alt"></i> ${vendor.city}, ${vendor.state}</div>` : ''}
                            </div>
                        ` : ''}
                        <div class="item-actions">
                            <button class="icon-btn" onclick='openEditVendorModal(${vendor.vendor_id}, ${JSON.stringify(vendor).replace(/'/g, "&apos;")})' title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="icon-btn delete" onclick='openDeleteModal(${vendor.vendor_id}, "${vendor.vendor_name}", "vendor")' title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    async function loadMunicipalities() {
        try {
            const response = await fetch('/api/municipalities');
            const data = await response.json();
            municipalities = data.municipalities || [];
            renderMunicipalities();
        } catch (error) {
            console.error('Error loading municipalities:', error);
            showToast('Failed to load municipalities', 'error');
        }
    }
    
    function renderMunicipalities() {
        const container = document.getElementById('municipalitiesContainer');
        
        if (municipalities.length === 0) {
            container.innerHTML = `
                <div class="placeholder-message">
                    <i class="fas fa-city"></i>
                    <h3>No municipalities yet</h3>
                    <p>Click "Add New Municipality" to register your first municipality.</p>
                </div>
            `;
            return;
        }
        
        const html = `
            <div class="grid">
                ${municipalities.map(muni => `
                    <div class="entity-item">
                        <div class="entity-header">
                            <div style="display: flex; align-items: start;">
                                <i class="fas fa-city entity-icon"></i>
                                <div class="entity-title">
                                    <div class="entity-name">${muni.municipality_name}</div>
                                    ${muni.municipality_type ? `<span class="entity-category">${muni.municipality_type}</span>` : ''}
                                    <div style="font-size: 0.85em; color: var(--muted); margin-top: 4px;">
                                        ${muni.county ? muni.county + ', ' : ''}${muni.state}
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${muni.contact_email || muni.contact_phone || muni.contact_department ? `
                            <div class="entity-desc">
                                ${muni.contact_department ? `<div><i class="fas fa-building"></i> ${muni.contact_department}</div>` : ''}
                                ${muni.contact_email ? `<div><i class="fas fa-envelope"></i> ${muni.contact_email}</div>` : ''}
                                ${muni.contact_phone ? `<div><i class="fas fa-phone"></i> ${muni.contact_phone}</div>` : ''}
                            </div>
                        ` : ''}
                        <div class="item-actions">
                            <button class="icon-btn" onclick='openEditMunicipalityModal(${muni.municipality_id}, ${JSON.stringify(muni).replace(/'/g, "&apos;")})' title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="icon-btn delete" onclick='openDeleteModal(${muni.municipality_id}, "${muni.municipality_name}", "municipality")' title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    async function loadCoordinateSystems() {
        try {
            const response = await fetch('/api/coordinate-systems');
            const data = await response.json();
            coordinateSystems = data.coordinate_systems || [];
            renderCoordinateSystems();
        } catch (error) {
            console.error('Error loading coordinate systems:', error);
            showToast('Failed to load coordinate systems', 'error');
        }
    }
    
    function renderCoordinateSystems() {
        const container = document.getElementById('coordinateSystemsContainer');
        
        if (coordinateSystems.length === 0) {
            container.innerHTML = `
                <div class="placeholder-message">
                    <i class="fas fa-globe"></i>
                    <h3>No coordinate systems yet</h3>
                    <p>Click "Add New Coordinate System" to register your first coordinate system.</p>
                </div>
            `;
            return;
        }
        
        const html = `
            <div class="grid">
                ${coordinateSystems.map(sys => `
                    <div class="entity-item">
                        <div class="entity-header">
                            <div style="display: flex; align-items: start;">
                                <i class="fas fa-globe entity-icon"></i>
                                <div class="entity-title">
                                    <div class="entity-name">${sys.system_name}</div>
                                    <div class="entity-table">${sys.epsg_code}</div>
                                    ${sys.region ? `<div style="font-size: 0.85em; color: var(--muted); margin-top: 4px;">${sys.region}</div>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="entity-desc">
                            ${sys.datum ? `<div><strong>Datum:</strong> ${sys.datum}</div>` : ''}
                            ${sys.units ? `<div><strong>Units:</strong> ${sys.units}</div>` : ''}
                            ${sys.zone_number ? `<div><strong>Zone:</strong> ${sys.zone_number}</div>` : ''}
                        </div>
                        <div class="item-actions">
                            <button class="icon-btn" onclick='openEditCoordinateSystemModal("${sys.system_id}", ${JSON.stringify(sys).replace(/'/g, "&apos;")})' title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="icon-btn delete" onclick='openDeleteModal("${sys.system_id}", "${sys.system_name}", "coordinate-system")' title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    async function loadSurveyPoints() {
        try {
            const response = await fetch('/api/survey-point-descriptions');
            const data = await response.json();
            surveyPoints = data.survey_point_descriptions || [];
            renderSurveyPoints();
        } catch (error) {
            console.error('Error loading survey points:', error);
            showToast('Failed to load survey points', 'error');
        }
    }
    
    function renderSurveyPoints() {
        const container = document.getElementById('surveyPointsContainer');
        
        if (surveyPoints.length === 0) {
            container.innerHTML = `
                <div class="placeholder-message">
                    <i class="fas fa-map-pin"></i>
                    <h3>No survey point descriptions yet</h3>
                    <p>Click "Add New Description" to create your first survey point description.</p>
                </div>
            `;
            return;
        }
        
        const grouped = surveyPoints.reduce((acc, point) => {
            const category = point.category || 'Uncategorized';
            if (!acc[category]) acc[category] = [];
            acc[category].push(point);
            return acc;
        }, {});
        
        Object.values(grouped).forEach(group => {
            group.sort((a, b) => (a.sort_order || 999) - (b.sort_order || 999));
        });
        
        const html = Object.entries(grouped).map(([category, items]) => `
            <div class="category-section">
                <div class="category-header">
                    <span class="category-title">${category}</span>
                    <span class="category-count">(${items.length} ${items.length === 1 ? 'description' : 'descriptions'})</span>
                </div>
                <div class="grid">
                    ${items.map(point => `
                        <div class="entity-item">
                            <div class="entity-header">
                                <div style="display: flex; align-items: start;">
                                    <i class="fas fa-map-pin entity-icon"></i>
                                    <div class="entity-title">
                                        <div class="entity-name">${point.description}</div>
                                        <div class="entity-table">Code: ${point.code}</div>
                                        ${point.discipline ? `<span class="entity-category">${point.discipline}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            ${point.layer_suggestion || point.symbol_reference ? `
                                <div class="entity-desc">
                                    ${point.layer_suggestion ? `<div><strong>Layer:</strong> ${point.layer_suggestion}</div>` : ''}
                                    ${point.symbol_reference ? `<div><strong>Symbol:</strong> ${point.symbol_reference}</div>` : ''}
                                </div>
                            ` : ''}
                            <div class="item-actions">
                                <button class="icon-btn" onclick='openEditSurveyPointModal(${point.description_id}, ${JSON.stringify(point).replace(/'/g, "&apos;")})' title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn delete" onclick='openDeleteModal(${point.description_id}, "${point.code} - ${point.description}", "survey-point")' title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
        
        container.innerHTML = html;
    }
    
    function openAddClientModal() {
        currentEdit = { id: null, data: null, type: 'client' };
        document.getElementById('clientModalTitle').textContent = 'Add New Client';
        document.getElementById('clientForm').reset();
        document.getElementById('clientModal').classList.add('active');
    }
    
    function openEditClientModal(id, data) {
        currentEdit = { id, data, type: 'client' };
        document.getElementById('clientModalTitle').textContent = 'Edit Client';
        
        const form = document.getElementById('clientForm');
        form.client_name.value = data.client_name || '';
        form.short_name.value = data.short_name || '';
        form.contact_name.value = data.contact_name || '';
        form.contact_email.value = data.contact_email || '';
        form.contact_phone.value = data.contact_phone || '';
        form.address.value = data.address || '';
        form.city.value = data.city || '';
        form.state.value = data.state || '';
        form.zip_code.value = data.zip_code || '';
        form.website.value = data.website || '';
        form.notes.value = data.notes || '';
        
        document.getElementById('clientModal').classList.add('active');
    }
    
    function closeClientModal() {
        document.getElementById('clientModal').classList.remove('active');
        currentEdit = { id: null, data: null, type: null };
    }
    
    function openAddVendorModal() {
        currentEdit = { id: null, data: null, type: 'vendor' };
        document.getElementById('vendorModalTitle').textContent = 'Add New Vendor';
        document.getElementById('vendorForm').reset();
        document.getElementById('vendorModal').classList.add('active');
    }
    
    function openEditVendorModal(id, data) {
        currentEdit = { id, data, type: 'vendor' };
        document.getElementById('vendorModalTitle').textContent = 'Edit Vendor';
        
        const form = document.getElementById('vendorForm');
        form.vendor_name.value = data.vendor_name || '';
        form.vendor_type.value = data.vendor_type || '';
        form.specialty.value = data.specialty || '';
        form.contact_name.value = data.contact_name || '';
        form.contact_email.value = data.contact_email || '';
        form.contact_phone.value = data.contact_phone || '';
        form.address.value = data.address || '';
        form.city.value = data.city || '';
        form.state.value = data.state || '';
        form.zip_code.value = data.zip_code || '';
        form.website.value = data.website || '';
        form.notes.value = data.notes || '';
        
        document.getElementById('vendorModal').classList.add('active');
    }
    
    function closeVendorModal() {
        document.getElementById('vendorModal').classList.remove('active');
        currentEdit = { id: null, data: null, type: null };
    }
    
    function openAddMunicipalityModal() {
        currentEdit = { id: null, data: null, type: 'municipality' };
        document.getElementById('municipalityModalTitle').textContent = 'Add New Municipality';
        document.getElementById('municipalityForm').reset();
        document.getElementById('municipalityModal').classList.add('active');
    }
    
    function openEditMunicipalityModal(id, data) {
        currentEdit = { id, data, type: 'municipality' };
        document.getElementById('municipalityModalTitle').textContent = 'Edit Municipality';
        
        const form = document.getElementById('municipalityForm');
        form.municipality_name.value = data.municipality_name || '';
        form.municipality_type.value = data.municipality_type || '';
        form.county.value = data.county || '';
        form.state.value = data.state || '';
        form.fips_code.value = data.fips_code || '';
        form.contact_department.value = data.contact_department || '';
        form.contact_name.value = data.contact_name || '';
        form.contact_email.value = data.contact_email || '';
        form.contact_phone.value = data.contact_phone || '';
        form.address.value = data.address || '';
        form.website.value = data.website || '';
        form.permit_portal_url.value = data.permit_portal_url || '';
        form.cad_standards_url.value = data.cad_standards_url || '';
        form.notes.value = data.notes || '';
        
        document.getElementById('municipalityModal').classList.add('active');
    }
    
    function closeMunicipalityModal() {
        document.getElementById('municipalityModal').classList.remove('active');
        currentEdit = { id: null, data: null, type: null };
    }
    
    function openAddCoordinateSystemModal() {
        currentEdit = { id: null, data: null, type: 'coordinate-system' };
        document.getElementById('coordinateSystemModalTitle').textContent = 'Add New Coordinate System';
        document.getElementById('coordinateSystemForm').reset();
        document.getElementById('coordinateSystemModal').classList.add('active');
    }
    
    function openEditCoordinateSystemModal(id, data) {
        currentEdit = { id, data, type: 'coordinate-system' };
        document.getElementById('coordinateSystemModalTitle').textContent = 'Edit Coordinate System';
        
        const form = document.getElementById('coordinateSystemForm');
        form.system_name.value = data.system_name || '';
        form.epsg_code.value = data.epsg_code || '';
        form.region.value = data.region || '';
        form.datum.value = data.datum || '';
        form.units.value = data.units || '';
        form.zone_number.value = data.zone_number || '';
        form.notes.value = data.notes || '';
        
        document.getElementById('coordinateSystemModal').classList.add('active');
    }
    
    function closeCoordinateSystemModal() {
        document.getElementById('coordinateSystemModal').classList.remove('active');
        currentEdit = { id: null, data: null, type: null };
    }
    
    function openAddSurveyPointModal() {
        currentEdit = { id: null, data: null, type: 'survey-point' };
        document.getElementById('surveyPointModalTitle').textContent = 'Add New Survey Point Description';
        document.getElementById('surveyPointForm').reset();
        document.getElementById('surveyPointModal').classList.add('active');
    }
    
    function openEditSurveyPointModal(id, data) {
        currentEdit = { id, data, type: 'survey-point' };
        document.getElementById('surveyPointModalTitle').textContent = 'Edit Survey Point Description';
        
        const form = document.getElementById('surveyPointForm');
        form.code.value = data.code || '';
        form.description.value = data.description || '';
        form.category.value = data.category || '';
        form.discipline.value = data.discipline || '';
        form.symbol_reference.value = data.symbol_reference || '';
        form.layer_suggestion.value = data.layer_suggestion || '';
        form.sort_order.value = data.sort_order || '';
        form.notes.value = data.notes || '';
        
        document.getElementById('surveyPointModal').classList.add('active');
    }
    
    function closeSurveyPointModal() {
        document.getElementById('surveyPointModal').classList.remove('active');
        currentEdit = { id: null, data: null, type: null };
    }
    
    // ===== GIS DATA LAYERS FUNCTIONS =====
    
    async function loadGISLayers() {
        try {
            const response = await fetch('/api/gis-data-layers');
            const data = await response.json();
            gisLayers = data.gis_data_layers || [];
            renderGISLayers();
        } catch (error) {
            console.error('Error loading GIS layers:', error);
            showToast('Failed to load GIS layers', 'error');
        }
    }
    
    function renderGISLayers() {
        const container = document.getElementById('gisLayersContainer');
        
        if (gisLayers.length === 0) {
            container.innerHTML = `
                <div class="placeholder-message">
                    <i class="fas fa-layer-group"></i>
                    <h3>No GIS layers configured yet</h3>
                    <p>Click "Add New Layer" to register your first GIS data layer.</p>
                </div>
            `;
            return;
        }
        
        const html = `
            <div class="entity-grid">
                ${gisLayers.map(layer => `
                    <div class="entity-card">
                        <div class="entity-card-header">
                            <h3>${layer.name}</h3>
                            <div class="entity-card-actions">
                                <button class="btn-icon" onclick="openEditGISLayerModal(${layer.layer_id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon" onclick="openDeleteModal(${layer.layer_id}, '${layer.name.replace(/'/g, "\\'")}', 'gis-layer')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="entity-card-body">
                            <div class="info-item">
                                <span class="label"><i class="fas fa-tag"></i> Service ID:</span>
                                <span class="value">${layer.service_id || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="label"><i class="fas fa-map-marker-alt"></i> Jurisdiction:</span>
                                <span class="value">${layer.jurisdiction || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="label"><i class="fas fa-folder"></i> Category:</span>
                                <span class="value">${layer.category || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="label"><i class="fas fa-link"></i> Server URL:</span>
                                <span class="value" style="font-size: 11px; word-break: break-all;">${layer.rest_url ? layer.rest_url.substring(0, 60) + '...' : 'N/A'}</span>
                            </div>
                            ${layer.status ? `<div class="info-item">
                                <span class="label"><i class="fas fa-circle"></i> Status:</span>
                                <span class="value"><span class="mc-badge mc-badge-${layer.status === 'active' ? 'success' : 'warning'}">${layer.status}</span></span>
                            </div>` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    function openAddGISLayerModal() {
        currentEdit = { id: null, data: null, type: 'gis-layer' };
        document.getElementById('gisLayerModalTitle').textContent = 'Add New GIS Data Layer';
        document.getElementById('gisLayerForm').reset();
        document.getElementById('gisLayerModal').classList.add('active');
    }
    
    function openEditGISLayerModal(layerId) {
        const layer = gisLayers.find(l => l.layer_id === layerId);
        if (!layer) return;
        
        currentEdit = { id: layerId, data: layer, type: 'gis-layer' };
        document.getElementById('gisLayerModalTitle').textContent = 'Edit GIS Data Layer';
        
        const form = document.getElementById('gisLayerForm');
        form.service_id.value = layer.service_id || '';
        form.name.value = layer.name || '';
        form.jurisdiction.value = layer.jurisdiction || '';
        form.category.value = layer.category || '';
        form.rest_url.value = layer.rest_url || '';
        form.layer.value = layer.layer !== null && layer.layer !== undefined ? layer.layer : '';
        form.behavior.value = layer.behavior || '';
        form.cs_wkid.value = layer.cs_wkid || '';
        form.query_where.value = layer.query_where || '';
        form.extent_mode.value = layer.extent_mode || '';
        form.label_field.value = layer.label_field || '';
        form.label_format.value = layer.label_format || '';
        form.sym_preset.value = layer.sym_preset || '';
        form.block_name.value = layer.block_name || '';
        form.min_scale.value = layer.min_scale || 0;
        form.max_scale.value = layer.max_scale || 0;
        form.status.value = layer.status || 'active';
        form.last_verified.value = layer.last_verified || '';
        form.notes.value = layer.notes || '';
        
        document.getElementById('gisLayerModal').classList.add('active');
    }
    
    function closeGISLayerModal() {
        document.getElementById('gisLayerModal').classList.remove('active');
        currentEdit = { id: null, data: null, type: null };
    }
    
    async function handleGISLayerSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const layerData = {
            service_id: formData.get('service_id'),
            name: formData.get('name'),
            jurisdiction: formData.get('jurisdiction'),
            category: formData.get('category'),
            rest_url: formData.get('rest_url'),
            layer: formData.get('layer') ? parseInt(formData.get('layer')) : null,
            behavior: formData.get('behavior'),
            cs_wkid: formData.get('cs_wkid') ? parseInt(formData.get('cs_wkid')) : null,
            query_where: formData.get('query_where'),
            extent_mode: formData.get('extent_mode'),
            label_field: formData.get('label_field'),
            label_format: formData.get('label_format'),
            sym_preset: formData.get('sym_preset'),
            block_name: formData.get('block_name'),
            min_scale: formData.get('min_scale') ? parseInt(formData.get('min_scale')) : 0,
            max_scale: formData.get('max_scale') ? parseInt(formData.get('max_scale')) : 0,
            status: formData.get('status') || 'active',
            last_verified: formData.get('last_verified') || null,
            notes: formData.get('notes')
        };
        
        try {
            let response;
            if (currentEdit.id) {
                response = await fetch(`/api/gis-data-layers/${currentEdit.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(layerData)
                });
            } else {
                response = await fetch('/api/gis-data-layers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(layerData)
                });
            }
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message, 'success');
                closeGISLayerModal();
                loadGISLayers();
            } else {
                showToast(result.error || 'Failed to save GIS layer', 'error');
            }
        } catch (error) {
            console.error('Error saving GIS layer:', error);
            showToast('Failed to save GIS layer', 'error');
        }
    }
    
    async function loadNamingTemplates() {
        try {
            const response = await fetch('/api/naming-templates');
            const data = await response.json();
            namingTemplates = data.templates || [];
            renderNamingTemplates();
        } catch (error) {
            console.error('Error loading naming templates:', error);
            showToast('Failed to load naming templates', 'error');
        }
    }
    
    function renderNamingTemplates() {
        const container = document.getElementById('namingTemplatesContainer');
        
        if (namingTemplates.length === 0) {
            container.innerHTML = `
                <div class="placeholder-message">
                    <i class="fas fa-tags"></i>
                    <h3>No naming templates yet</h3>
                    <p>Click "Add New Template" to create your first naming template for relationship sets.</p>
                </div>
            `;
            return;
        }
        
        const grouped = namingTemplates.reduce((acc, template) => {
            const category = template.category || 'Uncategorized';
            if (!acc[category]) acc[category] = [];
            acc[category].push(template);
            return acc;
        }, {});
        
        const html = Object.entries(grouped).map(([category, items]) => `
            <div class="category-section">
                <div class="category-header">
                    <span class="category-title">${category}</span>
                    <span class="category-count">(${items.length} ${items.length === 1 ? 'template' : 'templates'})</span>
                </div>
                <div class="grid">
                    ${items.map(template => `
                        <div class="entity-item">
                            <div class="entity-header">
                                <div style="display: flex; align-items: start;">
                                    <i class="fas fa-tags entity-icon"></i>
                                    <div class="entity-title">
                                        <div class="entity-name">${template.template_name}${template.is_default ? ' <span class="entity-category" style="background: var(--accent-cyan);">DEFAULT</span>' : ''}</div>
                                        <div class="entity-table">${template.category}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="entity-desc">
                                <div><strong>Name Format:</strong> <code style="font-size: 0.9em; color: var(--accent-cyan);">${template.name_format}</code></div>
                                <div><strong>Code Format:</strong> <code style="font-size: 0.9em; color: var(--accent-gold);">${template.short_code_format}</code></div>
                                ${template.description ? `<div style="margin-top: 8px; color: var(--muted);">${template.description}</div>` : ''}
                                ${template.example_name ? `<div style="margin-top: 8px; color: var(--success);"><strong>Example:</strong> ${template.example_name} (${template.example_code})</div>` : ''}
                                ${template.usage_count ? `<div style="margin-top: 8px; font-size: 0.85em; color: var(--muted);"><i class="fas fa-check-circle"></i> Used ${template.usage_count} ${template.usage_count === 1 ? 'time' : 'times'}</div>` : ''}
                            </div>
                            <div class="item-actions">
                                <button class="icon-btn" onclick='openEditNamingTemplateModal("${template.template_id}", ${JSON.stringify(template).replace(/'/g, "&apos;")})' title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn delete" onclick='openDeleteModal("${template.template_id}", "${template.template_name.replace(/'/g, "\\'")}", "naming-template")' title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
        
        container.innerHTML = html;
    }
    
    function openAddNamingTemplateModal() {
        currentEdit = { id: null, data: null, type: 'naming-template' };
        document.getElementById('namingTemplateModalTitle').textContent = 'Add New Naming Template';
        document.getElementById('namingTemplateForm').reset();
        document.getElementById('namingTemplateModal').classList.add('active');
    }
    
    function openEditNamingTemplateModal(id, data) {
        currentEdit = { id, data, type: 'naming-template' };
        document.getElementById('namingTemplateModalTitle').textContent = 'Edit Naming Template';
        
        const form = document.getElementById('namingTemplateForm');
        form.template_name.value = data.template_name || '';
        form.category.value = data.category || '';
        form.name_format.value = data.name_format || '';
        form.short_code_format.value = data.short_code_format || '';
        form.description.value = data.description || '';
        form.usage_instructions.value = data.usage_instructions || '';
        form.example_name.value = data.example_name || '';
        form.example_code.value = data.example_code || '';
        form.example_tokens.value = data.example_tokens ? JSON.stringify(data.example_tokens) : '';
        form.required_tokens.value = data.required_tokens ? JSON.stringify(data.required_tokens) : '[]';
        form.optional_tokens.value = data.optional_tokens ? JSON.stringify(data.optional_tokens) : '[]';
        form.is_default.checked = data.is_default || false;
        
        document.getElementById('namingTemplateModal').classList.add('active');
    }
    
    function closeNamingTemplateModal() {
        document.getElementById('namingTemplateModal').classList.remove('active');
        currentEdit = { id: null, data: null, type: null };
    }
    
    async function handleNamingTemplateSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        
        const templateData = {
            template_name: formData.get('template_name'),
            category: formData.get('category'),
            name_format: formData.get('name_format'),
            short_code_format: formData.get('short_code_format'),
            description: formData.get('description'),
            usage_instructions: formData.get('usage_instructions'),
            example_name: formData.get('example_name'),
            example_code: formData.get('example_code'),
            example_tokens: formData.get('example_tokens') ? JSON.parse(formData.get('example_tokens')) : null,
            required_tokens: formData.get('required_tokens') ? JSON.parse(formData.get('required_tokens')) : [],
            optional_tokens: formData.get('optional_tokens') ? JSON.parse(formData.get('optional_tokens')) : [],
            is_default: formData.get('is_default') === 'on'
        };
        
        try {
            let response;
            if (currentEdit.id) {
                response = await fetch(`/api/naming-templates/${currentEdit.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(templateData)
                });
            } else {
                response = await fetch('/api/naming-templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(templateData)
                });
            }
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message, 'success');
                closeNamingTemplateModal();
                loadNamingTemplates();
            } else {
                showToast(result.error || 'Failed to save naming template', 'error');
            }
        } catch (error) {
            console.error('Error saving naming template:', error);
            showToast('Failed to save naming template', 'error');
        }
    }
    
    function openDeleteModal(id, name, type) {
        deleteTarget = { id, name, type };
        document.getElementById('confirmMessage').textContent = `Are you sure you want to delete "${name}"?`;
        document.getElementById('confirmModal').classList.add('active');
    }
    
    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.remove('active');
        deleteTarget = { id: null, name: null, type: null };
    }
    
    async function handleClientSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        try {
            if (currentEdit.id) {
                await updateClient(currentEdit.id, data);
            } else {
                await createClient(data);
            }
        } catch (error) {
            console.error('Error submitting client:', error);
        }
    }
    
    async function handleVendorSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        try {
            if (currentEdit.id) {
                await updateVendor(currentEdit.id, data);
            } else {
                await createVendor(data);
            }
        } catch (error) {
            console.error('Error submitting vendor:', error);
        }
    }
    
    async function handleMunicipalitySubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        try {
            if (currentEdit.id) {
                await updateMunicipality(currentEdit.id, data);
            } else {
                await createMunicipality(data);
            }
        } catch (error) {
            console.error('Error submitting municipality:', error);
        }
    }
    
    async function handleCoordinateSystemSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        if (data.zone_number) {
            data.zone_number = parseInt(data.zone_number);
        }
        
        try {
            if (currentEdit.id) {
                await updateCoordinateSystem(currentEdit.id, data);
            } else {
                await createCoordinateSystem(data);
            }
        } catch (error) {
            console.error('Error submitting coordinate system:', error);
        }
    }
    
    async function handleSurveyPointSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        if (data.sort_order) {
            data.sort_order = parseInt(data.sort_order);
        }
        
        try {
            if (currentEdit.id) {
                await updateSurveyPoint(currentEdit.id, data);
            } else {
                await createSurveyPoint(data);
            }
        } catch (error) {
            console.error('Error submitting survey point:', error);
        }
    }
    
    async function createClient(data) {
        try {
            const response = await fetch('/api/clients', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Client created successfully', 'success');
                closeClientModal();
                await loadClients();
            } else {
                showToast(result.error || 'Failed to create client', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to create client', 'error');
        }
    }
    
    async function updateClient(id, data) {
        try {
            const response = await fetch(`/api/clients/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Client updated successfully', 'success');
                closeClientModal();
                await loadClients();
            } else {
                showToast(result.error || 'Failed to update client', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to update client', 'error');
        }
    }
    
    async function createVendor(data) {
        try {
            const response = await fetch('/api/vendors', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Vendor created successfully', 'success');
                closeVendorModal();
                await loadVendors();
            } else {
                showToast(result.error || 'Failed to create vendor', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to create vendor', 'error');
        }
    }
    
    async function updateVendor(id, data) {
        try {
            const response = await fetch(`/api/vendors/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Vendor updated successfully', 'success');
                closeVendorModal();
                await loadVendors();
            } else {
                showToast(result.error || 'Failed to update vendor', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to update vendor', 'error');
        }
    }
    
    async function createMunicipality(data) {
        try {
            const response = await fetch('/api/municipalities', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Municipality created successfully', 'success');
                closeMunicipalityModal();
                await loadMunicipalities();
            } else {
                showToast(result.error || 'Failed to create municipality', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to create municipality', 'error');
        }
    }
    
    async function updateMunicipality(id, data) {
        try {
            const response = await fetch(`/api/municipalities/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Municipality updated successfully', 'success');
                closeMunicipalityModal();
                await loadMunicipalities();
            } else {
                showToast(result.error || 'Failed to update municipality', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to update municipality', 'error');
        }
    }
    
    async function createCoordinateSystem(data) {
        try {
            const response = await fetch('/api/coordinate-systems', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Coordinate system created successfully', 'success');
                closeCoordinateSystemModal();
                await loadCoordinateSystems();
            } else {
                showToast(result.error || 'Failed to create coordinate system', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to create coordinate system', 'error');
        }
    }
    
    async function updateCoordinateSystem(id, data) {
        try {
            const response = await fetch(`/api/coordinate-systems/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Coordinate system updated successfully', 'success');
                closeCoordinateSystemModal();
                await loadCoordinateSystems();
            } else {
                showToast(result.error || 'Failed to update coordinate system', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to update coordinate system', 'error');
        }
    }
    
    async function createSurveyPoint(data) {
        try {
            const response = await fetch('/api/survey-point-descriptions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Survey point description created successfully', 'success');
                closeSurveyPointModal();
                await loadSurveyPoints();
            } else {
                showToast(result.error || 'Failed to create survey point description', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to create survey point description', 'error');
        }
    }
    
    async function updateSurveyPoint(id, data) {
        try {
            const response = await fetch(`/api/survey-point-descriptions/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Survey point description updated successfully', 'success');
                closeSurveyPointModal();
                await loadSurveyPoints();
            } else {
                showToast(result.error || 'Failed to update survey point description', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to update survey point description', 'error');
        }
    }
    
    async function confirmDelete() {
        const { id, type } = deleteTarget;
        
        let endpoint;
        let reloadFunction;
        
        switch(type) {
            case 'client':
                endpoint = `/api/clients/${id}`;
                reloadFunction = loadClients;
                break;
            case 'vendor':
                endpoint = `/api/vendors/${id}`;
                reloadFunction = loadVendors;
                break;
            case 'municipality':
                endpoint = `/api/municipalities/${id}`;
                reloadFunction = loadMunicipalities;
                break;
            case 'coordinate-system':
                endpoint = `/api/coordinate-systems/${id}`;
                reloadFunction = loadCoordinateSystems;
                break;
            case 'survey-point':
                endpoint = `/api/survey-point-descriptions/${id}`;
                reloadFunction = loadSurveyPoints;
                break;
            case 'gis-layer':
                endpoint = `/api/gis-data-layers/${id}`;
                reloadFunction = loadGISLayers;
                break;
            case 'naming-template':
                endpoint = `/api/naming-templates/${id}`;
                reloadFunction = loadNamingTemplates;
                break;
            default:
                showToast('Unknown item type', 'error');
                return;
        }
        
        try {
            const response = await fetch(endpoint, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Item deleted successfully', 'success');
                closeConfirmModal();
                await reloadFunction();
            } else {
                showToast(result.error || 'Failed to delete item', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to delete item', 'error');
        }
    }
    
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 4000);
    }
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeClientModal();
            closeVendorModal();
            closeMunicipalityModal();
            closeCoordinateSystemModal();
            closeSurveyPointModal();
            closeConfirmModal();
        }
    });
    
    document.getElementById('clientModal').addEventListener('click', (e) => {
        if (e.target.id === 'clientModal') closeClientModal();
    });
    
    document.getElementById('vendorModal').addEventListener('click', (e) => {
        if (e.target.id === 'vendorModal') closeVendorModal();
    });
    
    document.getElementById('municipalityModal').addEventListener('click', (e) => {
        if (e.target.id === 'municipalityModal') closeMunicipalityModal();
    });
    
    document.getElementById('coordinateSystemModal').addEventListener('click', (e) => {
        if (e.target.id === 'coordinateSystemModal') closeCoordinateSystemModal();
    });
    
    document.getElementById('surveyPointModal').addEventListener('click', (e) => {
        if (e.target.id === 'surveyPointModal') closeSurveyPointModal();
    });
    
    document.getElementById('confirmModal').addEventListener('click', (e) => {
        if (e.target.id === 'confirmModal') closeConfirmModal();
    });
</script>
{% endblock %}
