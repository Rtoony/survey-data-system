{% extends 'base.html' %}

{% block title %}CAD Layer Vocabulary{% endblock %}

{% block content %}
<div class="container">
    <h1><i class="fas fa-layer-group"></i> CAD Layer Vocabulary</h1>
    <p class="subtitle">Database-Driven Layer Naming Classification System</p>
    
    <div class="stats-grid" id="statsGrid"></div>
    
    <div class="tabs">
        <div class="tab active" data-tab="overview">Overview</div>
        <div class="tab" data-tab="disciplines">Disciplines</div>
        <div class="tab" data-tab="categories">Categories</div>
        <div class="tab" data-tab="types">Object Types</div>
        <div class="tab" data-tab="attributes">Attributes</div>
        <div class="tab" data-tab="phases">Phases</div>
        <div class="tab" data-tab="geometries">Geometries</div>
        <div class="tab" data-tab="hierarchy">Full Hierarchy</div>
    </div>
    
    <div class="tab-content active" id="overview">
        <div class="card">
            <h2><i class="fas fa-info-circle"></i> Layer Name Format</h2>
            <div class="layer-example">
                DISCIPLINE-CATEGORY-TYPE-[ATTRIBUTES]-PHASE-GEOMETRY
                <br><br>
                Example: CIV-UTIL-STORM-12IN-NEW-LN
                <br>
                → Civil Utility Storm Drain, 12 inch, New Construction, Line
            </div>
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0, 255, 100, 0.1); border: 1px solid rgba(0, 255, 100, 0.3); border-radius: 6px;">
                <h3 style="margin: 0 0 0.75rem 0; color: var(--accent-green); font-size: 14px;">
                    <i class="fas fa-lightbulb"></i> About Attributes [Optional]
                </h3>
                <p style="margin: 0 0 0.75rem 0; font-size: 13px; line-height: 1.6;">
                    <strong>Attributes</strong> are optional details (size, material, slope, etc.) inserted between TYPE and PHASE.
                    They provide specific object properties like <code>12IN</code> (diameter), <code>PVC</code> (material), or <code>2PCT</code> (slope).
                </p>
                <p style="margin: 0; font-size: 13px; line-height: 1.6;">
                    <i class="fas fa-magic" style="color: var(--accent-green);"></i>
                    <strong>Auto-extraction:</strong> During DXF export, attributes are automatically extracted from your database object properties - 
                    you don't manually create them! The layer generator lets you test them, but in production they come from your data.
                </p>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-lightbulb"></i> Key Benefits</h2>
            <ul style="list-style: none; padding-left: 20px;">
                <li><i class="fas fa-check" style="color: var(--accent);"></i> <strong>AI-Friendly:</strong> Clear hierarchy for LLM processing</li>
                <li><i class="fas fa-check" style="color: var(--accent);"></i> <strong>Human-Readable:</strong> Engineers understand at a glance</li>
                <li><i class="fas fa-check" style="color: var(--accent);"></i> <strong>Flexible:</strong> Handles client CAD variations via mapping</li>
                <li><i class="fas fa-check" style="color: var(--accent);"></i> <strong>Extensible:</strong> Add new codes without breaking patterns</li>
                <li><i class="fas fa-check" style="color: var(--accent);"></i> <strong>Database-Driven:</strong> Database is source of truth, not layer names</li>
            </ul>
        </div>
    </div>
    
    <div class="tab-content" id="disciplines">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-layer-group"></i> Discipline Codes</h2>
                <button class="btn btn-add" onclick="openAddModal('disciplines')">
                    <i class="fas fa-plus"></i> Add New Discipline
                </button>
            </div>
            <div class="grid" id="disciplinesGrid"></div>
        </div>
    </div>
    
    <div class="tab-content" id="categories">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-folder-tree"></i> Category Codes</h2>
                <button class="btn btn-add" onclick="openAddModal('categories')">
                    <i class="fas fa-plus"></i> Add New Category
                </button>
            </div>
            <div class="grid" id="categoriesGrid"></div>
        </div>
    </div>
    
    <div class="tab-content" id="types">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-cubes"></i> Object Type Codes</h2>
                <button class="btn btn-add" onclick="openAddModal('types')">
                    <i class="fas fa-plus"></i> Add New Object Type
                </button>
            </div>
            <div class="grid" id="typesGrid"></div>
        </div>
    </div>
    
    <div class="tab-content" id="attributes">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-tags"></i> Attribute Codes</h2>
                <button class="btn btn-add" onclick="openAddModal('attributes')">
                    <i class="fas fa-plus"></i> Add New Attribute
                </button>
            </div>
            <p class="subtitle" style="margin: -1rem 0 1.5rem 0; color: rgba(255,255,255,0.6);">
                Optional layer name components like size (12IN), material (PVC), slope (2PCT), etc.
            </p>
            <div class="grid" id="attributesGrid"></div>
        </div>
        
        <div class="card" style="margin-top: 2rem;">
            <div class="section-header">
                <h2><i class="fas fa-link"></i> Attribute Applicability Rules</h2>
                <button class="btn btn-add" onclick="openApplicabilityModal()">
                    <i class="fas fa-plus"></i> Add Applicability Rule
                </button>
            </div>
            <p class="subtitle" style="margin: -1rem 0 1.5rem 0; color: rgba(255,255,255,0.6);">
                Define which attributes can be used with specific Category + Object Type combinations
            </p>
            <div class="applicability-grid" id="applicabilityGrid">
                <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">
                    Loading applicability rules...
                </p>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="phases">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-clock"></i> Phase Codes</h2>
                <button class="btn btn-add" onclick="openAddModal('phases')">
                    <i class="fas fa-plus"></i> Add New Phase
                </button>
            </div>
            <div class="grid" id="phasesGrid"></div>
        </div>
    </div>
    
    <div class="tab-content" id="geometries">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-shapes"></i> Geometry Codes</h2>
                <button class="btn btn-add" onclick="openAddModal('geometries')">
                    <i class="fas fa-plus"></i> Add New Geometry
                </button>
            </div>
            <div class="grid" id="geometriesGrid"></div>
        </div>
    </div>
    
    <div class="tab-content" id="hierarchy">
        <div class="card">
            <h2><i class="fas fa-sitemap"></i> Complete Hierarchy</h2>
            <div class="hierarchy-tree" id="hierarchyTree"></div>
        </div>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Edit Item</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <form id="editForm" onsubmit="handleSubmit(event)">
            <div id="formFields"></div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-submit">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Delete</h3>
            <button class="close-btn" onclick="closeConfirmModal()">&times;</button>
        </div>
        <div class="confirm-dialog">
            <p id="confirmMessage">Are you sure you want to delete this item?</p>
            <div class="confirm-actions">
                <button class="btn btn-cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>

<div id="applicabilityModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Attribute Applicability Rule</h3>
            <button class="close-btn" onclick="closeApplicabilityModal()">&times;</button>
        </div>
        <form id="applicabilityForm" onsubmit="handleApplicabilitySubmit(event)">
            <div class="form-group">
                <label for="appl_category">Category</label>
                <select id="appl_category" required onchange="loadTypesForCategory()">
                    <option value="">Select Category...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="appl_type">Object Type</label>
                <select id="appl_type" required>
                    <option value="">Select Category First...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="appl_attribute">Attribute</label>
                <select id="appl_attribute" required>
                    <option value="">Select Attribute...</option>
                </select>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="appl_required">
                    <span>Required Attribute</span>
                </label>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="closeApplicabilityModal()">Cancel</button>
                <button type="submit" class="btn btn-submit">Add Rule</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentVocabulary = {
        disciplines: [],
        categories: [],
        types: [],
        attributes: [],
        phases: [],
        geometries: []
    };
    
    let currentEdit = {
        type: null,
        id: null,
        data: null
    };
    
    let deleteTarget = {
        type: null,
        id: null,
        name: null
    };
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        });
    });
    
    async function loadVocabulary() {
        try {
            const [disciplines, categories, types, attributes, phases, geometries] = await Promise.all([
                fetch('/api/vocabulary/disciplines').then(r => r.json()),
                fetch('/api/vocabulary/categories').then(r => r.json()),
                fetch('/api/vocabulary/object-types').then(r => r.json()),
                fetch('/api/standards/attributes').then(r => r.json()),
                fetch('/api/vocabulary/phases').then(r => r.json()),
                fetch('/api/vocabulary/geometries').then(r => r.json())
            ]);
            
            currentVocabulary.disciplines = disciplines.disciplines;
            currentVocabulary.categories = categories.categories;
            currentVocabulary.types = types.object_types;
            currentVocabulary.attributes = attributes.attributes;
            currentVocabulary.phases = phases.phases;
            currentVocabulary.geometries = geometries.geometries;
            
            renderStats(disciplines, categories, types, attributes, phases, geometries);
            renderDisciplines(disciplines.disciplines);
            renderCategories(categories.categories);
            renderTypes(types.object_types);
            renderAttributes(attributes.attributes);
            renderPhases(phases.phases);
            renderGeometries(geometries.geometries);
            renderHierarchy(disciplines.disciplines, categories.categories, types.object_types);
            
        } catch (error) {
            console.error('Error loading vocabulary:', error);
            showToast('Failed to load vocabulary data', 'error');
        }
    }
    
    function renderStats(disciplines, categories, types, attributes, phases, geometries) {
        const stats = [
            { value: disciplines.disciplines.length, label: 'Disciplines' },
            { value: categories.categories.length, label: 'Categories' },
            { value: types.object_types.length, label: 'Object Types' },
            { value: attributes.attributes.length, label: 'Attributes' },
            { value: phases.phases.length, label: 'Phases' },
            { value: geometries.geometries.length, label: 'Geometries' }
        ];
        
        document.getElementById('statsGrid').innerHTML = stats.map(stat => `
            <div class="stat-card">
                <div class="stat-value">${stat.value}</div>
                <div class="stat-label">${stat.label}</div>
            </div>
        `).join('');
    }
    
    function renderDisciplines(disciplines) {
        document.getElementById('disciplinesGrid').innerHTML = disciplines.map(d => `
            <div class="code-item">
                <div class="code-label">${d.code}</div>
                <div class="code-name">${d.full_name}</div>
                ${d.description ? `<div class="code-desc">${d.description}</div>` : ''}
                <div class="item-actions">
                    <button class="icon-btn" onclick='openEditModal("disciplines", ${d.discipline_id}, ${JSON.stringify(d)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn delete" onclick='openDeleteModal("disciplines", ${d.discipline_id}, "${d.code}")' title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function renderCategories(categories) {
        document.getElementById('categoriesGrid').innerHTML = categories.map(c => `
            <div class="code-item">
                <div class="code-label">${c.code}</div>
                <div class="code-name">${c.full_name}</div>
                <div class="code-desc">${c.discipline_code} → ${c.discipline_name}</div>
                <div class="item-actions">
                    <button class="icon-btn" onclick='openEditModal("categories", ${c.category_id}, ${JSON.stringify(c)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn delete" onclick='openDeleteModal("categories", ${c.category_id}, "${c.code}")' title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function renderTypes(types) {
        document.getElementById('typesGrid').innerHTML = types.map(t => `
            <div class="code-item">
                <div class="code-label">${t.code}</div>
                <div class="code-name">${t.full_name}</div>
                <div class="code-desc">${t.discipline_code}-${t.category_code}</div>
                ${t.database_table ? `<div class="code-desc">Table: ${t.database_table}</div>` : ''}
                <div class="item-actions">
                    <button class="icon-btn" onclick='openEditModal("types", ${t.type_id}, ${JSON.stringify(t)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn delete" onclick='openDeleteModal("types", ${t.type_id}, "${t.code}")' title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function renderAttributes(attributes) {
        document.getElementById('attributesGrid').innerHTML = attributes.map(a => `
            <div class="code-item">
                <div class="code-label">${a.code}</div>
                <div class="code-name">${a.full_name}</div>
                <div class="code-desc">Category: ${a.attribute_category || 'other'}</div>
                ${a.description ? `<div class="code-desc">${a.description}</div>` : ''}
                <div class="item-actions">
                    <button class="icon-btn" onclick='openEditModal("attributes", ${a.attribute_id}, ${JSON.stringify(a)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn delete" onclick='openDeleteModal("attributes", ${a.attribute_id}, "${a.code}")' title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function renderPhases(phases) {
        document.getElementById('phasesGrid').innerHTML = phases.map(p => `
            <div class="code-item">
                <div class="code-label">${p.code}</div>
                <div class="code-name">${p.full_name}</div>
                ${p.description ? `<div class="code-desc">${p.description}</div>` : ''}
                <div class="item-actions">
                    <button class="icon-btn" onclick='openEditModal("phases", ${p.phase_id}, ${JSON.stringify(p)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn delete" onclick='openDeleteModal("phases", ${p.phase_id}, "${p.code}")' title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function renderGeometries(geometries) {
        document.getElementById('geometriesGrid').innerHTML = geometries.map(g => `
            <div class="code-item">
                <div class="code-label">${g.code}</div>
                <div class="code-name">${g.full_name}</div>
                ${g.description ? `<div class="code-desc">${g.description}</div>` : ''}
                <div class="item-actions">
                    <button class="icon-btn" onclick='openEditModal("geometries", ${g.geometry_id}, ${JSON.stringify(g)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn delete" onclick='openDeleteModal("geometries", ${g.geometry_id}, "${g.code}")' title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function renderHierarchy(disciplines, categories, types) {
        const hierarchyHTML = disciplines.map(discipline => {
            const disciplineCategories = categories.filter(c => c.discipline_id === discipline.discipline_id);
            
            return `
                <div class="discipline-group">
                    <div class="discipline-header">
                        <div class="discipline-title">${discipline.code} - ${discipline.full_name}</div>
                    </div>
                    ${disciplineCategories.map(category => {
                        const categoryTypes = types.filter(t => t.category_id === category.category_id);
                        
                        return `
                            <div class="category-item">
                                <div class="category-title">${category.code} - ${category.full_name}</div>
                                ${categoryTypes.length > 0 ? `
                                    <div class="type-list">
                                        ${categoryTypes.map(type => `
                                            <div class="type-item">
                                                <strong>${type.code}</strong> - ${type.full_name}
                                                ${type.database_table ? `<br><small style="color: var(--muted);">Table: ${type.database_table}</small>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }).join('');
        
        document.getElementById('hierarchyTree').innerHTML = hierarchyHTML;
    }
    
    function openAddModal(type) {
        currentEdit = { type, id: null, data: null };
        document.getElementById('modalTitle').textContent = 'Add New ' + type.charAt(0).toUpperCase() + type.slice(1, -1);
        buildForm(type);
        document.getElementById('editModal').classList.add('active');
    }
    
    function openEditModal(type, id, data) {
        currentEdit = { type, id, data };
        document.getElementById('modalTitle').textContent = 'Edit ' + type.charAt(0).toUpperCase() + type.slice(1, -1);
        buildForm(type, data);
        document.getElementById('editModal').classList.add('active');
    }
    
    function closeModal() {
        document.getElementById('editModal').classList.remove('active');
        currentEdit = { type: null, id: null, data: null };
    }
    
    function openDeleteModal(type, id, name) {
        deleteTarget = { type, id, name };
        document.getElementById('confirmMessage').textContent = `Are you sure you want to delete "${name}"?`;
        document.getElementById('confirmModal').classList.add('active');
    }
    
    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.remove('active');
        deleteTarget = { type: null, id: null, name: null };
    }
    
    async function buildForm(type, data = null) {
        const formFields = document.getElementById('formFields');
        let html = '';
        
        if (type === 'disciplines') {
            html = `
                <div class="form-group">
                    <label>Code <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="code" value="${data?.code || ''}" required maxlength="10">
                </div>
                <div class="form-group">
                    <label>Full Name <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="full_name" value="${data?.full_name || ''}" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description">${data?.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Sort Order</label>
                    <input type="number" name="sort_order" value="${data?.sort_order || ''}" min="0">
                </div>
            `;
        } else if (type === 'categories') {
            const disciplineOptions = currentVocabulary.disciplines.map(d => 
                `<option value="${d.discipline_id}" ${data?.discipline_id === d.discipline_id ? 'selected' : ''}>${d.code} - ${d.full_name}</option>`
            ).join('');
            html = `
                <div class="form-group">
                    <label>Code <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="code" value="${data?.code || ''}" required maxlength="10">
                </div>
                <div class="form-group">
                    <label>Full Name <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="full_name" value="${data?.full_name || ''}" required>
                </div>
                <div class="form-group">
                    <label>Discipline <span style="color: #ff4444;">*</span></label>
                    <select name="discipline_id" required>
                        <option value="">Select Discipline</option>
                        ${disciplineOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description">${data?.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Sort Order</label>
                    <input type="number" name="sort_order" value="${data?.sort_order || ''}" min="0">
                </div>
            `;
        } else if (type === 'types') {
            const categoryOptions = currentVocabulary.categories.map(c => 
                `<option value="${c.category_id}" ${data?.category_id === c.category_id ? 'selected' : ''}>${c.discipline_code}-${c.code} - ${c.full_name}</option>`
            ).join('');
            
            let entityOptions = '<option value="">Loading...</option>';
            formFields.innerHTML = `
                <div class="form-group">
                    <label>Code <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="code" value="${data?.code || ''}" required maxlength="10">
                </div>
                <div class="form-group">
                    <label>Full Name <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="full_name" value="${data?.full_name || ''}" required>
                </div>
                <div class="form-group">
                    <label>Category <span style="color: #ff4444;">*</span></label>
                    <select name="category_id" required>
                        <option value="">Select Category</option>
                        ${categoryOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label>Database Table</label>
                    <select name="database_table" id="entityTableSelect">
                        ${entityOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description">${data?.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Sort Order</label>
                    <input type="number" name="sort_order" value="${data?.sort_order || ''}" min="0">
                </div>
            `;
            
            try {
                const response = await fetch('/api/entity-registry');
                const entityData = await response.json();
                const entities = entityData.entities || [];
                entityOptions = '<option value="">Select Database Table (Optional)</option>' + 
                    entities.map(e => 
                        `<option value="${e.table_name}" ${data?.database_table === e.table_name ? 'selected' : ''}>${e.display_name} (${e.table_name})</option>`
                    ).join('');
                document.getElementById('entityTableSelect').innerHTML = entityOptions;
            } catch (error) {
                console.error('Error loading entity registry:', error);
                document.getElementById('entityTableSelect').innerHTML = '<option value="">Select Database Table (Optional)</option>';
            }
            return;
        } else if (type === 'phases') {
            html = `
                <div class="form-group">
                    <label>Code <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="code" value="${data?.code || ''}" required maxlength="10">
                </div>
                <div class="form-group">
                    <label>Full Name <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="full_name" value="${data?.full_name || ''}" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description">${data?.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Color (RGB)</label>
                    <input type="color" name="color_rgb" value="${data?.color_rgb || '#00ffff'}">
                </div>
                <div class="form-group">
                    <label>Sort Order</label>
                    <input type="number" name="sort_order" value="${data?.sort_order || ''}" min="0">
                </div>
            `;
        } else if (type === 'geometries') {
            html = `
                <div class="form-group">
                    <label>Code <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="code" value="${data?.code || ''}" required maxlength="10">
                </div>
                <div class="form-group">
                    <label>Full Name <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="full_name" value="${data?.full_name || ''}" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description">${data?.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>DXF Entity Types</label>
                    <input type="text" name="dxf_entity_types" value="${data?.dxf_entity_types || ''}" placeholder="e.g., LINE,POLYLINE,ARC">
                </div>
                <div class="form-group">
                    <label>Sort Order</label>
                    <input type="number" name="sort_order" value="${data?.sort_order || ''}" min="0">
                </div>
            `;
        }
        
        formFields.innerHTML = html;
    }
    
    async function handleSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        Object.keys(data).forEach(key => {
            if (data[key] === '') {
                data[key] = null;
            }
        });
        
        try {
            if (currentEdit.id) {
                await updateVocabulary(currentEdit.type, currentEdit.id, data);
            } else {
                await createVocabulary(currentEdit.type, data);
            }
        } catch (error) {
            console.error('Error submitting form:', error);
        }
    }
    
    async function createVocabulary(type, data) {
        const endpoints = {
            disciplines: '/api/vocabulary/disciplines',
            categories: '/api/vocabulary/categories',
            types: '/api/vocabulary/object-types',
            phases: '/api/vocabulary/phases',
            geometries: '/api/vocabulary/geometries'
        };
        
        try {
            const response = await fetch(endpoints[type], {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Item created successfully', 'success');
                closeModal();
                await loadVocabulary();
            } else {
                showToast(result.error || 'Failed to create item', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to create item', 'error');
        }
    }
    
    async function updateVocabulary(type, id, data) {
        const endpoints = {
            disciplines: `/api/vocabulary/disciplines/${id}`,
            categories: `/api/vocabulary/categories/${id}`,
            types: `/api/vocabulary/object-types/${id}`,
            phases: `/api/vocabulary/phases/${id}`,
            geometries: `/api/vocabulary/geometries/${id}`
        };
        
        try {
            const response = await fetch(endpoints[type], {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Item updated successfully', 'success');
                closeModal();
                await loadVocabulary();
            } else {
                showToast(result.error || 'Failed to update item', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to update item', 'error');
        }
    }
    
    async function confirmDelete() {
        const { type, id } = deleteTarget;
        const endpoints = {
            disciplines: `/api/vocabulary/disciplines/${id}`,
            categories: `/api/vocabulary/categories/${id}`,
            types: `/api/vocabulary/object-types/${id}`,
            phases: `/api/vocabulary/phases/${id}`,
            geometries: `/api/vocabulary/geometries/${id}`
        };
        
        try {
            const response = await fetch(endpoints[type], {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Item deleted successfully', 'success');
                closeConfirmModal();
                await loadVocabulary();
            } else {
                showToast(result.error || 'Failed to delete item', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to delete item', 'error');
        }
    }
    
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 4000);
    }
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
            closeConfirmModal();
        }
    });
    
    document.getElementById('editModal').addEventListener('click', (e) => {
        if (e.target.id === 'editModal') {
            closeModal();
        }
    });
    
    document.getElementById('confirmModal').addEventListener('click', (e) => {
        if (e.target.id === 'confirmModal') {
            closeConfirmModal();
        }
    });
    
    document.getElementById('applicabilityModal').addEventListener('click', (e) => {
        if (e.target.id === 'applicabilityModal') {
            closeApplicabilityModal();
        }
    });
    
    // ============================================
    // ATTRIBUTE APPLICABILITY MANAGEMENT
    // ============================================
    
    let applicabilityRules = [];
    
    async function loadApplicabilityRules() {
        try {
            const response = await fetch('/api/standards/attribute-applicability');
            const data = await response.json();
            applicabilityRules = data.rules || [];
            renderApplicabilityRules();
        } catch (error) {
            console.error('Error loading applicability rules:', error);
            document.getElementById('applicabilityGrid').innerHTML = 
                '<p style="color: rgba(255,100,100,0.8); text-align: center; padding: 2rem;">Failed to load applicability rules</p>';
        }
    }
    
    function renderApplicabilityRules() {
        const grid = document.getElementById('applicabilityGrid');
        
        if (applicabilityRules.length === 0) {
            grid.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">No applicability rules defined yet. Click "Add Applicability Rule" to create one.</p>';
            return;
        }
        
        grid.innerHTML = `
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: rgba(0,255,255,0.1); border-bottom: 1px solid rgba(0,255,255,0.3);">
                        <th style="padding: 0.75rem; text-align: left;">Attribute</th>
                        <th style="padding: 0.75rem; text-align: left;">Category</th>
                        <th style="padding: 0.75rem; text-align: left;">Object Type</th>
                        <th style="padding: 0.75rem; text-align: center;">Required?</th>
                        <th style="padding: 0.75rem; text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${applicabilityRules.map(rule => `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 0.75rem;">
                                <strong>${rule.attribute_code || 'N/A'}</strong>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${rule.attribute_name || ''}</div>
                            </td>
                            <td style="padding: 0.75rem;">
                                <strong>${rule.category_code || 'N/A'}</strong>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${rule.category_name || ''}</div>
                            </td>
                            <td style="padding: 0.75rem;">
                                <strong>${rule.type_code || 'N/A'}</strong>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${rule.type_name || ''}</div>
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                ${rule.is_required ? '<i class="fas fa-check-circle" style="color: #00ff99;"></i>' : '<i class="fas fa-circle" style="color: rgba(255,255,255,0.3);"></i>'}
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <button class="icon-btn delete" onclick="deleteApplicabilityRule(${rule.applicability_id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    
    function openApplicabilityModal() {
        // Populate categories dropdown
        const categorySelect = document.getElementById('appl_category');
        categorySelect.innerHTML = '<option value="">Select Category...</option>' +
            currentVocabulary.categories.map(c => 
                `<option value="${c.category_id}">${c.code} - ${c.full_name}</option>`
            ).join('');
        
        // Populate attributes dropdown
        const attributeSelect = document.getElementById('appl_attribute');
        attributeSelect.innerHTML = '<option value="">Select Attribute...</option>' +
            currentVocabulary.attributes.map(a => 
                `<option value="${a.attribute_id}">${a.code} - ${a.full_name}</option>`
            ).join('');
        
        // Reset type dropdown
        document.getElementById('appl_type').innerHTML = '<option value="">Select Category First...</option>';
        document.getElementById('appl_required').checked = false;
        
        document.getElementById('applicabilityModal').style.display = 'flex';
    }
    
    function closeApplicabilityModal() {
        document.getElementById('applicabilityModal').style.display = 'none';
        document.getElementById('applicabilityForm').reset();
    }
    
    function loadTypesForCategory() {
        const categoryId = document.getElementById('appl_category').value;
        const typeSelect = document.getElementById('appl_type');
        
        if (!categoryId) {
            typeSelect.innerHTML = '<option value="">Select Category First...</option>';
            return;
        }
        
        const filteredTypes = currentVocabulary.types.filter(t => t.category_id == categoryId);
        typeSelect.innerHTML = '<option value="">Select Object Type...</option>' +
            filteredTypes.map(t => 
                `<option value="${t.type_id}">${t.code} - ${t.full_name}</option>`
            ).join('');
    }
    
    async function handleApplicabilitySubmit(event) {
        event.preventDefault();
        
        const data = {
            category_id: parseInt(document.getElementById('appl_category').value),
            type_id: parseInt(document.getElementById('appl_type').value),
            attribute_id: parseInt(document.getElementById('appl_attribute').value),
            is_required: document.getElementById('appl_required').checked
        };
        
        try {
            const response = await fetch('/api/standards/attribute-applicability', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast('Applicability rule created successfully', 'success');
                closeApplicabilityModal();
                await loadApplicabilityRules();
            } else {
                showToast(result.error || 'Failed to create applicability rule', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to create applicability rule', 'error');
        }
    }
    
    async function deleteApplicabilityRule(applicabilityId) {
        if (!confirm('Are you sure you want to delete this applicability rule?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/standards/attribute-applicability/${applicabilityId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast('Applicability rule deleted successfully', 'success');
                await loadApplicabilityRules();
            } else {
                showToast(result.error || 'Failed to delete applicability rule', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to delete applicability rule', 'error');
        }
    }
    
    loadVocabulary();
    loadApplicabilityRules();
</script>
{% endblock %}
