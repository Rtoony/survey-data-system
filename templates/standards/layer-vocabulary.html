{% extends 'base.html' %}

{% block title %}CAD Layer Vocabulary{% endblock %}

{% block content %}
<div class="container">
    <h1><i class="fas fa-layer-group"></i> CAD Layer Vocabulary</h1>
    <p class="subtitle">Database-Driven Layer Naming Classification System</p>
    
    <div class="stats-grid" id="statsGrid"></div>
    
    <div class="tabs">
        <div class="tab active" data-tab="overview">Overview</div>
        <div class="tab" data-tab="disciplines">Disciplines</div>
        <div class="tab" data-tab="categories">Categories</div>
        <div class="tab" data-tab="types">Object Types</div>
        <div class="tab" data-tab="attributes">Attributes</div>
        <div class="tab" data-tab="phases">Phases</div>
        <div class="tab" data-tab="geometries">Geometries</div>
        <div class="tab" data-tab="entity-registry">Entity Registry</div>
        <div class="tab" data-tab="hierarchy">Full Hierarchy</div>
    </div>
    
    <div class="tab-content active" id="overview">
        <div class="card">
            <h2><i class="fas fa-info-circle"></i> Layer Name Format</h2>
            <div class="layer-example">
                DISCIPLINE-CATEGORY-TYPE-[ATTRIBUTES]-PHASE-GEOMETRY
                <br><br>
                Example: CIV-UTIL-STORM-12IN-NEW-LN
                <br>
                → Civil Utility Storm Drain, 12 inch, New Construction, Line
            </div>
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0, 255, 100, 0.1); border: 1px solid rgba(0, 255, 100, 0.3); border-radius: 6px;">
                <h3 style="margin: 0 0 0.75rem 0; color: var(--accent-green); font-size: 14px;">
                    <i class="fas fa-lightbulb"></i> About Attributes [Optional]
                </h3>
                <p style="margin: 0 0 0.75rem 0; font-size: 13px; line-height: 1.6;">
                    <strong>Attributes</strong> are optional details (size, material, slope, etc.) inserted between TYPE and PHASE.
                    They provide specific object properties like <code>12IN</code> (diameter), <code>PVC</code> (material), or <code>2PCT</code> (slope).
                </p>
                <p style="margin: 0; font-size: 13px; line-height: 1.6;">
                    <i class="fas fa-magic" style="color: var(--accent-green);"></i>
                    <strong>Auto-extraction:</strong> During DXF export, attributes are automatically extracted from your database object properties - 
                    you don't manually create them! The layer generator lets you test them, but in production they come from your data.
                </p>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-lightbulb"></i> Key Benefits</h2>
            <ul style="list-style: none; padding-left: 20px;">
                <li><i class="fas fa-check" style="color: var(--accent);"></i> <strong>AI-Friendly:</strong> Clear hierarchy for LLM processing</li>
                <li><i class="fas fa-check" style="color: var(--accent);"></i> <strong>Human-Readable:</strong> Engineers understand at a glance</li>
                <li><i class="fas fa-check" style="color: var(--accent);"></i> <strong>Flexible:</strong> Handles client CAD variations via mapping</li>
                <li><i class="fas fa-check" style="color: var(--accent);"></i> <strong>Extensible:</strong> Add new codes without breaking patterns</li>
                <li><i class="fas fa-check" style="color: var(--accent);"></i> <strong>Database-Driven:</strong> Database is source of truth, not layer names</li>
            </ul>
        </div>
    </div>
    
    <div class="tab-content" id="disciplines">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-layer-group"></i> Discipline Codes</h2>
                <button class="btn btn-add" onclick="openAddModal('disciplines')">
                    <i class="fas fa-plus"></i> Add New Discipline
                </button>
            </div>
            <div class="grid" id="disciplinesGrid"></div>
        </div>
    </div>
    
    <div class="tab-content" id="categories">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-folder-tree"></i> Category Codes</h2>
                <button class="btn btn-add" onclick="openAddModal('categories')">
                    <i class="fas fa-plus"></i> Add New Category
                </button>
            </div>
            <div class="grid" id="categoriesGrid"></div>
        </div>
    </div>
    
    <div class="tab-content" id="types">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-cubes"></i> Object Type Codes</h2>
                <button class="btn btn-add" onclick="openAddModal('types')">
                    <i class="fas fa-plus"></i> Add New Object Type
                </button>
            </div>
            <div class="grid" id="typesGrid"></div>
        </div>
    </div>
    
    <div class="tab-content" id="attributes">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-tags"></i> Attribute Codes</h2>
                <button class="btn btn-add" onclick="openAddModal('attributes')">
                    <i class="fas fa-plus"></i> Add New Attribute
                </button>
            </div>
            <p class="subtitle" style="margin: -1rem 0 1.5rem 0; color: rgba(255,255,255,0.6);">
                Optional layer name components like size (12IN), material (PVC), slope (2PCT), etc.
            </p>
            <div class="grid" id="attributesGrid"></div>
        </div>
        
        <div class="card" style="margin-top: 2rem;">
            <div class="section-header">
                <h2><i class="fas fa-link"></i> Attribute Applicability Rules</h2>
                <button class="btn btn-add" onclick="openApplicabilityModal()">
                    <i class="fas fa-plus"></i> Add Applicability Rule
                </button>
            </div>
            <p class="subtitle" style="margin: -1rem 0 1.5rem 0; color: rgba(255,255,255,0.6);">
                Define which attributes can be used with specific Category + Object Type combinations
            </p>
            <div class="applicability-grid" id="applicabilityGrid">
                <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">
                    Loading applicability rules...
                </p>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="phases">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-clock"></i> Phase Codes</h2>
                <button class="btn btn-add" onclick="openAddModal('phases')">
                    <i class="fas fa-plus"></i> Add New Phase
                </button>
            </div>
            <div class="grid" id="phasesGrid"></div>
        </div>
    </div>
    
    <div class="tab-content" id="geometries">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-shapes"></i> Geometry Codes</h2>
                <button class="btn btn-add" onclick="openAddModal('geometries')">
                    <i class="fas fa-plus"></i> Add New Geometry
                </button>
            </div>
            <div class="grid" id="geometriesGrid"></div>
        </div>
    </div>
    
    <div class="tab-content" id="entity-registry">
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-table"></i> Entity Registry</h2>
                <button class="btn btn-add" onclick="openAddEntityModal()">
                    <i class="fas fa-plus"></i> Add New Entity
                </button>
            </div>
            <p style="color: var(--muted); margin-bottom: 20px;">
                Define database tables that can be linked to Object Type codes in the layer vocabulary.
            </p>
            <div id="entityRegistryContainer"></div>
        </div>
    </div>
    
    <div class="tab-content" id="hierarchy">
        <div class="card">
            <h2><i class="fas fa-sitemap"></i> Complete Hierarchy</h2>
            <div class="hierarchy-tree" id="hierarchyTree"></div>
        </div>
    </div>
</div>

<div id="entityModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="entityModalTitle">Add New Entity</h3>
            <button class="close-btn" onclick="closeEntityModal()">&times;</button>
        </div>
        <form id="entityForm" onsubmit="handleEntitySubmit(event)">
            <div class="form-group">
                <label>Table Name <span style="color: #ff4444;">*</span></label>
                <input type="text" id="tableName" name="table_name" required 
                       placeholder="e.g., storm_structures" 
                       onblur="validateTableName()">
                <div class="help-text">Database table name (lowercase, underscores only)</div>
                <div id="tableValidation"></div>
            </div>
            <div class="form-group">
                <label>Display Name <span style="color: #ff4444;">*</span></label>
                <input type="text" name="display_name" required placeholder="e.g., Storm Structures">
                <div class="help-text">Human-readable name</div>
            </div>
            <div class="form-group">
                <label>Category <span style="color: #ff4444;">*</span></label>
                <select name="category" required>
                    <option value="">Select Category</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Survey">Survey</option>
                    <option value="Annotation">Annotation</option>
                    <option value="Civil">Civil</option>
                    <option value="Architecture">Architecture</option>
                    <option value="Mechanical">Mechanical</option>
                    <option value="Electrical">Electrical</option>
                    <option value="General">General</option>
                </select>
            </div>
            <div class="form-group">
                <label>Icon</label>
                <input type="text" name="icon" placeholder="fas fa-table">
                <div class="help-text">Font Awesome icon class (optional)</div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea name="description" placeholder="Brief description of this entity table..."></textarea>
            </div>
            <div class="form-group">
                <label>Sort Order</label>
                <input type="number" name="sort_order" min="0" placeholder="0">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="closeEntityModal()">Cancel</button>
                <button type="submit" class="btn btn-submit">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Edit Item</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <form id="editForm" onsubmit="handleSubmit(event)">
            <div id="formFields"></div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-submit">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Delete</h3>
            <button class="close-btn" onclick="closeConfirmModal()">&times;</button>
        </div>
        <div class="confirm-dialog">
            <p id="confirmMessage">Are you sure you want to delete this item?</p>
            <div class="confirm-actions">
                <button class="btn btn-cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>

<div id="applicabilityModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Attribute Applicability Rule</h3>
            <button class="close-btn" onclick="closeApplicabilityModal()">&times;</button>
        </div>
        <form id="applicabilityForm" onsubmit="handleApplicabilitySubmit(event)">
            <div class="form-group">
                <label for="appl_category">Category</label>
                <select id="appl_category" required onchange="loadTypesForCategory()">
                    <option value="">Select Category...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="appl_type">Object Type <span style="color: rgba(255,255,255,0.5); font-size: 0.9rem;">(Optional)</span></label>
                <select id="appl_type">
                    <option value="">Select Category First...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="appl_attribute">Attribute</label>
                <select id="appl_attribute" required>
                    <option value="">Select Attribute...</option>
                </select>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="appl_required">
                    <span>Required Attribute</span>
                </label>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="closeApplicabilityModal()">Cancel</button>
                <button type="submit" class="btn btn-submit">Add Rule</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentVocabulary = {
        disciplines: [],
        categories: [],
        types: [],
        attributes: [],
        phases: [],
        geometries: []
    };
    
    let entities = [];
    
    let currentEdit = {
        type: null,
        id: null,
        data: null
    };
    
    let deleteTarget = {
        type: null,
        id: null,
        name: null
    };
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'entity-registry' && entities.length === 0) {
                loadEntityRegistry();
            }
        });
    });
    
    async function loadVocabulary() {
        try {
            console.log('Loading vocabulary data...');
            const [disciplines, categories, types, attributes, phases, geometries] = await Promise.all([
                fetch('/api/vocabulary/disciplines').then(r => r.json()),
                fetch('/api/vocabulary/categories').then(r => r.json()),
                fetch('/api/vocabulary/object-types').then(r => r.json()),
                fetch('/api/standards/attributes').then(r => r.json()),
                fetch('/api/vocabulary/phases').then(r => r.json()),
                fetch('/api/vocabulary/geometries').then(r => r.json())
            ]);
            
            console.log('API responses received:', { disciplines, categories, types, attributes, phases, geometries });
            
            currentVocabulary.disciplines = disciplines.disciplines;
            currentVocabulary.categories = categories.categories;
            currentVocabulary.types = types.object_types;
            currentVocabulary.attributes = attributes.attributes;
            currentVocabulary.phases = phases.phases;
            currentVocabulary.geometries = geometries.geometries;
            
            console.log('Attributes array length:', attributes.attributes?.length);
            console.log('Attributes data:', attributes.attributes);
            
            renderStats(disciplines, categories, types, attributes, phases, geometries);
            renderDisciplines(disciplines.disciplines);
            renderCategories(categories.categories);
            renderTypes(types.object_types);
            console.log('About to render attributes...');
            renderAttributes(attributes.attributes);
            console.log('Attributes rendered successfully');
            renderPhases(phases.phases);
            renderGeometries(geometries.geometries);
            renderHierarchy(disciplines.disciplines, categories.categories, types.object_types);
            
        } catch (error) {
            console.error('Error loading vocabulary:', error);
            console.error('Error stack:', error.stack);
            showToast('Failed to load vocabulary data', 'error');
        }
    }
    
    function renderStats(disciplines, categories, types, attributes, phases, geometries) {
        const stats = [
            { value: disciplines.disciplines.length, label: 'Disciplines' },
            { value: categories.categories.length, label: 'Categories' },
            { value: types.object_types.length, label: 'Object Types' },
            { value: attributes.attributes.length, label: 'Attributes' },
            { value: phases.phases.length, label: 'Phases' },
            { value: geometries.geometries.length, label: 'Geometries' }
        ];
        
        document.getElementById('statsGrid').innerHTML = stats.map(stat => `
            <div class="stat-card">
                <div class="stat-value">${stat.value}</div>
                <div class="stat-label">${stat.label}</div>
            </div>
        `).join('');
    }
    
    function renderDisciplines(disciplines) {
        document.getElementById('disciplinesGrid').innerHTML = disciplines.map(d => `
            <div class="code-item">
                <div class="code-label">${d.code}</div>
                <div class="code-name">${d.full_name}</div>
                ${d.description ? `<div class="code-desc">${d.description}</div>` : ''}
                <div class="item-actions">
                    <button class="icon-btn" onclick='openEditModal("disciplines", ${d.discipline_id}, ${JSON.stringify(d)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn delete" onclick='openDeleteModal("disciplines", ${d.discipline_id}, "${d.code}")' title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function renderCategories(categories) {
        document.getElementById('categoriesGrid').innerHTML = categories.map(c => `
            <div class="code-item">
                <div class="code-label">${c.code}</div>
                <div class="code-name">${c.full_name}</div>
                <div class="code-desc">${c.discipline_code} → ${c.discipline_name}</div>
                <div class="item-actions">
                    <button class="icon-btn" onclick='openEditModal("categories", ${c.category_id}, ${JSON.stringify(c)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn delete" onclick='openDeleteModal("categories", ${c.category_id}, "${c.code}")' title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function renderTypes(types) {
        document.getElementById('typesGrid').innerHTML = types.map(t => `
            <div class="code-item">
                <div class="code-label">${t.code}</div>
                <div class="code-name">${t.full_name}</div>
                <div class="code-desc">${t.discipline_code}-${t.category_code}</div>
                ${t.database_table ? `<div class="code-desc">Table: ${t.database_table}</div>` : ''}
                <div class="item-actions">
                    <button class="icon-btn" onclick='openEditModal("types", ${t.type_id}, ${JSON.stringify(t)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn delete" onclick='openDeleteModal("types", ${t.type_id}, "${t.code}")' title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function renderAttributes(attributes) {
        document.getElementById('attributesGrid').innerHTML = attributes.map(a => `
            <div class="code-item">
                <div class="code-label">${a.code}</div>
                <div class="code-name">${a.full_name}</div>
                <div class="code-desc">Category: ${a.attribute_category || 'other'}</div>
                ${a.description ? `<div class="code-desc">${a.description}</div>` : ''}
                <div class="item-actions">
                    <button class="icon-btn" onclick='openEditModal("attributes", ${a.attribute_id}, ${JSON.stringify(a)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn delete" onclick='openDeleteModal("attributes", ${a.attribute_id}, "${a.code}")' title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function renderPhases(phases) {
        document.getElementById('phasesGrid').innerHTML = phases.map(p => `
            <div class="code-item">
                <div class="code-label">${p.code}</div>
                <div class="code-name">${p.full_name}</div>
                ${p.description ? `<div class="code-desc">${p.description}</div>` : ''}
                <div class="item-actions">
                    <button class="icon-btn" onclick='openEditModal("phases", ${p.phase_id}, ${JSON.stringify(p)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn delete" onclick='openDeleteModal("phases", ${p.phase_id}, "${p.code}")' title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function renderGeometries(geometries) {
        document.getElementById('geometriesGrid').innerHTML = geometries.map(g => `
            <div class="code-item">
                <div class="code-label">${g.code}</div>
                <div class="code-name">${g.full_name}</div>
                ${g.description ? `<div class="code-desc">${g.description}</div>` : ''}
                <div class="item-actions">
                    <button class="icon-btn" onclick='openEditModal("geometries", ${g.geometry_id}, ${JSON.stringify(g)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn delete" onclick='openDeleteModal("geometries", ${g.geometry_id}, "${g.code}")' title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function renderHierarchy(disciplines, categories, types) {
        const hierarchyHTML = disciplines.map(discipline => {
            const disciplineCategories = categories.filter(c => c.discipline_id === discipline.discipline_id);
            
            return `
                <div class="discipline-group">
                    <div class="discipline-header">
                        <div class="discipline-title">${discipline.code} - ${discipline.full_name}</div>
                    </div>
                    ${disciplineCategories.map(category => {
                        const categoryTypes = types.filter(t => t.category_id === category.category_id);
                        
                        return `
                            <div class="category-item">
                                <div class="category-title">${category.code} - ${category.full_name}</div>
                                ${categoryTypes.length > 0 ? `
                                    <div class="type-list">
                                        ${categoryTypes.map(type => `
                                            <div class="type-item">
                                                <strong>${type.code}</strong> - ${type.full_name}
                                                ${type.database_table ? `<br><small style="color: var(--muted);">Table: ${type.database_table}</small>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }).join('');
        
        document.getElementById('hierarchyTree').innerHTML = hierarchyHTML;
    }
    
    function openAddModal(type) {
        currentEdit = { type, id: null, data: null };
        document.getElementById('modalTitle').textContent = 'Add New ' + type.charAt(0).toUpperCase() + type.slice(1, -1);
        buildForm(type);
        document.getElementById('editModal').classList.add('active');
    }
    
    function openEditModal(type, id, data) {
        currentEdit = { type, id, data };
        document.getElementById('modalTitle').textContent = 'Edit ' + type.charAt(0).toUpperCase() + type.slice(1, -1);
        buildForm(type, data);
        document.getElementById('editModal').classList.add('active');
    }
    
    function closeModal() {
        document.getElementById('editModal').classList.remove('active');
        currentEdit = { type: null, id: null, data: null };
    }
    
    function openDeleteModal(type, id, name) {
        deleteTarget = { type, id, name };
        document.getElementById('confirmMessage').textContent = `Are you sure you want to delete "${name}"?`;
        document.getElementById('confirmModal').classList.add('active');
    }
    
    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.remove('active');
        deleteTarget = { type: null, id: null, name: null };
    }
    
    async function buildForm(type, data = null) {
        const formFields = document.getElementById('formFields');
        let html = '';
        
        if (type === 'disciplines') {
            html = `
                <div class="form-group">
                    <label>Code <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="code" value="${data?.code || ''}" required maxlength="10">
                </div>
                <div class="form-group">
                    <label>Full Name <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="full_name" value="${data?.full_name || ''}" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description">${data?.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Sort Order</label>
                    <input type="number" name="sort_order" value="${data?.sort_order || ''}" min="0">
                </div>
            `;
        } else if (type === 'categories') {
            const disciplineOptions = currentVocabulary.disciplines.map(d => 
                `<option value="${d.discipline_id}" ${data?.discipline_id === d.discipline_id ? 'selected' : ''}>${d.code} - ${d.full_name}</option>`
            ).join('');
            html = `
                <div class="form-group">
                    <label>Code <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="code" value="${data?.code || ''}" required maxlength="10">
                </div>
                <div class="form-group">
                    <label>Full Name <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="full_name" value="${data?.full_name || ''}" required>
                </div>
                <div class="form-group">
                    <label>Discipline <span style="color: #ff4444;">*</span></label>
                    <select name="discipline_id" required>
                        <option value="">Select Discipline</option>
                        ${disciplineOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description">${data?.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Sort Order</label>
                    <input type="number" name="sort_order" value="${data?.sort_order || ''}" min="0">
                </div>
            `;
        } else if (type === 'types') {
            const categoryOptions = currentVocabulary.categories.map(c => 
                `<option value="${c.category_id}" ${data?.category_id === c.category_id ? 'selected' : ''}>${c.discipline_code}-${c.code} - ${c.full_name}</option>`
            ).join('');
            
            let entityOptions = '<option value="">Loading...</option>';
            formFields.innerHTML = `
                <div class="form-group">
                    <label>Code <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="code" value="${data?.code || ''}" required maxlength="10">
                </div>
                <div class="form-group">
                    <label>Full Name <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="full_name" value="${data?.full_name || ''}" required>
                </div>
                <div class="form-group">
                    <label>Category <span style="color: #ff4444;">*</span></label>
                    <select name="category_id" required>
                        <option value="">Select Category</option>
                        ${categoryOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label>Database Table</label>
                    <select name="database_table" id="entityTableSelect">
                        ${entityOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description">${data?.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Sort Order</label>
                    <input type="number" name="sort_order" value="${data?.sort_order || ''}" min="0">
                </div>
            `;
            
            try {
                const response = await fetch('/api/entity-registry');
                const entityData = await response.json();
                const entities = entityData.entities || [];
                entityOptions = '<option value="">Select Database Table (Optional)</option>' + 
                    entities.map(e => 
                        `<option value="${e.table_name}" ${data?.database_table === e.table_name ? 'selected' : ''}>${e.display_name} (${e.table_name})</option>`
                    ).join('');
                document.getElementById('entityTableSelect').innerHTML = entityOptions;
            } catch (error) {
                console.error('Error loading entity registry:', error);
                document.getElementById('entityTableSelect').innerHTML = '<option value="">Select Database Table (Optional)</option>';
            }
            return;
        } else if (type === 'phases') {
            html = `
                <div class="form-group">
                    <label>Code <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="code" value="${data?.code || ''}" required maxlength="10">
                </div>
                <div class="form-group">
                    <label>Full Name <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="full_name" value="${data?.full_name || ''}" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description">${data?.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Color (RGB)</label>
                    <input type="color" name="color_rgb" value="${data?.color_rgb || '#00ffff'}">
                </div>
                <div class="form-group">
                    <label>Sort Order</label>
                    <input type="number" name="sort_order" value="${data?.sort_order || ''}" min="0">
                </div>
            `;
        } else if (type === 'attributes') {
            html = `
                <div class="form-group">
                    <label>Code <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="code" value="${data?.code || ''}" required maxlength="10">
                </div>
                <div class="form-group">
                    <label>Full Name <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="full_name" value="${data?.full_name || ''}" required>
                </div>
                <div class="form-group">
                    <label>Attribute Category</label>
                    <input type="text" name="attribute_category" value="${data?.attribute_category || ''}" placeholder="e.g., Size, Material, Slope">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description">${data?.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Sort Order</label>
                    <input type="number" name="sort_order" value="${data?.sort_order || ''}" min="0">
                </div>
            `;
        } else if (type === 'geometries') {
            html = `
                <div class="form-group">
                    <label>Code <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="code" value="${data?.code || ''}" required maxlength="10">
                </div>
                <div class="form-group">
                    <label>Full Name <span style="color: #ff4444;">*</span></label>
                    <input type="text" name="full_name" value="${data?.full_name || ''}" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description">${data?.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>DXF Entity Types</label>
                    <input type="text" name="dxf_entity_types" value="${data?.dxf_entity_types || ''}" placeholder="e.g., LINE,POLYLINE,ARC">
                </div>
                <div class="form-group">
                    <label>Sort Order</label>
                    <input type="number" name="sort_order" value="${data?.sort_order || ''}" min="0">
                </div>
            `;
        }
        
        formFields.innerHTML = html;
    }
    
    async function handleSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        Object.keys(data).forEach(key => {
            if (data[key] === '') {
                data[key] = null;
            }
        });
        
        try {
            if (currentEdit.id) {
                await updateVocabulary(currentEdit.type, currentEdit.id, data);
            } else {
                await createVocabulary(currentEdit.type, data);
            }
        } catch (error) {
            console.error('Error submitting form:', error);
        }
    }
    
    async function createVocabulary(type, data) {
        const endpoints = {
            disciplines: '/api/vocabulary/disciplines',
            categories: '/api/vocabulary/categories',
            types: '/api/vocabulary/object-types',
            attributes: '/api/standards/attributes',
            phases: '/api/vocabulary/phases',
            geometries: '/api/vocabulary/geometries'
        };
        
        try {
            const response = await fetch(endpoints[type], {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Item created successfully', 'success');
                closeModal();
                await loadVocabulary();
            } else {
                showToast(result.error || 'Failed to create item', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to create item', 'error');
        }
    }
    
    async function updateVocabulary(type, id, data) {
        const endpoints = {
            disciplines: `/api/vocabulary/disciplines/${id}`,
            categories: `/api/vocabulary/categories/${id}`,
            types: `/api/vocabulary/object-types/${id}`,
            attributes: `/api/standards/attributes/${id}`,
            phases: `/api/vocabulary/phases/${id}`,
            geometries: `/api/vocabulary/geometries/${id}`
        };
        
        try {
            const response = await fetch(endpoints[type], {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Item updated successfully', 'success');
                closeModal();
                await loadVocabulary();
            } else {
                showToast(result.error || 'Failed to update item', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to update item', 'error');
        }
    }
    
    async function confirmDelete() {
        const { type, id } = deleteTarget;
        const endpoints = {
            disciplines: `/api/vocabulary/disciplines/${id}`,
            categories: `/api/vocabulary/categories/${id}`,
            types: `/api/vocabulary/object-types/${id}`,
            attributes: `/api/standards/attributes/${id}`,
            phases: `/api/vocabulary/phases/${id}`,
            geometries: `/api/vocabulary/geometries/${id}`
        };
        
        try {
            const response = await fetch(endpoints[type], {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Item deleted successfully', 'success');
                closeConfirmModal();
                await loadVocabulary();
            } else {
                showToast(result.error || 'Failed to delete item', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to delete item', 'error');
        }
    }
    
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 4000);
    }
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
            closeConfirmModal();
        }
    });
    
    document.getElementById('editModal').addEventListener('click', (e) => {
        if (e.target.id === 'editModal') {
            closeModal();
        }
    });
    
    document.getElementById('confirmModal').addEventListener('click', (e) => {
        if (e.target.id === 'confirmModal') {
            closeConfirmModal();
        }
    });
    
    document.getElementById('applicabilityModal').addEventListener('click', (e) => {
        if (e.target.id === 'applicabilityModal') {
            closeApplicabilityModal();
        }
    });
    
    // ============================================
    // ATTRIBUTE APPLICABILITY MANAGEMENT
    // ============================================
    
    let applicabilityRules = [];
    let editingRuleId = null;
    
    async function loadApplicabilityRules() {
        try {
            const response = await fetch('/api/standards/attribute-applicability');
            const data = await response.json();
            applicabilityRules = data.rules || [];
            renderApplicabilityRules();
        } catch (error) {
            console.error('Error loading applicability rules:', error);
            document.getElementById('applicabilityGrid').innerHTML = 
                '<p style="color: rgba(255,100,100,0.8); text-align: center; padding: 2rem;">Failed to load applicability rules</p>';
        }
    }
    
    function renderApplicabilityRules() {
        const grid = document.getElementById('applicabilityGrid');
        
        if (applicabilityRules.length === 0) {
            grid.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">No applicability rules defined yet. Click "Add Applicability Rule" to create one.</p>';
            return;
        }
        
        grid.innerHTML = `
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: rgba(0,255,255,0.1); border-bottom: 1px solid rgba(0,255,255,0.3);">
                        <th style="padding: 0.75rem; text-align: left;">Attribute</th>
                        <th style="padding: 0.75rem; text-align: left;">Category</th>
                        <th style="padding: 0.75rem; text-align: left;">Object Type</th>
                        <th style="padding: 0.75rem; text-align: center;">Required?</th>
                        <th style="padding: 0.75rem; text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${applicabilityRules.map(rule => `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 0.75rem;">
                                <strong>${rule.attribute_code || 'N/A'}</strong>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${rule.attribute_name || ''}</div>
                            </td>
                            <td style="padding: 0.75rem;">
                                <strong>${rule.category_code || 'N/A'}</strong>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${rule.category_name || ''}</div>
                            </td>
                            <td style="padding: 0.75rem;">
                                <strong>${rule.type_code || 'N/A'}</strong>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${rule.type_name || ''}</div>
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                ${rule.is_required ? '<i class="fas fa-check-circle" style="color: #00ff99;"></i>' : '<i class="fas fa-circle" style="color: rgba(255,255,255,0.3);"></i>'}
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <button class="icon-btn" onclick='openEditApplicabilityModal(${rule.applicability_id}, ${JSON.stringify(rule).replace(/'/g, "&#39;")})' title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn delete" onclick="deleteApplicabilityRule(${rule.applicability_id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    
    function openApplicabilityModal() {
        editingRuleId = null;
        document.querySelector('#applicabilityModal h3').textContent = 'Add Attribute Applicability Rule';
        
        // Populate categories dropdown
        const categorySelect = document.getElementById('appl_category');
        categorySelect.innerHTML = '<option value="">Select Category...</option>' +
            currentVocabulary.categories.map(c => 
                `<option value="${c.category_id}">${c.code} - ${c.full_name}</option>`
            ).join('');
        
        // Populate attributes dropdown
        const attributeSelect = document.getElementById('appl_attribute');
        attributeSelect.innerHTML = '<option value="">Select Attribute...</option>' +
            currentVocabulary.attributes.map(a => 
                `<option value="${a.attribute_id}">${a.code} - ${a.full_name}</option>`
            ).join('');
        
        // Reset type dropdown
        document.getElementById('appl_type').innerHTML = '<option value="">Select Category First...</option>';
        document.getElementById('appl_required').checked = false;
        
        document.getElementById('applicabilityModal').style.display = 'flex';
    }
    
    function openEditApplicabilityModal(applicabilityId, ruleData) {
        editingRuleId = applicabilityId;
        document.querySelector('#applicabilityModal h3').textContent = 'Edit Attribute Applicability Rule';
        
        // Populate categories dropdown
        const categorySelect = document.getElementById('appl_category');
        categorySelect.innerHTML = '<option value="">Select Category...</option>' +
            currentVocabulary.categories.map(c => 
                `<option value="${c.category_id}" ${ruleData.category_id === c.category_id ? 'selected' : ''}>${c.code} - ${c.full_name}</option>`
            ).join('');
        
        // Populate attributes dropdown
        const attributeSelect = document.getElementById('appl_attribute');
        attributeSelect.innerHTML = '<option value="">Select Attribute...</option>' +
            currentVocabulary.attributes.map(a => 
                `<option value="${a.attribute_id}" ${ruleData.attribute_id === a.attribute_id ? 'selected' : ''}>${a.code} - ${a.full_name}</option>`
            ).join('');
        
        // Load and populate types for the selected category
        const typeSelect = document.getElementById('appl_type');
        if (ruleData.category_id) {
            const filteredTypes = currentVocabulary.types.filter(t => t.category_id === ruleData.category_id);
            typeSelect.innerHTML = '<option value="">Select Object Type...</option>' +
                filteredTypes.map(t => 
                    `<option value="${t.type_id}" ${ruleData.type_id === t.type_id ? 'selected' : ''}>${t.code} - ${t.full_name}</option>`
                ).join('');
        } else {
            typeSelect.innerHTML = '<option value="">Select Category First...</option>';
        }
        
        // Set required checkbox
        document.getElementById('appl_required').checked = ruleData.is_required || false;
        
        document.getElementById('applicabilityModal').style.display = 'flex';
    }
    
    function closeApplicabilityModal() {
        editingRuleId = null;
        document.getElementById('applicabilityModal').style.display = 'none';
        document.getElementById('applicabilityForm').reset();
    }
    
    function loadTypesForCategory() {
        const categoryId = document.getElementById('appl_category').value;
        const typeSelect = document.getElementById('appl_type');
        
        if (!categoryId) {
            typeSelect.innerHTML = '<option value="">Select Category First...</option>';
            typeSelect.value = '';
            return;
        }
        
        const filteredTypes = currentVocabulary.types.filter(t => t.category_id === Number(categoryId));
        console.log(`loadTypesForCategory: category ${categoryId} has ${filteredTypes.length} object types`);
        
        typeSelect.innerHTML = '<option value="">Select Object Type...</option>' +
            filteredTypes.map(t => 
                `<option value="${t.type_id}">${t.code} - ${t.full_name}</option>`
            ).join('');
        
        if (filteredTypes.length === 0) {
            typeSelect.value = '';
        }
    }
    
    async function handleApplicabilitySubmit(event) {
        event.preventDefault();
        
        const categoryValue = document.getElementById('appl_category').value;
        const typeValue = document.getElementById('appl_type').value;
        const attributeValue = document.getElementById('appl_attribute').value;
        
        if (!categoryValue || !attributeValue) {
            showToast('Category and Attribute are required', 'error');
            return;
        }
        
        const data = {
            category_id: parseInt(categoryValue),
            type_id: typeValue ? parseInt(typeValue) : null,
            attribute_id: parseInt(attributeValue),
            is_required: document.getElementById('appl_required').checked
        };
        
        try {
            const url = editingRuleId 
                ? `/api/standards/attribute-applicability/${editingRuleId}`
                : '/api/standards/attribute-applicability';
            const method = editingRuleId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(`Applicability rule ${editingRuleId ? 'updated' : 'created'} successfully`, 'success');
                closeApplicabilityModal();
                await loadApplicabilityRules();
            } else {
                showToast(result.error || `Failed to ${editingRuleId ? 'update' : 'create'} applicability rule`, 'error');
            }
        } catch (error) {
            showToast(`Network error: Failed to ${editingRuleId ? 'update' : 'create'} applicability rule`, 'error');
        }
    }
    
    async function deleteApplicabilityRule(applicabilityId) {
        if (!confirm('Are you sure you want to delete this applicability rule?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/standards/attribute-applicability/${applicabilityId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast('Applicability rule deleted successfully', 'success');
                await loadApplicabilityRules();
            } else {
                showToast(result.error || 'Failed to delete applicability rule', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to delete applicability rule', 'error');
        }
    }
    
    async function loadEntityRegistry() {
        try {
            const response = await fetch('/api/entity-registry/enriched');
            const data = await response.json();
            if (data.success) {
                entities = data.entities || [];
                renderEntityRegistry();
            } else {
                throw new Error(data.error || 'Failed to load enriched entity registry');
            }
        } catch (error) {
            console.error('Error loading entity registry:', error);
            showToast('Failed to load entity registry', 'error');
        }
    }
    
    function renderEntityRegistry() {
        const container = document.getElementById('entityRegistryContainer');
        
        if (entities.length === 0) {
            container.innerHTML = `
                <div class="placeholder-message">
                    <i class="fas fa-table"></i>
                    <h3>No entities registered yet</h3>
                    <p>Click "Add New Entity" to register your first database table.</p>
                </div>
            `;
            return;
        }
        
        const grouped = entities.reduce((acc, entity) => {
            const category = entity.category || 'Uncategorized';
            if (!acc[category]) acc[category] = [];
            acc[category].push(entity);
            return acc;
        }, {});
        
        Object.values(grouped).forEach(group => {
            group.sort((a, b) => (a.sort_order || 999) - (b.sort_order || 999));
        });
        
        const html = Object.entries(grouped).map(([category, items]) => `
            <div class="category-section">
                <div class="category-header">
                    <span class="category-title">${category}</span>
                    <span class="category-count">(${items.length} ${items.length === 1 ? 'entity' : 'entities'})</span>
                </div>
                <div class="grid">
                    ${items.map(entity => renderEntityCard(entity)).join('')}
                </div>
            </div>
        `).join('');
        
        container.innerHTML = html;
    }
    
    function renderEntityCard(entity) {
        const icon = entity.icon || 'fas fa-table';
        const controlledTypes = entity.controlled_object_types || [];
        const specializedTools = entity.specialized_tools || [];
        const exampleLayers = entity.example_layers || [];
        const recordCount = entity.record_count || 0;
        
        return `
            <div class="entity-item" style="background: rgba(0, 255, 255, 0.03); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                <div style="display: flex; align-items: start; justify-content: space-between; margin-bottom: 15px;">
                    <div style="display: flex; align-items: start; flex: 1;">
                        <i class="${icon}" style="font-size: 28px; color: #00ffff; margin-right: 15px; margin-top: 3px;"></i>
                        <div style="flex: 1;">
                            <div style="font-size: 18px; font-weight: 600; color: #00ffff; margin-bottom: 3px;">${entity.display_name}</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.5); font-family: monospace; margin-bottom: 5px;">${entity.table_name}</div>
                            <span style="display: inline-block; padding: 3px 8px; background: rgba(0, 255, 255, 0.1); color: #00ffff; font-size: 11px; border-radius: 3px;">${entity.category || 'General'}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="icon-btn" onclick='openEditEntityModal(${entity.registry_id}, ${JSON.stringify(entity).replace(/'/g, "&apos;")})' title="Edit" style="background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3);">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn delete" onclick='openDeleteEntityModal(${entity.registry_id}, "${entity.display_name}")' title="Delete" style="background: rgba(255, 50, 50, 0.1); border: 1px solid rgba(255, 50, 50, 0.3);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                ${entity.description ? `<div style="color: rgba(255,255,255,0.7); font-size: 13px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(0, 255, 255, 0.1);">${entity.description}</div>` : ''}
                
                ${controlledTypes.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; font-weight: 600; color: #00ffff; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                            <i class="fas fa-code"></i> Controls CAD Object Types
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${controlledTypes.map(type => `
                                <span style="padding: 4px 10px; background: rgba(0, 255, 255, 0.15); color: #00ffff; font-size: 11px; border-radius: 4px; border: 1px solid rgba(0, 255, 255, 0.25); font-weight: 500;" title="${type.description || type.name}">
                                    ${type.code}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${specializedTools.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; font-weight: 600; color: #00ffff; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                            <i class="fas fa-tools"></i> Used by Specialized Tools
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            ${specializedTools.map(tool => `
                                <a href="${tool.tool_route}" style="display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: rgba(0, 255, 255, 0.08); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 4px; text-decoration: none; color: #00ffff; font-size: 12px; transition: all 0.2s;" onmouseover="this.style.background='rgba(0, 255, 255, 0.15)'" onmouseout="this.style.background='rgba(0, 255, 255, 0.08)'">
                                    <i class="${tool.icon || 'fas fa-tool'}" style="font-size: 14px;"></i>
                                    <span style="flex: 1;">${tool.tool_name}</span>
                                    ${tool.is_primary ? '<span style="padding: 2px 6px; background: rgba(0, 255, 255, 0.2); font-size: 10px; border-radius: 3px; font-weight: 600;">PRIMARY</span>' : ''}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${exampleLayers.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; font-weight: 600; color: #00ffff; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                            <i class="fas fa-layer-group"></i> Example Layer Names
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            ${exampleLayers.map(ex => `
                                <div style="font-family: monospace; font-size: 11px; color: rgba(0, 255, 255, 0.9); padding: 4px 8px; background: rgba(0, 0, 0, 0.3); border-radius: 3px; border-left: 2px solid #00ffff;" title="${ex.description || ''}">
                                    ${ex.example_layer_name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.5);">
                        <i class="fas fa-database"></i> Database Table
                    </div>
                    <div style="font-size: 14px; font-weight: 600; color: #00ffff;">
                        ${recordCount.toLocaleString()} ${recordCount === 1 ? 'record' : 'records'}
                    </div>
                </div>
            </div>
        `;
    }
    
    function openAddEntityModal() {
        currentEdit = { id: null, data: null, type: 'entity' };
        document.getElementById('entityModalTitle').textContent = 'Add New Entity';
        document.getElementById('entityForm').reset();
        document.getElementById('tableValidation').innerHTML = '';
        document.getElementById('entityModal').classList.add('active');
    }
    
    function openEditEntityModal(id, data) {
        currentEdit = { id, data, type: 'entity' };
        document.getElementById('entityModalTitle').textContent = 'Edit Entity';
        
        const form = document.getElementById('entityForm');
        form.table_name.value = data.table_name || '';
        form.display_name.value = data.display_name || '';
        form.category.value = data.category || '';
        form.icon.value = data.icon || '';
        form.description.value = data.description || '';
        form.sort_order.value = data.sort_order || '';
        
        document.getElementById('tableValidation').innerHTML = '';
        document.getElementById('entityModal').classList.add('active');
    }
    
    function closeEntityModal() {
        document.getElementById('entityModal').classList.remove('active');
        currentEdit = { id: null, data: null, type: null };
    }
    
    async function validateTableName() {
        const tableNameInput = document.getElementById('tableName');
        const tableName = tableNameInput.value.trim();
        const validationDiv = document.getElementById('tableValidation');
        
        if (!tableName) {
            validationDiv.innerHTML = '';
            return;
        }
        
        const formatValid = /^[a-z][a-z0-9_]*$/.test(tableName);
        if (!formatValid) {
            validationDiv.innerHTML = `
                <div class="validation-feedback invalid">
                    <i class="fas fa-exclamation-circle"></i>
                    Invalid format: use lowercase letters, numbers, and underscores only
                </div>
            `;
            return;
        }
        
        try {
            const response = await fetch('/api/schema');
            const data = await response.json();
            const tableExists = data.tables && data.tables[tableName];
            
            if (tableExists) {
                validationDiv.innerHTML = `
                    <div class="validation-feedback valid">
                        <i class="fas fa-check-circle"></i>
                        Table exists in database (${data.counts[tableName] || 0} rows)
                    </div>
                `;
            } else {
                validationDiv.innerHTML = `
                    <div class="validation-feedback invalid">
                        <i class="fas fa-info-circle"></i>
                        Table does not exist in database
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error validating table:', error);
            validationDiv.innerHTML = `
                <div class="validation-feedback invalid">
                    <i class="fas fa-exclamation-circle"></i>
                    Could not validate table
                </div>
            `;
        }
    }
    
    async function handleEntitySubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        Object.keys(data).forEach(key => {
            if (data[key] === '') {
                data[key] = null;
            }
        });
        
        try {
            if (currentEdit.id) {
                await updateEntity(currentEdit.id, data);
            } else {
                await createEntity(data);
            }
        } catch (error) {
            console.error('Error submitting entity:', error);
        }
    }
    
    async function createEntity(data) {
        try {
            const response = await fetch('/api/entity-registry', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Entity created successfully', 'success');
                closeEntityModal();
                await loadEntityRegistry();
            } else {
                showToast(result.error || 'Failed to create entity', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to create entity', 'error');
        }
    }
    
    async function updateEntity(id, data) {
        try {
            const response = await fetch(`/api/entity-registry/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Entity updated successfully', 'success');
                closeEntityModal();
                await loadEntityRegistry();
            } else {
                showToast(result.error || 'Failed to update entity', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to update entity', 'error');
        }
    }
    
    async function openDeleteEntityModal(id, name) {
        if (!confirm(`Are you sure you want to delete "${name}"?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/entity-registry/${id}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message || 'Entity deleted successfully', 'success');
                await loadEntityRegistry();
            } else {
                showToast(result.error || 'Failed to delete entity', 'error');
            }
        } catch (error) {
            showToast('Network error: Failed to delete entity', 'error');
        }
    }
    
    document.getElementById('entityModal').addEventListener('click', (e) => {
        if (e.target.id === 'entityModal') closeEntityModal();
    });
    
    loadVocabulary();
    loadApplicabilityRules();
</script>
{% endblock %}
