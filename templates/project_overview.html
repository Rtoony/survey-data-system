{% extends "base.html" %}

{% block title %}Project Overview{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='lib/leaflet/leaflet.css') }}">
{% endblock %}

{% block content %}
<style>
.mc-hero-section {
    display: grid;
    grid-template-columns: 1fr 500px;
    gap: 20px;
    margin-bottom: 30px;
    max-width: 1800px;
}

@media (max-width: 1200px) {
    .mc-hero-section {
        grid-template-columns: 60% 40%;
    }
}

.mc-map-container {
    background: linear-gradient(135deg, #1a2332 0%, #0d1117 100%);
    border: 2px solid var(--accent-cyan);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 50px rgba(0,255,255,0.3);
    height: 500px;
    position: relative;
}

#projectMap {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 100 !important;
}

.leaflet-container {
    background: #ddd !important;
    z-index: 100 !important;
}

.leaflet-tile-pane {
    z-index: 200 !important;
}

.leaflet-map-pane {
    z-index: 100 !important;
}

.mc-map-overlay {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(10, 14, 39, 0.9);
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid var(--accent-cyan);
    z-index: 1000;
}

.mc-map-overlay h4 {
    margin: 0 0 5px 0;
    color: var(--accent-cyan);
    font-size: 14px;
}

.mc-map-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    color: var(--text-dim);
}

.mc-map-placeholder i {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}

.mc-info-card {
    background: linear-gradient(135deg, #1a2332 0%, #0d1117 100%);
    border: 2px solid var(--accent-cyan);
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 10px 50px rgba(0,255,255,0.3);
}

.mc-info-card h2 {
    color: var(--accent-cyan);
    margin: 0 0 20px 0;
    font-size: 24px;
}

.mc-form-group {
    margin-bottom: 20px;
}

.mc-form-group label {
    display: block;
    margin-bottom: 8px;
    color: var(--accent-cyan);
    font-weight: 600;
    font-size: 14px;
}

.mc-form-group input,
.mc-form-group textarea {
    width: 100%;
    padding: 12px 15px;
    background: rgba(0,0,0,0.3);
    border: 2px solid rgba(0,255,255,0.3);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    transition: all 0.3s;
}

.mc-form-group input:focus,
.mc-form-group textarea:focus {
    outline: none;
    border-color: var(--accent-cyan);
    box-shadow: 0 0 15px rgba(0,255,255,0.3);
}

.mc-form-group textarea {
    resize: vertical;
    min-height: 80px;
}

.mc-tabs {
    background: linear-gradient(135deg, #1a2332 0%, #0d1117 100%);
    border: 2px solid var(--accent-cyan);
    border-radius: 12px;
    box-shadow: 0 10px 50px rgba(0,255,255,0.3);
    max-width: 1800px;
}

.mc-tab-header {
    display: flex;
    border-bottom: 2px solid rgba(0,255,255,0.2);
    overflow-x: auto;
}

.mc-tab-button {
    padding: 15px 25px;
    background: transparent;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-family: 'Orbitron', sans-serif;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s;
    white-space: nowrap;
    position: relative;
}

.mc-tab-button:hover {
    color: var(--accent-cyan);
    background: rgba(0,255,255,0.1);
}

.mc-tab-button.active {
    color: var(--accent-cyan);
    background: rgba(0,255,255,0.15);
}

.mc-tab-button.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--accent-cyan);
}

.mc-tab-content {
    padding: 30px;
    display: none;
}

.mc-tab-content.active {
    display: block;
}

.mc-stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 280px));
    gap: 20px;
    margin-bottom: 20px;
    max-width: 1400px;
}

.mc-stat-box {
    background: rgba(0,255,255,0.1);
    border: 1px solid rgba(0,255,255,0.3);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
}

.mc-stat-value {
    font-size: 32px;
    font-weight: bold;
    color: var(--accent-cyan);
    font-family: 'Orbitron', sans-serif;
}

.mc-stat-label {
    font-size: 14px;
    color: var(--text-dim);
    margin-top: 5px;
}

.mc-ref-section {
    margin-bottom: 25px;
}

.mc-ref-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.mc-ref-header h3 {
    color: var(--accent-cyan);
    margin: 0;
    font-size: 18px;
}

.mc-ref-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.mc-ref-badge {
    background: rgba(0,255,255,0.15);
    border: 1px solid rgba(0,255,255,0.3);
    border-radius: 20px;
    padding: 8px 15px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.mc-ref-badge.primary {
    border-color: var(--accent-magenta);
    background: rgba(255,0,255,0.15);
}

.mc-ref-badge i {
    font-size: 12px;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.3s;
}

.mc-ref-badge i:hover {
    opacity: 1;
}

.mc-empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-dim);
}

.mc-empty-state i {
    font-size: 48px;
    opacity: 0.5;
    margin-bottom: 15px;
}

@media (max-width: 1024px) {
    .mc-hero-section {
        grid-template-columns: 1fr;
    }
}
</style>

<div id="loading" style="display: none; text-align: center; padding: 3rem;">
    <div class="spinner" style="margin: 0 auto;"></div>
    <p class="loading-text" id="loadingStatus">Initializing...</p>
</div>

<div id="mainContent">
    <div class="mc-hero-section">
        <div class="mc-map-container">
            <div id="mapPlaceholder" class="mc-map-placeholder">
                <i class="fas fa-map-marked-alt"></i>
                <p>Loading project area map...</p>
            </div>
            <div id="projectMap" style="display: none;"></div>
        </div>
        
        <div class="mc-info-card">
            <h2><i class="fas fa-info-circle"></i> Project Information</h2>
            <form id="projectInfoForm">
                <div class="mc-form-group">
                    <label for="projectName">Project Name <span style="color: #ff6b6b;">*</span></label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="mc-form-group">
                    <label for="projectNumber">Project Number</label>
                    <input type="text" id="projectNumber">
                </div>
                <div class="mc-form-group">
                    <label for="clientId">Client Name</label>
                    <select id="clientId">
                        <option value="">Select a client...</option>
                    </select>
                </div>
                <div class="mc-form-group">
                    <label for="description">Description</label>
                    <textarea id="description"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </form>
        </div>
    </div>

    <div class="mc-tabs">
        <div class="mc-tab-header">
            <button class="mc-tab-button active" data-tab="overview">
                <i class="fas fa-chart-line"></i> Overview
            </button>
            <button class="mc-tab-button" data-tab="drawings">
                <i class="fas fa-file-image"></i> Drawings
            </button>
            <button class="mc-tab-button" data-tab="reference-data">
                <i class="fas fa-database"></i> Reference Data
            </button>
            <button class="mc-tab-button" data-tab="compliance">
                <i class="fas fa-check-circle"></i> Compliance
            </button>
            <button class="mc-tab-button" data-tab="standards">
                <i class="fas fa-ruler-combined"></i> Standards
            </button>
        </div>

        <div class="mc-tab-content active" id="tab-overview">
            <h2 style="color: var(--accent-cyan); margin: 0 0 20px 0;">
                <i class="fas fa-chart-bar"></i> Project Metrics
            </h2>
            <div class="mc-stat-grid" id="statsGrid">
                <div class="mc-stat-box">
                    <div class="mc-stat-value" id="drawingCount">-</div>
                    <div class="mc-stat-label">Drawings</div>
                </div>
                <div class="mc-stat-box">
                    <div class="mc-stat-value" id="entityCount">-</div>
                    <div class="mc-stat-label">CAD Entities</div>
                </div>
                <div class="mc-stat-box" style="cursor: pointer;" onclick="window.location.href='/projects/{{ project_id }}/survey-points';" title="Click to view Survey Point Manager">
                    <div class="mc-stat-value" id="surveyPointCount">-</div>
                    <div class="mc-stat-label">Survey Points <i class="fas fa-external-link-alt" style="font-size: 12px; opacity: 0.7;"></i></div>
                </div>
                <div class="mc-stat-box">
                    <div class="mc-stat-value" id="refDataCount">-</div>
                    <div class="mc-stat-label">Reference Data</div>
                </div>
                <div class="mc-stat-box">
                    <div class="mc-stat-value" id="spatialStatus">-</div>
                    <div class="mc-stat-label">Spatial Data</div>
                </div>
            </div>
            
            <h3 style="color: var(--accent-cyan); margin: 30px 0 15px 0;">
                <i class="fas fa-database"></i> Attached Reference Data Breakdown
            </h3>
            <div class="mc-stat-grid" id="refDataBreakdown" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <div class="mc-stat-box">
                    <div class="mc-stat-value" style="font-size: 24px;" id="clientsCount">-</div>
                    <div class="mc-stat-label">Clients</div>
                </div>
                <div class="mc-stat-box">
                    <div class="mc-stat-value" style="font-size: 24px;" id="vendorsCount">-</div>
                    <div class="mc-stat-label">Vendors</div>
                </div>
                <div class="mc-stat-box">
                    <div class="mc-stat-value" style="font-size: 24px;" id="municipalitiesCount">-</div>
                    <div class="mc-stat-label">Municipalities</div>
                </div>
                <div class="mc-stat-box">
                    <div class="mc-stat-value" style="font-size: 24px;" id="coordinateSystemsCount">-</div>
                    <div class="mc-stat-label">Coord Systems</div>
                </div>
                <div class="mc-stat-box">
                    <div class="mc-stat-value" style="font-size: 24px;" id="surveyPointDescriptionsCount">-</div>
                    <div class="mc-stat-label">Survey Points</div>
                </div>
                <div class="mc-stat-box">
                    <div class="mc-stat-value" style="font-size: 24px;" id="gisLayersCount">-</div>
                    <div class="mc-stat-label">GIS Layers</div>
                </div>
            </div>
        </div>

        <div class="mc-tab-content" id="tab-drawings">
            <h2 style="color: var(--accent-cyan); margin: 0 0 20px 0;">
                <i class="fas fa-file-image"></i> Associated Drawings
            </h2>
            <div id="drawingsList"></div>
        </div>

        <div class="mc-tab-content" id="tab-reference-data">
            <h2 style="color: var(--accent-cyan); margin: 0 0 30px 0;">
                <i class="fas fa-database"></i> Reference Data Mappings
            </h2>
            
            <div class="mc-ref-section">
                <div class="mc-ref-header">
                    <h3><i class="fas fa-building"></i> Clients</h3>
                    <button class="btn btn-primary btn-sm" onclick="openAttachModal('clients')">
                        <i class="fas fa-plus"></i> Attach Client
                    </button>
                </div>
                <div class="mc-ref-list" id="clientsList">
                    <div class="mc-empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No clients attached to this project</p>
                    </div>
                </div>
            </div>

            <div class="mc-ref-section">
                <div class="mc-ref-header">
                    <h3><i class="fas fa-truck"></i> Vendors</h3>
                    <button class="btn btn-primary btn-sm" onclick="openAttachModal('vendors')">
                        <i class="fas fa-plus"></i> Attach Vendor
                    </button>
                </div>
                <div class="mc-ref-list" id="vendorsList">
                    <div class="mc-empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No vendors attached to this project</p>
                    </div>
                </div>
            </div>

            <div class="mc-ref-section">
                <div class="mc-ref-header">
                    <h3><i class="fas fa-landmark"></i> Municipalities</h3>
                    <button class="btn btn-primary btn-sm" onclick="openAttachModal('municipalities')">
                        <i class="fas fa-plus"></i> Attach Municipality
                    </button>
                </div>
                <div class="mc-ref-list" id="municipalitiesList">
                    <div class="mc-empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No municipalities attached to this project</p>
                    </div>
                </div>
            </div>

            <div class="mc-ref-section">
                <div class="mc-ref-header">
                    <h3><i class="fas fa-globe"></i> Coordinate Systems</h3>
                    <button class="btn btn-primary btn-sm" onclick="openAttachModal('coordinate-systems')">
                        <i class="fas fa-plus"></i> Attach Coordinate System
                    </button>
                </div>
                <div class="mc-ref-list" id="coordinateSystemsList">
                    <div class="mc-empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No coordinate systems attached to this project</p>
                    </div>
                </div>
            </div>

            <div class="mc-ref-section">
                <div class="mc-ref-header">
                    <h3><i class="fas fa-map-pin"></i> Survey Point Descriptions</h3>
                    <button class="btn btn-primary btn-sm" onclick="openAttachModal('survey-points')">
                        <i class="fas fa-plus"></i> Attach Survey Point
                    </button>
                </div>
                <div class="mc-ref-list" id="surveyPointsList">
                    <div class="mc-empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No survey point descriptions attached to this project</p>
                    </div>
                </div>
            </div>

            <div class="mc-ref-section">
                <div class="mc-ref-header">
                    <h3><i class="fas fa-layer-group"></i> GIS Data Layers</h3>
                    <button class="btn btn-primary btn-sm" onclick="openAttachModal('gis-layers')">
                        <i class="fas fa-plus"></i> Attach GIS Layer
                    </button>
                </div>
                <div class="mc-ref-list" id="gisLayersList">
                    <div class="mc-empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No GIS layers attached to this project</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mc-tab-content" id="tab-compliance">
            <h2 style="color: var(--accent-cyan); margin: 0 0 20px 0;">
                <i class="fas fa-check-circle"></i> Compliance Status
            </h2>
            <div class="mc-empty-state">
                <i class="fas fa-chart-pie"></i>
                <p>Compliance tracking coming soon</p>
                <a href="/project-compliance" class="btn btn-primary" style="margin-top: 20px;">
                    <i class="fas fa-external-link-alt"></i> View Full Compliance Dashboard
                </a>
            </div>
        </div>

        <div class="mc-tab-content" id="tab-standards">
            <h2 style="color: var(--accent-cyan); margin: 0 0 20px 0;">
                <i class="fas fa-ruler-combined"></i> Assigned Standards
            </h2>
            <div class="mc-empty-state">
                <i class="fas fa-link"></i>
                <p>Standards assignment coming soon</p>
                <a href="/project-standards-assignment" class="btn btn-primary" style="margin-top: 20px;">
                    <i class="fas fa-external-link-alt"></i> Manage Standards Assignment
                </a>
            </div>
        </div>
    </div>
</div>

<div id="attachModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 id="modalTitle"><i class="fas fa-plus-circle"></i> Attach Entity</h3>
            <button class="modal-close" onclick="closeAttachModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Search Available Entities</label>
                <input type="text" id="entitySearch" class="form-control" placeholder="Type to search..." oninput="filterAvailableEntities()">
            </div>
            
            <div class="form-group">
                <label>Available Entities</label>
                <div id="availableEntitiesList" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;">
                    <div class="loading-spinner">
                        <i class="fas fa-circle-notch fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="isPrimary"> Set as Primary
                </label>
            </div>
            
            <div class="form-group">
                <label>Relationship Notes</label>
                <textarea id="relationshipNotes" class="form-control" rows="3" placeholder="Optional notes about this relationship..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAttachModal()">Cancel</button>
            <button class="btn btn-primary" id="attachButton" onclick="attachSelectedEntity()" disabled>
                <i class="fas fa-link"></i> Attach
            </button>
        </div>
    </div>
</div>

<script>
const projectId = '{{ project_id }}';
let map = null;
let projectData = null;
let currentEntityType = null;
let availableEntities = [];
let selectedEntityId = null;

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

async function loadClients() {
    try {
        const response = await fetch('/api/clients');
        const data = await response.json();
        
        if (data.error) {
            console.error('Error loading clients:', data.error);
            return;
        }
        
        const clientSelect = document.getElementById('clientId');
        clientSelect.innerHTML = '<option value="">Select a client...</option>';
        
        const clients = data.clients || data;
        clients.forEach(client => {
            const option = document.createElement('option');
            option.value = client.client_id;
            option.textContent = client.client_name;
            clientSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading clients:', error);
    }
}

async function loadProjectData() {
    try {
        await loadClients();
        
        const response = await fetch(`/api/projects/${projectId}`);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        projectData = data;
        
        document.getElementById('projectName').value = data.project_name || '';
        document.getElementById('projectNumber').value = data.project_number || '';
        document.getElementById('clientId').value = data.client_id || '';
        document.getElementById('description').value = data.description || '';
        
    } catch (error) {
        console.error('Error loading project:', error);
        alert(`Failed to load project: ${error.message}`);
    }
}

async function loadStatistics() {
    try {
        const response = await fetch(`/api/projects/${projectId}/statistics`);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        document.getElementById('drawingCount').textContent = data.drawing_count || 0;
        document.getElementById('entityCount').textContent = data.entity_count?.toLocaleString() || 0;
        document.getElementById('surveyPointCount').textContent = data.survey_point_count?.toLocaleString() || 0;
        document.getElementById('refDataCount').textContent = data.total_reference_data || 0;
        document.getElementById('spatialStatus').innerHTML = data.has_spatial_data 
            ? '<i class="fas fa-check-circle" style="color: var(--accent-green);"></i>' 
            : '<i class="fas fa-times-circle" style="color: var(--text-dim);"></i>';
        
        if (data.reference_data_counts) {
            document.getElementById('clientsCount').textContent = data.reference_data_counts.clients || 0;
            document.getElementById('vendorsCount').textContent = data.reference_data_counts.vendors || 0;
            document.getElementById('municipalitiesCount').textContent = data.reference_data_counts.municipalities || 0;
            document.getElementById('coordinateSystemsCount').textContent = data.reference_data_counts.coordinate_systems || 0;
            document.getElementById('surveyPointDescriptionsCount').textContent = data.reference_data_counts.survey_point_descriptions || 0;
            document.getElementById('gisLayersCount').textContent = data.reference_data_counts.gis_layers || 0;
        }
        
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

async function loadMapSummary() {
    try {
        console.log('Fetching map summary...');
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const response = await fetch(`/api/projects/${projectId}/map-summary`, {
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers.get('content-type'));
        
        const text = await response.text();
        console.log('Response length:', text.length);
        
        const data = JSON.parse(text);
        console.log('Map summary data parsed successfully');
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        if (!data.has_spatial_data) {
            console.log('No spatial data available');
            document.getElementById('mapPlaceholder').innerHTML = `
                <i class="fas fa-map-marked-alt"></i>
                <p>${data.message}</p>
                <p style="font-size: 12px; margin-top: 10px;">Add drawings with spatial entities to see the project area</p>
            `;
            return;
        }
        
        await initializeMap(data);
        
        console.log('✓ Map loaded');
    } catch (error) {
        console.error('Error loading map:', error);
        document.getElementById('mapPlaceholder').innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <p>Error loading map: ${error.message}</p>
        `;
    }
}

async function initializeMap(mapData) {
    if (typeof L === 'undefined') {
        console.error('Leaflet library not available - waiting for it to load...');
        setTimeout(() => initializeMap(mapData), 100);
        return;
    }
    
    try {
        document.getElementById('mapPlaceholder').style.display = 'none';
        document.getElementById('projectMap').style.display = 'block';
        
        map = L.map('projectMap', {
            zoomControl: false,
            dragging: false,
            touchZoom: false,
            doubleClickZoom: false,
            scrollWheelZoom: false,
            boxZoom: false,
            keyboard: false
        });
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap',
            maxZoom: 19
        }).addTo(map);
        
        const bounds = [
            [mapData.bbox.min_y, mapData.bbox.min_x],
            [mapData.bbox.max_y, mapData.bbox.max_x]
        ];
        
        map.fitBounds(bounds, { padding: [50, 50] });
        
        L.geoJSON(mapData.features, {
            style: {
                color: '#00ffff',
                weight: 3,
                opacity: 0.9,
                fillColor: '#00ffff',
                fillOpacity: 0.15
            }
        }).addTo(map);
        
        console.log('✓ Map rendered with project area boundary');
    } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('mapPlaceholder').innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <p>Error rendering map: ${error.message}</p>
        `;
        document.getElementById('mapPlaceholder').style.display = 'flex';
        document.getElementById('projectMap').style.display = 'none';
    }
}

async function loadDrawings() {
    try {
        const response = await fetch(`/api/projects/${projectId}/drawings`);
        const data = await response.json();
        
        const drawingsDiv = document.getElementById('drawingsList');
        const drawingCount = document.getElementById('drawingCount');
        
        drawingCount.textContent = data.drawings.length;
        
        if (data.drawings.length === 0) {
            drawingsDiv.innerHTML = `
                <div class="mc-empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No drawings associated with this project</p>
                </div>
            `;
            return;
        }
        
        drawingsDiv.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>Drawing Name</th>
                        <th>Drawing Number</th>
                        <th>Type</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.drawings.map(d => `
                        <tr>
                            <td><strong>${d.drawing_name || '-'}</strong></td>
                            <td>${d.drawing_number || '-'}</td>
                            <td>${d.drawing_type || '-'}</td>
                            <td>${formatDate(d.created_at)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } catch (error) {
        console.error('Error loading drawings:', error);
    }
}

document.getElementById('projectInfoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const clientIdValue = document.getElementById('clientId').value;
    
    const data = {
        project_name: document.getElementById('projectName').value,
        project_number: document.getElementById('projectNumber').value || null,
        client_id: clientIdValue ? parseInt(clientIdValue) : null,
        description: document.getElementById('description').value || null
    };
    
    try {
        const response = await fetch(`/api/projects/${projectId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showToast('Project updated successfully', 'success');
            await loadProjectData();
        } else {
            const error = await response.json();
            showToast(`Error: ${error.error}`, 'error');
        }
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
});

document.querySelectorAll('.mc-tab-button').forEach(button => {
    button.addEventListener('click', () => {
        document.querySelectorAll('.mc-tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mc-tab-content').forEach(c => c.classList.remove('active'));
        
        button.classList.add('active');
        document.getElementById(`tab-${button.dataset.tab}`).classList.add('active');
    });
});

const ENTITY_TYPE_CONFIG = {
    'clients': {
        apiType: 'clients',
        displayName: 'Client',
        getDisplayText: (entity) => `${entity.client_name}${entity.contact_name ? ` - ${entity.contact_name}` : ''}`,
        getSubtext: (entity) => `${entity.city || ''}, ${entity.state || ''}`,
        renderCard: (entity) => `
            <div class="mc-ref-item">
                <div class="mc-ref-item-header">
                    <strong>${entity.client_name}</strong>
                    ${entity.is_primary ? '<span class="badge badge-primary">PRIMARY</span>' : ''}
                </div>
                <div class="mc-ref-item-details">
                    <div>${entity.contact_name || '-'}</div>
                    <div>${entity.contact_email || '-'}</div>
                    <div>${entity.city || '-'}, ${entity.state || '-'}</div>
                </div>
                ${entity.relationship_notes ? `<div class="mc-ref-item-notes">${entity.relationship_notes}</div>` : ''}
                <div class="mc-ref-item-actions">
                    <button class="btn btn-sm btn-danger" onclick="detachEntity('clients', ${entity.mapping_id})">
                        <i class="fas fa-unlink"></i> Detach
                    </button>
                </div>
            </div>
        `
    },
    'vendors': {
        apiType: 'vendors',
        displayName: 'Vendor',
        getDisplayText: (entity) => `${entity.vendor_name}${entity.specialty ? ` - ${entity.specialty}` : ''}`,
        getSubtext: (entity) => `${entity.city || ''}, ${entity.state || ''}`,
        renderCard: (entity) => `
            <div class="mc-ref-item">
                <div class="mc-ref-item-header">
                    <strong>${entity.vendor_name}</strong>
                    ${entity.is_primary ? '<span class="badge badge-primary">PRIMARY</span>' : ''}
                </div>
                <div class="mc-ref-item-details">
                    <div>Specialty: ${entity.specialty || '-'}</div>
                    <div>${entity.contact_name || '-'}</div>
                    <div>${entity.city || '-'}, ${entity.state || '-'}</div>
                </div>
                ${entity.relationship_notes ? `<div class="mc-ref-item-notes">${entity.relationship_notes}</div>` : ''}
                <div class="mc-ref-item-actions">
                    <button class="btn btn-sm btn-danger" onclick="detachEntity('vendors', ${entity.mapping_id})">
                        <i class="fas fa-unlink"></i> Detach
                    </button>
                </div>
            </div>
        `
    },
    'municipalities': {
        apiType: 'municipalities',
        displayName: 'Municipality',
        getDisplayText: (entity) => `${entity.municipality_name} - ${entity.municipality_type || 'Municipality'}`,
        getSubtext: (entity) => `${entity.county || ''}, ${entity.state || ''}`,
        renderCard: (entity) => `
            <div class="mc-ref-item">
                <div class="mc-ref-item-header">
                    <strong>${entity.municipality_name}</strong>
                    ${entity.is_primary ? '<span class="badge badge-primary">PRIMARY</span>' : ''}
                </div>
                <div class="mc-ref-item-details">
                    <div>Type: ${entity.municipality_type || '-'}</div>
                    <div>${entity.county || '-'}, ${entity.state || '-'}</div>
                </div>
                ${entity.relationship_notes ? `<div class="mc-ref-item-notes">${entity.relationship_notes}</div>` : ''}
                <div class="mc-ref-item-actions">
                    <button class="btn btn-sm btn-danger" onclick="detachEntity('municipalities', ${entity.mapping_id})">
                        <i class="fas fa-unlink"></i> Detach
                    </button>
                </div>
            </div>
        `
    },
    'coordinate-systems': {
        apiType: 'coordinate_systems',
        displayName: 'Coordinate System',
        getDisplayText: (entity) => `${entity.system_name} (EPSG:${entity.epsg_code || 'Unknown'})`,
        getSubtext: (entity) => `${entity.datum || ''} - ${entity.units || ''}`,
        renderCard: (entity) => `
            <div class="mc-ref-item">
                <div class="mc-ref-item-header">
                    <strong>${entity.system_name}</strong>
                    ${entity.is_primary ? '<span class="badge badge-primary">PRIMARY</span>' : ''}
                </div>
                <div class="mc-ref-item-details">
                    <div>EPSG: ${entity.epsg_code || '-'}</div>
                    <div>Datum: ${entity.datum || '-'}</div>
                    <div>Units: ${entity.units || '-'}</div>
                </div>
                ${entity.relationship_notes ? `<div class="mc-ref-item-notes">${entity.relationship_notes}</div>` : ''}
                <div class="mc-ref-item-actions">
                    <button class="btn btn-sm btn-danger" onclick="detachEntity('coordinate_systems', ${entity.mapping_id})">
                        <i class="fas fa-unlink"></i> Detach
                    </button>
                </div>
            </div>
        `
    },
    'survey-points': {
        apiType: 'survey_point_descriptions',
        displayName: 'Survey Point Description',
        getDisplayText: (entity) => `${entity.code} - ${entity.description}`,
        getSubtext: (entity) => `${entity.category || ''} (${entity.discipline || ''})`,
        renderCard: (entity) => `
            <div class="mc-ref-item">
                <div class="mc-ref-item-header">
                    <strong>${entity.code}</strong>
                    ${entity.is_primary ? '<span class="badge badge-primary">PRIMARY</span>' : ''}
                </div>
                <div class="mc-ref-item-details">
                    <div>${entity.description}</div>
                    <div>Category: ${entity.category || '-'}</div>
                    <div>Discipline: ${entity.discipline || '-'}</div>
                </div>
                ${entity.relationship_notes ? `<div class="mc-ref-item-notes">${entity.relationship_notes}</div>` : ''}
                <div class="mc-ref-item-actions">
                    <button class="btn btn-sm btn-danger" onclick="detachEntity('survey_point_descriptions', ${entity.mapping_id})">
                        <i class="fas fa-unlink"></i> Detach
                    </button>
                </div>
            </div>
        `
    },
    'gis-layers': {
        apiType: 'gis_layers',
        displayName: 'GIS Data Layer',
        getDisplayText: (entity) => entity.name,
        getSubtext: (entity) => `${entity.jurisdiction || ''} - ${entity.category || ''}`,
        renderCard: (entity) => `
            <div class="mc-ref-item">
                <div class="mc-ref-item-header">
                    <strong>${entity.name}</strong>
                    ${entity.is_primary ? '<span class="badge badge-primary">PRIMARY</span>' : ''}
                </div>
                <div class="mc-ref-item-details">
                    <div>Jurisdiction: ${entity.jurisdiction || '-'}</div>
                    <div>Category: ${entity.category || '-'}</div>
                    <div>Status: ${entity.status || '-'}</div>
                </div>
                ${entity.relationship_notes ? `<div class="mc-ref-item-notes">${entity.relationship_notes}</div>` : ''}
                <div class="mc-ref-item-actions">
                    <button class="btn btn-sm btn-danger" onclick="detachEntity('gis_layers', ${entity.mapping_id})">
                        <i class="fas fa-unlink"></i> Detach
                    </button>
                </div>
            </div>
        `
    }
};

async function loadReferenceData() {
    const listIdMap = {
        'clients': 'clientsList',
        'vendors': 'vendorsList',
        'municipalities': 'municipalitiesList',
        'coordinate-systems': 'coordinateSystemsList',
        'survey-points': 'surveyPointsList',
        'gis-layers': 'gisLayersList'
    };
    
    const loadPromises = Object.entries(ENTITY_TYPE_CONFIG).map(async ([key, config]) => {
        try {
            console.log(`Loading ${key}...`);
            const response = await fetch(`/api/projects/${projectId}/${config.apiType}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            const listElement = document.getElementById(listIdMap[key]);
            if (!listElement) {
                console.error(`List element not found for key: ${key}, looking for ID: ${listIdMap[key]}`);
                return;
            }
            
            if (data.entities && data.entities.length > 0) {
                listElement.innerHTML = data.entities.map(entity => config.renderCard(entity)).join('');
            } else {
                listElement.innerHTML = `
                    <div class="mc-empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No ${config.displayName.toLowerCase()}s attached to this project</p>
                    </div>
                `;
            }
            console.log(`Loaded ${key} successfully`);
        } catch (error) {
            console.error(`Error loading ${config.displayName}:`, error);
        }
    });
    
    await Promise.all(loadPromises);
    console.log('All reference data loaded');
}

async function openAttachModal(type) {
    const config = ENTITY_TYPE_CONFIG[type];
    if (!config) {
        showToast('Invalid entity type', 'error');
        return;
    }
    
    currentEntityType = type;
    selectedEntityId = null;
    document.getElementById('modalTitle').innerHTML = `<i class="fas fa-plus-circle"></i> Attach ${config.displayName}`;
    document.getElementById('entitySearch').value = '';
    document.getElementById('isPrimary').checked = false;
    document.getElementById('relationshipNotes').value = '';
    document.getElementById('attachButton').disabled = true;
    
    document.getElementById('attachModal').style.display = 'flex';
    
    try {
        const response = await fetch(`/api/projects/${projectId}/${config.apiType}/available`);
        const data = await response.json();
        availableEntities = data.entities || [];
        
        renderAvailableEntities();
    } catch (error) {
        document.getElementById('availableEntitiesList').innerHTML = `
            <div class="mc-empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Error loading available entities</p>
            </div>
        `;
        showToast(`Error: ${error.message}`, 'error');
    }
}

function renderAvailableEntities() {
    const config = ENTITY_TYPE_CONFIG[currentEntityType];
    const searchTerm = document.getElementById('entitySearch').value.toLowerCase();
    
    const filtered = availableEntities.filter(entity => {
        const displayText = config.getDisplayText(entity).toLowerCase();
        const subtext = config.getSubtext(entity).toLowerCase();
        return displayText.includes(searchTerm) || subtext.includes(searchTerm);
    });
    
    const listElement = document.getElementById('availableEntitiesList');
    
    if (filtered.length === 0) {
        listElement.innerHTML = `
            <div class="mc-empty-state">
                <i class="fas fa-inbox"></i>
                <p>${searchTerm ? 'No matching entities found' : 'No entities available to attach'}</p>
            </div>
        `;
        return;
    }
    
    listElement.innerHTML = filtered.map(entity => {
        const idField = Object.keys(entity).find(key => key.endsWith('_id'));
        const entityId = entity[idField];
        
        return `
            <div class="available-entity-item ${selectedEntityId === entityId ? 'selected' : ''}" 
                 onclick="selectEntity(${entityId})">
                <div style="font-weight: 500;">${config.getDisplayText(entity)}</div>
                <div style="font-size: 12px; color: var(--text-dim); margin-top: 4px;">${config.getSubtext(entity)}</div>
            </div>
        `;
    }).join('');
}

function selectEntity(entityId) {
    selectedEntityId = entityId;
    renderAvailableEntities();
    document.getElementById('attachButton').disabled = false;
}

function filterAvailableEntities() {
    renderAvailableEntities();
}

async function attachSelectedEntity() {
    if (!selectedEntityId || !currentEntityType) return;
    
    const config = ENTITY_TYPE_CONFIG[currentEntityType];
    const isPrimary = document.getElementById('isPrimary').checked;
    const notes = document.getElementById('relationshipNotes').value;
    
    try {
        const response = await fetch(`/api/projects/${projectId}/${config.apiType}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                entity_id: selectedEntityId,
                is_primary: isPrimary,
                relationship_notes: notes || null
            })
        });
        
        if (response.ok) {
            showToast(`${config.displayName} attached successfully`, 'success');
            closeAttachModal();
            await loadReferenceData();
        } else {
            const error = await response.json();
            showToast(`Error: ${error.error}`, 'error');
        }
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

async function detachEntity(type, mappingId) {
    if (!confirm('Are you sure you want to detach this entity?')) return;
    
    try {
        const response = await fetch(`/api/projects/${projectId}/${type}/${mappingId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Entity detached successfully', 'success');
            await loadReferenceData();
        } else {
            const error = await response.json();
            showToast(`Error: ${error.error}`, 'error');
        }
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

function closeAttachModal() {
    document.getElementById('attachModal').style.display = 'none';
    currentEntityType = null;
    selectedEntityId = null;
    availableEntities = [];
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.position = 'fixed';
    toast.style.bottom = '20px';
    toast.style.right = '20px';
    toast.style.padding = '15px 20px';
    toast.style.background = type === 'success' ? 'rgba(0,255,136,0.2)' : type === 'error' ? 'rgba(255,107,107,0.2)' : 'rgba(0,255,255,0.2)';
    toast.style.border = type === 'success' ? '1px solid #00ff88' : type === 'error' ? '1px solid #ff6b6b' : '1px solid #00ffff';
    toast.style.borderRadius = '8px';
    toast.style.zIndex = '10000';
    toast.style.color = '#fff';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function updateStatus(message) {
    const statusEl = document.getElementById('loadingStatus');
    if (statusEl) statusEl.textContent = message;
    console.log(message);
}

function init() {
    console.log('Init function called - showing UI immediately');
    
    const loading = document.getElementById('loading');
    const mainContent = document.getElementById('mainContent');
    
    if (loading) loading.style.display = 'none';
    if (mainContent) {
        mainContent.style.display = 'block';
        mainContent.style.opacity = '1';
        mainContent.style.visibility = 'visible';
    }
    
    console.log('UI visible - loading data in background');
    
    loadProjectData()
        .then(() => console.log('✓ Project data loaded'))
        .catch(err => console.error('✗ Project data error:', err));
    
    loadDrawings()
        .then(() => console.log('✓ Drawings loaded'))
        .catch(err => console.error('✗ Drawings error:', err));
    
    loadReferenceData()
        .then(() => console.log('✓ Reference data loaded'))
        .catch(err => console.error('✗ Reference data error:', err));
    
    loadStatistics()
        .then(() => console.log('✓ Statistics loaded'))
        .catch(err => console.error('✗ Statistics error:', err));
    
    loadMapSummary()
        .then(() => console.log('✓ Map loaded'))
        .catch(err => {
            console.error('✗ Map error:', err);
            const placeholder = document.getElementById('mapPlaceholder');
            if (placeholder) {
                placeholder.innerHTML = `
                    <i class="fas fa-map-marked-alt"></i>
                    <p>Map data unavailable</p>
                `;
            }
        });
}

function handleInitError(error) {
    console.error('Critical initialization error:', error);
    const loading = document.getElementById('loading');
    if (loading) {
        loading.innerHTML = `
            <div style="color: #ff6b6b;">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Error loading project overview</p>
                <p style="font-size: 12px; margin-top: 10px;">${error.message}</p>
            </div>
        `;
    }
}
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='lib/leaflet/leaflet.js') }}"></script>
<script>
    console.log('Leaflet loaded in scripts block - L is:', typeof L !== 'undefined' ? 'DEFINED (version ' + L.version + ')' : 'UNDEFINED');
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
</script>
{% endblock %}
