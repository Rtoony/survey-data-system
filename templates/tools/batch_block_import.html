{% extends 'base.html' %}

{% block title %}Batch CAD Import{% endblock %}

{% block content %}
<div class="mc-page">
    <div class="mc-header">
        <h1>üîß Batch CAD Import Tool</h1>
        <p>Extract and import CAD elements from multiple DXF files to standards library</p>
    </div>

    <!-- Import Type Selector -->
    <div class="mc-card">
        <h2>Select Import Type</h2>
        <div class="import-type-selector">
            <label for="importType" class="mc-label">CAD Element Type:</label>
            <select id="importType" class="mc-select type-selector">
                <option value="blocks">üì¶ Blocks (Symbols)</option>
                <option value="details">üìê Details (Construction Details)</option>
                <option value="hatches">üé® Hatches (Fill Patterns)</option>
                <option value="linetypes">‚ûñ Linetypes (Line Patterns)</option>
            </select>
            <p class="import-type-description" id="typeDescription">
                Import block definitions (symbols, title blocks, annotations) from DXF files
            </p>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="mc-card" id="uploadSection">
        <h2>Step 1: Upload DXF Files</h2>
        <div class="upload-zone" id="dropZone">
            <div class="upload-icon">üìÅ</div>
            <p class="upload-text">Drag & drop DXF files here</p>
            <p class="upload-subtext">or</p>
            <button class="mc-btn-primary" onclick="document.getElementById('fileInput').click()">
                Browse Files
            </button>
            <input type="file" id="fileInput" multiple accept=".dxf" style="display:none;">
            <p class="upload-hint">Supports multiple DXF files</p>
        </div>
        
        <div id="fileList" class="file-list" style="display:none;">
            <h3>Selected Files</h3>
            <ul id="fileItems"></ul>
            <button class="mc-btn-primary" id="extractBtn">
                <span id="extractBtnText">Extract Blocks</span>
            </button>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="mc-card" id="progressSection" style="display:none;">
        <h2 id="progressTitle">Extracting Blocks...</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <p id="progressText">Processing files...</p>
    </div>

    <!-- Preview Section -->
    <div class="mc-card" id="previewSection" style="display:none;">
        <div class="preview-header">
            <h2 id="previewTitle">Step 2: Review Extracted Blocks</h2>
            <div class="preview-stats">
                <span id="totalElements" class="stat-badge">0 blocks found</span>
                <span id="newElements" class="stat-badge stat-new">0 new</span>
                <span id="existingElements" class="stat-badge stat-existing">0 existing</span>
            </div>
        </div>

        <!-- Filters -->
        <div class="preview-filters">
            <input type="text" id="searchFilter" placeholder="Search..." class="mc-input">
            <select id="categoryFilter" class="mc-select">
                <option value="">All Categories</option>
            </select>
            <select id="actionFilter" class="mc-select">
                <option value="">All Actions</option>
                <option value="import">Import New</option>
                <option value="update">Update Existing</option>
                <option value="skip">Skip</option>
            </select>
        </div>

        <!-- Block Grid -->
        <div id="blockGrid" class="block-grid"></div>

        <!-- Import Actions -->
        <div class="import-actions">
            <button class="mc-btn-secondary" id="selectAllBtn">Select All</button>
            <button class="mc-btn-secondary" id="deselectAllBtn">Deselect All</button>
            <button class="mc-btn-primary" id="importBtn">
                <span id="importBtnText">Import Selected Blocks</span>
            </button>
        </div>
    </div>

    <!-- Results Section -->
    <div class="mc-card" id="resultsSection" style="display:none;">
        <h2>‚úÖ Import Complete</h2>
        <div class="results-summary">
            <div class="result-item">
                <span class="result-label">Imported:</span>
                <span class="result-value" id="importedCount">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Updated:</span>
                <span class="result-value" id="updatedCount">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Skipped:</span>
                <span class="result-value" id="skippedCount">0</span>
            </div>
        </div>
        <button class="mc-btn-primary" onclick="location.reload()">
            <span id="importMoreBtnText">Import More Blocks</span>
        </button>
        <a href="/data-manager/blocks" class="mc-btn-secondary" id="viewLibraryLink">
            View Block Library
        </a>
    </div>
</div>

<style>
/* Import Type Selector */
.import-type-selector {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.type-selector {
    font-size: 1.1rem;
    padding: 0.75rem;
    max-width: 400px;
}

.import-type-description {
    color: var(--mc-text-muted);
    font-style: italic;
    padding: 0.5rem;
    background: rgba(0, 255, 255, 0.05);
    border-left: 3px solid var(--mc-cyan);
    border-radius: 4px;
}

/* Upload Zone */
.upload-zone {
    border: 3px dashed var(--mc-cyan);
    border-radius: 8px;
    padding: 3rem;
    text-align: center;
    transition: all 0.3s ease;
    background: rgba(0, 255, 255, 0.05);
}

.upload-zone.drag-over {
    background: rgba(0, 255, 255, 0.15);
    border-color: var(--mc-magenta);
    transform: scale(1.02);
}

.upload-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.upload-text {
    font-size: 1.25rem;
    color: var(--mc-cyan);
    margin-bottom: 0.5rem;
}

.upload-subtext {
    color: var(--mc-text-muted);
    margin: 1rem 0;
}

.upload-hint {
    color: var(--mc-text-muted);
    font-size: 0.875rem;
    margin-top: 1rem;
}

/* File List */
.file-list {
    margin-top: 2rem;
}

.file-list h3 {
    color: var(--mc-cyan);
    margin-bottom: 1rem;
}

.file-list ul {
    list-style: none;
    padding: 0;
    margin-bottom: 1.5rem;
}

.file-list li {
    padding: 0.75rem;
    background: rgba(0, 255, 255, 0.05);
    border: 1px solid var(--mc-border);
    border-radius: 4px;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.file-list li::before {
    content: 'üìÑ';
}

/* Progress Bar */
.progress-bar {
    width: 100%;
    height: 30px;
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--mc-cyan);
    border-radius: 15px;
    overflow: hidden;
    margin: 1.5rem 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--mc-cyan), var(--mc-accent));
    transition: width 0.3s ease;
    width: 0%;
}

#progressText {
    text-align: center;
    color: var(--mc-text-muted);
}

/* Preview Section */
.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.preview-stats {
    display: flex;
    gap: 1rem;
}

.stat-badge {
    padding: 0.5rem 1rem;
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--mc-cyan);
    border-radius: 4px;
    font-weight: 600;
}

.stat-new {
    background: rgba(0, 255, 136, 0.1);
    border-color: var(--mc-accent);
    color: var(--mc-accent);
}

.stat-existing {
    background: rgba(255, 170, 0, 0.1);
    border-color: #ffaa00;
    color: #ffaa00;
}

/* Filters */
.preview-filters {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 1rem;
    margin-bottom: 2rem;
}

/* Block Grid */
.block-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.block-card {
    background: rgba(0, 255, 255, 0.03);
    border: 2px solid var(--mc-border);
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.2s ease;
    cursor: pointer;
}

.block-card:hover {
    border-color: var(--mc-cyan);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 255, 255, 0.2);
}

.block-card.selected {
    border-color: var(--mc-accent);
    background: rgba(0, 255, 136, 0.05);
}

.block-card.existing {
    border-color: #ffaa00;
}

.block-preview {
    width: 100%;
    height: 150px;
    background: #0a0a0a;
    border: 1px solid var(--mc-border);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    overflow: hidden;
}

.block-preview svg {
    max-width: 100%;
    max-height: 100%;
}

.block-info h3 {
    color: var(--mc-cyan);
    font-size: 1rem;
    margin-bottom: 0.5rem;
    word-break: break-word;
}

.block-meta {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    font-size: 0.875rem;
    color: var(--mc-text-muted);
    margin-bottom: 0.75rem;
}

.block-actions {
    display: flex;
    gap: 0.5rem;
}

.block-actions select {
    flex: 1;
    padding: 0.5rem;
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--mc-border);
    color: var(--mc-cyan);
    border-radius: 4px;
}

.block-actions input {
    flex: 2;
    padding: 0.5rem;
    background: rgba(0, 255, 255, 0.05);
    border: 1px solid var(--mc-border);
    color: var(--mc-text);
    border-radius: 4px;
}

/* Import Actions */
.import-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding-top: 1.5rem;
    border-top: 1px solid var(--mc-border);
}

/* Results */
.results-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin: 2rem 0;
}

.result-item {
    text-align: center;
    padding: 1.5rem;
    background: rgba(0, 255, 255, 0.05);
    border: 1px solid var(--mc-border);
    border-radius: 8px;
}

.result-label {
    display: block;
    color: var(--mc-text-muted);
    margin-bottom: 0.5rem;
}

.result-value {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: var(--mc-cyan);
}
</style>

<script>
let selectedFiles = [];
let extractedBlocks = [];
let existingBlocks = new Set();
let validCategories = [];
let currentImportType = 'blocks'; // Default to blocks

// Import type configuration
const importTypeConfig = {
    blocks: {
        name: 'Blocks',
        namePlural: 'blocks',
        description: 'Import block definitions (symbols, title blocks, annotations) from DXF files',
        extractBtnText: 'Extract Blocks',
        progressTitle: 'Extracting Blocks...',
        previewTitle: 'Step 2: Review Extracted Blocks',
        importBtnText: 'Import Selected Blocks',
        importMoreText: 'Import More Blocks',
        searchPlaceholder: 'Search blocks...',
        viewLibraryLink: '/data-manager/blocks',
        viewLibraryText: 'View Block Library',
        apiEndpoint: '/api/batch-cad-import/extract',
        saveEndpoint: '/api/batch-cad-import/save'
    },
    details: {
        name: 'Details',
        namePlural: 'details',
        description: 'Import construction details (typical sections, connection details) from DXF files',
        extractBtnText: 'Extract Details',
        progressTitle: 'Extracting Details...',
        previewTitle: 'Step 2: Review Extracted Details',
        importBtnText: 'Import Selected Details',
        importMoreText: 'Import More Details',
        searchPlaceholder: 'Search details...',
        viewLibraryLink: '/data-manager/details',
        viewLibraryText: 'View Detail Library',
        apiEndpoint: '/api/batch-cad-import/extract',
        saveEndpoint: '/api/batch-cad-import/save'
    },
    hatches: {
        name: 'Hatches',
        namePlural: 'hatches',
        description: 'Import hatch patterns (fill patterns for areas and surfaces) from DXF files',
        extractBtnText: 'Extract Hatches',
        progressTitle: 'Extracting Hatches...',
        previewTitle: 'Step 2: Review Extracted Hatches',
        importBtnText: 'Import Selected Hatches',
        importMoreText: 'Import More Hatches',
        searchPlaceholder: 'Search hatches...',
        viewLibraryLink: '/data-manager/hatches',
        viewLibraryText: 'View Hatch Library',
        apiEndpoint: '/api/batch-cad-import/extract',
        saveEndpoint: '/api/batch-cad-import/save'
    },
    linetypes: {
        name: 'Linetypes',
        namePlural: 'linetypes',
        description: 'Import linetype definitions (dashed, dotted, custom line patterns) from DXF files',
        extractBtnText: 'Extract Linetypes',
        progressTitle: 'Extracting Linetypes...',
        previewTitle: 'Step 2: Review Extracted Linetypes',
        importBtnText: 'Import Selected Linetypes',
        importMoreText: 'Import More Linetypes',
        searchPlaceholder: 'Search linetypes...',
        viewLibraryLink: '/data-manager/linetypes',
        viewLibraryText: 'View Linetype Library',
        apiEndpoint: '/api/batch-cad-import/extract',
        saveEndpoint: '/api/batch-cad-import/save'
    }
};

// Import type selector handler
document.getElementById('importType').addEventListener('change', function(e) {
    currentImportType = e.target.value;
    updateUIForImportType();
});

function updateUIForImportType() {
    const config = importTypeConfig[currentImportType];
    
    // Update description
    document.getElementById('typeDescription').textContent = config.description;
    
    // Update button texts
    document.getElementById('extractBtnText').textContent = config.extractBtnText;
    document.getElementById('importBtnText').textContent = config.importBtnText;
    document.getElementById('importMoreBtnText').textContent = config.importMoreText;
    
    // Update titles
    document.getElementById('progressTitle').textContent = config.progressTitle;
    document.getElementById('previewTitle').textContent = config.previewTitle;
    
    // Update search placeholder
    document.getElementById('searchFilter').placeholder = config.searchPlaceholder;
    
    // Update library link
    document.getElementById('viewLibraryLink').href = config.viewLibraryLink;
    document.getElementById('viewLibraryLink').textContent = config.viewLibraryText;
    
    // Reset state when changing type
    selectedFiles = [];
    extractedBlocks = [];
    existingBlocks = new Set();
    document.getElementById('fileList').style.display = 'none';
    document.getElementById('fileItems').innerHTML = '';
}

// Drag and drop handlers
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
});

dropZone.addEventListener('drop', handleDrop, false);
fileInput.addEventListener('change', handleFileSelect, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

function handleFileSelect(e) {
    handleFiles(e.target.files);
}

function handleFiles(files) {
    selectedFiles = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.dxf'));
    
    if (selectedFiles.length === 0) {
        alert('Please select DXF files');
        return;
    }
    
    // Show file list
    const fileList = document.getElementById('fileList');
    const fileItems = document.getElementById('fileItems');
    fileItems.innerHTML = '';
    
    selectedFiles.forEach(file => {
        const li = document.createElement('li');
        li.textContent = file.name;
        fileItems.appendChild(li);
    });
    
    fileList.style.display = 'block';
}

// Extract elements
document.getElementById('extractBtn').addEventListener('click', async () => {
    document.getElementById('uploadSection').style.display = 'none';
    document.getElementById('progressSection').style.display = 'block';
    
    const formData = new FormData();
    selectedFiles.forEach(file => {
        formData.append('files[]', file);
    });
    formData.append('import_type', currentImportType);
    
    try {
        const config = importTypeConfig[currentImportType];
        const response = await fetch(config.apiEndpoint, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Error: ' + data.error);
            location.reload();
            return;
        }
        
        extractedBlocks = data.blocks || data.details || data.hatches || data.linetypes || [];
        validCategories = data.valid_categories || [];
        
        // Check which elements already exist
        await checkExistingBlocks();
        
        // Show preview
        document.getElementById('progressSection').style.display = 'none';
        renderBlockPreview();
        
    } catch (error) {
        alert('Error extracting blocks: ' + error.message);
        location.reload();
    }
});

async function checkExistingBlocks() {
    try {
        const response = await fetch('/api/data-manager/blocks');
        const data = await response.json();
        
        data.blocks.forEach(block => {
            existingBlocks.add(block.block_name.toLowerCase());
        });
        
        // Mark blocks as existing
        extractedBlocks.forEach(block => {
            if (existingBlocks.has(block.name.toLowerCase())) {
                block.exists = true;
                block.action = 'skip';
            }
        });
        
    } catch (error) {
        console.error('Error checking existing blocks:', error);
    }
}

function renderBlockPreview() {
    const grid = document.getElementById('blockGrid');
    grid.innerHTML = '';
    
    const config = importTypeConfig[currentImportType];
    
    // Update stats
    const newCount = extractedBlocks.filter(b => !b.exists).length;
    const existingCount = extractedBlocks.filter(b => b.exists).length;
    
    document.getElementById('totalElements').textContent = `${extractedBlocks.length} ${config.namePlural} found`;
    document.getElementById('newElements').textContent = `${newCount} new`;
    document.getElementById('existingElements').textContent = `${existingCount} existing`;
    
    // Populate category filter with valid CAD Layer Vocabulary categories
    const categoryFilter = document.getElementById('categoryFilter');
    categoryFilter.innerHTML = '<option value="">All Categories</option>';
    validCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.code;
        option.textContent = `${cat.code} - ${cat.full_name}`;
        categoryFilter.appendChild(option);
    });
    
    // Render blocks
    extractedBlocks.forEach((block, index) => {
        const card = createBlockCard(block, index);
        grid.appendChild(card);
    });
    
    document.getElementById('previewSection').style.display = 'block';
}

function createBlockCard(block, index) {
    const card = document.createElement('div');
    card.className = 'block-card';
    if (block.exists) card.classList.add('existing');
    card.dataset.index = index;
    
    card.innerHTML = `
        <div class="block-preview">
            ${block.svg_preview}
        </div>
        <div class="block-info">
            <h3>${block.name}</h3>
            <div class="block-meta">
                <span>üìÇ ${block.category}</span>
                <span>üìÑ ${block.source_file}</span>
                <span>${block.exists ? '‚ö†Ô∏è Already exists' : '‚ú® New block'}</span>
            </div>
            <div class="block-actions">
                <select class="action-select" data-index="${index}">
                    <option value="import" ${!block.exists ? 'selected' : ''}>Import</option>
                    <option value="update" ${block.exists ? 'selected' : ''}>Update</option>
                    <option value="skip" ${block.exists ? 'selected' : ''}>Skip</option>
                </select>
                <select class="category-select mc-select" data-index="${index}">
                    <option value="" ${!block.category ? 'selected' : ''}>-- Select Category --</option>
                    ${validCategories.map(cat => `
                        <option value="${cat.code}" ${block.category === cat.code ? 'selected' : ''}>
                            ${cat.code} - ${cat.full_name}
                        </option>
                    `).join('')}
                </select>
            </div>
        </div>
    `;
    
    // Event listeners
    card.querySelector('.action-select').addEventListener('change', (e) => {
        extractedBlocks[index].action = e.target.value;
        updateCardSelection(card, e.target.value);
    });
    
    card.querySelector('.category-select').addEventListener('change', (e) => {
        extractedBlocks[index].category = e.target.value;
    });
    
    return card;
}

function updateCardSelection(card, action) {
    if (action === 'skip') {
        card.classList.remove('selected');
    } else {
        card.classList.add('selected');
    }
}

// Select/Deselect all
document.getElementById('selectAllBtn').addEventListener('click', () => {
    extractedBlocks.forEach((block, i) => {
        block.action = block.exists ? 'update' : 'import';
        const select = document.querySelector(`.action-select[data-index="${i}"]`);
        const card = document.querySelector(`.block-card[data-index="${i}"]`);
        if (select) {
            select.value = block.action;
        }
        if (card) {
            updateCardSelection(card, block.action);
        }
    });
});

document.getElementById('deselectAllBtn').addEventListener('click', () => {
    extractedBlocks.forEach((block, i) => {
        block.action = 'skip';
        const select = document.querySelector(`.action-select[data-index="${i}"]`);
        const card = document.querySelector(`.block-card[data-index="${i}"]`);
        if (select) {
            select.value = 'skip';
        }
        if (card) {
            updateCardSelection(card, 'skip');
        }
    });
});

// Import elements
document.getElementById('importBtn').addEventListener('click', async () => {
    const elementsToImport = extractedBlocks.filter(b => b.action !== 'skip');
    
    if (elementsToImport.length === 0) {
        const config = importTypeConfig[currentImportType];
        alert(`No ${config.namePlural} selected for import`);
        return;
    }
    
    try {
        const config = importTypeConfig[currentImportType];
        const response = await fetch(config.saveEndpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                import_type: currentImportType,
                elements: extractedBlocks
            })
        });
        
        const result = await response.json();
        
        // Show results
        document.getElementById('previewSection').style.display = 'none';
        document.getElementById('importedCount').textContent = result.imported || 0;
        document.getElementById('updatedCount').textContent = result.updated || 0;
        document.getElementById('skippedCount').textContent = result.skipped || 0;
        document.getElementById('resultsSection').style.display = 'block';
        
    } catch (error) {
        alert('Error importing: ' + error.message);
    }
});

// Search and filter
document.getElementById('searchFilter').addEventListener('input', filterBlocks);
document.getElementById('categoryFilter').addEventListener('change', filterBlocks);
document.getElementById('actionFilter').addEventListener('change', filterBlocks);

function filterBlocks() {
    const search = document.getElementById('searchFilter').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    const action = document.getElementById('actionFilter').value;
    
    const cards = document.querySelectorAll('.block-card');
    cards.forEach((card, i) => {
        const block = extractedBlocks[i];
        const matchesSearch = block.name.toLowerCase().includes(search);
        const matchesCategory = !category || block.category === category;
        const matchesAction = !action || block.action === action;
        
        if (matchesSearch && matchesCategory && matchesAction) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}
</script>

{% endblock %}
