{% extends "base_specialized_tool.html" %}

{% block tool_title %}Alignment Editor{% endblock %}
{% block tool_icon %}fas fa-road{% endblock %}
{% block tool_description %}Create and edit horizontal/vertical alignments for roads and utilities with station/offset calculations{% endblock %}

{% block content_layout_class %}tool-complex-layout{% endblock %}

{% block leaflet_assets %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}

{% block map_navigation_links %}
<div class="map-navigation-panel">
    <a href="/project-command-center" class="map-nav-link">
        <i class="fas fa-th-large"></i> Command Center
    </a>
    <a href="/map-viewer" class="map-nav-link">
        <i class="fas fa-map-marked-alt"></i> Map Viewer
    </a>
</div>
{% endblock %}

{% block sidebar_content %}
<div class="tool-filter-section">
    <h4>Alignment Filters</h4>
    <div class="tool-filter-item">
        <label for="filter-alignment-type">Alignment Type:</label>
        <select id="filter-alignment-type" onchange="applyFilters()">
            <option value="">All Types</option>
            <option value="road">Road Centerline</option>
            <option value="utility">Utility Alignment</option>
            <option value="trail">Trail/Path</option>
            <option value="curb">Curb Line</option>
        </select>
    </div>
</div>

<div class="tool-stats-section">
    <h4>Alignment Statistics</h4>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total Alignments:</span>
        <span class="tool-stat-value" id="stat-total-alignments">0</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total Length:</span>
        <span class="tool-stat-value" id="stat-total-length">0 ft</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total Stations:</span>
        <span class="tool-stat-value" id="stat-total-stations">0</span>
    </div>
</div>

<button class="tool-action-btn" onclick="showAddAlignmentModal()">
    <i class="fas fa-plus"></i> Add Alignment
</button>
<button class="tool-action-btn secondary" onclick="calculateStationing()">
    <i class="fas fa-calculator"></i> Calculate Stationing
</button>
<button class="tool-action-btn secondary" onclick="exportAlignments()">
    <i class="fas fa-file-export"></i> Export Data
</button>
{% endblock %}

{% block main_content %}
<div class="tool-top-area">
    <div id="alignment-map" style="height: 100%; width: 100%; background: #0a1929; position: relative;"></div>

    <div id="mapLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; text-align: center; z-index: 1000;">
        <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--mc-primary); margin-bottom: 1rem;"></i>
        <p style="color: var(--mc-text); font-size: 18px;">Loading alignments...</p>
    </div>
</div>

<div class="tool-resizer"></div>

<div class="tool-bottom-area">
    <div class="tool-data-tabs">
        <button class="tool-data-tab active" onclick="showTab('alignments')">
            <i class="fas fa-road"></i> Alignments (<span id="alignments-tab-count">0</span>)
        </button>
        <button class="tool-data-tab" onclick="showTab('profiles')">
            <i class="fas fa-chart-area"></i> Vertical Profiles
        </button>
        <button class="tool-data-tab" onclick="showTab('stations')">
            <i class="fas fa-ruler"></i> Station/Offset
        </button>
    </div>

    <div class="tool-data-content">
        <!-- Alignments Tab -->
        <div id="alignmentsTab" class="tab-content">
            <table class="tool-data-table" id="alignmentsTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('alignment_name')">Name <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable('alignment_type')">Type <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable('length_ft')">Length (ft) <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable('start_station')">Start Station <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable('end_station')">End Station <i class="fas fa-sort"></i></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="alignments-table-body">
                    <!-- Populated via JavaScript -->
                </tbody>
            </table>

            <div id="alignmentsEmptyState" style="display: none; text-align: center; padding: 3rem; color: var(--mc-muted);">
                <i class="fas fa-road" style="font-size: 64px; opacity: 0.3; margin-bottom: 1rem;"></i>
                <h3>No Alignments Found</h3>
                <p>Add alignments to your project.</p>
            </div>
        </div>

        <!-- Profiles Tab -->
        <div id="profilesTab" class="tab-content" style="display: none;">
            <div id="profiles-content">
                <p style="padding: 2rem; text-align: center; color: var(--mc-muted);">
                    Select an alignment to view vertical profile.
                </p>
            </div>
        </div>

        <!-- Stations Tab -->
        <div id="stationsTab" class="tab-content" style="display: none;">
            <div id="stations-content">
                <p style="padding: 2rem; text-align: center; color: var(--mc-muted);">
                    Select an alignment to calculate station/offset.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.tool-data-table {
    width: 100%;
    border-collapse: collapse;
}

.tool-data-table th {
    background: rgba(0, 255, 255, 0.1);
    padding: 0.75rem;
    text-align: left;
    border-bottom: 2px solid var(--mc-primary);
    cursor: pointer;
    user-select: none;
}

.tool-data-table th:hover {
    background: rgba(0, 255, 255, 0.2);
}

.tool-data-table td {
    padding: 0.75rem;
    border-bottom: 1px solid rgba(0, 255, 255, 0.1);
}

.tool-data-table tbody tr:hover {
    background: rgba(0, 255, 255, 0.05);
}

.tool-data-table .action-btn {
    padding: 0.25rem 0.5rem;
    margin: 0 0.25rem;
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--mc-primary);
    color: var(--mc-primary);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
}

.tool-data-table .action-btn:hover {
    background: rgba(0, 255, 255, 0.2);
}

.tool-data-table .action-btn.danger {
    border-color: var(--mc-danger);
    color: var(--mc-danger);
}

.tab-content {
    padding: 1rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="/static/js/specialized-tools-common.js"></script>
<script>
let map;
let alignmentLayer;
let allAlignments = [];
let filteredAlignments = [];
let currentTab = 'alignments';
let sortColumn = null;
let sortAsc = true;

function initializeMap() {
    map = SpecializedTools.initializeMap('alignment-map', { interactive: false });
    alignmentLayer = L.layerGroup().addTo(map);
}

async function loadAlignments() {
    SpecializedTools.showLoading('mapLoading', true);

    try {
        const projectId = await SpecializedTools.getActiveProjectId();
        if (!projectId) {
            SpecializedTools.showError('No active project selected');
            return;
        }

        const response = await fetch(`/api/alignments?project_id=${projectId}`);
        const data = await response.json();

        if (data.error) {
            console.error('Error loading alignments:', data.error);
            SpecializedTools.showError(data.error);
            return;
        }

        allAlignments = data.alignments || [];
        filteredAlignments = [...allAlignments];

        renderAlignmentsOnMap();
        renderAlignmentTable();
        updateStatistics();

    } catch (error) {
        console.error('Failed to load alignments:', error);
        SpecializedTools.showError('Failed to load alignments: ' + error.message);
    } finally {
        SpecializedTools.showLoading('mapLoading', false);
    }
}

function renderAlignmentsOnMap() {
    alignmentLayer.clearLayers();

    if (filteredAlignments.length === 0) return;

    const features = [];

    filteredAlignments.forEach(alignment => {
        if (!alignment.geometry) return;

        const color = getColorForAlignmentType(alignment.alignment_type);

        const layer = L.geoJSON(alignment.geometry, {
            style: {
                color: color,
                weight: 3,
                opacity: 0.8
            }
        }).addTo(alignmentLayer);

        layer.bindPopup(`
            <strong>${alignment.alignment_name || 'Unnamed'}</strong><br>
            Type: ${alignment.alignment_type || 'Unknown'}<br>
            Length: ${SpecializedTools.formatNumber(alignment.length_ft, 1)} ft<br>
            Stations: ${alignment.start_station || '0+00'} to ${alignment.end_station || '0+00'}
        `);

        features.push(layer);
    });

    SpecializedTools.fitMapToFeatures(map, features);
}

function getColorForAlignmentType(type) {
    const colors = {
        'road': '#ffaa00',
        'utility': '#00aaff',
        'trail': '#00ff88',
        'curb': '#ff00ff'
    };
    return colors[type] || '#00ffff';
}

function renderAlignmentTable() {
    const tbody = document.getElementById('alignments-table-body');
    const emptyState = document.getElementById('alignmentsEmptyState');
    const table = document.getElementById('alignmentsTable');

    document.getElementById('alignments-tab-count').textContent = filteredAlignments.length;

    if (filteredAlignments.length === 0) {
        table.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }

    table.style.display = 'table';
    emptyState.style.display = 'none';

    tbody.innerHTML = filteredAlignments.map(alignment => `
        <tr data-alignment-id="${alignment.alignment_id}">
            <td>${alignment.alignment_name || 'Unnamed'}</td>
            <td>${alignment.alignment_type || 'Unknown'}</td>
            <td>${SpecializedTools.formatNumber(alignment.length_ft, 1)}</td>
            <td>${alignment.start_station || '0+00'}</td>
            <td>${alignment.end_station || '0+00'}</td>
            <td>
                <button class="action-btn" onclick="viewProfile('${alignment.alignment_id}')">
                    <i class="fas fa-chart-area"></i> Profile
                </button>
                <button class="action-btn" onclick="editAlignment('${alignment.alignment_id}')">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="action-btn danger" onclick="deleteAlignment('${alignment.alignment_id}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </td>
        </tr>
    `).join('');
}

function updateStatistics() {
    const total = filteredAlignments.length;
    const totalLength = filteredAlignments.reduce((sum, a) => sum + (a.length_ft || 0), 0);
    const totalStations = filteredAlignments.reduce((sum, a) => {
        const start = parseStation(a.start_station);
        const end = parseStation(a.end_station);
        return sum + (end - start);
    }, 0);

    document.getElementById('stat-total-alignments').textContent = total;
    document.getElementById('stat-total-length').textContent = SpecializedTools.formatNumber(totalLength, 0) + ' ft';
    document.getElementById('stat-total-stations').textContent = Math.floor(totalStations / 100);
}

function parseStation(station) {
    if (!station) return 0;
    const parts = station.split('+');
    return parseInt(parts[0]) * 100 + parseInt(parts[1] || 0);
}

function applyFilters() {
    const alignmentType = document.getElementById('filter-alignment-type').value;

    filteredAlignments = allAlignments.filter(alignment => {
        if (alignmentType && alignment.alignment_type !== alignmentType) return false;
        return true;
    });

    renderAlignmentsOnMap();
    renderAlignmentTable();
    updateStatistics();
}

function sortTable(column) {
    if (sortColumn === column) {
        sortAsc = !sortAsc;
    } else {
        sortColumn = column;
        sortAsc = true;
    }

    filteredAlignments = SpecializedTools.sortData(filteredAlignments, column, sortAsc);
    renderAlignmentTable();
}

function showTab(tabName) {
    currentTab = tabName;

    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });

    document.querySelectorAll('.tool-data-tab').forEach(btn => {
        btn.classList.remove('active');
    });

    document.getElementById(tabName + 'Tab').style.display = 'block';
    event.target.classList.add('active');
}

function showAddAlignmentModal() {
    SpecializedTools.showError('Add Alignment functionality coming soon');
}

function viewProfile(alignmentId) {
    SpecializedTools.showError('Profile view coming soon');
}

function editAlignment(alignmentId) {
    SpecializedTools.showError('Edit alignment: ' + alignmentId);
}

function deleteAlignment(alignmentId) {
    if (confirm('Are you sure you want to delete this alignment?')) {
        SpecializedTools.showError('Delete functionality coming soon');
    }
}

function calculateStationing() {
    SpecializedTools.showSuccess('Stationing calculations updated');
}

function exportAlignments() {
    if (filteredAlignments.length > 0) {
        SpecializedTools.exportToCSV(filteredAlignments, 'alignments.csv');
    } else {
        SpecializedTools.showError('No alignments to export');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    initializeMap();
    loadAlignments();
});
</script>
{% endblock %}

{% block about_tool_description %}
The Alignment Editor manages horizontal and vertical alignments for roads, utilities, and other linear features. Create centerlines, calculate stations, define vertical profiles, and perform station/offset calculations for construction staking.
{% endblock %}

{% block about_tool_tags %}
<span class="about-tool-tag">ROAD</span>
<span class="about-tool-tag">ALIGNMENT</span>
<span class="about-tool-tag">CENTERLINE</span>
<span class="about-tool-tag">STATIONING</span>
{% endblock %}

{% block about_tool_examples %}
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-ROAD-CNTR-PROP-LN</div>
    <div class="about-tool-example-desc">→ Proposed road centerline</div>
</div>
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-UTIL-CNTR-EXST-LN</div>
    <div class="about-tool-example-desc">→ Existing utility centerline</div>
</div>
{% endblock %}
