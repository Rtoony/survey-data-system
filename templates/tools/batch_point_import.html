{% extends 'base.html' %}

{% block title %}Batch Point Import{% endblock %}

{% block content %}
<div class="mc-page">
    <div class="mc-header">
        <h1>üìç Batch Point Import Tool</h1>
        <p>Import survey points from PNEZD text files with optional code processing and auto-connectivity</p>
    </div>

    <!-- Mode Tabs -->
    <div class="tab-nav">
        <button class="tab-btn active" data-mode="basic" onclick="switchMode('basic')">
            üìç Basic Import
        </button>
        <button class="tab-btn" data-mode="survey" onclick="switchMode('survey')">
            üéØ Survey Code Import (Auto-Connectivity)
        </button>
    </div>

    <!-- Basic Import Mode (Existing Functionality) -->
    <div id="basicMode" style="display:block;">
    <!-- Configuration Section -->
    <div class="mc-card" id="configSection">
        <h2>Step 1: Configure Import</h2>
        
        <div class="config-grid">
            <div class="config-item">
                <label for="drawingSelect" class="mc-label">Select Drawing:</label>
                <select id="drawingSelect" class="mc-select" required>
                    <option value="">-- Select Drawing --</option>
                </select>
                <p class="help-text">Points will be imported into the selected drawing</p>
            </div>

            <div class="config-item">
                <label for="coordSystemSelect" class="mc-label">Coordinate System:</label>
                <select id="coordSystemSelect" class="mc-select" required>
                    <option value="">-- Select Coordinate System --</option>
                </select>
                <p class="help-text">Coordinate system of the incoming data. Points will be automatically transformed to SRID 2226 (CA State Plane Zone 3) for database storage. If your data is already in 2226, select that option to skip transformation.</p>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="mc-card" id="uploadSection">
        <h2>Step 2: Upload PNEZD Files</h2>
        <div class="upload-zone" id="dropZone">
            <div class="upload-icon">üìÅ</div>
            <p class="upload-text">Drag & drop PNEZD text files here</p>
            <p class="upload-subtext">or</p>
            <button class="mc-btn-primary" onclick="document.getElementById('fileInput').click()">
                Browse Files
            </button>
            <input type="file" id="fileInput" multiple accept=".txt,.csv" style="display:none;">
            <p class="upload-hint">Supports .txt and .csv files (comma-separated P,N,E,Z,D format)</p>
        </div>
        
        <div id="fileList" class="file-list" style="display:none;">
            <h3>Selected Files</h3>
            <ul id="fileItems"></ul>
            <button class="mc-btn-primary" id="parseBtn">
                Parse Files
            </button>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="mc-card" id="progressSection" style="display:none;">
        <h2>Parsing Points...</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <p id="progressText">Processing files...</p>
    </div>

    <!-- Preview Section -->
    <div class="mc-card" id="previewSection" style="display:none;">
        <div class="preview-header">
            <h2>Step 3: Review Parsed Points</h2>
            <div class="preview-stats">
                <span id="totalPoints" class="stat-badge">0 points found</span>
                <span id="newPoints" class="stat-badge stat-new">0 new</span>
                <span id="existingPoints" class="stat-badge stat-existing">0 existing</span>
                <span id="errorCount" class="stat-badge stat-error" style="display:none;">0 errors</span>
            </div>
        </div>

        <!-- Errors (if any) -->
        <div id="errorsSection" style="display:none;">
            <h3 style="color: var(--mc-danger);">‚ö†Ô∏è Parsing Errors</h3>
            <div id="errorsList" class="errors-list"></div>
        </div>

        <!-- Filters -->
        <div class="preview-filters">
            <input type="text" id="searchFilter" placeholder="Search by point number or description..." class="mc-input">
            <select id="actionFilter" class="mc-select">
                <option value="">All Actions</option>
                <option value="import">Import New</option>
                <option value="update">Update Existing</option>
                <option value="skip">Skip</option>
            </select>
            <select id="sourceFilter" class="mc-select">
                <option value="">All Files</option>
            </select>
        </div>

        <!-- Point Table -->
        <div class="table-container">
            <table id="pointsTable" class="mc-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllCheckbox"></th>
                        <th>Point #</th>
                        <th>Northing</th>
                        <th>Easting</th>
                        <th>Elevation</th>
                        <th>Description</th>
                        <th>Source File</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="pointsTableBody">
                </tbody>
            </table>
        </div>

        <!-- Import Actions -->
        <div class="import-actions">
            <button class="mc-btn-secondary" id="selectAllBtn">Select All</button>
            <button class="mc-btn-secondary" id="deselectAllBtn">Deselect All</button>
            <button class="mc-btn-primary" id="importBtn">
                Import Selected Points
            </button>
        </div>
    </div>

    <!-- Results Section -->
    <div class="mc-card" id="resultsSection" style="display:none;">
        <h2>‚úÖ Import Complete</h2>
        <div class="results-summary">
            <div class="result-item">
                <span class="result-label">Imported:</span>
                <span class="result-value" id="importedCount">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Updated:</span>
                <span class="result-value" id="updatedCount">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Skipped:</span>
                <span class="result-value" id="skippedCount">0</span>
            </div>
        </div>
        <button class="mc-btn-primary" onclick="location.reload()">
            Import More Points
        </button>
    </div>
</div>

<!-- Survey Code Import Mode (Auto-Connectivity) -->
<div id="surveyMode" style="display:none;">
    <!-- Configuration Section -->
    <div class="mc-card">
        <h2>Step 1: Select Drawing</h2>
        <div class="config-grid">
            <div class="config-item">
                <label for="surveyDrawingSelect" class="mc-label">Select Drawing:</label>
                <select id="surveyDrawingSelect" class="mc-select" required>
                    <option value="">-- Select Drawing --</option>
                </select>
                <p class="help-text">Points and auto-generated polylines will be imported into this drawing</p>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="mc-card">
        <h2>Step 2: Upload PNEZD File with Survey Codes</h2>
        <div class="upload-zone" id="surveyDropZone">
            <div class="upload-icon">üéØ</div>
            <p class="upload-text">Drag & drop PNEZD file with survey codes</p>
            <p class="upload-subtext">or</p>
            <button class="mc-btn-primary" onclick="document.getElementById('surveyFileInput').click()">
                Browse Files
            </button>
            <input type="file" id="surveyFileInput" accept=".txt,.csv" style="display:none;">
            <p class="upload-hint">Format: PointNumber,Northing,Easting,Elevation,Code<br>
            Codes like CIV-UTIL-STORM-MH, SITE-ROAD-ASPH-LINE will auto-generate polylines based on connectivity rules</p>
        </div>
        
        <div id="surveyFilePreview" style="display:none; margin-top:1rem;">
            <p><strong>Selected:</strong> <span id="surveyFileName"></span></p>
            <button class="mc-btn-primary" id="surveyParseBtn">
                Parse & Preview
            </button>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="mc-card" id="surveyProgressSection" style="display:none;">
        <h2>Processing Survey Data...</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="surveyProgressFill"></div>
        </div>
        <p id="surveyProgressText">Parsing codes and generating connectivity...</p>
    </div>

    <!-- Preview Section -->
    <div class="mc-card" id="surveyPreviewSection" style="display:none;">
        <div class="preview-header">
            <h2>Step 3: Review Auto-Connectivity Preview</h2>
            <div class="preview-stats">
                <span id="surveyTotalPoints" class="stat-badge">0 points</span>
                <span id="surveySequences" class="stat-badge stat-new">0 sequences</span>
                <span id="surveyLineSegments" class="stat-badge stat-existing">0 line segments</span>
                <span id="surveyWarnings" class="stat-badge stat-error" style="display:none;">0 warnings</span>
            </div>
        </div>

        <!-- Warnings (if any) -->
        <div id="surveyWarningsSection" style="display:none;">
            <h3 style="color: var(--mc-warning);">‚ö†Ô∏è Connectivity Warnings</h3>
            <div id="surveyWarningsList" class="errors-list"></div>
        </div>

        <!-- Preview Tabs -->
        <div class="tab-nav" style="margin-top:1.5rem;">
            <button class="tab-btn active" onclick="switchPreviewTab('points')">
                üìç Points (<span id="pointsTabCount">0</span>)
            </button>
            <button class="tab-btn" onclick="switchPreviewTab('sequences')">
                üîó Sequences (<span id="sequencesTabCount">0</span>)
            </button>
            <button class="tab-btn" onclick="switchPreviewTab('segments')">
                üìê Line Segments (<span id="segmentsTabCount">0</span>)
            </button>
        </div>

        <!-- Points Tab -->
        <div id="pointsPreviewTab" class="preview-tab" style="display:block;">
            <div class="table-container" style="max-height:400px; overflow-y:auto;">
                <table class="mc-table">
                    <thead>
                        <tr>
                            <th>Point #</th>
                            <th>Code</th>
                            <th>Layer</th>
                            <th>Connectivity</th>
                            <th>Coords (N, E, Z)</th>
                            <th>Sequence</th>
                        </tr>
                    </thead>
                    <tbody id="surveyPointsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sequences Tab -->
        <div id="sequencesPreviewTab" class="preview-tab" style="display:none;">
            <div class="table-container" style="max-height:400px; overflow-y:auto;">
                <table class="mc-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Code</th>
                            <th>Feature Type</th>
                            <th>Connectivity</th>
                            <th>Points</th>
                            <th>Closed?</th>
                        </tr>
                    </thead>
                    <tbody id="surveySequencesTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Line Segments Tab -->
        <div id="segmentsPreviewTab" class="preview-tab" style="display:none;">
            <div class="table-container" style="max-height:400px; overflow-y:auto;">
                <table class="mc-table">
                    <thead>
                        <tr>
                            <th>Feature Type</th>
                            <th>Layer</th>
                            <th>Connectivity</th>
                            <th>Point Count</th>
                            <th>Closed?</th>
                            <th>Geometry</th>
                        </tr>
                    </thead>
                    <tbody id="surveySegmentsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Import Actions -->
        <div class="import-actions" style="margin-top:1.5rem;">
            <button class="mc-btn-secondary" onclick="location.reload()">Cancel</button>
            <button class="mc-btn-primary" id="surveyCommitBtn">
                ‚úÖ Commit Import to Database
            </button>
        </div>
    </div>

    <!-- Results Section -->
    <div class="mc-card" id="surveyResultsSection" style="display:none;">
        <h2>‚úÖ Survey Import Complete</h2>
        <div class="results-summary">
            <div class="result-item">
                <span class="result-label">Points Imported:</span>
                <span class="result-value" id="surveyPointsImported">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Sequences Created:</span>
                <span class="result-value" id="surveySequencesCreated">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Line Segments Created:</span>
                <span class="result-value" id="surveySegmentsCreated">0</span>
            </div>
        </div>
        <div style="margin-top:1.5rem; padding:1rem; background:rgba(0,255,255,0.1); border-radius:8px;">
            <p><strong>üéØ Auto-Connectivity Applied:</strong></p>
            <p style="margin-top:0.5rem; color:var(--mc-muted);">
                Survey codes were parsed and polylines were automatically generated based on connectivity rules (NODE, LINE, EDGE, BREAK, CLOSE).
                Points are stored with 3D PostGIS geometry and linked to their sequences.
            </p>
        </div>
        <button class="mc-btn-primary" onclick="location.reload()">
            Import More Survey Data
        </button>
    </div>
</div>

<style>
/* Config Grid */
.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

.config-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.help-text {
    font-size: 0.875rem;
    color: var(--mc-muted);
    font-style: italic;
}

/* Upload Zone */
.upload-zone {
    border: 3px dashed var(--mc-primary);
    border-radius: 8px;
    padding: 3rem;
    text-align: center;
    transition: all 0.3s ease;
    background: rgba(0, 255, 255, 0.05);
}

.upload-zone.drag-over {
    background: rgba(0, 255, 255, 0.15);
    border-color: var(--mc-secondary);
    transform: scale(1.02);
}

.upload-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.upload-text {
    font-size: 1.25rem;
    color: var(--mc-primary);
    margin-bottom: 0.5rem;
}

.upload-subtext {
    color: var(--mc-muted);
    margin: 1rem 0;
}

.upload-hint {
    color: var(--mc-muted);
    font-size: 0.875rem;
    margin-top: 1rem;
}

/* File List */
.file-list {
    margin-top: 2rem;
}

.file-list h3 {
    color: var(--mc-primary);
    margin-bottom: 1rem;
}

.file-list ul {
    list-style: none;
    padding: 0;
    margin-bottom: 1.5rem;
}

.file-list li {
    padding: 0.75rem;
    background: rgba(0, 255, 255, 0.05);
    border: 1px solid var(--mc-primary);
    border-radius: 4px;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.file-list li::before {
    content: 'üìÑ';
}

/* Progress Bar */
.progress-bar {
    width: 100%;
    height: 30px;
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--mc-primary);
    border-radius: 15px;
    overflow: hidden;
    margin: 1.5rem 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--mc-primary), var(--mc-accent));
    transition: width 0.3s ease;
    width: 0%;
}

/* Stats Badges */
.preview-stats {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.stat-badge {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--mc-primary);
    color: var(--mc-primary);
    font-weight: 600;
}

.stat-new {
    background: rgba(0, 255, 136, 0.1);
    border-color: var(--mc-accent);
    color: var(--mc-accent);
}

.stat-existing {
    background: rgba(255, 0, 255, 0.1);
    border-color: var(--mc-secondary);
    color: var(--mc-secondary);
}

.stat-error {
    background: rgba(255, 68, 68, 0.1);
    border-color: var(--mc-danger);
    color: var(--mc-danger);
}

/* Errors Section */
.errors-list {
    background: rgba(255, 68, 68, 0.05);
    border: 1px solid var(--mc-danger);
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    max-height: 300px;
    overflow-y: auto;
}

.error-item {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.875rem;
}

.error-line {
    color: var(--mc-danger);
    font-weight: bold;
}

/* Filters */
.preview-filters {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 1rem;
    margin: 1.5rem 0;
}

/* Table */
.table-container {
    overflow-x: auto;
    margin: 1.5rem 0;
    max-height: 600px;
    overflow-y: auto;
}

.mc-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.mc-table th {
    position: sticky;
    top: 0;
    background: var(--mc-surface);
    color: var(--mc-primary);
    padding: 0.75rem;
    text-align: left;
    border-bottom: 2px solid var(--mc-primary);
    z-index: 10;
}

.mc-table td {
    padding: 0.75rem;
    border-bottom: 1px solid rgba(0, 255, 255, 0.1);
}

.mc-table tbody tr:hover {
    background: rgba(0, 255, 255, 0.05);
}

.mc-table tr.row-selected {
    background: rgba(0, 255, 136, 0.1);
}

.mc-table tr.row-existing {
    background: rgba(255, 0, 255, 0.05);
}

.mc-table tr.row-skip {
    opacity: 0.5;
}

.action-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
}

.action-import {
    background: rgba(0, 255, 136, 0.2);
    color: var(--mc-accent);
}

.action-update {
    background: rgba(255, 0, 255, 0.2);
    color: var(--mc-secondary);
}

.action-skip {
    background: rgba(128, 128, 128, 0.2);
    color: #999;
}

/* Import Actions */
.import-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
}

/* Results Summary */
.results-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}

.result-item {
    background: rgba(0, 255, 255, 0.05);
    border: 1px solid var(--mc-primary);
    border-radius: 6px;
    padding: 1.5rem;
    text-align: center;
}

.result-label {
    display: block;
    color: var(--mc-muted);
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.result-value {
    display: block;
    color: var(--mc-primary);
    font-size: 2rem;
    font-weight: 700;
}
</style>

<script>
let parsedPoints = [];
let selectedFiles = [];
let projects = [];
let coordinateSystems = [];

// Load initial data
window.addEventListener('DOMContentLoaded', async () => {
    await loadProjectsAndDrawings();
    await loadCoordinateSystems();
});

async function loadProjectsAndDrawings() {
    try {
        const response = await fetch('/api/batch-point-import/get-drawings');
        const data = await response.json();
        
        if (data.error) {
            alert('Error loading drawings: ' + data.error);
            return;
        }
        
        projects = data.projects || [];
        
        const drawingSelect = document.getElementById('drawingSelect');
        drawingSelect.innerHTML = '<option value="">-- Select Drawing --</option>';
        
        projects.forEach(project => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = `${project.project_number} - ${project.project_name}`;
            
            project.drawings.forEach(drawing => {
                const option = document.createElement('option');
                option.value = drawing.drawing_id;
                option.textContent = `${drawing.drawing_number} - ${drawing.drawing_name}`;
                optgroup.appendChild(option);
            });
            
            if (project.drawings.length > 0) {
                drawingSelect.appendChild(optgroup);
            }
        });
        
    } catch (error) {
        console.error('Error loading drawings:', error);
        alert('Failed to load drawings');
    }
}

async function loadCoordinateSystems() {
    try {
        const response = await fetch('/api/batch-point-import/get-coordinate-systems');
        const data = await response.json();
        
        if (data.error) {
            alert('Error loading coordinate systems: ' + data.error);
            return;
        }
        
        coordinateSystems = data.coordinate_systems || [];
        
        const coordSelect = document.getElementById('coordSystemSelect');
        coordSelect.innerHTML = '<option value="">-- Select Coordinate System --</option>';
        
        coordinateSystems.forEach(cs => {
            const option = document.createElement('option');
            option.value = cs.epsg_code;
            option.textContent = `${cs.system_name} (EPSG:${cs.epsg_code})`;
            option.dataset.units = cs.units;
            coordSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading coordinate systems:', error);
        alert('Failed to load coordinate systems');
    }
}

// File upload handlers
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const fileList = document.getElementById('fileList');
const fileItems = document.getElementById('fileItems');

fileInput.addEventListener('change', handleFileSelect);

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('drag-over');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    handleFileSelect({ target: { files: e.dataTransfer.files } });
});

function handleFileSelect(e) {
    selectedFiles = Array.from(e.target.files);
    
    if (selectedFiles.length === 0) return;
    
    fileItems.innerHTML = '';
    selectedFiles.forEach(file => {
        const li = document.createElement('li');
        li.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
        fileItems.appendChild(li);
    });
    
    fileList.style.display = 'block';
}

// Parse button handler
document.getElementById('parseBtn').addEventListener('click', async () => {
    const drawingId = document.getElementById('drawingSelect').value;
    const coordSystem = document.getElementById('coordSystemSelect').value;
    
    if (!drawingId) {
        alert('Please select a drawing');
        return;
    }
    
    if (!coordSystem) {
        alert('Please select a coordinate system');
        return;
    }
    
    if (selectedFiles.length === 0) {
        alert('Please select files to import');
        return;
    }
    
    document.getElementById('uploadSection').style.display = 'none';
    document.getElementById('progressSection').style.display = 'block';
    
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    parsedPoints = [];
    let totalErrors = [];
    
    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        progressText.textContent = `Processing ${file.name} (${i + 1}/${selectedFiles.length})...`;
        progressFill.style.width = `${((i + 1) / selectedFiles.length) * 100}%`;
        
        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('drawing_id', drawingId);
            formData.append('epsg_code', coordSystem);
            
            const response = await fetch('/api/batch-point-import/parse', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.error) {
                alert(`Error parsing ${file.name}: ${data.error}`);
                continue;
            }
            
            parsedPoints.push(...data.points);
            totalErrors.push(...data.errors);
            
        } catch (error) {
            console.error(`Error parsing ${file.name}:`, error);
            alert(`Failed to parse ${file.name}`);
        }
    }
    
    document.getElementById('progressSection').style.display = 'none';
    displayPointsPreview(parsedPoints, totalErrors);
});

function displayPointsPreview(points, errors) {
    const previewSection = document.getElementById('previewSection');
    const tbody = document.getElementById('pointsTableBody');
    
    // Update stats
    document.getElementById('totalPoints').textContent = `${points.length} points found`;
    document.getElementById('newPoints').textContent = `${points.filter(p => !p.exists).length} new`;
    document.getElementById('existingPoints').textContent = `${points.filter(p => p.exists).length} existing`;
    
    if (errors.length > 0) {
        document.getElementById('errorCount').textContent = `${errors.length} errors`;
        document.getElementById('errorCount').style.display = 'inline-block';
        
        const errorsSection = document.getElementById('errorsSection');
        const errorsList = document.getElementById('errorsList');
        errorsSection.style.display = 'block';
        
        errorsList.innerHTML = errors.map(err => `
            <div class="error-item">
                <span class="error-line">Line ${err.line}:</span> ${err.error}<br>
                <small style="color: var(--mc-muted);">${err.content}</small>
            </div>
        `).join('');
    }
    
    // Populate table
    tbody.innerHTML = points.map((point, index) => `
        <tr class="row-${point.action}" data-index="${index}">
            <td><input type="checkbox" class="point-checkbox" data-index="${index}" ${point.action !== 'skip' ? 'checked' : ''}></td>
            <td>${point.point_number}</td>
            <td>${point.northing.toFixed(3)}</td>
            <td>${point.easting.toFixed(3)}</td>
            <td>${point.elevation.toFixed(3)}</td>
            <td>${point.description}</td>
            <td><small>${point.source_file}</small></td>
            <td><span class="action-badge action-${point.action}">${point.action}</span></td>
        </tr>
    `).join('');
    
    // Populate source filter
    const sourceFilter = document.getElementById('sourceFilter');
    const uniqueFiles = [...new Set(points.map(p => p.source_file))];
    sourceFilter.innerHTML = '<option value="">All Files</option>' +
        uniqueFiles.map(file => `<option value="${file}">${file}</option>`).join('');
    
    previewSection.style.display = 'block';
    setupTableFilters();
}

function setupTableFilters() {
    const searchFilter = document.getElementById('searchFilter');
    const actionFilter = document.getElementById('actionFilter');
    const sourceFilter = document.getElementById('sourceFilter');
    
    function applyFilters() {
        const searchText = searchFilter.value.toLowerCase();
        const actionValue = actionFilter.value;
        const sourceValue = sourceFilter.value;
        
        document.querySelectorAll('#pointsTableBody tr').forEach((row, index) => {
            const point = parsedPoints[index];
            const matchesSearch = !searchText || 
                point.point_number.toLowerCase().includes(searchText) ||
                point.description.toLowerCase().includes(searchText);
            const matchesAction = !actionValue || point.action === actionValue;
            const matchesSource = !sourceValue || point.source_file === sourceValue;
            
            row.style.display = (matchesSearch && matchesAction && matchesSource) ? '' : 'none';
        });
    }
    
    searchFilter.addEventListener('input', applyFilters);
    actionFilter.addEventListener('change', applyFilters);
    sourceFilter.addEventListener('change', applyFilters);
}

// Select all/deselect all
document.getElementById('selectAllBtn').addEventListener('click', () => {
    document.querySelectorAll('.point-checkbox').forEach(cb => cb.checked = true);
});

document.getElementById('deselectAllBtn').addEventListener('click', () => {
    document.querySelectorAll('.point-checkbox').forEach(cb => cb.checked = false);
});

document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
    document.querySelectorAll('.point-checkbox').forEach(cb => cb.checked = e.target.checked);
});

// Import button handler
document.getElementById('importBtn').addEventListener('click', async () => {
    const selectedIndices = Array.from(document.querySelectorAll('.point-checkbox:checked'))
        .map(cb => parseInt(cb.dataset.index));
    
    if (selectedIndices.length === 0) {
        alert('Please select points to import');
        return;
    }
    
    const selectedPoints = selectedIndices.map(i => parsedPoints[i]);
    const drawingId = document.getElementById('drawingSelect').value;
    const epsgCode = document.getElementById('coordSystemSelect').value;
    
    try {
        document.getElementById('importBtn').disabled = true;
        document.getElementById('importBtn').textContent = 'Importing...';
        
        const response = await fetch('/api/batch-point-import/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                points: selectedPoints,
                drawing_id: drawingId,
                source_epsg: epsgCode
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Error importing points: ' + data.error);
            return;
        }
        
        document.getElementById('previewSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'block';
        
        document.getElementById('importedCount').textContent = data.imported || 0;
        document.getElementById('updatedCount').textContent = data.updated || 0;
        document.getElementById('skippedCount').textContent = data.skipped || 0;
        
    } catch (error) {
        console.error('Error importing points:', error);
        alert('Failed to import points');
    } finally {
        document.getElementById('importBtn').disabled = false;
        document.getElementById('importBtn').textContent = 'Import Selected Points';
    }
});

// ===========================
// Survey Mode (Auto-Connectivity)
// ===========================
let surveyPreviewData = null;
let surveySelectedFile = null;

// Mode switching
function switchMode(mode) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (mode === 'basic') {
        document.getElementById('basicMode').style.display = 'block';
        document.getElementById('surveyMode').style.display = 'none';
    } else if (mode === 'survey') {
        document.getElementById('basicMode').style.display = 'none';
        document.getElementById('surveyMode').style.display = 'block';
        loadSurveyDrawings();
    }
}

// Load drawings for survey mode
async function loadSurveyDrawings() {
    try {
        const response = await fetch('/api/batch-point-import/get-drawings');
        const data = await response.json();
        
        if (data.error) {
            alert('Error loading drawings: ' + data.error);
            return;
        }
        
        const drawingSelect = document.getElementById('surveyDrawingSelect');
        drawingSelect.innerHTML = '<option value="">-- Select Drawing --</option>';
        
        (data.projects || []).forEach(project => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = `${project.project_number} - ${project.project_name}`;
            
            project.drawings.forEach(drawing => {
                const option = document.createElement('option');
                option.value = drawing.drawing_id;
                option.textContent = `${drawing.drawing_number} - ${drawing.drawing_name}`;
                option.dataset.projectId = project.project_id;
                optgroup.appendChild(option);
            });
            
            drawingSelect.appendChild(optgroup);
        });
    } catch (error) {
        console.error('Error loading drawings:', error);
    }
}

// Survey file upload handlers
const surveyFileInput = document.getElementById('surveyFileInput');
const surveyDropZone = document.getElementById('surveyDropZone');

surveyFileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        surveySelectedFile = e.target.files[0];
        document.getElementById('surveyFileName').textContent = surveySelectedFile.name;
        document.getElementById('surveyFilePreview').style.display = 'block';
    }
});

surveyDropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    surveyDropZone.classList.add('drag-over');
});

surveyDropZone.addEventListener('dragleave', () => {
    surveyDropZone.classList.remove('drag-over');
});

surveyDropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    surveyDropZone.classList.remove('drag-over');
    
    if (e.dataTransfer.files.length > 0) {
        surveySelectedFile = e.dataTransfer.files[0];
        document.getElementById('surveyFileName').textContent = surveySelectedFile.name;
        document.getElementById('surveyFilePreview').style.display = 'block';
    }
});

// Parse & Preview button
document.getElementById('surveyParseBtn').addEventListener('click', async () => {
    const drawingId = document.getElementById('surveyDrawingSelect').value;
    
    if (!drawingId) {
        alert('Please select a drawing first');
        return;
    }
    
    if (!surveySelectedFile) {
        alert('Please select a file first');
        return;
    }
    
    // Show progress
    document.getElementById('surveyProgressSection').style.display = 'block';
    document.getElementById('surveyProgressFill').style.width = '50%';
    
    try {
        const formData = new FormData();
        formData.append('file', surveySelectedFile);
        formData.append('coordinate_system', 'SRID_2226'); // Always State Plane for now
        
        const response = await fetch('/api/survey-import/preview', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Error parsing file: ' + data.error);
            document.getElementById('surveyProgressSection').style.display = 'none';
            return;
        }
        
        surveyPreviewData = data;
        
        // Hide progress, show preview
        document.getElementById('surveyProgressSection').style.display = 'none';
        document.getElementById('surveyPreviewSection').style.display = 'block';
        
        // Display preview data
        displaySurveyPreview(data);
        
    } catch (error) {
        console.error('Error parsing file:', error);
        alert('Failed to parse file');
        document.getElementById('surveyProgressSection').style.display = 'none';
    }
});

// Display preview data
function displaySurveyPreview(data) {
    // Update stats
    document.getElementById('surveyTotalPoints').textContent = `${data.points.length} points`;
    document.getElementById('surveySequences').textContent = `${data.sequences.length} sequences`;
    document.getElementById('surveyLineSegments').textContent = `${data.line_segments.length} line segments`;
    
    document.getElementById('pointsTabCount').textContent = data.points.length;
    document.getElementById('sequencesTabCount').textContent = data.sequences.length;
    document.getElementById('segmentsTabCount').textContent = data.line_segments.length;
    
    // Show warnings if any
    if (data.warnings && data.warnings.length > 0) {
        document.getElementById('surveyWarnings').textContent = `${data.warnings.length} warnings`;
        document.getElementById('surveyWarnings').style.display = 'inline-block';
        document.getElementById('surveyWarningsSection').style.display = 'block';
        
        const warningsList = document.getElementById('surveyWarningsList');
        warningsList.innerHTML = data.warnings.map(w => 
            `<div class="error-item">‚ö†Ô∏è ${escapeHtml(w)}</div>`
        ).join('');
    }
    
    // Populate Points table
    const pointsBody = document.getElementById('surveyPointsTableBody');
    pointsBody.innerHTML = data.points.map(pt => `
        <tr>
            <td>${escapeHtml(pt.point_number)}</td>
            <td><code>${escapeHtml(pt.code || '')}</code></td>
            <td><small>${escapeHtml(pt.layer_name || '')}</small></td>
            <td><span class="badge-${pt.connectivity_type}">${escapeHtml(pt.connectivity_type || '')}</span></td>
            <td><small>${pt.northing.toFixed(2)}, ${pt.easting.toFixed(2)}, ${pt.elevation.toFixed(2)}</small></td>
            <td>${pt.sequence_id ? '‚úì' : '‚àí'}</td>
        </tr>
    `).join('');
    
    // Populate Sequences table
    const seqBody = document.getElementById('surveySequencesTableBody');
    seqBody.innerHTML = data.sequences.map((seq, idx) => `
        <tr>
            <td>${idx + 1}</td>
            <td><code>${escapeHtml(seq.code)}</code></td>
            <td>${escapeHtml(seq.feature_type || '')}</td>
            <td>${escapeHtml(seq.connectivity_type)}</td>
            <td>${seq.points.length}</td>
            <td>${seq.is_closed ? '‚úì' : '‚úó'}</td>
        </tr>
    `).join('');
    
    // Populate Line Segments table
    const segBody = document.getElementById('surveySegmentsTableBody');
    segBody.innerHTML = data.line_segments.map(seg => `
        <tr>
            <td>${escapeHtml(seg.feature_type || '')}</td>
            <td><small>${escapeHtml(seg.layer_name || '')}</small></td>
            <td>${escapeHtml(seg.connectivity_type)}</td>
            <td>${seg.point_count}</td>
            <td>${seg.is_closed ? '‚úì' : '‚úó'}</td>
            <td><small>${escapeHtml(seg.geometry_wkt.substring(0, 50))}...</small></td>
        </tr>
    `).join('');
}

// Preview tab switching
function switchPreviewTab(tabName) {
    document.querySelectorAll('.preview-tab').forEach(tab => tab.style.display = 'none');
    
    if (tabName === 'points') {
        document.getElementById('pointsPreviewTab').style.display = 'block';
    } else if (tabName === 'sequences') {
        document.getElementById('sequencesPreviewTab').style.display = 'block';
    } else if (tabName === 'segments') {
        document.getElementById('segmentsPreviewTab').style.display = 'block';
    }
    
    event.target.closest('.tab-nav').querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

// Commit import
document.getElementById('surveyCommitBtn').addEventListener('click', async () => {
    if (!surveyPreviewData) {
        alert('No preview data available');
        return;
    }
    
    const drawingSelect = document.getElementById('surveyDrawingSelect');
    const selectedOption = drawingSelect.options[drawingSelect.selectedIndex];
    const projectId = selectedOption.dataset.projectId;
    const drawingId = drawingSelect.value;
    
    if (!projectId || !drawingId) {
        alert('Please select a drawing');
        return;
    }
    
    try {
        document.getElementById('surveyCommitBtn').disabled = true;
        document.getElementById('surveyCommitBtn').textContent = 'Committing...';
        
        const response = await fetch('/api/survey-import/commit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                project_id: projectId,
                drawing_id: drawingId,
                preview_data: surveyPreviewData
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Error committing import: ' + data.error);
            return;
        }
        
        // Show results
        document.getElementById('surveyPreviewSection').style.display = 'none';
        document.getElementById('surveyResultsSection').style.display = 'block';
        
        document.getElementById('surveyPointsImported').textContent = data.points_inserted || 0;
        document.getElementById('surveySequencesCreated').textContent = data.sequences_created || 0;
        document.getElementById('surveySegmentsCreated').textContent = data.line_segments_created || 0;
        
    } catch (error) {
        console.error('Error committing import:', error);
        alert('Failed to commit import');
    } finally {
        document.getElementById('surveyCommitBtn').disabled = false;
        document.getElementById('surveyCommitBtn').textContent = '‚úÖ Commit Import to Database';
    }
});

// Helper function to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
