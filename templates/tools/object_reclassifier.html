<!--
DEPRECATED: This wizard-based reclassifier has been replaced by the new
Classification Review Dashboard (/tools/classification-review).
This file is kept for reference only. It will be removed in a future version.
See: templates/tools/classification_review.html

The new system uses classification metadata in standards_entities instead of
the generic_objects table, and provides ML-powered suggestions with spatial context.
-->
{% extends "base.html" %}

{% block title %}Object Reclassifier (DEPRECATED){% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/ProjectContext.js') }}"></script>
{% endblock %}

{% block content %}
<div class="mc-page-header">
    <div style="background: #ff4444; color: white; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
        <strong>⚠️ DEPRECATED:</strong> This tool has been replaced by the new
        <a href="/tools/classification-review" style="color: white; text-decoration: underline;">Classification Review Dashboard</a>.
        Please use the new tool for better ML-powered classification with spatial context.
    </div>
    <h1><i class="fas fa-exchange-alt"></i> Object Reclassifier (DEPRECATED)</h1>
    <p>Review and reclassify unclassified or low-confidence DXF entities</p>
</div>

<!-- Map Navigation Links -->
<div class="map-navigation-panel" style="position: absolute; top: 60px; right: 15px; z-index: 999; display: flex; flex-direction: column; gap: 8px;">
    <a href="/project-command-center" class="map-nav-link" title="View full project overview with interactive map" style="display: flex; align-items: center; gap: 8px; background: var(--mc-bg-dark); border: 2px solid var(--mc-primary); color: var(--mc-primary); padding: 8px 14px; border-radius: 4px; text-decoration: none; font-family: 'Rajdhani', sans-serif; font-size: 0.85rem; font-weight: 600; transition: all 0.3s; box-shadow: 0 0 10px rgba(0, 255, 255, 0.3); white-space: nowrap;">
        <i class="fas fa-th-large"></i> Command Center
    </a>
    <a href="/map-viewer" class="map-nav-link" title="Access full interactive map with pan and zoom" style="display: flex; align-items: center; gap: 8px; background: var(--mc-bg-dark); border: 2px solid var(--mc-primary); color: var(--mc-primary); padding: 8px 14px; border-radius: 4px; text-decoration: none; font-family: 'Rajdhani', sans-serif; font-size: 0.85rem; font-weight: 600; transition: all 0.3s; box-shadow: 0 0 10px rgba(0, 255, 255, 0.3); white-space: nowrap;">
        <i class="fas fa-map-marked-alt"></i> Map Viewer
    </a>
</div>

<div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem; margin-bottom: 2rem;">
    <!-- Left Panel: Project Selection & Filters -->
    <div class="mc-card">
        <div class="mc-card-header">
            <h2><i class="fas fa-filter"></i> Filters</h2>
        </div>
        <div class="mc-card-content">
            <!-- Review Status Filter -->
            <div class="mc-form-group">
                <label for="statusFilter">Review Status:</label>
                <select id="statusFilter" class="mc-select">
                    <option value="pending">Pending Review</option>
                    <option value="all">All Objects</option>
                    <option value="approved">Approved</option>
                    <option value="reclassified">Reclassified</option>
                    <option value="ignored">Ignored</option>
                </select>
            </div>

            <!-- Confidence Threshold -->
            <div class="mc-form-group">
                <label for="confidenceFilter">Min Confidence:</label>
                <input type="range" id="confidenceFilter" min="0" max="1" step="0.1" value="0" class="mc-slider">
                <span id="confidenceValue">0.0</span>
            </div>

            <button id="loadBtn" class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-sync"></i> Load Objects
            </button>

            <!-- Stats Section -->
            <div id="statsArea" style="margin-top: 2rem; padding: 1rem; background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.2); border-radius: 4px; display: none;">
                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--accent-color);">Statistics</h4>
                <div class="stat-item">
                    <span>Total:</span>
                    <strong id="statTotal">0</strong>
                </div>
                <div class="stat-item">
                    <span>Pending:</span>
                    <strong id="statPending">0</strong>
                </div>
                <div class="stat-item">
                    <span>Reclassified:</span>
                    <strong id="statReclassified">0</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Panel: Object List & Actions -->
    <div class="mc-card">
        <div class="mc-card-header">
            <h2><i class="fas fa-list"></i> Generic Objects</h2>
            <span id="objectCount" class="mc-badge">0 objects</span>
        </div>
        <div class="mc-card-content">
            <div id="objectsContainer">
                <p class="text-dim" style="text-align: center; padding: 3rem;">
                    Select a project and click "Load Objects" to begin
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Reclassification Wizard Modal -->
<div id="reclassifyModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3><i class="fas fa-exchange-alt"></i> Reclassify Object</h3>
            <button class="modal-close" onclick="closeReclassifyModal()">&times;</button>
        </div>
        
        <!-- Progress Indicator -->
        <div class="wizard-progress">
            <div class="wizard-step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Discipline</div>
            </div>
            <div class="wizard-step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Category</div>
            </div>
            <div class="wizard-step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">Type</div>
            </div>
            <div class="wizard-step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-label">Attributes</div>
            </div>
            <div class="wizard-step" data-step="5">
                <div class="step-number">5</div>
                <div class="step-label">Phase</div>
            </div>
            <div class="wizard-step" data-step="6">
                <div class="step-number">6</div>
                <div class="step-label">Review</div>
            </div>
        </div>
        
        <div class="modal-body">
            <!-- Object Context (Always Visible) -->
            <div class="object-context">
                <div class="context-grid">
                    <div class="context-item">
                        <span class="context-label">Current Layer:</span>
                        <span id="modalLayerName" class="context-value"></span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">Entity Type:</span>
                        <span id="modalEntityType" class="context-value"></span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">Geometry:</span>
                        <span id="modalGeometry" class="context-value"></span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">Confidence:</span>
                        <span id="modalConfidence" class="context-value"></span>
                    </div>
                </div>
            </div>
            
            <!-- Layer Name Preview -->
            <div class="layer-preview">
                <label>New Layer Name Preview:</label>
                <div id="layerNamePreview" class="layer-name-display">
                    <span class="preview-segment incomplete">DISCIPLINE</span>-<span class="preview-segment incomplete">CATEGORY</span>-<span class="preview-segment incomplete">TYPE</span>-<span class="preview-segment optional">[ATTRIBUTES]</span>-<span class="preview-segment incomplete">PHASE</span>-<span class="preview-segment auto">GEOMETRY</span>
                </div>
            </div>
            
            <!-- Step 1: Discipline -->
            <div class="wizard-content active" data-step="1">
                <h4><i class="fas fa-layer-group"></i> Select Discipline</h4>
                <p class="step-instruction">Choose the primary discipline for this object</p>
                <div id="disciplineGrid" class="selection-grid"></div>
            </div>
            
            <!-- Step 2: Category -->
            <div class="wizard-content" data-step="2">
                <h4><i class="fas fa-folder"></i> Select Category</h4>
                <p class="step-instruction">Choose the category within <span id="selectedDisciplineName" class="highlight"></span></p>
                <div id="categoryGrid" class="selection-grid"></div>
            </div>
            
            <!-- Step 3: Type -->
            <div class="wizard-content" data-step="3">
                <h4><i class="fas fa-cube"></i> Select Object Type</h4>
                <p class="step-instruction">Choose the specific type within <span id="selectedCategoryName" class="highlight"></span></p>
                <div id="typeGrid" class="selection-grid"></div>
            </div>
            
            <!-- Step 4: Attributes -->
            <div class="wizard-content" data-step="4">
                <h4><i class="fas fa-tags"></i> Select Attributes (Optional)</h4>
                <p class="step-instruction">Add size, material, or other attributes for <span id="selectedTypeName" class="highlight"></span></p>
                <div id="attributesList" class="attribute-list"></div>
                <p class="text-dim" style="font-size: 0.85rem; margin-top: 1rem;">
                    <i class="fas fa-info-circle"></i> Attributes are optional details like pipe diameter (12IN), material (PVC), or slope (2PCT)
                </p>
            </div>
            
            <!-- Step 5: Phase -->
            <div class="wizard-content" data-step="5">
                <h4><i class="fas fa-clock"></i> Select Phase</h4>
                <p class="step-instruction">Choose the construction or design phase</p>
                <div id="phaseGrid" class="selection-grid"></div>
            </div>
            
            <!-- Step 6: Review -->
            <div class="wizard-content" data-step="6">
                <h4><i class="fas fa-check-circle"></i> Review & Confirm</h4>
                <div class="review-summary">
                    <div class="summary-item">
                        <span class="summary-label">Discipline:</span>
                        <span id="reviewDiscipline" class="summary-value"></span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Category:</span>
                        <span id="reviewCategory" class="summary-value"></span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Type:</span>
                        <span id="reviewType" class="summary-value"></span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Attributes:</span>
                        <span id="reviewAttributes" class="summary-value"></span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Phase:</span>
                        <span id="reviewPhase" class="summary-value"></span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Geometry:</span>
                        <span id="reviewGeometry" class="summary-value"></span>
                    </div>
                    <div class="summary-item highlight">
                        <span class="summary-label">Final Layer Name:</span>
                        <span id="reviewLayerName" class="summary-value" style="font-family: 'Courier New', monospace;"></span>
                    </div>
                </div>
                
                <div class="mc-form-group" style="margin-top: 1.5rem;">
                    <label for="reclassifyNotes">Notes (optional):</label>
                    <textarea id="reclassifyNotes" class="mc-textarea" rows="3" placeholder="Add any notes about this reclassification..."></textarea>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button id="wizardBackBtn" onclick="wizardBack()" class="btn btn-secondary" style="display: none;">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <button onclick="closeReclassifyModal()" class="btn btn-secondary">Cancel</button>
            <button id="wizardNextBtn" onclick="wizardNext()" class="btn btn-primary" disabled>
                Next <i class="fas fa-arrow-right"></i>
            </button>
            <button id="wizardSubmitBtn" onclick="submitReclassification()" class="btn btn-success" style="display: none;">
                <i class="fas fa-check"></i> Reclassify
            </button>
        </div>
    </div>
</div>

<style>
.map-nav-link:hover {
    background: var(--mc-primary) !important;
    color: var(--mc-bg-dark) !important;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.6) !important;
    transform: translateX(-4px);
}

.stat-item {
    display: flex;
    justify-content: space-between;
    padding: 0.25rem 0;
    font-size: 0.85rem;
}

.object-card {
    padding: 1rem;
    margin-bottom: 1rem;
    background: rgba(0,255,255,0.03);
    border: 1px solid rgba(0,255,255,0.1);
    border-radius: 4px;
    transition: all 0.2s;
}

.object-card:hover {
    background: rgba(0,255,255,0.08);
    border-color: rgba(0,255,255,0.3);
}

.object-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.object-name {
    font-weight: 600;
    color: var(--accent-color);
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending { background: rgba(255,165,0,0.2); color: #ffa500; }
.status-approved { background: rgba(0,255,0,0.2); color: #00ff00; }
.status-reclassified { background: rgba(0,191,255,0.2); color: #00bfff; }
.status-ignored { background: rgba(128,128,128,0.2); color: #999; }

.object-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: 0.85rem;
}

.detail-item {
    display: flex;
    flex-direction: column;
}

.detail-label {
    color: var(--text-dim);
    font-size: 0.75rem;
    margin-bottom: 0.1rem;
}

.detail-value {
    font-family: 'Courier New', monospace;
    color: var(--text-color);
}

.confidence-bar {
    height: 4px;
    background: rgba(0,255,255,0.1);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 0.75rem;
}

.confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #ff4444, #ffaa00, #00ff00);
    transition: width 0.3s;
}

.object-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
}

.info-display {
    padding: 0.75rem;
    background: rgba(0,255,255,0.05);
    border: 1px solid rgba(0,255,255,0.2);
    border-radius: 4px;
    font-family: 'Courier New', monospace;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

/* Wizard Styles */
.wizard-progress {
    display: flex;
    justify-content: space-between;
    padding: 1.5rem 2rem;
    background: rgba(0,255,255,0.03);
    border-bottom: 1px solid rgba(0,255,255,0.2);
}

.wizard-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
    position: relative;
    opacity: 0.4;
    transition: opacity 0.3s;
}

.wizard-step.active,
.wizard-step.completed {
    opacity: 1;
}

.wizard-step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 15px;
    left: 50%;
    width: 100%;
    height: 2px;
    background: rgba(0,255,255,0.2);
    z-index: -1;
}

.wizard-step.completed:not(:last-child)::after {
    background: var(--accent-color);
}

.step-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: rgba(0,255,255,0.1);
    border: 2px solid rgba(0,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
}

.wizard-step.active .step-number {
    background: var(--accent-color);
    border-color: var(--accent-color);
    color: var(--bg-primary);
}

.wizard-step.completed .step-number {
    background: var(--accent-color);
    border-color: var(--accent-color);
}

.wizard-step.completed .step-number::before {
    content: '\f00c';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
}

.step-label {
    font-size: 0.75rem;
    text-align: center;
    color: var(--text-dim);
}

.wizard-step.active .step-label {
    color: var(--accent-color);
    font-weight: 600;
}

.wizard-content {
    display: none;
    padding: 1.5rem 0;
    min-height: 300px;
}

.wizard-content.active {
    display: block;
}

.wizard-content h4 {
    margin: 0 0 0.5rem 0;
    color: var(--accent-color);
}

.step-instruction {
    margin: 0 0 1.5rem 0;
    color: var(--text-dim);
    font-size: 0.9rem;
}

.highlight {
    color: var(--accent-color);
    font-weight: 600;
}

.object-context {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: rgba(0,255,255,0.03);
    border: 1px solid rgba(0,255,255,0.15);
    border-radius: 6px;
}

.context-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
}

.context-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.context-label {
    font-size: 0.75rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.context-value {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    color: var(--text-color);
}

.layer-preview {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: rgba(0,0,0,0.3);
    border: 2px dashed rgba(0,255,255,0.3);
    border-radius: 6px;
}

.layer-preview label {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
    color: var(--text-dim);
}

.layer-name-display {
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-color);
    letter-spacing: 1px;
}

.preview-segment {
    padding: 2px 4px;
    border-radius: 3px;
}

.preview-segment.incomplete {
    color: rgba(255,255,255,0.3);
}

.preview-segment.complete {
    color: var(--accent-color);
    background: rgba(0,255,255,0.1);
}

.preview-segment.optional {
    color: rgba(255,255,255,0.4);
    font-style: italic;
}

.preview-segment.auto {
    color: #00ff00;
}

.selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.75rem;
}

.selection-card {
    padding: 1rem;
    background: rgba(0,255,255,0.05);
    border: 2px solid rgba(0,255,255,0.2);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.selection-card:hover {
    background: rgba(0,255,255,0.1);
    border-color: rgba(0,255,255,0.4);
    transform: translateY(-2px);
}

.selection-card.selected {
    background: rgba(0,255,255,0.15);
    border-color: var(--accent-color);
    box-shadow: 0 0 10px rgba(0,255,255,0.3);
}

.selection-code {
    font-weight: 700;
    color: var(--accent-color);
    font-family: 'Courier New', monospace;
    margin-bottom: 0.25rem;
}

.selection-name {
    font-size: 0.9rem;
    color: var(--text-color);
}

.selection-desc {
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-top: 0.25rem;
}

.attribute-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.attribute-checkbox {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    background: rgba(0,255,255,0.05);
    border: 1px solid rgba(0,255,255,0.2);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.attribute-checkbox:hover {
    background: rgba(0,255,255,0.1);
    border-color: rgba(0,255,255,0.4);
}

.attribute-checkbox.selected {
    background: rgba(0,255,255,0.15);
    border-color: var(--accent-color);
}

.attribute-checkbox input[type="checkbox"] {
    margin-right: 0.75rem;
    width: 18px;
    height: 18px;
}

.attribute-info {
    flex: 1;
}

.attribute-code {
    font-weight: 600;
    color: var(--accent-color);
    font-family: 'Courier New', monospace;
}

.attribute-name {
    font-size: 0.85rem;
    color: var(--text-dim);
    margin-left: 0.5rem;
}

.review-summary {
    background: rgba(0,255,255,0.03);
    border: 1px solid rgba(0,255,255,0.2);
    border-radius: 6px;
    padding: 1.5rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(0,255,255,0.1);
}

.summary-item:last-child {
    border-bottom: none;
}

.summary-item.highlight {
    background: rgba(0,255,255,0.08);
    padding: 1rem;
    margin: 0.5rem -0.5rem;
    border-radius: 4px;
}

.summary-label {
    font-weight: 600;
    color: var(--text-dim);
}

.summary-value {
    color: var(--text-color);
}

.modal-content {
    background: var(--bg-secondary);
    border: 1px solid rgba(0,255,255,0.3);
    border-radius: 8px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(0,255,255,0.2);
}

.modal-header h3 {
    margin: 0;
    color: var(--accent-color);
}

.modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    color: var(--text-dim);
    cursor: pointer;
    padding: 0;
    line-height: 1;
}

.modal-close:hover {
    color: var(--accent-color);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem;
    border-top: 1px solid rgba(0,255,255,0.2);
}

.mc-slider {
    width: 100%;
}
</style>

<script>
let currentProjectId = null;
let currentObjects = [];
let selectedObjectId = null;

// Wizard state management
const wizardState = {
    currentStep: 1,
    selectedDiscipline: null,
    selectedCategory: null,
    selectedType: null,
    selectedAttributes: [],
    selectedPhase: null,
    geometryCode: null,
    
    disciplineName: '',
    categoryName: '',
    typeName: '',
    phaseName: '',
    
    reset() {
        this.currentStep = 1;
        this.selectedDiscipline = null;
        this.selectedCategory = null;
        this.selectedType = null;
        this.selectedAttributes = [];
        this.selectedPhase = null;
        this.geometryCode = null;
        this.disciplineName = '';
        this.categoryName = '';
        this.typeName = '';
        this.phaseName = '';
    }
};

// Vocabulary data cache
const vocabularyCache = {
    disciplines: null,
    phases: null,
    geometries: null,
    categories: {},
    types: {},
    attributes: {}
};

// Load projects on page load
const projectContext = new ProjectContext();

document.addEventListener('DOMContentLoaded', async function() {
    await projectContext.init();

    const activeProject = projectContext.getActiveProject();
    if (!activeProject) {
        alert('Please select a project from the header');
        return;
    }

    currentProjectId = activeProject.project_id;

    document.getElementById('confidenceFilter').addEventListener('input', function(e) {
        document.getElementById('confidenceValue').textContent = parseFloat(e.target.value).toFixed(1);
    });

    // Reload data when project changes
    projectContext.onProjectChange(async () => {
        const newActiveProject = projectContext.getActiveProject();
        if (newActiveProject) {
            currentProjectId = newActiveProject.project_id;
            currentObjects = [];
            displayObjects([]);
        }
    });
});

document.getElementById('loadBtn').addEventListener('click', async function() {
    const activeProject = projectContext.getActiveProject();
    if (!activeProject) {
        alert('Please select a project from the header');
        return;
    }

    currentProjectId = activeProject.project_id;
    const projectId = currentProjectId;
    const status = document.getElementById('statusFilter').value;
    const minConfidence = parseFloat(document.getElementById('confidenceFilter').value);
    
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    
    try {
        let url = `/api/projects/${projectId}/generic-objects?`;
        if (status !== 'all') {
            url += `status=${status}&`;
        }
        if (minConfidence > 0) {
            url += `min_confidence=${minConfidence}`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        currentObjects = data.objects || [];
        displayObjects(currentObjects);
        updateStats(data.summary || {});
        
    } catch (error) {
        console.error('Error loading objects:', error);
        alert('Error loading objects');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync"></i> Load Objects';
    }
});

function displayObjects(objects) {
    const container = document.getElementById('objectsContainer');
    
    if (objects.length === 0) {
        container.innerHTML = '<p class="text-dim" style="text-align: center; padding: 3rem;">No objects found with current filters</p>';
        document.getElementById('objectCount').textContent = '0 objects';
        return;
    }
    
    document.getElementById('objectCount').textContent = `${objects.length} object${objects.length !== 1 ? 's' : ''}`;
    
    container.innerHTML = objects.map(obj => `
        <div class="object-card">
            <div class="object-header">
                <div class="object-name">${obj.object_name || 'Unnamed Object'}</div>
                <span class="status-badge status-${obj.review_status}">${obj.review_status}</span>
            </div>
            
            <div class="confidence-bar">
                <div class="confidence-fill" style="width: ${(obj.classification_confidence * 100).toFixed(0)}%"></div>
            </div>
            
            <div class="object-details">
                <div class="detail-item">
                    <span class="detail-label">Layer</span>
                    <span class="detail-value">${obj.original_layer_name || 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Entity Type</span>
                    <span class="detail-value">${obj.original_entity_type || 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Confidence</span>
                    <span class="detail-value">${(obj.classification_confidence * 100).toFixed(1)}%</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Suggested</span>
                    <span class="detail-value">${obj.suggested_object_type || 'None'}</span>
                </div>
            </div>
            
            <div class="object-actions">
                <button class="btn btn-primary btn-sm" onclick="openReclassifyModal('${obj.object_id}')">
                    <i class="fas fa-exchange-alt"></i> Reclassify
                </button>
                <button class="btn btn-secondary btn-sm" onclick="approveObject('${obj.object_id}')">
                    <i class="fas fa-check"></i> Approve
                </button>
                <button class="btn btn-secondary btn-sm" onclick="ignoreObject('${obj.object_id}')">
                    <i class="fas fa-ban"></i> Ignore
                </button>
            </div>
        </div>
    `).join('');
}

function updateStats(summary) {
    document.getElementById('statsArea').style.display = 'block';
    document.getElementById('statTotal').textContent = summary.total || 0;
    document.getElementById('statPending').textContent = summary.by_status?.pending || 0;
    document.getElementById('statReclassified').textContent = summary.by_status?.reclassified || 0;
}

// ============================================
// VOCABULARY DATA LOADING FUNCTIONS
// ============================================

async function loadVocabularyData() {
    try {
        if (!vocabularyCache.disciplines) {
            const response = await fetch('/api/vocabulary/disciplines');
            const data = await response.json();
            vocabularyCache.disciplines = data.disciplines || [];
        }
        
        if (!vocabularyCache.phases) {
            const response = await fetch('/api/vocabulary/phases');
            const data = await response.json();
            vocabularyCache.phases = data.phases || [];
        }
        
        if (!vocabularyCache.geometries) {
            const response = await fetch('/api/vocabulary/geometries');
            const data = await response.json();
            vocabularyCache.geometries = data.geometries || [];
        }
    } catch (error) {
        console.error('Error loading vocabulary data:', error);
        throw error;
    }
}

async function loadCategories(disciplineId) {
    if (vocabularyCache.categories[disciplineId]) {
        return vocabularyCache.categories[disciplineId];
    }
    
    try {
        const response = await fetch(`/api/vocabulary/categories?discipline_id=${disciplineId}`);
        const data = await response.json();
        vocabularyCache.categories[disciplineId] = data.categories || [];
        return vocabularyCache.categories[disciplineId];
    } catch (error) {
        console.error('Error loading categories:', error);
        return [];
    }
}

async function loadTypes(categoryId) {
    if (vocabularyCache.types[categoryId]) {
        return vocabularyCache.types[categoryId];
    }
    
    try {
        const response = await fetch(`/api/vocabulary/object-types?category_id=${categoryId}`);
        const data = await response.json();
        vocabularyCache.types[categoryId] = data.object_types || [];
        return vocabularyCache.types[categoryId];
    } catch (error) {
        console.error('Error loading types:', error);
        return [];
    }
}

async function loadApplicableAttributes(categoryId, typeId) {
    const cacheKey = `${categoryId}_${typeId}`;
    if (vocabularyCache.attributes[cacheKey]) {
        return vocabularyCache.attributes[cacheKey];
    }
    
    try {
        const response = await fetch(`/api/vocabulary/attribute-applicability?category_id=${categoryId}&type_id=${typeId}`);
        const data = await response.json();
        vocabularyCache.attributes[cacheKey] = data.attributes || [];
        return vocabularyCache.attributes[cacheKey];
    } catch (error) {
        console.error('Error loading applicable attributes:', error);
        return [];
    }
}

// ============================================
// WIZARD NAVIGATION FUNCTIONS
// ============================================

function updateWizardUI() {
    document.querySelectorAll('.wizard-step').forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.remove('active', 'completed');
        
        if (stepNum < wizardState.currentStep) {
            step.classList.add('completed');
        } else if (stepNum === wizardState.currentStep) {
            step.classList.add('active');
        }
    });
    
    document.querySelectorAll('.wizard-content').forEach((content, index) => {
        content.classList.toggle('active', index + 1 === wizardState.currentStep);
    });
    
    const backBtn = document.getElementById('wizardBackBtn');
    const nextBtn = document.getElementById('wizardNextBtn');
    const submitBtn = document.getElementById('wizardSubmitBtn');
    
    backBtn.style.display = wizardState.currentStep > 1 ? 'inline-block' : 'none';
    
    if (wizardState.currentStep === 6) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'inline-block';
    } else {
        nextBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
        
        const isStepValid = validateCurrentStep();
        nextBtn.disabled = !isStepValid;
    }
    
    updateLayerPreview();
}

function validateCurrentStep() {
    switch (wizardState.currentStep) {
        case 1:
            return wizardState.selectedDiscipline !== null;
        case 2:
            return wizardState.selectedCategory !== null;
        case 3:
            return wizardState.selectedType !== null;
        case 4:
            return true;
        case 5:
            return wizardState.selectedPhase !== null;
        case 6:
            return true;
        default:
            return false;
    }
}

async function wizardNext() {
    if (!validateCurrentStep()) {
        return;
    }
    
    wizardState.currentStep++;
    
    if (wizardState.currentStep === 2) {
        await renderCategories();
    } else if (wizardState.currentStep === 3) {
        await renderTypes();
    } else if (wizardState.currentStep === 4) {
        await renderAttributes();
    } else if (wizardState.currentStep === 5) {
        renderPhases();
    } else if (wizardState.currentStep === 6) {
        renderReview();
    }
    
    updateWizardUI();
}

function wizardBack() {
    if (wizardState.currentStep > 1) {
        wizardState.currentStep--;
        updateWizardUI();
    }
}

// ============================================
// LAYER NAME PREVIEW
// ============================================

function updateLayerPreview() {
    const preview = document.getElementById('layerNamePreview');
    
    const discCode = wizardState.selectedDiscipline 
        ? vocabularyCache.disciplines.find(d => d.discipline_id === Number(wizardState.selectedDiscipline))?.code || 'DISC'
        : 'DISCIPLINE';
    
    const catCode = wizardState.selectedCategory
        ? (vocabularyCache.categories[wizardState.selectedDiscipline] || []).find(c => c.category_id === Number(wizardState.selectedCategory))?.code || 'CAT'
        : 'CATEGORY';
    
    const typeCode = wizardState.selectedType
        ? (vocabularyCache.types[wizardState.selectedCategory] || []).find(t => t.type_id === Number(wizardState.selectedType))?.code || 'TYPE'
        : 'TYPE';
    
    let attrSegment = '';
    if (wizardState.selectedAttributes.length > 0) {
        const attrCodes = wizardState.selectedAttributes.map(attrId => {
            const cacheKey = `${wizardState.selectedCategory}_${wizardState.selectedType}`;
            const attrs = vocabularyCache.attributes[cacheKey] || [];
            const attr = attrs.find(a => a.attribute_id === Number(attrId));
            return attr?.code || 'ATTR';
        });
        attrSegment = attrCodes.join('-');
    }
    
    const phaseCode = wizardState.selectedPhase
        ? (vocabularyCache.phases || []).find(p => p.phase_id === Number(wizardState.selectedPhase))?.code || 'PHASE'
        : 'PHASE';
    
    const geomCode = wizardState.geometryCode || 'GEOM';
    
    let html = '';
    html += `<span class="preview-segment ${wizardState.selectedDiscipline ? 'complete' : 'incomplete'}">${discCode}</span>`;
    html += '-';
    html += `<span class="preview-segment ${wizardState.selectedCategory ? 'complete' : 'incomplete'}">${catCode}</span>`;
    html += '-';
    html += `<span class="preview-segment ${wizardState.selectedType ? 'complete' : 'incomplete'}">${typeCode}</span>`;
    
    if (attrSegment) {
        html += '-';
        html += `<span class="preview-segment complete">${attrSegment}</span>`;
    } else {
        html += '-';
        html += `<span class="preview-segment optional">[ATTRIBUTES]</span>`;
    }
    
    html += '-';
    html += `<span class="preview-segment ${wizardState.selectedPhase ? 'complete' : 'incomplete'}">${phaseCode}</span>`;
    html += '-';
    html += `<span class="preview-segment auto">${geomCode}</span>`;
    
    preview.innerHTML = html;
}

// ============================================
// STEP-SPECIFIC RENDERING FUNCTIONS
// ============================================

function renderDisciplines() {
    const grid = document.getElementById('disciplineGrid');
    const disciplines = vocabularyCache.disciplines || [];
    
    if (disciplines.length === 0) {
        grid.innerHTML = '<p class="text-dim">No disciplines available</p>';
        return;
    }
    
    grid.innerHTML = disciplines.map(disc => `
        <div class="selection-card ${wizardState.selectedDiscipline === disc.discipline_id ? 'selected' : ''}" 
             onclick="selectDiscipline('${disc.discipline_id}', '${disc.code}')">
            <div class="selection-code">${disc.code}</div>
            <div class="selection-name">${disc.full_name}</div>
            ${disc.description ? `<div class="selection-desc">${disc.description}</div>` : ''}
        </div>
    `).join('');
}

async function renderCategories() {
    const grid = document.getElementById('categoryGrid');
    grid.innerHTML = '<p class="text-dim"><i class="fas fa-spinner fa-spin"></i> Loading categories...</p>';
    
    const categories = await loadCategories(wizardState.selectedDiscipline);
    
    document.getElementById('selectedDisciplineName').textContent = wizardState.disciplineName;
    
    if (categories.length === 0) {
        grid.innerHTML = '<p class="text-dim">No categories available for this discipline</p>';
        return;
    }
    
    grid.innerHTML = categories.map(cat => `
        <div class="selection-card ${wizardState.selectedCategory === cat.category_id ? 'selected' : ''}" 
             onclick="selectCategory('${cat.category_id}', '${cat.code}')">
            <div class="selection-code">${cat.code}</div>
            <div class="selection-name">${cat.full_name}</div>
            ${cat.description ? `<div class="selection-desc">${cat.description}</div>` : ''}
        </div>
    `).join('');
}

async function renderTypes() {
    const grid = document.getElementById('typeGrid');
    grid.innerHTML = '<p class="text-dim"><i class="fas fa-spinner fa-spin"></i> Loading types...</p>';
    
    const types = await loadTypes(wizardState.selectedCategory);
    
    document.getElementById('selectedCategoryName').textContent = wizardState.categoryName;
    
    if (types.length === 0) {
        grid.innerHTML = '<p class="text-dim">No types available for this category</p>';
        return;
    }
    
    grid.innerHTML = types.map(type => `
        <div class="selection-card ${wizardState.selectedType === type.type_id ? 'selected' : ''}" 
             onclick="selectType('${type.type_id}', '${type.code}')">
            <div class="selection-code">${type.code}</div>
            <div class="selection-name">${type.full_name}</div>
            ${type.description ? `<div class="selection-desc">${type.description}</div>` : ''}
        </div>
    `).join('');
}

async function renderAttributes() {
    const container = document.getElementById('attributesList');
    container.innerHTML = '<p class="text-dim"><i class="fas fa-spinner fa-spin"></i> Loading attributes...</p>';
    
    const attributes = await loadApplicableAttributes(wizardState.selectedCategory, wizardState.selectedType);
    
    document.getElementById('selectedTypeName').textContent = wizardState.typeName;
    
    if (attributes.length === 0) {
        container.innerHTML = '<p class="text-dim">No applicable attributes for this type. You may skip this step.</p>';
        return;
    }
    
    container.innerHTML = attributes.map(attr => `
        <label class="attribute-checkbox ${wizardState.selectedAttributes.includes(attr.attribute_id) ? 'selected' : ''}">
            <input type="checkbox" 
                   value="${attr.attribute_id}" 
                   ${wizardState.selectedAttributes.includes(attr.attribute_id) ? 'checked' : ''}
                   onchange="toggleAttribute('${attr.attribute_id}')">
            <div class="attribute-info">
                <span class="attribute-code">${attr.code}</span>
                <span class="attribute-name">${attr.full_name}</span>
            </div>
        </label>
    `).join('');
}

function renderPhases() {
    const grid = document.getElementById('phaseGrid');
    const phases = vocabularyCache.phases || [];
    
    if (phases.length === 0) {
        grid.innerHTML = '<p class="text-dim">No phases available</p>';
        return;
    }
    
    grid.innerHTML = phases.map(phase => `
        <div class="selection-card ${wizardState.selectedPhase === phase.phase_id ? 'selected' : ''}" 
             onclick="selectPhase('${phase.phase_id}', '${phase.code}')">
            <div class="selection-code">${phase.code}</div>
            <div class="selection-name">${phase.full_name}</div>
            ${phase.description ? `<div class="selection-desc">${phase.description}</div>` : ''}
        </div>
    `).join('');
}

function renderReview() {
    document.getElementById('reviewDiscipline').textContent = wizardState.disciplineName;
    document.getElementById('reviewCategory').textContent = wizardState.categoryName;
    document.getElementById('reviewType').textContent = wizardState.typeName;
    
    const attrNames = wizardState.selectedAttributes.map(attrId => {
        const cacheKey = `${wizardState.selectedCategory}_${wizardState.selectedType}`;
        const attrs = vocabularyCache.attributes[cacheKey] || [];
        const attr = attrs.find(a => a.attribute_id === attrId);
        return attr ? `${attr.code} (${attr.full_name})` : 'Unknown';
    });
    document.getElementById('reviewAttributes').textContent = attrNames.length > 0 ? attrNames.join(', ') : 'None';
    
    document.getElementById('reviewPhase').textContent = wizardState.phaseName;
    document.getElementById('reviewGeometry').textContent = wizardState.geometryCode || 'N/A';
    
    const layerName = buildLayerName();
    document.getElementById('reviewLayerName').textContent = layerName;
}

// ============================================
// SELECTION HANDLERS
// ============================================

function selectDiscipline(disciplineId, disciplineCode) {
    wizardState.selectedDiscipline = disciplineId;
    wizardState.disciplineName = disciplineCode;
    
    wizardState.selectedCategory = null;
    wizardState.selectedType = null;
    wizardState.selectedAttributes = [];
    wizardState.selectedPhase = null;
    
    renderDisciplines();
    updateWizardUI();
}

function selectCategory(categoryId, categoryCode) {
    wizardState.selectedCategory = categoryId;
    wizardState.categoryName = categoryCode;
    
    wizardState.selectedType = null;
    wizardState.selectedAttributes = [];
    
    renderCategories();
    updateWizardUI();
}

function selectType(typeId, typeCode) {
    wizardState.selectedType = typeId;
    wizardState.typeName = typeCode;
    
    wizardState.selectedAttributes = [];
    
    renderTypes();
    updateWizardUI();
}

function toggleAttribute(attributeId) {
    const index = wizardState.selectedAttributes.indexOf(attributeId);
    
    if (index > -1) {
        wizardState.selectedAttributes.splice(index, 1);
    } else {
        wizardState.selectedAttributes.push(attributeId);
    }
    
    const checkbox = document.querySelector(`input[value="${attributeId}"]`);
    if (checkbox) {
        const label = checkbox.closest('.attribute-checkbox');
        label.classList.toggle('selected', checkbox.checked);
    }
    
    updateLayerPreview();
}

function selectPhase(phaseId, phaseCode) {
    wizardState.selectedPhase = phaseId;
    wizardState.phaseName = phaseCode;
    
    renderPhases();
    updateWizardUI();
}

// ============================================
// LAYER NAME BUILDING
// ============================================

function buildLayerName() {
    const discCode = vocabularyCache.disciplines.find(d => d.discipline_id === wizardState.selectedDiscipline)?.code || '';
    const catCode = (vocabularyCache.categories[wizardState.selectedDiscipline] || []).find(c => c.category_id === wizardState.selectedCategory)?.code || '';
    const typeCode = (vocabularyCache.types[wizardState.selectedCategory] || []).find(t => t.type_id === wizardState.selectedType)?.code || '';
    
    const attrCodes = wizardState.selectedAttributes.map(attrId => {
        const cacheKey = `${wizardState.selectedCategory}_${wizardState.selectedType}`;
        const attrs = vocabularyCache.attributes[cacheKey] || [];
        const attr = attrs.find(a => a.attribute_id === attrId);
        return attr?.code || '';
    }).filter(code => code);
    
    const phaseCode = (vocabularyCache.phases || []).find(p => p.phase_id === wizardState.selectedPhase)?.code || '';
    const geomCode = wizardState.geometryCode || '';
    
    let layerName = `${discCode}-${catCode}-${typeCode}`;
    
    if (attrCodes.length > 0) {
        layerName += `-${attrCodes.join('-')}`;
    }
    
    layerName += `-${phaseCode}-${geomCode}`;
    
    return layerName;
}

// ============================================
// MODAL FUNCTIONS
// ============================================

async function openReclassifyModal(objectId) {
    const obj = currentObjects.find(o => o.object_id === objectId);
    if (!obj) return;
    
    selectedObjectId = objectId;
    wizardState.reset();
    
    document.getElementById('modalLayerName').textContent = obj.original_layer_name || 'N/A';
    document.getElementById('modalEntityType').textContent = obj.original_entity_type || 'N/A';
    
    const geomMap = {
        'LINE': 'LN',
        'POLYLINE': 'LN',
        'LWPOLYLINE': 'LN',
        'CIRCLE': 'CR',
        'ARC': 'AR',
        'POINT': 'PT',
        'INSERT': 'BK',
        'TEXT': 'TX',
        'MTEXT': 'TX',
        'HATCH': 'HT',
        'SOLID': 'SD'
    };
    
    wizardState.geometryCode = geomMap[obj.original_entity_type] || 'UN';
    
    document.getElementById('modalGeometry').textContent = wizardState.geometryCode;
    document.getElementById('modalConfidence').textContent = `${(obj.classification_confidence * 100).toFixed(1)}%`;
    
    try {
        await loadVocabularyData();
        renderDisciplines();
        updateWizardUI();
        
        document.getElementById('reclassifyModal').style.display = 'flex';
    } catch (error) {
        console.error('Error initializing wizard:', error);
        alert('Error loading vocabulary data. Please try again.');
    }
}

function closeReclassifyModal() {
    document.getElementById('reclassifyModal').style.display = 'none';
    selectedObjectId = null;
    wizardState.reset();
}

async function submitReclassification() {
    const layerName = buildLayerName();
    const notes = document.getElementById('reclassifyNotes').value;
    
    if (!layerName) {
        alert('Unable to build layer name');
        return;
    }
    
    // Look up geometry_id from geometry code
    const geometry = (vocabularyCache.geometries || []).find(g => g.code === wizardState.geometryCode);
    if (!geometry) {
        alert('Geometry not found in vocabulary. Please refresh and try again.');
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${currentProjectId}/generic-objects/${selectedObjectId}/reclassify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                discipline_id: wizardState.selectedDiscipline,
                category_id: wizardState.selectedCategory,
                type_id: wizardState.selectedType,
                attribute_ids: wizardState.selectedAttributes,
                phase_id: wizardState.selectedPhase,
                geometry_id: geometry.geometry_id,
                notes: notes 
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            alert(`Success! Reclassified to layer: ${result.layer_name}`);
            closeReclassifyModal();
            document.getElementById('loadBtn').click();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Reclassification failed'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error submitting reclassification');
    }
}

async function approveObject(objectId) {
    if (!confirm('Approve this object as-is? It will be marked as approved and no changes will be made.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${currentProjectId}/generic-objects/${objectId}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: 'Approved via UI' })
        });
        
        if (response.ok) {
            document.getElementById('loadBtn').click();
        } else {
            alert('Error approving object');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error approving object');
    }
}

async function ignoreObject(objectId) {
    if (!confirm('Ignore this object? It will be hidden from review but remain in the database.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${currentProjectId}/generic-objects/${objectId}/ignore`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: 'Ignored via UI' })
        });
        
        if (response.ok) {
            document.getElementById('loadBtn').click();
        } else {
            alert('Error ignoring object');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error ignoring object');
    }
}
</script>
{% endblock %}
