{% extends "base.html" %}
{% block title %}Classification Review{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<div class="mc-page-header">
    <h1><i class="fas fa-tasks"></i> Classification Review</h1>
    <p>Review and classify entities with uncertain or low-confidence classifications</p>
</div>

<div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem;">
    <!-- LEFT PANEL: Filters -->
    <div class="mc-card">
        <div class="mc-card-header">
            <h2><i class="fas fa-filter"></i> Filters</h2>
        </div>
        <div class="mc-card-content">
            <!-- Confidence Range -->
            <div class="mc-form-group">
                <label>Confidence Range:</label>
                <input type="range" id="minConfidence" min="0" max="1" step="0.1" value="0"
                       oninput="updateConfidenceLabel(); loadReviewQueue()">
                <input type="range" id="maxConfidence" min="0" max="1" step="0.1" value="1"
                       oninput="updateConfidenceLabel(); loadReviewQueue()">
                <div id="confidenceLabel" class="text-dim" style="font-size: 0.85rem; margin-top: 0.5rem;">
                    0.0 - 1.0
                </div>
            </div>

            <!-- Geometry Type -->
            <div class="mc-form-group">
                <label>Geometry:</label>
                <div class="mc-checkbox-group">
                    <label><input type="checkbox" checked onchange="loadReviewQueue()"> Points</label>
                    <label><input type="checkbox" checked onchange="loadReviewQueue()"> Lines</label>
                    <label><input type="checkbox" checked onchange="loadReviewQueue()"> Polygons</label>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-box" style="margin-top: 2rem; padding: 1rem; background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.2); border-radius: 4px;">
                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Queue Stats</h4>
                <div class="stat-row">
                    <span>Total:</span>
                    <strong id="statTotal">0</strong>
                </div>
                <div class="stat-row">
                    <span>Selected:</span>
                    <strong id="statSelected">0</strong>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div class="mc-form-group" style="margin-top: 2rem;">
                <button id="bulkReclassifyBtn" class="btn btn-primary" style="width: 100%;" onclick="bulkReclassifySelected()" disabled>
                    <i class="fas fa-tasks"></i> Bulk Reclassify
                </button>
                <button class="btn btn-success" style="width: 100%; margin-top: 0.5rem;" onclick="approveAllAISuggestions()" disabled id="approveAIBtn">
                    <i class="fas fa-magic"></i> Approve Top AI Suggestions
                </button>
            </div>
        </div>
    </div>

    <!-- RIGHT PANEL: Entity List & Context -->
    <div class="mc-card">
        <div class="mc-card-header">
            <h2><i class="fas fa-list"></i> Entities Needing Review</h2>
            <span id="entityCount" class="mc-badge">0 entities</span>
        </div>
        <div class="mc-card-content">
            <!-- Entity Table -->
            <div style="overflow-x: auto;">
                <table class="mc-table" id="entityTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th>Preview</th>
                            <th>Layer</th>
                            <th>Geometry</th>
                            <th>Confidence</th>
                            <th>Top Suggestion</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="entityTableBody">
                        <tr>
                            <td colspan="7" class="text-center text-dim">
                                Click "Load Review Queue" to begin
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Reclassification Modal -->
<div id="reclassifyModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3><i class="fas fa-exchange-alt"></i> Reclassify Entity</h3>
            <button class="modal-close" onclick="closeReclassifyModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Geometry Preview -->
            <div class="geometry-preview-section" style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem;">
                    <i class="fas fa-draw-polygon"></i> Geometry Preview
                </h4>
                <div id="geometryPreview" style="background: #1a1a1a; border-radius: 4px; padding: 10px; text-align: center;">
                    <svg width="400" height="300" style="background: #1a1a1a;">
                        <text x="200" y="150" fill="#666" font-size="14" text-anchor="middle">Loading...</text>
                    </svg>
                </div>
            </div>

            <!-- Entity Context -->
            <div class="entity-context" style="padding: 1rem; background: rgba(0,255,255,0.05); border-radius: 4px; margin-bottom: 1.5rem;">
                <div class="context-row">
                    <span class="label">Layer:</span>
                    <span id="modalLayer" class="value"></span>
                </div>
                <div class="context-row">
                    <span class="label">Current Type:</span>
                    <span id="modalCurrentType" class="value"></span>
                </div>
                <div class="context-row">
                    <span class="label">Confidence:</span>
                    <span id="modalConfidence" class="value"></span>
                </div>
            </div>

            <!-- Spatial Context -->
            <div id="spatialContextSection" style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem;">
                    <i class="fas fa-map-marker-alt"></i> Spatial Context
                </h4>
                <div id="spatialContextContent" class="text-dim">
                    <p>Loading spatial context...</p>
                </div>
            </div>

            <!-- AI Suggestions -->
            <div id="suggestionsSection" style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem;">
                    <i class="fas fa-brain"></i> AI Suggestions
                </h4>
                <div id="suggestionsList">
                    <p class="text-dim">Loading AI suggestions...</p>
                </div>
            </div>

            <!-- Manual Selection -->
            <div class="mc-form-group">
                <label for="newTypeSelect">Or Choose Type Manually:</label>
                <select id="newTypeSelect" class="mc-select">
                    <option value="">Select type...</option>
                </select>
            </div>

            <!-- Notes -->
            <div class="mc-form-group">
                <label for="reclassifyNotes">Notes (optional):</label>
                <textarea id="reclassifyNotes" class="mc-textarea" rows="3" placeholder="Add notes about this classification..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeReclassifyModal()" class="btn btn-secondary">Cancel</button>
            <button id="submitReclassifyBtn" onclick="submitReclassification()" class="btn btn-primary">
                <i class="fas fa-check"></i> Reclassify
            </button>
        </div>
    </div>
</div>

<style>
.stat-row {
    display: flex;
    justify-content: space-between;
    padding: 0.25rem 0;
    font-size: 0.85rem;
}

.context-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(0,255,255,0.1);
}

.context-row:last-child {
    border-bottom: none;
}

.context-row .label {
    font-weight: 600;
    color: var(--text-dim);
}

.context-row .value {
    font-family: 'Courier New', monospace;
}

.suggestion-card {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: rgba(0,255,255,0.05);
    border: 2px solid rgba(0,255,255,0.2);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.suggestion-card:hover {
    background: rgba(0,255,255,0.1);
    border-color: rgba(0,255,255,0.4);
}

.suggestion-card.selected {
    background: rgba(0,255,255,0.15);
    border-color: var(--accent-color);
    box-shadow: 0 0 10px rgba(0,255,255,0.3);
}

.confidence-bar-container {
    width: 100px;
    height: 6px;
    background: rgba(0,255,255,0.1);
    border-radius: 3px;
    overflow: hidden;
}

.confidence-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #ff4444, #ffaa00, #00ff00);
    transition: width 0.3s;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.modal-content {
    background: var(--card-bg);
    border-radius: 8px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid rgba(0,255,255,0.2);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-color);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid rgba(0,255,255,0.2);
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}
</style>

<script>
let currentEntities = [];
const projectContext = new ProjectContext();
let selectedEntity = null;
let selectedEntityIds = new Set();

// Load review queue
async function loadReviewQueue() {
    try {
        const activeProject = projectContext.getActiveProject();
        if (!activeProject) {
            alert('Please select a project from the header');
            return;
        }

        const projectId = activeProject.project_id;
        const minConf = document.getElementById('minConfidence').value;
        const maxConf = document.getElementById('maxConfidence').value;

        const params = new URLSearchParams({
            min_confidence: minConf,
            max_confidence: maxConf,
            limit: 200,
            project_id: projectId
        });

        const response = await fetch(`/api/classification/review-queue?${params}`);
        const data = await response.json();

        if (data.success) {
            currentEntities = data.entities;
            renderEntityTable(data.entities);
            updateStats();
        }
    } catch (error) {
        console.error('Failed to load review queue:', error);
    }
}

// Render entity table
function renderEntityTable(entities) {
    const tbody = document.getElementById('entityTableBody');
    tbody.innerHTML = '';

    if (entities.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-dim">No entities need review</td></tr>';
        return;
    }

    entities.forEach(entity => {
        const metadata = JSON.parse(entity.classification_metadata || '{}');
        const topSuggestion = metadata.suggestions?.[0];

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="checkbox" class="entity-checkbox" data-id="${entity.entity_id}" onchange="updateSelection()"></td>
            <td>
                <div style="width: 80px; height: 60px; background: #1a1a1a; border-radius: 4px; overflow: hidden;" id="thumb-${entity.entity_id}">
                    <div style="font-size: 10px; color: #666; padding: 5px;">Loading...</div>
                </div>
            </td>
            <td><code style="font-size: 0.85rem;">${entity.layer_name || 'N/A'}</code></td>
            <td><span style="font-size: 0.85rem;">${entity.geometry_type?.replace('ST_', '') || 'Unknown'}</span></td>
            <td>
                <div class="confidence-bar-container">
                    <div class="confidence-bar-fill" style="width: ${(entity.classification_confidence || 0) * 100}%"></div>
                </div>
                <small>${(entity.classification_confidence || 0).toFixed(2)}</small>
            </td>
            <td>
                <span class="text-dim" style="font-size: 0.85rem;">AI loading...</span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openReclassifyModal('${entity.entity_id}')">
                    <i class="fas fa-edit"></i> Review
                </button>
            </td>
        `;
        tbody.appendChild(row);

        // Load thumbnail asynchronously
        loadThumbnail(entity.entity_id);
    });
}

// Load thumbnail for entity
async function loadThumbnail(entityId) {
    const thumbDiv = document.getElementById(`thumb-${entityId}`);
    if (!thumbDiv) return;

    try {
        const response = await fetch(`/api/classification/geometry-thumbnail/${entityId}?size=80`);
        const svgText = await response.text();
        thumbDiv.innerHTML = svgText;
    } catch (error) {
        console.error('Failed to load thumbnail:', error);
        thumbDiv.innerHTML = '<div style="font-size: 10px; color: #ff4444; padding: 5px;">Error</div>';
    }
}

// Update stats
function updateStats() {
    document.getElementById('statTotal').textContent = currentEntities.length;
    document.getElementById('statSelected').textContent = selectedEntityIds.size;
    document.getElementById('entityCount').textContent = `${currentEntities.length} entities`;

    document.getElementById('bulkReclassifyBtn').disabled = selectedEntityIds.size === 0;
}

// Selection handling
function toggleSelectAll() {
    const checked = document.getElementById('selectAll').checked;
    document.querySelectorAll('.entity-checkbox').forEach(cb => {
        cb.checked = checked;
        if (checked) {
            selectedEntityIds.add(cb.dataset.id);
        } else {
            selectedEntityIds.delete(cb.dataset.id);
        }
    });
    updateStats();
}

function updateSelection() {
    selectedEntityIds.clear();
    document.querySelectorAll('.entity-checkbox:checked').forEach(cb => {
        selectedEntityIds.add(cb.dataset.id);
    });
    updateStats();
}

// Open reclassify modal
async function openReclassifyModal(entityId) {
    selectedEntity = currentEntities.find(e => e.entity_id === entityId);
    if (!selectedEntity) return;

    // Populate basic context
    document.getElementById('modalLayer').textContent = selectedEntity.layer_name || 'N/A';
    document.getElementById('modalCurrentType').textContent = selectedEntity.entity_type || 'Unknown';
    document.getElementById('modalConfidence').textContent = (selectedEntity.classification_confidence || 0).toFixed(2);

    // Show modal immediately
    document.getElementById('reclassifyModal').style.display = 'flex';

    // Load geometry preview
    loadGeometryPreview(entityId);

    // Load spatial context
    loadSpatialContext(entityId);

    // Load AI suggestions
    await loadAISuggestions(entityId);

    // Load vocabulary for manual selection
    await loadVocabulary();
}

// Load geometry preview
async function loadGeometryPreview(entityId) {
    const previewDiv = document.getElementById('geometryPreview');
    previewDiv.innerHTML = '<p class="text-dim">Loading geometry preview...</p>';

    try {
        const response = await fetch(`/api/classification/geometry-preview/${entityId}?width=400&height=300`);
        const svgText = await response.text();
        previewDiv.innerHTML = svgText;
    } catch (error) {
        console.error('Failed to load geometry preview:', error);
        previewDiv.innerHTML = '<p style="color: #ff4444;">Failed to load preview</p>';
    }
}

// Load spatial context
async function loadSpatialContext(entityId) {
    const contextDiv = document.getElementById('spatialContextContent');
    contextDiv.innerHTML = '<p class="text-dim">Loading...</p>';

    try {
        const response = await fetch(`/api/classification/spatial-context/${entityId}?radius=100`);
        const data = await response.json();

        if (data.success && data.context) {
            const ctx = data.context;
            let html = '';

            if (ctx.total_nearby > 0) {
                html += `<p><strong>${ctx.total_nearby}</strong> classified entities within ${ctx.search_radius_feet} feet</p>`;

                if (ctx.nearby_types && ctx.nearby_types.length > 0) {
                    html += '<div style="margin-top: 0.5rem;"><strong>Nearby Types:</strong><ul style="margin: 0.25rem 0; padding-left: 1.5rem;">';
                    ctx.nearby_types.forEach(t => {
                        html += `<li>${t.type}: ${t.count}</li>`;
                    });
                    html += '</ul></div>';
                }

                if (ctx.network_hints && ctx.network_hints.length > 0) {
                    html += '<div style="margin-top: 0.5rem;"><strong>Network Hints:</strong><ul style="margin: 0.25rem 0; padding-left: 1.5rem;">';
                    ctx.network_hints.forEach(hint => {
                        html += `<li>${hint}</li>`;
                    });
                    html += '</ul></div>';
                }

                html += `<p style="margin-top: 0.5rem;"><em>Density: ${ctx.density}</em></p>`;
            } else {
                html = `<p class="text-dim">${ctx.message || 'No classified entities found nearby'}</p>`;
            }

            contextDiv.innerHTML = html;
        } else {
            contextDiv.innerHTML = '<p class="text-dim">No spatial context available</p>';
        }
    } catch (error) {
        console.error('Failed to load spatial context:', error);
        contextDiv.innerHTML = '<p style="color: #ff4444;">Failed to load context</p>';
    }
}

// Load AI suggestions
async function loadAISuggestions(entityId) {
    const suggestionsList = document.getElementById('suggestionsList');
    suggestionsList.innerHTML = '<p class="text-dim">Loading AI suggestions...</p>';

    try {
        const response = await fetch(`/api/classification/ai-suggestions/${entityId}?limit=5`);
        const data = await response.json();

        if (data.success && data.suggestions && data.suggestions.length > 0) {
            suggestionsList.innerHTML = '';

            data.suggestions.forEach((sug, idx) => {
                const card = document.createElement('div');
                card.className = 'suggestion-card';
                card.onclick = () => selectSuggestion(sug.suggested_type, card);
                card.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${sug.suggested_type}</strong>
                        <div class="text-dim" style="font-size: 0.85rem; margin-top: 0.25rem;">
                            ${sug.reason}
                        </div>
                        <div class="text-dim" style="font-size: 0.75rem; margin-top: 0.25rem;">
                            Similarity: ${sug.similarity_score} | Support: ${sug.support_count} entities
                            ${sug.user_verified_count > 0 ? ` | ${sug.user_verified_count} user-verified` : ''}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div class="confidence-bar-container" style="width: 80px;">
                            <div class="confidence-bar-fill" style="width: ${sug.confidence * 100}%"></div>
                        </div>
                        <small style="display: block; margin-top: 0.25rem;">${sug.confidence.toFixed(3)}</small>
                    </div>
                `;
                suggestionsList.appendChild(card);
            });
        } else {
            suggestionsList.innerHTML = '<p class="text-dim">No AI suggestions available (entity may not have embeddings)</p>';
        }
    } catch (error) {
        console.error('Failed to load AI suggestions:', error);
        suggestionsList.innerHTML = '<p style="color: #ff4444;">Failed to load suggestions</p>';
    }
}

function closeReclassifyModal() {
    document.getElementById('reclassifyModal').style.display = 'none';
    selectedEntity = null;
}

// Load vocabulary for dropdown
async function loadVocabulary() {
    try {
        const response = await fetch('/api/classification/vocabulary');
        const data = await response.json();

        if (data.success) {
            const select = document.getElementById('newTypeSelect');
            select.innerHTML = '<option value="">Select type...</option>';

            // Flatten vocabulary into options
            Object.values(data.vocabulary).forEach(discipline => {
                Object.values(discipline.categories).forEach(category => {
                    category.types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.code;
                        option.textContent = `${type.name} (${type.code})`;
                        select.appendChild(option);
                    });
                });
            });
        }
    } catch (error) {
        console.error('Failed to load vocabulary:', error);
    }
}

// Select suggestion
function selectSuggestion(type, cardElement) {
    // Deselect all
    document.querySelectorAll('.suggestion-card').forEach(c => c.classList.remove('selected'));
    // Select this one
    cardElement.classList.add('selected');
    // Set dropdown
    document.getElementById('newTypeSelect').value = type;
}

// Submit reclassification
async function submitReclassification() {
    if (!selectedEntity) return;

    const newType = document.getElementById('newTypeSelect').value;
    const notes = document.getElementById('reclassifyNotes').value;

    if (!newType) {
        alert('Please select a type');
        return;
    }

    try {
        const response = await fetch('/api/classification/reclassify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                entity_id: selectedEntity.entity_id,
                new_type: newType,
                notes: notes
            })
        });

        const data = await response.json();

        if (data.success) {
            alert('Entity reclassified successfully!');
            closeReclassifyModal();
            loadReviewQueue(); // Refresh
        } else {
            alert('Reclassification failed: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Reclassification error:', error);
        alert('Failed to reclassify entity');
    }
}

// Update confidence label
function updateConfidenceLabel() {
    const min = document.getElementById('minConfidence').value;
    const max = document.getElementById('maxConfidence').value;
    document.getElementById('confidenceLabel').textContent = `${parseFloat(min).toFixed(1)} - ${parseFloat(max).toFixed(1)}`;
}

// Bulk reclassify selected entities
async function bulkReclassifySelected() {
    if (selectedEntityIds.size === 0) {
        alert('Please select at least one entity');
        return;
    }

    const newType = prompt('Enter entity type for all selected entities (e.g., utility_line, utility_structure):');
    if (!newType) return;

    const notes = prompt('Optional notes for this batch reclassification:') || 'Bulk reclassification via UI';

    const confirmation = confirm(`Reclassify ${selectedEntityIds.size} entities to type "${newType}"?`);
    if (!confirmation) return;

    try {
        const response = await fetch('/api/classification/bulk-reclassify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                entity_ids: Array.from(selectedEntityIds),
                new_type: newType,
                notes: notes
            })
        });

        const data = await response.json();

        if (data.success !== undefined) {
            alert(`Successfully reclassified ${data.success} entities. Failed: ${data.failed}`);
            if (data.failed > 0 && data.errors) {
                console.error('Reclassification errors:', data.errors);
            }
            selectedEntityIds.clear();
            loadReviewQueue(); // Refresh
        } else {
            alert('Bulk reclassification failed: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Bulk reclassification error:', error);
        alert('Failed to perform bulk reclassification');
    }
}

// Approve all AI suggestions for selected entities
async function approveAllAISuggestions() {
    if (selectedEntityIds.size === 0) {
        alert('Please select at least one entity');
        return;
    }

    const confirmation = confirm(`Approve top AI suggestion for ${selectedEntityIds.size} selected entities?`);
    if (!confirmation) return;

    let successCount = 0;
    let failCount = 0;

    for (const entityId of selectedEntityIds) {
        try {
            // Get AI suggestions
            const sugResponse = await fetch(`/api/classification/ai-suggestions/${entityId}?limit=1`);
            const sugData = await sugResponse.json();

            if (sugData.success && sugData.suggestions && sugData.suggestions.length > 0) {
                const topSuggestion = sugData.suggestions[0];

                // Reclassify to top suggestion
                const reclassResponse = await fetch('/api/classification/reclassify', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        entity_id: entityId,
                        new_type: topSuggestion.suggested_type,
                        notes: `Auto-approved AI suggestion (confidence: ${topSuggestion.confidence})`
                    })
                });

                const reclassData = await reclassResponse.json();
                if (reclassData.success) {
                    successCount++;
                } else {
                    failCount++;
                }
            } else {
                failCount++;
            }
        } catch (error) {
            console.error('Error approving suggestion for entity:', entityId, error);
            failCount++;
        }
    }

    alert(`Approved ${successCount} entities. Failed: ${failCount}`);
    selectedEntityIds.clear();
    loadReviewQueue(); // Refresh
}

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    await projectContext.init();

    const activeProject = projectContext.getActiveProject();
    if (!activeProject) {
        alert('Please select a project from the header');
        return;
    }

    await loadReviewQueue();

    // Reload data when project changes
    projectContext.onProjectChange(() => {
        loadReviewQueue();
    });
});
</script>
{% endblock %}
