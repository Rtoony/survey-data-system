{% extends "base_specialized_tool.html" %}

{% block tool_title %}BMP Manager{% endblock %}
{% block tool_icon %}fas fa-water{% endblock %}
{% block tool_description %}Manage stormwater Best Management Practices with drainage area tracking and treatment capacity calculations{% endblock %}

{% block content_layout_class %}tool-complex-layout{% endblock %}

{% block leaflet_assets %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}

{% block map_navigation_links %}
<div class="map-navigation-panel">
    <a href="/project-command-center" class="map-nav-link">
        <i class="fas fa-th-large"></i> Command Center
    </a>
    <a href="/map-viewer" class="map-nav-link">
        <i class="fas fa-map-marked-alt"></i> Map Viewer
    </a>
</div>
{% endblock %}

{% block sidebar_content %}
<div class="tool-filter-section">
    <h4>BMP Filters</h4>
    <div class="tool-filter-item">
        <label for="filter-bmp-type">BMP Type:</label>
        <select id="filter-bmp-type" onchange="applyFilters()">
            <option value="">All Types</option>
            <option value="bioretention">Bioretention</option>
            <option value="swale">Swale</option>
            <option value="detention_basin">Detention Basin</option>
            <option value="retention_basin">Retention Basin</option>
            <option value="infiltration_trench">Infiltration Trench</option>
            <option value="permeable_pavement">Permeable Pavement</option>
            <option value="rain_garden">Rain Garden</option>
            <option value="green_roof">Green Roof</option>
        </select>
    </div>
    <div class="tool-filter-item">
        <label for="filter-status">Status:</label>
        <select id="filter-status" onchange="applyFilters()">
            <option value="">All Status</option>
            <option value="proposed">Proposed</option>
            <option value="existing">Existing</option>
            <option value="planned">Planned</option>
            <option value="constructed">Constructed</option>
        </select>
    </div>
</div>

<div class="tool-stats-section">
    <h4>BMP Statistics</h4>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total BMPs:</span>
        <span class="tool-stat-value" id="stat-total-bmps">0</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Treatment Volume:</span>
        <span class="tool-stat-value" id="stat-treatment-volume">0 CF</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Drainage Area:</span>
        <span class="tool-stat-value" id="stat-drainage-area">0 ac</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total Surface Area:</span>
        <span class="tool-stat-value" id="stat-surface-area">0 SF</span>
    </div>
</div>

<button class="tool-action-btn" onclick="showAddBMPModal()">
    <i class="fas fa-plus"></i> Add BMP
</button>
<button class="tool-action-btn secondary" onclick="calculateCapacity()">
    <i class="fas fa-calculator"></i> Calculate Capacity
</button>
<button class="tool-action-btn secondary" onclick="exportBMPs()">
    <i class="fas fa-file-export"></i> Export Data
</button>
{% endblock %}

{% block main_content %}
<div class="tool-top-area">
    <div id="bmp-map" style="height: 100%; width: 100%; background: #0a1929; position: relative;"></div>

    <div id="mapLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; text-align: center; z-index: 1000;">
        <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--mc-primary); margin-bottom: 1rem;"></i>
        <p style="color: var(--mc-text); font-size: 18px;">Loading BMPs...</p>
    </div>
</div>

<div class="tool-resizer"></div>

<div class="tool-bottom-area">
    <div class="tool-data-tabs">
        <button class="tool-data-tab active" onclick="showTab('bmps')">
            <i class="fas fa-water"></i> BMPs (<span id="bmps-tab-count">0</span>)
        </button>
        <button class="tool-data-tab" onclick="showTab('maintenance')">
            <i class="fas fa-wrench"></i> Maintenance
        </button>
        <button class="tool-data-tab" onclick="showTab('performance')">
            <i class="fas fa-chart-line"></i> Performance
        </button>
    </div>

    <div class="tool-data-content">
        <!-- BMPs Tab -->
        <div id="bmpsTab" class="tab-content">
            <table class="tool-data-table" id="bmpsTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('bmp_name')">Name <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable('bmp_type')">Type <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable('bmp_status')">Status <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable('treatment_volume_cf')">Treatment (CF) <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable('drainage_area_acres')">Drainage Area (ac) <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable('infiltration_rate_in_hr')">Infil. Rate (in/hr) <i class="fas fa-sort"></i></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bmps-table-body">
                    <!-- Populated via JavaScript -->
                </tbody>
            </table>

            <div id="bmpsEmptyState" style="display: none; text-align: center; padding: 3rem; color: var(--mc-muted);">
                <i class="fas fa-water" style="font-size: 64px; opacity: 0.3; margin-bottom: 1rem;"></i>
                <h3>No BMPs Found</h3>
                <p>Add BMPs to your project or adjust filters.</p>
            </div>
        </div>

        <!-- Maintenance Tab -->
        <div id="maintenanceTab" class="tab-content" style="display: none;">
            <div id="maintenance-content">
                <p style="padding: 2rem; text-align: center; color: var(--mc-muted);">
                    Maintenance tracking coming soon.
                </p>
            </div>
        </div>

        <!-- Performance Tab -->
        <div id="performanceTab" class="tab-content" style="display: none;">
            <div id="performance-content">
                <p style="padding: 2rem; text-align: center; color: var(--mc-muted);">
                    Performance analysis coming soon.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.tool-data-table {
    width: 100%;
    border-collapse: collapse;
}

.tool-data-table th {
    background: rgba(0, 255, 255, 0.1);
    padding: 0.75rem;
    text-align: left;
    border-bottom: 2px solid var(--mc-primary);
    cursor: pointer;
    user-select: none;
}

.tool-data-table th:hover {
    background: rgba(0, 255, 255, 0.2);
}

.tool-data-table td {
    padding: 0.75rem;
    border-bottom: 1px solid rgba(0, 255, 255, 0.1);
}

.tool-data-table tbody tr:hover {
    background: rgba(0, 255, 255, 0.05);
}

.tool-data-table .action-btn {
    padding: 0.25rem 0.5rem;
    margin: 0 0.25rem;
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--mc-primary);
    color: var(--mc-primary);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
}

.tool-data-table .action-btn:hover {
    background: rgba(0, 255, 255, 0.2);
}

.tool-data-table .action-btn.danger {
    border-color: var(--mc-danger);
    color: var(--mc-danger);
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.85rem;
}

.status-proposed { background: rgba(255, 165, 0, 0.2); color: #ffa500; }
.status-existing { background: rgba(0, 200, 255, 0.2); color: #00ccff; }
.status-planned { background: rgba(255, 255, 0, 0.2); color: #ffff00; }
.status-constructed { background: rgba(0, 255, 100, 0.2); color: #00ff64; }

.tab-content {
    padding: 1rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let map;
let bmpLayer;
let allBMPs = [];
let filteredBMPs = [];
let currentTab = 'bmps';
let sortColumn = null;
let sortAsc = true;

function initializeMap() {
    map = L.map('bmp-map', {
        dragging: false,
        touchZoom: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        zoomControl: true
    }).setView([37.8, -122.4], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    bmpLayer = L.layerGroup().addTo(map);
}

async function loadBMPs() {
    document.getElementById('mapLoading').style.display = 'block';

    try {
        const response = await fetch('/api/bmps');
        const data = await response.json();

        if (data.error) {
            console.error('Error loading BMPs:', data.error);
            return;
        }

        allBMPs = data.bmps || [];
        filteredBMPs = [...allBMPs];

        renderBMPsOnMap();
        renderBMPTable();
        updateStatistics();

    } catch (error) {
        console.error('Failed to load BMPs:', error);
    } finally {
        document.getElementById('mapLoading').style.display = 'none';
    }
}

function renderBMPsOnMap() {
    bmpLayer.clearLayers();

    if (filteredBMPs.length === 0) return;

    const bounds = [];

    filteredBMPs.forEach(bmp => {
        // Note: BMPs might have polygon or point geometry
        // For now, we'll handle them generically
        const color = getColorForBMPType(bmp.bmp_type);

        // Simple marker for BMPs (can be enhanced with polygon rendering)
        const marker = L.circleMarker([0, 0], {
            radius: 8,
            fillColor: color,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.7
        });

        marker.bindPopup(`
            <strong>${bmp.bmp_name || 'Unnamed BMP'}</strong><br>
            Type: ${bmp.bmp_type || 'Unknown'}<br>
            Treatment: ${bmp.treatment_volume_cf || 0} CF<br>
            Drainage Area: ${bmp.drainage_area_acres || 0} acres
        `);

        // Add to layer group (simplified - would need actual coordinates)
        // bmpLayer.addLayer(marker);
    });

    if (bounds.length > 0) {
        const allBounds = bounds.reduce((a, b) => a.extend(b));
        map.fitBounds(allBounds, { padding: [50, 50] });
    }
}

function getColorForBMPType(bmpType) {
    const colors = {
        'bioretention': '#00ff88',
        'swale': '#00ccff',
        'detention_basin': '#0088ff',
        'retention_basin': '#0044ff',
        'infiltration_trench': '#8800ff',
        'permeable_pavement': '#ff00ff',
        'rain_garden': '#00ff00',
        'green_roof': '#88ff00'
    };
    return colors[bmpType] || '#00ffff';
}

function renderBMPTable() {
    const tbody = document.getElementById('bmps-table-body');
    const emptyState = document.getElementById('bmpsEmptyState');
    const table = document.getElementById('bmpsTable');

    document.getElementById('bmps-tab-count').textContent = filteredBMPs.length;

    if (filteredBMPs.length === 0) {
        table.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }

    table.style.display = 'table';
    emptyState.style.display = 'none';

    tbody.innerHTML = filteredBMPs.map(bmp => `
        <tr data-bmp-id="${bmp.bmp_id}">
            <td>${bmp.bmp_name || 'Unnamed'}</td>
            <td>${bmp.bmp_type || 'Unknown'}</td>
            <td><span class="status-badge status-${bmp.bmp_status || 'proposed'}">${bmp.bmp_status || 'Proposed'}</span></td>
            <td>${(bmp.treatment_volume_cf || 0).toFixed(1)}</td>
            <td>${(bmp.drainage_area_acres || 0).toFixed(2)}</td>
            <td>${(bmp.infiltration_rate_in_hr || 0).toFixed(2)}</td>
            <td>
                <button class="action-btn" onclick="editBMP('${bmp.bmp_id}')">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="action-btn danger" onclick="deleteBMP('${bmp.bmp_id}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </td>
        </tr>
    `).join('');
}

function updateStatistics() {
    const totalBMPs = filteredBMPs.length;
    const totalTreatment = filteredBMPs.reduce((sum, b) => sum + (b.treatment_volume_cf || 0), 0);
    const totalDrainageArea = filteredBMPs.reduce((sum, b) => sum + (b.drainage_area_acres || 0), 0);
    const totalSurfaceArea = filteredBMPs.reduce((sum, b) => sum + (b.surface_area_sqft || 0), 0);

    document.getElementById('stat-total-bmps').textContent = totalBMPs;
    document.getElementById('stat-treatment-volume').textContent = totalTreatment.toFixed(0) + ' CF';
    document.getElementById('stat-drainage-area').textContent = totalDrainageArea.toFixed(2) + ' ac';
    document.getElementById('stat-surface-area').textContent = totalSurfaceArea.toFixed(0) + ' SF';
}

function applyFilters() {
    const bmpType = document.getElementById('filter-bmp-type').value;
    const status = document.getElementById('filter-status').value;

    filteredBMPs = allBMPs.filter(bmp => {
        if (bmpType && bmp.bmp_type !== bmpType) return false;
        if (status && bmp.bmp_status !== status) return false;
        return true;
    });

    renderBMPsOnMap();
    renderBMPTable();
    updateStatistics();
}

function sortTable(column) {
    if (sortColumn === column) {
        sortAsc = !sortAsc;
    } else {
        sortColumn = column;
        sortAsc = true;
    }

    filteredBMPs.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];

        if (typeof aVal === 'string') {
            return sortAsc ? (aVal || '').localeCompare(bVal || '') : (bVal || '').localeCompare(aVal || '');
        } else {
            return sortAsc ? (aVal || 0) - (bVal || 0) : (bVal || 0) - (aVal || 0);
        }
    });

    renderBMPTable();
}

function showTab(tabName) {
    currentTab = tabName;

    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });

    document.querySelectorAll('.tool-data-tab').forEach(btn => {
        btn.classList.remove('active');
    });

    document.getElementById(tabName + 'Tab').style.display = 'block';
    event.target.classList.add('active');
}

function showAddBMPModal() {
    alert('Add BMP modal - Coming soon');
}

function editBMP(bmpId) {
    alert('Edit BMP: ' + bmpId);
}

function deleteBMP(bmpId) {
    if (confirm('Are you sure you want to delete this BMP?')) {
        alert('Delete functionality coming soon');
    }
}

function calculateCapacity() {
    alert('Capacity calculation - Coming soon');
}

function exportBMPs() {
    alert('Export functionality coming soon');
}

document.addEventListener('DOMContentLoaded', () => {
    initializeMap();
    loadBMPs();
});
</script>
{% endblock %}

{% block about_tool_description %}
The BMP Manager helps manage stormwater Best Management Practices (BMPs) including bioretention basins, swales, detention/retention facilities, and other green infrastructure. Track treatment volumes, drainage areas, infiltration rates, and maintenance schedules.
{% endblock %}

{% block about_tool_tags %}
<span class="about-tool-tag">STORM</span>
<span class="about-tool-tag">BMP</span>
<span class="about-tool-tag">DRAINAGE</span>
<span class="about-tool-tag">GREEN_INFRASTRUCTURE</span>
{% endblock %}

{% block about_tool_examples %}
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-STORM-BMP-BIORT-POLY</div>
    <div class="about-tool-example-desc">→ Bioretention basin polygons</div>
</div>
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-STORM-BMP-SWALE-POLY</div>
    <div class="about-tool-example-desc">→ Vegetated swale areas</div>
</div>
{% endblock %}
