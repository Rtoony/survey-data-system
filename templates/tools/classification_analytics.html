{% extends "base.html" %}
{% block title %}Classification Analytics{% endblock %}

{% block content %}
<div class="mc-page-header">
    <h1><i class="fas fa-chart-line"></i> Classification Analytics</h1>
    <p>Track classification accuracy, user corrections, and AI performance over time</p>
</div>

<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
    <!-- Stats Cards -->
    <div class="mc-card">
        <div class="mc-card-content" style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--mc-primary);" id="totalAutoClassified">0</div>
            <div class="text-dim" style="font-size: 0.9rem;">Auto-Classified</div>
        </div>
    </div>

    <div class="mc-card">
        <div class="mc-card-content" style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #00ff00;" id="totalUserClassified">0</div>
            <div class="text-dim" style="font-size: 0.9rem;">User-Classified</div>
        </div>
    </div>

    <div class="mc-card">
        <div class="mc-card-content" style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #ffaa00;" id="totalNeedsReview">0</div>
            <div class="text-dim" style="font-size: 0.9rem;">Needs Review</div>
        </div>
    </div>

    <div class="mc-card">
        <div class="mc-card-content" style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #ff4444;" id="totalReclassifications">0</div>
            <div class="text-dim" style="font-size: 0.9rem;">Reclassifications</div>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
    <!-- Confidence Metrics -->
    <div class="mc-card">
        <div class="mc-card-header">
            <h2><i class="fas fa-percentage"></i> Confidence Metrics</h2>
        </div>
        <div class="mc-card-content">
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Average Auto-Classification Confidence:</span>
                    <strong id="avgAutoConfidence">0%</strong>
                </div>
                <div class="progress-bar" style="height: 8px; background: rgba(0,255,255,0.1); border-radius: 4px;">
                    <div id="avgAutoConfidenceBar" style="height: 100%; background: var(--mc-primary); border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>

            <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Average User-Classification Confidence:</span>
                    <strong id="avgUserConfidence">0%</strong>
                </div>
                <div class="progress-bar" style="height: 8px; background: rgba(0,255,0,0.1); border-radius: 4px;">
                    <div id="avgUserConfidenceBar" style="height: 100%; background: #00ff00; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>

            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0,255,255,0.05); border-radius: 4px;">
                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Interpretation</h4>
                <p class="text-dim" style="font-size: 0.85rem; margin: 0;">
                    Higher auto-classification confidence indicates the AI is making better predictions.
                    User-classified entities should have 100% confidence as they represent ground truth.
                </p>
            </div>
        </div>
    </div>

    <!-- Time Period Selector -->
    <div class="mc-card">
        <div class="mc-card-header">
            <h2><i class="fas fa-calendar"></i> Time Period</h2>
        </div>
        <div class="mc-card-content">
            <div class="mc-form-group">
                <label>Select Period:</label>
                <select id="timePeriod" class="mc-select" onchange="loadAnalytics()">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="180">Last 6 Months</option>
                    <option value="365">Last Year</option>
                </select>
            </div>

            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0,255,255,0.05); border-radius: 4px;">
                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Data Freshness</h4>
                <p class="text-dim" style="font-size: 0.85rem; margin: 0;">
                    Analytics updated in real-time based on classification activities.
                    Last refreshed: <strong id="lastRefresh">Never</strong>
                </p>
                <button class="btn btn-sm btn-secondary" onclick="loadAnalytics()" style="margin-top: 0.5rem;">
                    <i class="fas fa-sync"></i> Refresh Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Common Reclassifications -->
<div class="mc-card">
    <div class="mc-card-header">
        <h2><i class="fas fa-exchange-alt"></i> Common Reclassifications</h2>
        <span class="mc-badge" id="reclassCountBadge">0 patterns</span>
    </div>
    <div class="mc-card-content">
        <p class="text-dim" style="margin-bottom: 1rem;">
            These patterns show which entity types are frequently being reclassified,
            indicating areas where the AI classification may need improvement.
        </p>

        <div style="overflow-x: auto;">
            <table class="mc-table" id="reclassificationsTable">
                <thead>
                    <tr>
                        <th>Original Type</th>
                        <th style="text-align: center;"><i class="fas fa-arrow-right"></i></th>
                        <th>Corrected Type</th>
                        <th style="text-align: right;">Count</th>
                        <th style="text-align: right;">Impact</th>
                    </tr>
                </thead>
                <tbody id="reclassificationsTableBody">
                    <tr>
                        <td colspan="5" class="text-center text-dim">No reclassification data available</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- AI Accuracy Insights -->
<div class="mc-card" style="margin-top: 2rem;">
    <div class="mc-card-header">
        <h2><i class="fas fa-brain"></i> AI Accuracy Insights</h2>
    </div>
    <div class="mc-card-content">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
            <div style="padding: 1rem; background: rgba(0,255,0,0.05); border-left: 4px solid #00ff00; border-radius: 4px;">
                <h4 style="margin: 0 0 0.5rem 0; color: #00ff00; font-size: 0.9rem;">
                    <i class="fas fa-check-circle"></i> High Confidence (≥0.8)
                </h4>
                <div style="font-size: 1.5rem; font-weight: bold;" id="highConfCount">0</div>
                <p class="text-dim" style="font-size: 0.85rem; margin: 0.5rem 0 0 0;">
                    Entities classified with high confidence
                </p>
            </div>

            <div style="padding: 1rem; background: rgba(255,170,0,0.05); border-left: 4px solid #ffaa00; border-radius: 4px;">
                <h4 style="margin: 0 0 0.5rem 0; color: #ffaa00; font-size: 0.9rem;">
                    <i class="fas fa-exclamation-triangle"></i> Medium Confidence (0.5-0.8)
                </h4>
                <div style="font-size: 1.5rem; font-weight: bold;" id="medConfCount">0</div>
                <p class="text-dim" style="font-size: 0.85rem; margin: 0.5rem 0 0 0;">
                    Entities needing manual review
                </p>
            </div>

            <div style="padding: 1rem; background: rgba(255,68,68,0.05); border-left: 4px solid #ff4444; border-radius: 4px;">
                <h4 style="margin: 0 0 0.5rem 0; color: #ff4444; font-size: 0.9rem;">
                    <i class="fas fa-times-circle"></i> Low Confidence (<0.5)
                </h4>
                <div style="font-size: 1.5rem; font-weight: bold;" id="lowConfCount">0</div>
                <p class="text-dim" style="font-size: 0.85rem; margin: 0.5rem 0 0 0;">
                    Entities requiring user input
                </p>
            </div>
        </div>

        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0,255,255,0.05); border-radius: 4px;">
            <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">
                <i class="fas fa-lightbulb"></i> Recommendations
            </h4>
            <ul id="recommendationsList" style="margin: 0; padding-left: 1.5rem; font-size: 0.85rem;" class="text-dim">
                <li>Review common reclassifications to identify patterns</li>
                <li>Focus training on medium and low confidence categories</li>
                <li>Use spatial context to improve classification accuracy</li>
            </ul>
        </div>
    </div>
</div>

<style>
.progress-bar {
    overflow: hidden;
}
</style>

<script>
const projectContext = new ProjectContext();

// Load analytics data
async function loadAnalytics() {
    try {
        const days = document.getElementById('timePeriod').value;

        const response = await fetch(`/api/classification/analytics?days=${days}`);
        const data = await response.json();

        if (data.success && data.analytics) {
            const analytics = data.analytics;

            // Update stats cards
            document.getElementById('totalAutoClassified').textContent = analytics.total_auto_classified || 0;
            document.getElementById('totalUserClassified').textContent = analytics.total_user_classified || 0;
            document.getElementById('totalNeedsReview').textContent = analytics.total_needs_review || 0;
            document.getElementById('totalReclassifications').textContent = analytics.total_reclassifications || 0;

            // Update confidence metrics
            const avgAutoConf = (analytics.avg_auto_confidence * 100).toFixed(1);
            const avgUserConf = (analytics.avg_user_confidence * 100).toFixed(1);

            document.getElementById('avgAutoConfidence').textContent = avgAutoConf + '%';
            document.getElementById('avgAutoConfidenceBar').style.width = avgAutoConf + '%';

            document.getElementById('avgUserConfidence').textContent = avgUserConf + '%';
            document.getElementById('avgUserConfidenceBar').style.width = avgUserConf + '%';

            // Update reclassifications table
            renderReclassifications(analytics.common_reclassifications || []);

            // Calculate confidence distribution (mock data for now - would need DB query)
            const total = analytics.total_auto_classified + analytics.total_user_classified + analytics.total_needs_review;
            document.getElementById('highConfCount').textContent = analytics.total_auto_classified || 0;
            document.getElementById('medConfCount').textContent = Math.floor((analytics.total_needs_review || 0) * 0.6);
            document.getElementById('lowConfCount').textContent = Math.ceil((analytics.total_needs_review || 0) * 0.4);

            // Update last refresh time
            document.getElementById('lastRefresh').textContent = new Date().toLocaleTimeString();

            // Generate recommendations
            generateRecommendations(analytics);
        }
    } catch (error) {
        console.error('Failed to load analytics:', error);
    }
}

// Render reclassifications table
function renderReclassifications(reclassifications) {
    const tbody = document.getElementById('reclassificationsTableBody');
    tbody.innerHTML = '';

    document.getElementById('reclassCountBadge').textContent = `${reclassifications.length} patterns`;

    if (reclassifications.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-dim">No reclassification patterns found</td></tr>';
        return;
    }

    const total = reclassifications.reduce((sum, r) => sum + r.count, 0);

    reclassifications.forEach(reclass => {
        const impact = ((reclass.count / total) * 100).toFixed(1);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><code>${reclass.from_type || 'unknown'}</code></td>
            <td style="text-align: center; color: var(--mc-primary);"><i class="fas fa-arrow-right"></i></td>
            <td><code>${reclass.to_type}</code></td>
            <td style="text-align: right;"><strong>${reclass.count}</strong></td>
            <td style="text-align: right;">
                <div style="display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem;">
                    <div style="width: 60px; height: 6px; background: rgba(0,255,255,0.1); border-radius: 3px; overflow: hidden;">
                        <div style="height: 100%; background: var(--mc-primary); width: ${impact}%;"></div>
                    </div>
                    <span>${impact}%</span>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Generate recommendations based on analytics
function generateRecommendations(analytics) {
    const recommendations = [];

    if (analytics.total_reclassifications > 10) {
        recommendations.push('High reclassification rate detected - review common patterns to improve AI training');
    }

    if (analytics.avg_auto_confidence < 0.6) {
        recommendations.push('Low average auto-classification confidence - consider manual review of training data');
    }

    if (analytics.total_needs_review > analytics.total_auto_classified) {
        recommendations.push('More entities need review than were auto-classified - AI may need retraining');
    }

    if (analytics.common_reclassifications.length > 0) {
        const topPattern = analytics.common_reclassifications[0];
        recommendations.push(`Most common correction: ${topPattern.from_type} → ${topPattern.to_type} (${topPattern.count} times)`);
    }

    if (recommendations.length === 0) {
        recommendations.push('Classification performance looks good! Continue monitoring trends.');
    }

    const list = document.getElementById('recommendationsList');
    list.innerHTML = recommendations.map(r => `<li>${r}</li>`).join('');
}

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    await projectContext.init();

    const activeProject = projectContext.getActiveProject();
    if (!activeProject) {
        alert('Please select a project from the header');
        return;
    }

    await loadAnalytics();

    // Reload data when project changes
    projectContext.onProjectChange(() => {
        loadAnalytics();
    });

    // Auto-refresh every 5 minutes
    setInterval(loadAnalytics, 5 * 60 * 1000);
});
</script>
{% endblock %}
