{% extends "base.html" %}

{% block title %}Sheet Note Manager{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/specialized-tool-info.js') }}"></script>
<script src="{{ url_for('static', filename='js/ProjectContext.js') }}"></script>
{% endblock %}

{% block content %}
<div class="content">
    <div class="page-header">
        <div class="page-header-content">
            <i class="fas fa-sticky-note neon-cyan"></i>
            <div>
                <h2 class="orbitron">Sheet Note Manager</h2>
                <p>Manage standard notes and create project-specific variations with deviation tracking</p>
            </div>
        </div>
    </div>

    <div class="sheet-notes-container">
        <div class="top-controls">
            <div class="set-selector">
                <label for="noteSetSelect">Note Set:</label>
                <select id="noteSetSelect" onchange="loadNoteSet()">
                    <option value="">Select or create a note set...</option>
                </select>
                <button class="btn-primary" onclick="showCreateNoteSetModal()">
                    <i class="fas fa-plus"></i> New Set
                </button>
            </div>
            <div class="actions">
                <button class="btn-secondary" onclick="refreshAll()">
                    <i class="fas fa-refresh"></i> Refresh
                </button>
            </div>
        </div>

        <div class="two-panel-layout">
            <div class="left-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-book"></i> Standard Notes Library</h3>
                    <div class="search-box">
                        <input type="text" id="standardSearchInput" placeholder="Search standards..." onkeyup="filterStandardNotes()">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                <div class="filter-controls">
                    <select id="categoryFilter" onchange="filterStandardNotes()">
                        <option value="">All Categories</option>
                    </select>
                    <select id="disciplineFilter" onchange="filterStandardNotes()">
                        <option value="">All Disciplines</option>
                    </select>
                </div>
                <div class="standards-list" id="standardNotesList">
                    <div class="empty-state">Load a project to view standard notes</div>
                </div>
            </div>

            <div class="right-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-edit"></i> Project Notes</h3>
                    <div class="note-actions" id="noteActions" style="display: none;">
                        <button class="btn-sm btn-primary" onclick="showAddCustomNoteModal()">
                            <i class="fas fa-plus"></i> Custom Note
                        </button>
                    </div>
                </div>
                <div class="project-notes-list" id="projectNotesList">
                    <div class="empty-state">Select a note set to begin</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="createNoteSetModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create Note Set</h3>
            <button class="modal-close" onclick="closeModal('createNoteSetModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Set Name:</label>
                <input type="text" id="newSetName" placeholder="e.g., General Notes Set A">
            </div>
            <div class="form-group">
                <label>Description (optional):</label>
                <textarea id="newSetDescription" placeholder="Optional description"></textarea>
            </div>
            <div class="form-group">
                <label>Discipline (optional):</label>
                <input type="text" id="newSetDiscipline" placeholder="e.g., Civil, Structural">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('createNoteSetModal')">Cancel</button>
            <button class="btn-primary" onclick="createNoteSet()">Create</button>
        </div>
    </div>
</div>

<div id="addCustomNoteModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Create Custom Note</h3>
            <button class="modal-close" onclick="closeModal('addCustomNoteModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                <span>Custom notes are project-specific and not based on standards. Justification required.</span>
            </div>
            <div class="form-group">
                <label>Display Code: <span class="required">*</span></label>
                <input type="text" id="customNoteCode" placeholder="e.g., C1">
            </div>
            <div class="form-group">
                <label>Title: <span class="required">*</span></label>
                <input type="text" id="customNoteTitle" placeholder="Note title">
            </div>
            <div class="form-group">
                <label>Text: <span class="required">*</span></label>
                <textarea id="customNoteText" placeholder="Note content" rows="5"></textarea>
            </div>
            <div class="form-group">
                <label>Deviation Category: <span class="required">*</span></label>
                <select id="customDeviationCategory">
                    <option value="">Select category...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Justification: <span class="required">*</span></label>
                <textarea id="customJustification" placeholder="Why is this custom note needed?" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Conformance Status: <span class="required">*</span></label>
                <select id="customConformanceStatus">
                    <option value="">Select status...</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('addCustomNoteModal')">Cancel</button>
            <button class="btn-primary" onclick="createCustomNote()">Create Custom Note</button>
        </div>
    </div>
</div>

<div id="modifiedCopyModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Create Modified Copy</h3>
            <button class="modal-close" onclick="closeModal('modifiedCopyModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                <span>Creating a modified copy allows you to customize a standard note while tracking deviations</span>
            </div>
            <div class="form-group">
                <label>Display Code:</label>
                <input type="text" id="modifiedNoteCode" placeholder="e.g., G1">
            </div>
            <div class="form-group">
                <label>Custom Title (optional):</label>
                <input type="text" id="modifiedNoteTitle" placeholder="Leave blank to use standard title">
            </div>
            <div class="form-group">
                <label>Custom Text (optional):</label>
                <textarea id="modifiedNoteText" placeholder="Leave blank to use standard text" rows="5"></textarea>
            </div>
            <div class="form-group">
                <label>Deviation Category:</label>
                <select id="deviationCategory">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Deviation Reason:</label>
                <textarea id="deviationReason" placeholder="Explain why this deviation is necessary" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Conformance Status:</label>
                <select id="conformanceStatus">
                    <option value="">Loading...</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('modifiedCopyModal')">Cancel</button>
            <button class="btn-primary" onclick="createModifiedCopy()">Create Modified Copy</button>
        </div>
    </div>
</div>

<div id="editNoteModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Edit Note</h3>
            <button class="modal-close" onclick="closeModal('editNoteModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                <span id="editNoteInfo">Editing this note will create a modified version with deviation tracking.</span>
            </div>
            <div class="form-group">
                <label>Display Code: <span class="required">*</span></label>
                <input type="text" id="editNoteCode" readonly style="background: rgba(0,0,0,0.3);">
            </div>
            <div class="form-group">
                <label>Title: <span class="required">*</span></label>
                <input type="text" id="editNoteTitle" placeholder="Note title">
            </div>
            <div class="form-group">
                <label>Text: <span class="required">*</span></label>
                <textarea id="editNoteText" placeholder="Note content" rows="5"></textarea>
            </div>
            <div class="form-group">
                <label>Deviation Category: <span class="required">*</span></label>
                <select id="editDeviationCategory">
                    <option value="">Select category...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Justification for Changes: <span class="required">*</span></label>
                <textarea id="editJustification" placeholder="Explain why this change is necessary" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Conformance Status: <span class="required">*</span></label>
                <select id="editConformanceStatus">
                    <option value="">Select status...</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('editNoteModal')">Cancel</button>
            <button class="btn-primary" onclick="saveEditedNote()">Save Changes</button>
        </div>
    </div>
</div>

<style>
.sheet-notes-container {
    padding: 20px;
}

.top-controls {
    background: rgba(0, 20, 40, 0.6);
    border: 1px solid var(--neon-blue);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
}

.set-selector {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 2;
    min-width: 400px;
}

.top-controls label {
    color: var(--neon-cyan);
    font-weight: bold;
    white-space: nowrap;
}

.top-controls select {
    flex: 1;
    padding: 10px;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid var(--neon-blue);
    color: var(--text-primary);
    border-radius: 4px;
}

.two-panel-layout {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 20px;
    height: calc(100vh - 350px);
    min-height: 600px;
}

.left-panel, .right-panel {
    background: rgba(0, 20, 40, 0.6);
    border: 1px solid var(--neon-blue);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.panel-header {
    padding: 15px;
    border-bottom: 2px solid var(--neon-cyan);
    background: rgba(0, 255, 255, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-header h3 {
    color: var(--neon-cyan);
    margin: 0;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.search-box {
    position: relative;
    margin-top: 10px;
}

.search-box input {
    width: 100%;
    padding: 8px 30px 8px 10px;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid var(--neon-blue);
    color: var(--text-primary);
    border-radius: 4px;
}

.search-box i {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--neon-cyan);
}

.filter-controls {
    padding: 10px 15px;
    border-bottom: 1px solid var(--neon-blue);
    display: flex;
    gap: 10px;
}

.filter-controls select {
    flex: 1;
    padding: 6px;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid var(--neon-blue);
    color: var(--text-primary);
    border-radius: 4px;
    font-size: 0.85rem;
}

.standards-list, .project-notes-list, .assignments-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.note-card {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--neon-blue);
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s;
}

.note-card:hover {
    border-color: var(--neon-cyan);
    background: rgba(0, 255, 255, 0.05);
    transform: translateX(5px);
}

.note-card.selected {
    border-color: var(--mc-accent);
    background: rgba(0, 255, 136, 0.1);
}

.note-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 8px;
}

.note-title {
    font-weight: bold;
    color: var(--neon-cyan);
    font-size: 0.95rem;
}

.note-category {
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 3px;
    background: rgba(0, 255, 255, 0.2);
    color: var(--neon-cyan);
}

.note-text {
    color: var(--text-primary);
    font-size: 0.85rem;
    line-height: 1.4;
    max-height: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
}

.note-actions-inline {
    display: flex;
    gap: 5px;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(0, 255, 255, 0.2);
}

.btn-sm {
    padding: 5px 10px;
    font-size: 0.8rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.3s;
}

.btn-sm.btn-primary {
    background: var(--neon-cyan);
    color: #000;
}

.btn-sm.btn-primary:hover {
    background: var(--mc-accent);
    box-shadow: 0 0 10px var(--mc-accent);
}

.btn-sm.btn-secondary {
    background: rgba(0, 255, 255, 0.2);
    color: var(--neon-cyan);
    border: 1px solid var(--neon-cyan);
}

.btn-sm.btn-secondary:hover {
    background: rgba(0, 255, 255, 0.3);
}

.btn-sm.btn-danger {
    background: rgba(255, 0, 0, 0.2);
    color: #ff6b6b;
    border: 1px solid #ff6b6b;
}

.btn-sm.btn-danger:hover {
    background: rgba(255, 0, 0, 0.3);
}

.project-note-card {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--neon-blue);
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 10px;
}

.project-note-card.modified {
    border-left: 3px solid #ffa500;
}

.project-note-card.custom {
    border-left: 3px solid var(--mc-accent);
}

.note-code {
    display: inline-block;
    background: var(--neon-cyan);
    color: #000;
    padding: 2px 8px;
    border-radius: 3px;
    font-weight: bold;
    font-size: 0.9rem;
    margin-right: 10px;
}

.note-badges {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-top: 8px;
}

.badge {
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 3px;
    display: inline-flex;
    align-items: center;
    gap: 3px;
}

.badge.modified {
    background: rgba(255, 165, 0, 0.2);
    color: #ffa500;
    border: 1px solid #ffa500;
}

.badge.custom {
    background: rgba(0, 255, 136, 0.2);
    color: var(--mc-accent);
    border: 1px solid var(--mc-accent);
}

.badge.standard {
    background: rgba(0, 255, 255, 0.2);
    color: var(--neon-cyan);
    border: 1px solid var(--neon-cyan);
}

.empty-state {
    text-align: center;
    color: var(--text-secondary);
    padding: 40px 20px;
    font-style: italic;
}

.assignment-controls {
    padding: 15px;
    border-bottom: 1px solid var(--neon-blue);
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.assignment-controls label {
    color: var(--neon-cyan);
    font-size: 0.85rem;
    font-weight: bold;
}

.assignment-controls select {
    padding: 8px;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid var(--neon-blue);
    color: var(--text-primary);
    border-radius: 4px;
}

.assignment-card {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--neon-blue);
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: rgba(0, 20, 40, 0.95);
    border: 2px solid var(--neon-cyan);
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-content.modal-large {
    max-width: 800px;
}

.modal-header {
    padding: 20px;
    border-bottom: 2px solid var(--neon-cyan);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    color: var(--neon-cyan);
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    color: var(--neon-cyan);
    font-size: 2rem;
    cursor: pointer;
    line-height: 1;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid var(--neon-cyan);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    color: var(--neon-cyan);
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 10px;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid var(--neon-blue);
    color: var(--text-primary);
    border-radius: 4px;
}

.form-group textarea {
    resize: vertical;
}

.info-box {
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--neon-cyan);
    border-radius: 4px;
    padding: 12px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--neon-cyan);
}

.info-box i {
    font-size: 1.2rem;
}
</style>

<script>
const projectContext = new ProjectContext();
let currentProject = null;
let currentNoteSet = null;
let currentSelectedNote = null;
let standardNotes = [];
let projectNotes = [];

document.addEventListener('DOMContentLoaded', async function() {
    await projectContext.init();

    const activeProject = projectContext.getActiveProject();
    if (!activeProject) {
        alert('Please select a project from the header');
        return;
    }

    loadDeviationCategories();
    loadConformanceStatuses();
    await loadProjectNoteSets();

    // Reload data when project changes
    projectContext.onProjectChange(() => {
        loadProjectNoteSets();
    });
});

async function loadProjectNoteSets() {
    const activeProject = projectContext.getActiveProject();
    if (!activeProject) {
        document.getElementById('noteSetSelect').innerHTML = '<option value="">Select a project first...</option>';
        return;
    }

    const projectId = activeProject.project_id;
    currentProject = projectId;
    
    try {
        const response = await fetch(`/api/sheet-note-sets?project_id=${projectId}`);
        const data = await response.json();
        
        const select = document.getElementById('noteSetSelect');
        select.innerHTML = '<option value="">Select a note set...</option>';
        
        if (data.sets) {
            data.sets.forEach(set => {
                const option = document.createElement('option');
                option.value = set.set_id;
                option.textContent = `${set.set_name} (${set.status})`;
                select.appendChild(option);
            });
        }
        
        loadStandardNotes();
    } catch (error) {
        console.error('Error loading note sets:', error);
    }
}

async function loadStandardNotes() {
    try {
        const response = await fetch('/api/data-manager/standard-notes');
        const data = await response.json();
        standardNotes = data.notes || [];
        
        populateFilters();
        displayStandardNotes();
    } catch (error) {
        console.error('Error loading standard notes:', error);
    }
}

function populateFilters() {
    const categories = [...new Set(standardNotes.map(n => n.note_category).filter(Boolean))];
    const disciplines = [...new Set(standardNotes.map(n => n.discipline).filter(Boolean))];
    
    const catFilter = document.getElementById('categoryFilter');
    const discFilter = document.getElementById('disciplineFilter');
    
    catFilter.innerHTML = '<option value="">All Categories</option>';
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        catFilter.appendChild(option);
    });
    
    discFilter.innerHTML = '<option value="">All Disciplines</option>';
    disciplines.forEach(disc => {
        const option = document.createElement('option');
        option.value = disc;
        option.textContent = disc;
        discFilter.appendChild(option);
    });
}

function filterStandardNotes() {
    const searchTerm = document.getElementById('standardSearchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    const discipline = document.getElementById('disciplineFilter').value;
    
    const filtered = standardNotes.filter(note => {
        const matchesSearch = !searchTerm || 
            note.note_title.toLowerCase().includes(searchTerm) ||
            note.note_text.toLowerCase().includes(searchTerm);
        const matchesCategory = !category || note.note_category === category;
        const matchesDiscipline = !discipline || note.discipline === discipline;
        
        return matchesSearch && matchesCategory && matchesDiscipline;
    });
    
    displayStandardNotes(filtered);
}

function displayStandardNotes(notes = standardNotes) {
    const container = document.getElementById('standardNotesList');
    
    if (notes.length === 0) {
        container.innerHTML = '<div class="empty-state">No standard notes found</div>';
        return;
    }
    
    container.innerHTML = notes.map(note => `
        <div class="note-card" onclick="selectStandardNote('${note.note_id}')">
            <div class="note-card-header">
                <div class="note-title">${note.note_title}</div>
                ${note.note_category ? `<div class="note-category">${note.note_category}</div>` : ''}
            </div>
            <div class="note-text">${note.note_text}</div>
            ${currentNoteSet ? `
                <div class="note-actions-inline">
                    <button class="btn-sm btn-primary" onclick="event.stopPropagation(); addStandardToProject('${note.note_id}')">
                        <i class="fas fa-plus"></i> Add
                    </button>
                    <button class="btn-sm btn-secondary" onclick="event.stopPropagation(); showModifiedCopyModal('${note.note_id}')">
                        <i class="fas fa-copy"></i> Modified Copy
                    </button>
                </div>
            ` : ''}
        </div>
    `).join('');
}

function selectStandardNote(noteId) {
    currentSelectedNote = noteId;
    document.querySelectorAll('#standardNotesList .note-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
}

async function loadNoteSet() {
    const setId = document.getElementById('noteSetSelect').value;
    currentNoteSet = setId;
    
    if (!setId) {
        document.getElementById('projectNotesList').innerHTML = '<div class="empty-state">Select a note set to begin</div>';
        document.getElementById('noteActions').style.display = 'none';
        return;
    }
    
    document.getElementById('noteActions').style.display = 'flex';
    
    try {
        const response = await fetch(`/api/project-sheet-notes?set_id=${setId}`);
        const data = await response.json();
        projectNotes = data.notes || [];
        
        displayProjectNotes();
        displayStandardNotes();
    } catch (error) {
        console.error('Error loading note set:', error);
    }
}

function displayProjectNotes() {
    const container = document.getElementById('projectNotesList');
    
    if (projectNotes.length === 0) {
        container.innerHTML = '<div class="empty-state">No notes in this set. Add notes from the Standard Library or create custom notes.</div>';
        return;
    }
    
    container.innerHTML = projectNotes.map(note => {
        const isCustom = !note.standard_note_id;
        const isModified = note.is_modified || note.source_type === 'modified_standard';
        const title = note.custom_title || note.standard_title || 'Untitled';
        const text = note.custom_text || note.standard_text || '';
        
        return `
            <div class="project-note-card ${isCustom ? 'custom' : ''} ${isModified ? 'modified' : ''}">
                <div class="note-card-header">
                    <div>
                        <span class="note-code">${note.display_code}</span>
                        <span class="note-title">${title}</span>
                    </div>
                    <div class="note-badges">
                        ${isCustom ? '<span class="badge custom"><i class="fas fa-star"></i> Custom</span>' : ''}
                        ${isModified ? '<span class="badge modified"><i class="fas fa-edit"></i> Modified</span>' : ''}
                        ${!isCustom && !isModified ? '<span class="badge standard"><i class="fas fa-check"></i> Standard</span>' : ''}
                    </div>
                </div>
                <div class="note-text">${text}</div>
                ${note.deviation_reason ? `<div style="margin-top: 8px; padding: 8px; background: rgba(255,165,0,0.1); border-left: 2px solid #ffa500; font-size: 0.8rem;">
                    <strong>Deviation:</strong> ${note.deviation_reason}
                </div>` : ''}
                <div class="note-actions-inline">
                    <button class="btn-sm btn-secondary" onclick="editProjectNote('${note.project_note_id}')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn-sm btn-danger" onclick="deleteProjectNote('${note.project_note_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

async function addStandardToProject(standardNoteId) {
    if (!currentNoteSet) {
        alert('Please select a note set first');
        return;
    }
    
    const code = prompt('Enter display code (e.g., G1, C1):');
    if (!code) return;
    
    try {
        const response = await fetch('/api/project-sheet-notes/assign-standard', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                set_id: currentNoteSet,
                standard_note_id: standardNoteId,
                display_code: code
            })
        });
        
        if (response.ok) {
            loadNoteSet();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to add note'));
        }
    } catch (error) {
        console.error('Error adding note:', error);
        alert('Failed to add note');
    }
}

function showCreateNoteSetModal() {
    const activeProject = projectContext.getActiveProject();
    if (!activeProject) {
        alert('Please select a project from the header');
        return;
    }
    currentProject = activeProject.project_id;
    document.getElementById('createNoteSetModal').classList.add('show');
}

function showAddCustomNoteModal() {
    if (!currentNoteSet) {
        alert('Please select a note set first');
        return;
    }
    document.getElementById('addCustomNoteModal').classList.add('show');
}

function showModifiedCopyModal(standardNoteId) {
    if (!currentNoteSet) {
        alert('Please select a note set first');
        return;
    }
    currentSelectedNote = standardNoteId;
    document.getElementById('modifiedCopyModal').classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

async function createNoteSet() {
    const name = document.getElementById('newSetName').value;
    const description = document.getElementById('newSetDescription').value;
    const discipline = document.getElementById('newSetDiscipline').value;
    
    if (!name) {
        alert('Please enter a set name');
        return;
    }
    
    try {
        const response = await fetch('/api/sheet-note-sets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                project_id: currentProject,
                set_name: name,
                description: description || null,
                discipline: discipline || null
            })
        });
        
        if (response.ok) {
            closeModal('createNoteSetModal');
            document.getElementById('newSetName').value = '';
            document.getElementById('newSetDescription').value = '';
            document.getElementById('newSetDiscipline').value = '';
            loadProjectNoteSets();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to create note set'));
        }
    } catch (error) {
        console.error('Error creating note set:', error);
        alert('Failed to create note set');
    }
}

async function createCustomNote() {
    const code = document.getElementById('customNoteCode').value;
    const title = document.getElementById('customNoteTitle').value;
    const text = document.getElementById('customNoteText').value;
    const deviationCategory = document.getElementById('customDeviationCategory').value;
    const justification = document.getElementById('customJustification').value;
    const conformanceStatus = document.getElementById('customConformanceStatus').value;
    
    if (!code || !title || !text || !deviationCategory || !justification || !conformanceStatus) {
        alert('Please fill in all required fields');
        return;
    }
    
    try {
        const response = await fetch('/api/project-sheet-notes/custom', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                set_id: currentNoteSet,
                display_code: code,
                custom_title: title,
                custom_text: text,
                deviation_category_id: deviationCategory,
                deviation_reason: justification,
                conformance_status_id: conformanceStatus
            })
        });
        
        if (response.ok) {
            closeModal('addCustomNoteModal');
            document.getElementById('customNoteCode').value = '';
            document.getElementById('customNoteTitle').value = '';
            document.getElementById('customNoteText').value = '';
            document.getElementById('customDeviationCategory').value = '';
            document.getElementById('customJustification').value = '';
            document.getElementById('customConformanceStatus').value = '';
            loadNoteSet();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to create note'));
        }
    } catch (error) {
        console.error('Error creating note:', error);
        alert('Failed to create note');
    }
}

async function createModifiedCopy() {
    const code = document.getElementById('modifiedNoteCode').value;
    const title = document.getElementById('modifiedNoteTitle').value;
    const text = document.getElementById('modifiedNoteText').value;
    const deviationCategory = document.getElementById('deviationCategory').value;
    const deviationReason = document.getElementById('deviationReason').value;
    const conformanceStatus = document.getElementById('conformanceStatus').value;
    
    if (!code || !deviationCategory || !deviationReason || !conformanceStatus) {
        alert('Please fill in all required fields');
        return;
    }
    
    const projectNote = projectNotes.find(n => n.standard_note_id === currentSelectedNote);
    if (!projectNote) {
        alert('Original note not found in project');
        return;
    }
    
    try {
        const response = await fetch(`/api/project-sheet-notes/${projectNote.project_note_id}/create-modified-copy`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                display_code: code,
                custom_title: title || null,
                custom_text: text || null,
                deviation_category_id: deviationCategory,
                deviation_reason: deviationReason,
                conformance_status_id: conformanceStatus
            })
        });
        
        if (response.ok) {
            closeModal('modifiedCopyModal');
            document.getElementById('modifiedNoteCode').value = '';
            document.getElementById('modifiedNoteTitle').value = '';
            document.getElementById('modifiedNoteText').value = '';
            document.getElementById('deviationReason').value = '';
            loadNoteSet();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to create modified copy'));
        }
    } catch (error) {
        console.error('Error creating modified copy:', error);
        alert('Failed to create modified copy');
    }
}

function editProjectNote(projectNoteId) {
    const note = projectNotes.find(n => n.project_note_id === projectNoteId);
    if (!note) {
        alert('Note not found');
        return;
    }
    
    const isStandard = note.source_type === 'standard' && !note.is_modified;
    const title = note.custom_title || note.standard_title || '';
    const text = note.custom_text || note.standard_text || '';
    
    if (isStandard) {
        document.getElementById('editNoteInfo').textContent = 'Editing this standard note will create a modified version with deviation tracking.';
    } else {
        document.getElementById('editNoteInfo').textContent = 'Update this note and explain the changes.';
    }
    
    document.getElementById('editNoteCode').value = note.display_code;
    document.getElementById('editNoteTitle').value = title;
    document.getElementById('editNoteText').value = text;
    document.getElementById('editDeviationCategory').value = note.deviation_category_id || '';
    document.getElementById('editJustification').value = note.deviation_reason || '';
    document.getElementById('editConformanceStatus').value = note.conformance_status_id || '';
    
    currentSelectedNote = projectNoteId;
    document.getElementById('editNoteModal').classList.add('show');
}

async function saveEditedNote() {
    const title = document.getElementById('editNoteTitle').value;
    const text = document.getElementById('editNoteText').value;
    const deviationCategory = document.getElementById('editDeviationCategory').value;
    const justification = document.getElementById('editJustification').value;
    const conformanceStatus = document.getElementById('editConformanceStatus').value;
    
    if (!title || !text || !deviationCategory || !justification || !conformanceStatus) {
        alert('Please fill in all required fields');
        return;
    }
    
    const note = projectNotes.find(n => n.project_note_id === currentSelectedNote);
    if (!note) {
        alert('Note not found');
        return;
    }
    
    const isStandard = note.source_type === 'standard' && !note.is_modified;
    
    if (isStandard) {
        try {
            const response = await fetch(`/api/project-sheet-notes/${currentSelectedNote}/create-modified-copy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    display_code: note.display_code,
                    custom_title: title,
                    custom_text: text,
                    deviation_category_id: deviationCategory,
                    deviation_reason: justification,
                    conformance_status_id: conformanceStatus
                })
            });
            
            if (response.ok) {
                closeModal('editNoteModal');
                loadNoteSet();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to save changes'));
            }
        } catch (error) {
            console.error('Error saving note:', error);
            alert('Failed to save changes');
        }
    } else {
        try {
            const response = await fetch(`/api/project-sheet-notes/${currentSelectedNote}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    custom_title: title,
                    custom_text: text,
                    deviation_category_id: deviationCategory,
                    deviation_reason: justification,
                    conformance_status_id: conformanceStatus
                })
            });
            
            if (response.ok) {
                closeModal('editNoteModal');
                loadNoteSet();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to save changes'));
            }
        } catch (error) {
            console.error('Error saving note:', error);
            alert('Failed to save changes');
        }
    }
}

async function deleteProjectNote(projectNoteId) {
    if (!confirm('Are you sure you want to delete this note?')) return;
    
    try {
        const response = await fetch(`/api/project-sheet-notes/${projectNoteId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadNoteSet();
        } else {
            alert('Failed to delete note');
        }
    } catch (error) {
        console.error('Error deleting note:', error);
        alert('Failed to delete note');
    }
}

async function loadDeviationCategories() {
    try {
        const response = await fetch('/api/conformance/deviation-categories');
        const data = await response.json();
        
        const select1 = document.getElementById('deviationCategory');
        const select2 = document.getElementById('customDeviationCategory');
        const select3 = document.getElementById('editDeviationCategory');
        
        const optionHtml = '<option value="">Select category...</option>' + 
            (data.categories || []).map(cat => 
                `<option value="${cat.category_id}">${cat.category_code} - ${cat.category_name}</option>`
            ).join('');
        
        select1.innerHTML = optionHtml;
        select2.innerHTML = optionHtml;
        select3.innerHTML = optionHtml;
    } catch (error) {
        console.error('Error loading deviation categories:', error);
    }
}

async function loadConformanceStatuses() {
    try {
        const response = await fetch('/api/conformance/statuses');
        const data = await response.json();
        
        const select1 = document.getElementById('conformanceStatus');
        const select2 = document.getElementById('customConformanceStatus');
        const select3 = document.getElementById('editConformanceStatus');
        
        const optionHtml = '<option value="">Select status...</option>' + 
            (data.conformance_statuses || []).map(status => 
                `<option value="${status.status_id}">${status.status_code} - ${status.status_name}</option>`
            ).join('');
        
        select1.innerHTML = optionHtml;
        select2.innerHTML = optionHtml;
        select3.innerHTML = optionHtml;
    } catch (error) {
        console.error('Error loading conformance statuses:', error);
    }
}

function refreshAll() {
    const activeProject = projectContext.getActiveProject();
    if (activeProject) {
        loadProjectNoteSets();
    }
    if (currentNoteSet) {
        loadNoteSet();
    }
}
</script>

{% endblock %}
