{% extends "base.html" %}

{% block title %}Project Command Center{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<style>
    /* Full-screen lock - no scrolling */
    body {
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    :root {
        --mc-primary: #00ffff;
        --mc-accent: #00ff88;
        --mc-bg-dark: rgba(0, 20, 40, 0.95);
        --mc-bg-section: rgba(0, 40, 80, 0.6);
        --mc-text: #e0f0ff;
        --header-height: 140px;
    }

    .command-center-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - var(--header-height));
        overflow: hidden;
        margin: 0;
        padding: 0;
    }

    /* Main content area with sidebar + map */
    .command-center-main {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 0;
        flex: 1 1 auto;
        min-height: 0;
        overflow: hidden;
    }

    /* Left Sidebar - All controls consolidated */
    .command-strip {
        background: var(--mc-bg-dark);
        border-right: 1px solid var(--mc-primary);
        border-radius: 0;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        overflow-y: auto;
    }

    .command-strip h3 {
        color: var(--mc-primary);
        font-family: 'Orbitron', monospace;
        font-size: 1.1rem;
        margin: 0 0 1rem 0;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .command-category {
        margin-bottom: 0.5rem;
        border: 1px solid rgba(0, 255, 255, 0.2);
        border-radius: 4px;
        background: rgba(0, 30, 60, 0.3);
    }

    .command-category-title {
        color: var(--mc-accent);
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.8rem;
        text-transform: uppercase;
        margin: 0;
        padding: 0.75rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        user-select: none;
    }

    .command-category-title:hover {
        background: rgba(0, 255, 136, 0.1);
        border-radius: 4px 4px 0 0;
    }

    .dropdown-toggle {
        font-size: 0.7rem;
        color: var(--mc-primary);
        transition: transform 0.2s;
    }

    .dropdown-toggle.expanded {
        transform: rotate(90deg);
    }

    .command-category-content {
        padding: 0.5rem;
        display: none;
    }

    .command-category-content.expanded {
        display: block;
    }

    .command-button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: rgba(0, 20, 40, 0.7);
        border: 1px solid rgba(0, 255, 255, 0.3);
        border-radius: 4px;
        color: var(--mc-text);
        text-decoration: none;
        transition: all 0.2s;
        margin-bottom: 0.4rem;
        font-family: 'Rajdhani', sans-serif;
        cursor: pointer;
        font-size: 0.8rem;
    }

    .command-button:hover {
        border-color: var(--mc-accent);
        background: rgba(0, 255, 136, 0.15);
        transform: translateX(3px);
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
    }

    .command-button i {
        color: var(--mc-primary);
        font-size: 0.9rem;
        width: 16px;
        text-align: center;
    }

    .command-button-text {
        flex: 1;
        font-size: 0.8rem;
    }

    .layer-checkbox-item, .basemap-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.75rem;
        margin-bottom: 0.3rem;
        border-radius: 3px;
        transition: background 0.2s;
        cursor: pointer;
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.75rem;
        color: var(--mc-text);
    }

    .layer-checkbox-item:hover, .basemap-option:hover {
        background: rgba(0, 255, 136, 0.1);
    }

    .layer-checkbox-item input[type="checkbox"],
    .basemap-option input[type="radio"] {
        cursor: pointer;
        accent-color: var(--mc-accent);
    }

    .layer-checkbox-label {
        flex: 1;
        font-size: 0.75rem;
    }

    .layer-count {
        color: var(--mc-accent);
        font-size: 0.7rem;
        opacity: 0.8;
    }

    .basemap-selector {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(0, 255, 136, 0.2);
    }

    .toggle-all-btn {
        width: 100%;
        padding: 0.5rem;
        background: rgba(0, 255, 136, 0.2);
        border: 1px solid var(--mc-accent);
        border-radius: 3px;
        color: var(--mc-accent);
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 0.5rem;
    }

    .toggle-all-btn:hover {
        background: rgba(0, 255, 136, 0.3);
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
    }

    /* Map Container - Read Only */
    .map-panel {
        background: rgba(0, 0, 0, 0.9);
        border: none;
        border-radius: 0;
        overflow: hidden;
        position: relative;
        z-index: 1;
        height: 100%;
        width: 100%;
    }

    #mapView {
        height: 100%;
        width: 100%;
    }

    .map-title {
        position: absolute;
        top: 1rem;
        left: 1rem;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid var(--mc-primary);
        border-radius: 4px;
        padding: 0.75rem 1rem;
        color: var(--mc-accent);
        font-family: 'Orbitron', monospace;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Map Controls Display */
    .map-controls-display {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid var(--mc-primary);
        border-radius: 8px;
        padding: 1rem;
        max-width: 250px;
    }

    .map-controls-title {
        color: var(--mc-accent);
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.85rem;
        text-transform: uppercase;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(0, 255, 136, 0.3);
    }

    .entity-count-item {
        display: flex;
        justify-content: space-between;
        padding: 0.4rem 0;
        color: var(--mc-text);
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.85rem;
        border-bottom: 1px solid rgba(0, 255, 255, 0.1);
    }

    .entity-count-item:last-child {
        border-bottom: none;
    }

    .entity-count-label {
        color: rgba(255, 255, 255, 0.7);
    }

    .entity-count-value {
        color: var(--mc-accent);
        font-weight: bold;
    }

    /* Health Summary Footer */
    .health-ribbon {
        background: linear-gradient(135deg, rgba(0, 20, 40, 0.85) 0%, rgba(0, 40, 60, 0.85) 100%);
        border: 1px solid var(--mc-primary);
        border-radius: 6px;
        padding: 0.75rem 1rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
        flex-shrink: 0;
        height: 70px;
    }

    .health-metric {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
    }

    .health-metric-value {
        font-size: 1.4rem;
        font-family: 'Orbitron', monospace;
        color: var(--mc-accent);
        font-weight: bold;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
        line-height: 1;
    }

    .health-metric-label {
        font-family: 'Rajdhani', sans-serif;
        color: var(--mc-primary);
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1;
    }

    /* Project Info Section */
    .project-info-box {
        background: var(--mc-bg-section);
        border: 1px solid var(--mc-primary);
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .project-name {
        color: var(--mc-accent);
        font-family: 'Orbitron', monospace;
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }

    .project-id {
        color: rgba(255, 255, 255, 0.5);
        font-family: 'Courier New', monospace;
        font-size: 0.75rem;
    }

    /* Full Screen Mode */
    body.fullscreen-mode {
        overflow: hidden;
    }

    body.fullscreen-mode .sticky-header-container {
        display: none !important;
    }

    body.fullscreen-mode .command-center-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        height: 100vh !important;
        z-index: 100;
    }

    .fullscreen-toggle-cc {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 1000;
        background: var(--mc-bg-dark);
        border: 2px solid var(--mc-accent);
        color: var(--mc-accent);
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        box-shadow: 0 0 15px rgba(0, 255, 136, 0.4);
        font-weight: bold;
        font-family: 'Rajdhani', sans-serif;
    }

    .fullscreen-toggle-cc:hover {
        background: var(--mc-accent);
        color: var(--mc-bg-dark);
        box-shadow: 0 0 25px rgba(0, 255, 136, 0.6);
        transform: scale(1.05);
    }

    .fullscreen-toggle-cc i {
        margin-right: 5px;
    }
</style>

<script>
// Set header height SYNCHRONOUSLY before page renders to prevent layout shift
(function() {
    function updateHeaderHeight() {
        const header = document.querySelector('.sticky-header-container');
        if (header) {
            const height = header.offsetHeight;
            document.documentElement.style.setProperty('--header-height', height + 'px');
        }
    }
    
    // Run immediately when script executes (blocking)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateHeaderHeight);
    } else {
        updateHeaderHeight();
    }
})();
</script>
{% endblock %}

{% block content %}
<script>
// Calculate header height BEFORE rendering content (runs synchronously)
(function() {
    const header = document.querySelector('.sticky-header-container');
    if (header) {
        const height = header.offsetHeight;
        document.documentElement.style.setProperty('--header-height', height + 'px');
    }
})();
</script>

<div class="command-center-container">
    <!-- Main Content: Sidebar + Map -->
    <div class="command-center-main">
        <!-- Left Sidebar - Consolidated Controls -->
        <div class="command-strip">
            <h3>Command Center</h3>
            
            <!-- Project Info -->
            <div class="project-info-box" id="projectInfoBox">
                <div class="project-name">Loading...</div>
                <div class="project-id"></div>
            </div>
            
            <!-- üéØ Quick Actions -->
            <div class="command-category">
                <div class="command-category-title" onclick="toggleDropdown('quickActions')">
                    <span class="dropdown-toggle expanded" id="toggle-quickActions">‚ñ∂</span>
                    <span>üéØ Quick Actions</span>
                </div>
                <div class="command-category-content expanded" id="content-quickActions">
                    <a href="/map-viewer-v2" class="command-button">
                        <i>üó∫Ô∏è</i>
                        <span class="command-button-text">Map Viewer</span>
                    </a>
                    <button class="command-button" onclick="refreshData()">
                        <i>üîÑ</i>
                        <span class="command-button-text">Refresh Data</span>
                    </button>
                </div>
            </div>
            
            <!-- üõ†Ô∏è Project Tools -->
            <div class="command-category">
                <div class="command-category-title" onclick="toggleDropdown('projectTools')">
                    <span class="dropdown-toggle" id="toggle-projectTools">‚ñ∂</span>
                    <span>üõ†Ô∏è Project Tools</span>
                </div>
                <div class="command-category-content" id="content-projectTools">
                    <a href="/tools/batch-cad-import" class="command-button">
                        <i>üì•</i>
                        <span class="command-button-text">CAD Import</span>
                    </a>
                    <a href="/tools/batch-point-import" class="command-button">
                        <i>üìç</i>
                        <span class="command-button-text">Point Import</span>
                    </a>
                    <a href="/tools/object-reclassifier" class="command-button">
                        <i>üîß</i>
                        <span class="command-button-text">Object Reclassifier</span>
                    </a>
                    <a href="/tools/survey-point-manager" class="command-button">
                        <i>üéØ</i>
                        <span class="command-button-text">Survey Point Manager</span>
                    </a>
                    <a href="/tools/survey-codes" class="command-button">
                        <i>üìù</i>
                        <span class="command-button-text">Survey Codes</span>
                    </a>
                    <a href="/tools/survey-code-tester" class="command-button">
                        <i>üß™</i>
                        <span class="command-button-text">Survey Code Tester</span>
                    </a>
                    <a href="/tools/batch-block-import" class="command-button">
                        <i>üì¶</i>
                        <span class="command-button-text">Batch Block Import</span>
                    </a>
                    <a href="/tools/z-stress-test" class="command-button">
                        <i>‚ö°</i>
                        <span class="command-button-text">Z-Stress Test</span>
                    </a>
                    <a href="/tools/dxf-test-generator" class="command-button">
                        <i>üé≤</i>
                        <span class="command-button-text">DXF Test Generator</span>
                    </a>
                    <a href="/tools/specialized-tools-directory" class="command-button">
                        <i>üîß</i>
                        <span class="command-button-text">Specialized Tools</span>
                    </a>
                </div>
            </div>
            
            <!-- üìê CAD Standards -->
            <div class="command-category">
                <div class="command-category-title" onclick="toggleDropdown('cadStandards')">
                    <span class="dropdown-toggle" id="toggle-cadStandards">‚ñ∂</span>
                    <span>üìê CAD Standards</span>
                </div>
                <div class="command-category-content" id="content-cadStandards">
                    <a href="/standards/layers" class="command-button">
                        <i>üìÑ</i>
                        <span class="command-button-text">Layers</span>
                    </a>
                    <a href="/standards/blocks" class="command-button">
                        <i>üî≤</i>
                        <span class="command-button-text">Blocks</span>
                    </a>
                    <a href="/standards/linetypes" class="command-button">
                        <i>‚ûñ</i>
                        <span class="command-button-text">Linetypes</span>
                    </a>
                    <a href="/standards/colors" class="command-button">
                        <i>üé®</i>
                        <span class="command-button-text">Colors</span>
                    </a>
                    <a href="/standards/text" class="command-button">
                        <i>üî§</i>
                        <span class="command-button-text">Text</span>
                    </a>
                    <a href="/standards/hatches" class="command-button">
                        <i>‚ñ¶</i>
                        <span class="command-button-text">Hatches</span>
                    </a>
                    <a href="/standards/details" class="command-button">
                        <i>üîç</i>
                        <span class="command-button-text">Details</span>
                    </a>
                    <a href="/standards/abbreviations" class="command-button">
                        <i>üìù</i>
                        <span class="command-button-text">Abbreviations</span>
                    </a>
                    <a href="/standards/materials" class="command-button">
                        <i>üß±</i>
                        <span class="command-button-text">Materials</span>
                    </a>
                    <a href="/standards/vocabulary" class="command-button">
                        <i>üìñ</i>
                        <span class="command-button-text">Vocabulary</span>
                    </a>
                    <a href="/standards/layer-vocabulary" class="command-button">
                        <i>üìö</i>
                        <span class="command-button-text">Layer Vocabulary</span>
                    </a>
                    <a href="/standards/reference-data" class="command-button">
                        <i>üìä</i>
                        <span class="command-button-text">Reference Data</span>
                    </a>
                    <a href="/standards/reference" class="command-button">
                        <i>üîñ</i>
                        <span class="command-button-text">Reference</span>
                    </a>
                    <a href="/standards/sheets" class="command-button">
                        <i>üìã</i>
                        <span class="command-button-text">Sheets</span>
                    </a>
                    <a href="/standards/plotstyles" class="command-button">
                        <i>üñ®Ô∏è</i>
                        <span class="command-button-text">Plotstyles</span>
                    </a>
                    <a href="/standards/viewports" class="command-button">
                        <i>üñºÔ∏è</i>
                        <span class="command-button-text">Viewports</span>
                    </a>
                    <a href="/standards/annotations" class="command-button">
                        <i>üí¨</i>
                        <span class="command-button-text">Annotations</span>
                    </a>
                    <a href="/standards/categories" class="command-button">
                        <i>üìÇ</i>
                        <span class="command-button-text">Categories</span>
                    </a>
                    <a href="/standards/codes" class="command-button">
                        <i>üî¢</i>
                        <span class="command-button-text">Codes</span>
                    </a>
                    <a href="/standards/notes" class="command-button">
                        <i>üìå</i>
                        <span class="command-button-text">Notes</span>
                    </a>
                    <a href="/standards/scales" class="command-button">
                        <i>üìè</i>
                        <span class="command-button-text">Scales</span>
                    </a>
                    <a href="/layer-generator" class="command-button">
                        <i>‚öôÔ∏è</i>
                        <span class="command-button-text">Layer Generator</span>
                    </a>
                    <a href="/standards/import-manager" class="command-button">
                        <i>üì•</i>
                        <span class="command-button-text">Import Manager</span>
                    </a>
                    <a href="/standards/bulk-editor" class="command-button">
                        <i>‚úèÔ∏è</i>
                        <span class="command-button-text">Bulk Editor</span>
                    </a>
                </div>
            </div>
            
            <!-- üó∫Ô∏è Map Controls -->
            <div class="command-category">
                <div class="command-category-title" onclick="toggleDropdown('mapControls')">
                    <span class="dropdown-toggle" id="toggle-mapControls">‚ñ∂</span>
                    <span>üó∫Ô∏è Map Controls</span>
                </div>
                <div class="command-category-content" id="content-mapControls">
                    <div class="basemap-selector">
                        <div style="font-size: 0.7rem; color: var(--mc-accent); margin-bottom: 0.5rem; text-transform: uppercase;">Basemap</div>
                        <label class="basemap-option">
                            <input type="radio" name="basemap" value="streets" checked onchange="changeBasemap('streets')">
                            <span>Streets</span>
                        </label>
                        <label class="basemap-option">
                            <input type="radio" name="basemap" value="satellite" onchange="changeBasemap('satellite')">
                            <span>Satellite</span>
                        </label>
                        <label class="basemap-option">
                            <input type="radio" name="basemap" value="topo" onchange="changeBasemap('topo')">
                            <span>Topo</span>
                        </label>
                        <label class="basemap-option">
                            <input type="radio" name="basemap" value="dark" onchange="changeBasemap('dark')">
                            <span>Dark</span>
                        </label>
                    </div>
                    
                    <div style="font-size: 0.7rem; color: var(--mc-accent); margin-bottom: 0.5rem; text-transform: uppercase;">Layers</div>
                    <div id="layerToggles">
                        <div style="color: rgba(255,255,255,0.5); text-align: center; font-size: 0.75rem; padding: 1rem 0;">
                            Loading layers...
                        </div>
                    </div>
                    <button class="toggle-all-btn" onclick="toggleAllLayers()">Toggle All</button>
                </div>
            </div>
            
            <!-- üß≠ Navigation -->
            <div class="command-category">
                <div class="command-category-title" onclick="toggleDropdown('navigation')">
                    <span class="dropdown-toggle" id="toggle-navigation">‚ñ∂</span>
                    <span>üß≠ Navigation</span>
                </div>
                <div class="command-category-content" id="content-navigation">
                    <a href="/" class="command-button">
                        <i>üè†</i>
                        <span class="command-button-text">Home</span>
                    </a>
                    <a href="/projects" class="command-button">
                        <i>üìÇ</i>
                        <span class="command-button-text">All Projects</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Map Panel - Read Only Context View -->
        <div class="map-panel">
            <button class="fullscreen-toggle-cc" onclick="toggleFullScreenCC()" title="Toggle Full Screen Mode">
                <i class="fas fa-expand"></i>
                <span id="fullscreenBtnTextCC">Full Screen</span>
            </button>
            <div class="map-title">Project Overview Map</div>
            <div id="mapView"></div>
        </div>
    </div>
    
    <!-- Health Metrics Footer -->
    <div class="health-ribbon">
        <div class="health-metric">
            <div class="health-metric-value" id="entityCount">--</div>
            <div class="health-metric-label">Total Entities</div>
        </div>
        <div class="health-metric">
            <div class="health-metric-value" id="layerCount">--</div>
            <div class="health-metric-label">Layers</div>
        </div>
        <div class="health-metric">
            <div class="health-metric-value" id="intelligentObjectCount">--</div>
            <div class="health-metric-label">Intelligent Objects</div>
        </div>
        <div class="health-metric">
            <div class="health-metric-value" id="drawingCount">--</div>
            <div class="health-metric-label">Drawings</div>
        </div>
    </div>
</div>

<script>
// Calculate and set header height dynamically
function setHeaderHeight() {
    const header = document.querySelector('.sticky-header-container');
    if (header) {
        const height = header.offsetHeight;
        document.documentElement.style.setProperty('--header-height', `${height}px`);
    }
}

// Set header height on load and resize
window.addEventListener('load', setHeaderHeight);
window.addEventListener('resize', setHeaderHeight);

// Watch for header changes (e.g., when project selector is revealed)
const headerObserver = new MutationObserver(() => {
    setTimeout(setHeaderHeight, 50); // Small delay to let layout settle
});

// Start observing header for attribute and child changes
window.addEventListener('load', () => {
    const header = document.querySelector('.sticky-header-container');
    if (header) {
        headerObserver.observe(header, {
            attributes: true,
            childList: true,
            subtree: true
        });
    }
});

let map;
let activeProjectId = null;
let projectData = null;
let layerGroups = {};
let currentBasemap = null;

const basemaps = {
    streets: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }),
    satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '¬© Esri'
    }),
    topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenTopoMap contributors'
    }),
    dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© CartoDB'
    })
};

// Initialize read-only map
function initMap() {
    map = L.map('mapView', {
        zoomControl: false,
        dragging: false,
        touchZoom: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        tap: false
    }).setView([37.7749, -122.4194], 13);
    
    currentBasemap = basemaps.streets;
    currentBasemap.addTo(map);
}

// Toggle dropdown sections
function toggleDropdown(sectionId) {
    const toggle = document.getElementById(`toggle-${sectionId}`);
    const content = document.getElementById(`content-${sectionId}`);
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        toggle.classList.remove('expanded');
    } else {
        content.classList.add('expanded');
        toggle.classList.add('expanded');
    }
}

// Change basemap
function changeBasemap(basemapType) {
    if (currentBasemap) {
        map.removeLayer(currentBasemap);
    }
    currentBasemap = basemaps[basemapType];
    currentBasemap.addTo(map);
}

// Toggle full screen mode
function toggleFullScreenCC() {
    const body = document.body;
    const isFullScreen = body.classList.contains('fullscreen-mode');
    const btnText = document.getElementById('fullscreenBtnTextCC');
    const btnIcon = document.querySelector('.fullscreen-toggle-cc i');
    
    if (isFullScreen) {
        // Exit full screen
        body.classList.remove('fullscreen-mode');
        btnText.textContent = 'Full Screen';
        btnIcon.className = 'fas fa-expand';
    } else {
        // Enter full screen
        body.classList.add('fullscreen-mode');
        btnText.textContent = 'Exit Full Screen';
        btnIcon.className = 'fas fa-compress';
    }
    
    // Invalidate map size after layout change
    setTimeout(() => {
        map.invalidateSize();
    }, 100);
}

// ESC key to exit full screen
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.body.classList.contains('fullscreen-mode')) {
        toggleFullScreenCC();
    }
});

// Fetch active project
async function fetchActiveProject() {
    try {
        const response = await fetch('/api/active-project');
        const data = await response.json();
        
        if (data.active_project) {
            activeProjectId = data.active_project.project_id;
            displayProjectInfo(data.active_project);
            loadProjectData();
        } else {
            displayNoProject();
        }
    } catch (error) {
        console.error('Error fetching active project:', error);
        displayError();
    }
}

// Display project info
function displayProjectInfo(project) {
    const infoBox = document.getElementById('projectInfoBox');
    infoBox.innerHTML = `
        <div class="project-name">${project.project_name}</div>
        <div class="project-id">${project.project_id}</div>
    `;
}

// Display no project message
function displayNoProject() {
    const infoBox = document.getElementById('projectInfoBox');
    infoBox.innerHTML = `
        <div class="project-name" style="color: #ffaa00;">No Active Project</div>
        <div class="project-id">Please select a project</div>
    `;
}

// Display error message
function displayError() {
    const infoBox = document.getElementById('projectInfoBox');
    infoBox.innerHTML = `
        <div class="project-name" style="color: #ff6666;">Error</div>
        <div class="project-id">Failed to load project</div>
    `;
}

// Load project data and display on map
async function loadProjectData() {
    if (!activeProjectId) return;
    
    try {
        // Load drawing entities for map display
        const mapResponse = await fetch(`/api/projects/${activeProjectId}/drawing-entities-map`);
        const mapData = await mapResponse.json();
        
        if (mapData.has_spatial_data) {
            displayMapData(mapData);
        }
        
        // Load statistics for health metrics
        const statsResponse = await fetch(`/api/projects/${activeProjectId}/statistics`);
        const statsData = await statsResponse.json();
        
        displayHealthMetrics(statsData);
        displayMapControls(mapData);
        
    } catch (error) {
        console.error('Error loading project data:', error);
    }
}

// Display map data
function displayMapData(data) {
    if (!data.layer_groups || data.layer_groups.length === 0) return;
    
    // Remove existing layers from map before adding new ones
    Object.values(layerGroups).forEach(group => {
        if (group.layer) {
            map.removeLayer(group.layer);
        }
    });
    
    layerGroups = {};
    
    // Add all layer groups to map and store references
    data.layer_groups.forEach(groupData => {
        const layerGroup = L.geoJSON(groupData.features, {
            style: {
                color: groupData.color,
                weight: 2,
                opacity: 0.7,
                fillOpacity: 0.2
            },
            pointToLayer: function(feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 4,
                    fillColor: groupData.color,
                    color: groupData.color,
                    weight: 2,
                    opacity: 0.7,
                    fillOpacity: 0.5
                });
            }
        }).addTo(map);
        
        layerGroups[groupData.id] = {
            layer: layerGroup,
            name: groupData.name,
            category: groupData.category,
            count: groupData.feature_count,
            visible: true
        };
    });
    
    // Auto-fit to project extent
    if (data.bbox) {
        const bounds = [
            [data.bbox.min_y, data.bbox.min_x],
            [data.bbox.max_y, data.bbox.max_x]
        ];
        map.fitBounds(bounds, { padding: [20, 20] });
    }
}

// Toggle layer visibility
function toggleLayer(groupId, visible) {
    if (layerGroups[groupId]) {
        if (visible) {
            map.addLayer(layerGroups[groupId].layer);
        } else {
            map.removeLayer(layerGroups[groupId].layer);
        }
        layerGroups[groupId].visible = visible;
    }
}

// Toggle all layers
function toggleAllLayers() {
    const anyVisible = Object.values(layerGroups).some(g => g.visible);
    const newState = !anyVisible;
    
    Object.keys(layerGroups).forEach(groupId => {
        toggleLayer(groupId, newState);
        const checkbox = document.getElementById(`layer-${groupId}`);
        if (checkbox) {
            checkbox.checked = newState;
        }
    });
}

// Display map controls (layer checkboxes in sidebar)
function displayMapControls(data) {
    const layerTogglesContainer = document.getElementById('layerToggles');
    
    if (!data.layer_groups || data.layer_groups.length === 0) {
        layerTogglesContainer.innerHTML = `
            <div style="color: rgba(255,255,255,0.5); text-align: center; font-size: 0.75rem; padding: 1rem 0;">
                No layers available
            </div>
        `;
        return;
    }
    
    let html = '';
    data.layer_groups.forEach(group => {
        html += `
            <label class="layer-checkbox-item">
                <input 
                    type="checkbox" 
                    id="layer-${group.id}" 
                    checked 
                    onchange="toggleLayer('${group.id}', this.checked)"
                >
                <span class="layer-checkbox-label">${group.name}</span>
                <span class="layer-count">${group.feature_count}</span>
            </label>
        `;
    });
    
    layerTogglesContainer.innerHTML = html;
}

// Display health metrics
function displayHealthMetrics(data) {
    document.getElementById('entityCount').textContent = data.total_entities || 0;
    document.getElementById('layerCount').textContent = data.total_layers || 0;
    document.getElementById('intelligentObjectCount').textContent = data.total_intelligent_objects || 0;
    document.getElementById('drawingCount').textContent = data.drawing_count || 0;
}

// Refresh data
function refreshData() {
    loadProjectData();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    fetchActiveProject();
});
</script>
{% endblock %}
