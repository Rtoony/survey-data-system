{% extends "base.html" %}

{% block title %}Project Command Center{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<style>
    :root {
        --mc-primary: #00ffff;
        --mc-accent: #00ff88;
        --mc-bg-dark: rgba(0, 20, 40, 0.95);
        --mc-bg-section: rgba(0, 40, 80, 0.6);
        --mc-text: #e0f0ff;
    }

    .command-center-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 120px);
        gap: 0.75rem;
        padding: 1rem;
    }

    /* Main content area with sidebar + map */
    .command-center-main {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 1rem;
        flex: 1 1 auto;
        min-height: 0;
        overflow: hidden;
    }

    /* Left Sidebar - All controls consolidated */
    .command-strip {
        background: var(--mc-bg-dark);
        border: 1px solid var(--mc-primary);
        border-radius: 8px;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        overflow-y: auto;
    }

    .command-strip h3 {
        color: var(--mc-primary);
        font-family: 'Orbitron', monospace;
        font-size: 1.1rem;
        margin: 0 0 1rem 0;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .command-category {
        margin-bottom: 1.5rem;
    }

    .command-category-title {
        color: var(--mc-accent);
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.85rem;
        text-transform: uppercase;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(0, 255, 136, 0.3);
    }

    .command-button {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: rgba(0, 20, 40, 0.7);
        border: 1px solid rgba(0, 255, 255, 0.3);
        border-radius: 4px;
        color: var(--mc-text);
        text-decoration: none;
        transition: all 0.2s;
        margin-bottom: 0.5rem;
        font-family: 'Rajdhani', sans-serif;
        cursor: pointer;
    }

    .command-button:hover {
        border-color: var(--mc-accent);
        background: rgba(0, 255, 136, 0.15);
        transform: translateX(5px);
        box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
    }

    .command-button i {
        color: var(--mc-primary);
        font-size: 1.1rem;
        width: 20px;
        text-align: center;
    }

    .command-button-text {
        flex: 1;
        font-size: 0.9rem;
    }

    /* Map Container - Read Only */
    .map-panel {
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid var(--mc-primary);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        z-index: 1;
    }

    #mapView {
        height: 100%;
        width: 100%;
    }

    .map-title {
        position: absolute;
        top: 1rem;
        left: 1rem;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid var(--mc-primary);
        border-radius: 4px;
        padding: 0.75rem 1rem;
        color: var(--mc-accent);
        font-family: 'Orbitron', monospace;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Map Controls Display */
    .map-controls-display {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid var(--mc-primary);
        border-radius: 8px;
        padding: 1rem;
        max-width: 250px;
    }

    .map-controls-title {
        color: var(--mc-accent);
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.85rem;
        text-transform: uppercase;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(0, 255, 136, 0.3);
    }

    .entity-count-item {
        display: flex;
        justify-content: space-between;
        padding: 0.4rem 0;
        color: var(--mc-text);
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.85rem;
        border-bottom: 1px solid rgba(0, 255, 255, 0.1);
    }

    .entity-count-item:last-child {
        border-bottom: none;
    }

    .entity-count-label {
        color: rgba(255, 255, 255, 0.7);
    }

    .entity-count-value {
        color: var(--mc-accent);
        font-weight: bold;
    }

    /* Health Summary Footer */
    .health-ribbon {
        background: linear-gradient(135deg, rgba(0, 20, 40, 0.85) 0%, rgba(0, 40, 60, 0.85) 100%);
        border: 1px solid var(--mc-primary);
        border-radius: 6px;
        padding: 0.75rem 1rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
        flex-shrink: 0;
        height: 70px;
    }

    .health-metric {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
    }

    .health-metric-value {
        font-size: 1.4rem;
        font-family: 'Orbitron', monospace;
        color: var(--mc-accent);
        font-weight: bold;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
        line-height: 1;
    }

    .health-metric-label {
        font-family: 'Rajdhani', sans-serif;
        color: var(--mc-primary);
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1;
    }

    /* Project Info Section */
    .project-info-box {
        background: var(--mc-bg-section);
        border: 1px solid var(--mc-primary);
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .project-name {
        color: var(--mc-accent);
        font-family: 'Orbitron', monospace;
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }

    .project-id {
        color: rgba(255, 255, 255, 0.5);
        font-family: 'Courier New', monospace;
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="command-center-container">
    <!-- Main Content: Sidebar + Map -->
    <div class="command-center-main">
        <!-- Left Sidebar - Consolidated Controls -->
        <div class="command-strip">
            <h3>Command Center</h3>
            
            <!-- Project Info -->
            <div class="project-info-box" id="projectInfoBox">
                <div class="project-name">Loading...</div>
                <div class="project-id"></div>
            </div>
            
            <!-- Quick Actions -->
            <div class="command-category">
                <div class="command-category-title">Quick Actions</div>
                <a href="/map-viewer-v2" class="command-button">
                    <i>üó∫Ô∏è</i>
                    <span class="command-button-text">Map Viewer</span>
                </a>
                <button class="command-button" onclick="refreshData()">
                    <i>üîÑ</i>
                    <span class="command-button-text">Refresh Data</span>
                </button>
            </div>
            
            <!-- Project Settings -->
            <div class="command-category">
                <div class="command-category-title">Project Settings</div>
                <a href="/tools/reference-data-mappings" class="command-button">
                    <i>üìã</i>
                    <span class="command-button-text">Reference Data Mappings</span>
                </a>
                <a href="/tools/assign-standards" class="command-button">
                    <i>üìê</i>
                    <span class="command-button-text">Assign Standards</span>
                </a>
            </div>
            
            <!-- Data Management -->
            <div class="command-category">
                <div class="command-category-title">Data Management</div>
                <a href="/tools/batch-cad-import" class="command-button">
                    <i>üì•</i>
                    <span class="command-button-text">CAD Import</span>
                </a>
                <a href="/tools/batch-point-import" class="command-button">
                    <i>üìç</i>
                    <span class="command-button-text">Point Import</span>
                </a>
                <a href="/tools/survey-point-manager" class="command-button">
                    <i>üéØ</i>
                    <span class="command-button-text">Survey Point Manager</span>
                </a>
            </div>
            
            <!-- Standards & Templates -->
            <div class="command-category">
                <div class="command-category-title">Standards</div>
                <a href="/standards/layers" class="command-button">
                    <i>üìÑ</i>
                    <span class="command-button-text">Layer Standards</span>
                </a>
                <a href="/standards/blocks" class="command-button">
                    <i>üî≤</i>
                    <span class="command-button-text">Block Standards</span>
                </a>
                <a href="/standards/linetypes" class="command-button">
                    <i>‚ûñ</i>
                    <span class="command-button-text">Linetypes</span>
                </a>
            </div>
            
            <!-- Project Navigation -->
            <div class="command-category">
                <div class="command-category-title">Navigation</div>
                <a href="/" class="command-button">
                    <i>üè†</i>
                    <span class="command-button-text">Home</span>
                </a>
                <a href="/projects" class="command-button">
                    <i>üìÇ</i>
                    <span class="command-button-text">All Projects</span>
                </a>
            </div>
        </div>
        
        <!-- Map Panel - Read Only Context View -->
        <div class="map-panel">
            <div class="map-title">Project Overview Map</div>
            <div class="map-controls-display" id="mapControlsDisplay">
                <div class="map-controls-title">Map Entities</div>
                <div id="entityCounts">
                    <div style="color: rgba(255,255,255,0.5); text-align: center; font-size: 0.85rem;">
                        Loading...
                    </div>
                </div>
            </div>
            <div id="mapView"></div>
        </div>
    </div>
    
    <!-- Health Metrics Footer -->
    <div class="health-ribbon">
        <div class="health-metric">
            <div class="health-metric-value" id="entityCount">--</div>
            <div class="health-metric-label">Total Entities</div>
        </div>
        <div class="health-metric">
            <div class="health-metric-value" id="layerCount">--</div>
            <div class="health-metric-label">Layers</div>
        </div>
        <div class="health-metric">
            <div class="health-metric-value" id="intelligentObjectCount">--</div>
            <div class="health-metric-label">Intelligent Objects</div>
        </div>
        <div class="health-metric">
            <div class="health-metric-value" id="drawingCount">--</div>
            <div class="health-metric-label">Drawings</div>
        </div>
    </div>
</div>

<script>
let map;
let activeProjectId = null;
let projectData = null;

// Initialize read-only map
function initMap() {
    map = L.map('mapView', {
        zoomControl: false,
        dragging: false,
        touchZoom: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        tap: false
    }).setView([37.7749, -122.4194], 13);
    
    // Add basemap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
}

// Fetch active project
async function fetchActiveProject() {
    try {
        const response = await fetch('/api/active-project');
        const data = await response.json();
        
        if (data.active_project) {
            activeProjectId = data.active_project.project_id;
            displayProjectInfo(data.active_project);
            loadProjectData();
        } else {
            displayNoProject();
        }
    } catch (error) {
        console.error('Error fetching active project:', error);
        displayError();
    }
}

// Display project info
function displayProjectInfo(project) {
    const infoBox = document.getElementById('projectInfoBox');
    infoBox.innerHTML = `
        <div class="project-name">${project.project_name}</div>
        <div class="project-id">${project.project_id}</div>
    `;
}

// Display no project message
function displayNoProject() {
    const infoBox = document.getElementById('projectInfoBox');
    infoBox.innerHTML = `
        <div class="project-name" style="color: #ffaa00;">No Active Project</div>
        <div class="project-id">Please select a project</div>
    `;
}

// Display error message
function displayError() {
    const infoBox = document.getElementById('projectInfoBox');
    infoBox.innerHTML = `
        <div class="project-name" style="color: #ff6666;">Error</div>
        <div class="project-id">Failed to load project</div>
    `;
}

// Load project data and display on map
async function loadProjectData() {
    if (!activeProjectId) return;
    
    try {
        // Load drawing entities for map display
        const mapResponse = await fetch(`/api/projects/${activeProjectId}/drawing-entities-map`);
        const mapData = await mapResponse.json();
        
        if (mapData.has_spatial_data) {
            displayMapData(mapData);
        }
        
        // Load statistics for health metrics
        const statsResponse = await fetch(`/api/projects/${activeProjectId}/statistics`);
        const statsData = await statsResponse.json();
        
        displayHealthMetrics(statsData);
        displayMapControls(mapData);
        
    } catch (error) {
        console.error('Error loading project data:', error);
    }
}

// Display map data
function displayMapData(data) {
    if (!data.layer_groups || data.layer_groups.length === 0) return;
    
    // Add all layer groups to map
    data.layer_groups.forEach(groupData => {
        L.geoJSON(groupData.features, {
            style: {
                color: groupData.color,
                weight: 2,
                opacity: 0.7,
                fillOpacity: 0.2
            },
            pointToLayer: function(feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 4,
                    fillColor: groupData.color,
                    color: groupData.color,
                    weight: 2,
                    opacity: 0.7,
                    fillOpacity: 0.5
                });
            }
        }).addTo(map);
    });
    
    // Auto-fit to project extent
    if (data.bbox) {
        const bounds = [
            [data.bbox.min_y, data.bbox.min_x],
            [data.bbox.max_y, data.bbox.max_x]
        ];
        map.fitBounds(bounds, { padding: [20, 20] });
    }
}

// Display map controls (entity counts)
function displayMapControls(data) {
    const container = document.getElementById('entityCounts');
    
    if (!data.layer_groups || data.layer_groups.length === 0) {
        container.innerHTML = `
            <div style="color: rgba(255,255,255,0.5); text-align: center; font-size: 0.85rem;">
                No entities
            </div>
        `;
        return;
    }
    
    // Group by category and sum counts
    const categoryCounts = {};
    data.layer_groups.forEach(group => {
        const category = group.category;
        if (!categoryCounts[category]) {
            categoryCounts[category] = 0;
        }
        categoryCounts[category] += group.feature_count;
    });
    
    let html = '';
    Object.entries(categoryCounts).forEach(([category, count]) => {
        html += `
            <div class="entity-count-item">
                <span class="entity-count-label">${category}</span>
                <span class="entity-count-value">${count}</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Display health metrics
function displayHealthMetrics(data) {
    document.getElementById('entityCount').textContent = data.total_entities || 0;
    document.getElementById('layerCount').textContent = data.total_layers || 0;
    document.getElementById('intelligentObjectCount').textContent = data.total_intelligent_objects || 0;
    document.getElementById('drawingCount').textContent = data.drawing_count || 0;
}

// Refresh data
function refreshData() {
    loadProjectData();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    fetchActiveProject();
});
</script>
{% endblock %}
