{% extends "base.html" %}

{% block title %}Usage Tracking Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <h2 class="orbitron"><i class="fas fa-chart-line neon-cyan"></i> Usage Tracking Dashboard</h2>
    <p class="subtitle">Monitor project and standards usage patterns</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="totalProjects">-</div>
        <div class="stat-label">Total Projects</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="totalLayers">-</div>
        <div class="stat-label">Unique Layers Used</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="totalBlocks">-</div>
        <div class="stat-label">Block Instances</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="avgEntities">-</div>
        <div class="stat-label">Avg Entities/Project</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <div class="panel">
        <h3 class="orbitron"><i class="fas fa-briefcase"></i> Most Active Projects</h3>
        <div id="topProjectsLoading" style="text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>
        <div id="topProjectsTable" style="display: none;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Entities</th>
                        <th>Layers</th>
                        <th>Last Modified</th>
                    </tr>
                </thead>
                <tbody id="topProjectsBody"></tbody>
            </table>
        </div>
        <div id="topProjectsEmpty" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
            No project data available
        </div>
    </div>

    <div class="panel">
        <h3 class="orbitron"><i class="fas fa-layer-group"></i> Most Used Layers</h3>
        <div id="topLayersLoading" style="text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>
        <div id="topLayersTable" style="display: none;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Layer Name</th>
                        <th>Projects</th>
                        <th>Usage Count</th>
                        <th>Category</th>
                    </tr>
                </thead>
                <tbody id="topLayersBody"></tbody>
            </table>
        </div>
        <div id="topLayersEmpty" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
            No layer usage data available
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <div class="panel">
        <h3 class="orbitron"><i class="fas fa-sticky-note"></i> Most Used Standard Notes</h3>
        <div id="topNotesLoading" style="text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>
        <div id="topNotesTable" style="display: none;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Note Title</th>
                        <th>Category</th>
                        <th>Usage Count</th>
                    </tr>
                </thead>
                <tbody id="topNotesBody"></tbody>
            </table>
        </div>
        <div id="topNotesEmpty" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
            No notes data available
        </div>
    </div>

    <div class="panel">
        <h3 class="orbitron"><i class="fas fa-cube"></i> Most Used Blocks</h3>
        <div id="topBlocksLoading" style="text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>
        <div id="topBlocksTable" style="display: none;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Block Name</th>
                        <th>Category</th>
                        <th>Usage Count</th>
                    </tr>
                </thead>
                <tbody id="topBlocksBody"></tbody>
            </table>
        </div>
        <div id="topBlocksEmpty" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
            No blocks data available
        </div>
    </div>
</div>

<div class="panel">
    <h3 class="orbitron"><i class="fas fa-history"></i> Recent Project Activity</h3>
    <div id="recentActivityLoading" style="text-align: center; padding: 40px;">
        <i class="fas fa-spinner fa-spin"></i> Loading...
    </div>
    <div id="recentActivityTable" style="display: none;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Project Name</th>
                    <th>Project Number</th>
                    <th>Entities</th>
                    <th>Created</th>
                    <th>Last Modified</th>
                </tr>
            </thead>
            <tbody id="recentActivityBody"></tbody>
        </table>
    </div>
    <div id="recentActivityEmpty" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
        No activity data available
    </div>
</div>

<style>
.data-table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(0, 20, 40, 0.4);
    margin-top: 15px;
}

.data-table th {
    background: rgba(0, 100, 150, 0.3);
    padding: 10px;
    text-align: left;
    border-bottom: 2px solid var(--neon-cyan);
    font-weight: 600;
    font-size: 0.9em;
}

.data-table td {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border-color);
    font-size: 0.9em;
}

.data-table tbody tr:hover {
    background: rgba(0, 100, 150, 0.2);
}

.usage-badge {
    background: rgba(0, 200, 255, 0.2);
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 600;
}

.timestamp {
    color: var(--text-secondary);
    font-size: 0.85em;
}
</style>

<script>
async function loadDashboard() {
    try {
        await Promise.all([
            loadSummaryStats(),
            loadTopProjects(),
            loadTopLayers(),
            loadTopNotes(),
            loadTopBlocks(),
            loadRecentActivity()
        ]);
    } catch (error) {
        console.error('Error loading dashboard:', error);
    }
}

async function loadSummaryStats() {
    try {
        const response = await fetch('/api/usage/summary');
        const data = await response.json();
        
        if (data.error) {
            console.error('Summary stats error:', data.error);
            return;
        }
        
        document.getElementById('totalProjects').textContent = data.total_projects || 0;
        document.getElementById('totalLayers').textContent = data.unique_layers || 0;
        document.getElementById('totalBlocks').textContent = data.total_block_instances || 0;
        document.getElementById('avgEntities').textContent = data.avg_entities_per_project || 0;
    } catch (error) {
        console.error('Failed to load summary stats:', error);
    }
}

async function loadTopProjects() {
    try {
        const response = await fetch('/api/usage/top-projects');
        const data = await response.json();
        
        document.getElementById('topProjectsLoading').style.display = 'none';
        
        if (data.error || !data.projects || data.projects.length === 0) {
            document.getElementById('topProjectsEmpty').style.display = 'block';
            return;
        }
        
        const tbody = document.getElementById('topProjectsBody');
        tbody.innerHTML = data.projects.map(p => `
            <tr>
                <td><strong>${p.project_name || 'Unnamed'}</strong><br>
                    <small style="color: var(--text-secondary);">${p.project_number || '-'}</small>
                </td>
                <td>${p.entity_count || 0}</td>
                <td>${p.layer_count || 0}</td>
                <td class="timestamp">${p.last_modified ? new Date(p.last_modified).toLocaleDateString() : 'Never'}</td>
            </tr>
        `).join('');
        
        document.getElementById('topProjectsTable').style.display = 'block';
    } catch (error) {
        document.getElementById('topProjectsLoading').style.display = 'none';
        document.getElementById('topProjectsEmpty').style.display = 'block';
        console.error('Failed to load top projects:', error);
    }
}

async function loadTopLayers() {
    try {
        const response = await fetch('/api/usage/top-layers');
        const data = await response.json();
        
        document.getElementById('topLayersLoading').style.display = 'none';
        
        if (data.error || !data.layers || data.layers.length === 0) {
            document.getElementById('topLayersEmpty').style.display = 'block';
            return;
        }
        
        const tbody = document.getElementById('topLayersBody');
        tbody.innerHTML = data.layers.map(l => `
            <tr>
                <td><strong>${l.layer_name || 'Unknown'}</strong></td>
                <td><span class="usage-badge">${l.project_count || 0}</span></td>
                <td>${l.usage_count || 0}</td>
                <td>${l.category || '-'}</td>
            </tr>
        `).join('');
        
        document.getElementById('topLayersTable').style.display = 'block';
    } catch (error) {
        document.getElementById('topLayersLoading').style.display = 'none';
        document.getElementById('topLayersEmpty').style.display = 'block';
        console.error('Failed to load top layers:', error);
    }
}

async function loadTopNotes() {
    try {
        const response = await fetch('/api/usage/top-notes');
        const data = await response.json();
        
        document.getElementById('topNotesLoading').style.display = 'none';
        
        if (data.error || !data.notes || data.notes.length === 0) {
            document.getElementById('topNotesEmpty').style.display = 'block';
            return;
        }
        
        const tbody = document.getElementById('topNotesBody');
        tbody.innerHTML = data.notes.map(n => `
            <tr>
                <td><strong>${n.note_title}</strong></td>
                <td>${n.note_category || 'General'}</td>
                <td><span class="usage-badge">${n.usage_frequency || 0}</span></td>
            </tr>
        `).join('');
        
        document.getElementById('topNotesTable').style.display = 'block';
    } catch (error) {
        document.getElementById('topNotesLoading').style.display = 'none';
        document.getElementById('topNotesEmpty').style.display = 'block';
        console.error('Failed to load top notes:', error);
    }
}

async function loadTopBlocks() {
    try {
        const response = await fetch('/api/usage/top-blocks');
        const data = await response.json();
        
        document.getElementById('topBlocksLoading').style.display = 'none';
        
        if (data.error || !data.blocks || data.blocks.length === 0) {
            document.getElementById('topBlocksEmpty').style.display = 'block';
            return;
        }
        
        const tbody = document.getElementById('topBlocksBody');
        tbody.innerHTML = data.blocks.map(b => `
            <tr>
                <td><strong>${b.block_name}</strong></td>
                <td>${b.symbol_category || '-'}</td>
                <td><span class="usage-badge">${b.usage_frequency || 0}</span></td>
            </tr>
        `).join('');
        
        document.getElementById('topBlocksTable').style.display = 'block';
    } catch (error) {
        document.getElementById('topBlocksLoading').style.display = 'none';
        document.getElementById('topBlocksEmpty').style.display = 'block';
        console.error('Failed to load top blocks:', error);
    }
}

async function loadRecentActivity() {
    try {
        const response = await fetch('/api/usage/recent-activity');
        const data = await response.json();
        
        document.getElementById('recentActivityLoading').style.display = 'none';
        
        if (data.error || !data.activity || data.activity.length === 0) {
            document.getElementById('recentActivityEmpty').style.display = 'block';
            return;
        }
        
        const tbody = document.getElementById('recentActivityBody');
        tbody.innerHTML = data.activity.map(a => `
            <tr>
                <td><strong>${a.project_name || 'Unnamed'}</strong></td>
                <td>${a.project_number || '-'}</td>
                <td>${a.entity_count || 0}</td>
                <td class="timestamp">${a.created_at ? new Date(a.created_at).toLocaleDateString() : '-'}</td>
                <td class="timestamp">${a.updated_at ? new Date(a.updated_at).toLocaleDateString() : 'Never'}</td>
            </tr>
        `).join('');
        
        document.getElementById('recentActivityTable').style.display = 'block';
    } catch (error) {
        document.getElementById('recentActivityLoading').style.display = 'none';
        document.getElementById('recentActivityEmpty').style.display = 'block';
        console.error('Failed to load recent activity:', error);
    }
}

document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
{% endblock %}
