{% extends "base_specialized_tool.html" %}

{% block tool_title %}BMP Manager{% endblock %}
{% block tool_icon %}fas fa-leaf{% endblock %}
{% block tool_description %}Manage stormwater Best Management Practices (bioswales, detention basins, infiltration systems){% endblock %}

{% block content_layout_class %}tool-complex-layout{% endblock %}

{% block leaflet_assets %}
<!-- Not using Leaflet, using SVG viewer instead -->
{% endblock %}

{% block extra_head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/specialized-tool-info.js') }}"></script>
<script src="/static/js/entity_viewer_core.js"></script>
{% endblock %}

{% block sidebar_content %}
<!-- BMP Selector -->
<div class="tool-filter-section">
    <h4>BMP Selection</h4>
    <div class="tool-filter-item">
        <label>Select BMP:</label>
        <select id="bmpSelect" onchange="loadBMP()">
            <option value="">Loading BMPs...</option>
        </select>
    </div>
</div>

<!-- Filters -->
<div class="tool-filter-section">
    <h4>BMP Type</h4>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="filterBioretention" checked onchange="applyFilters()">
        <label for="filterBioretention">Bioretention</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="filterInfiltration" checked onchange="applyFilters()">
        <label for="filterInfiltration">Infiltration</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="filterDetention" checked onchange="applyFilters()">
        <label for="filterDetention">Detention Basin</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="filterSwale" checked onchange="applyFilters()">
        <label for="filterSwale">Swale</label>
    </div>
    <div class="tool-filter-item" style="margin-top: 0.75rem;">
        <label>Status:</label>
        <select id="filterStatus" onchange="applyFilters()">
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="proposed">Proposed</option>
            <option value="maintained">Under Maintenance</option>
        </select>
    </div>
</div>

<!-- Quick Stats -->
<div class="tool-stats-section" id="bmpStats" style="display:none;">
    <h4>BMP Stats</h4>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total BMPs:</span>
        <span class="tool-stat-value" id="statTotal">0</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Treatment Vol:</span>
        <span class="tool-stat-value" id="statVolume">0 CF</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Drainage Area:</span>
        <span class="tool-stat-value" id="statArea">0 ac</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Active:</span>
        <span class="tool-stat-value" id="statActive">0</span>
    </div>
</div>

<!-- Actions -->
<div id="bmpActions" style="display:none;">
    <button class="tool-action-btn" onclick="addBMP()">
        <i class="fas fa-plus"></i> Add New BMP
    </button>
    <button class="tool-action-btn" id="saveBtn" onclick="saveChanges()">
        <i class="fas fa-save"></i> Save Changes
    </button>
    <button class="tool-action-btn secondary" onclick="exportData()">
        <i class="fas fa-download"></i> Export Report
    </button>
</div>

<!-- Status Messages -->
<div id="statusContainer" style="margin-top: 1rem;"></div>
{% endblock %}

{% block main_content %}
<!-- Top Area: Interactive Map -->
<div class="tool-top-area">
    <div class="tool-loading" id="loadingMessage" style="display:none;">
        Loading BMPs...
    </div>
    <div class="tool-empty-state" id="emptyState">
        <i class="fas fa-leaf" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
        <p>Select a BMP to begin</p>
        <p style="font-size: 0.8rem; opacity: 0.7;">Choose a BMP from the sidebar or add a new one</p>
    </div>
    
    <!-- SVG Viewer for BMP visualization -->
    <div id="bmpViewer" style="display:none; width: 100%; height: 100%; position: relative;">
        <svg id="bmpCanvas" width="100%" height="100%"></svg>
        
        <!-- Legend overlay -->
        <div style="position: absolute; top: 1rem; left: 1rem; background: rgba(0,0,0,0.9); border: 1px solid var(--mc-primary); border-radius: 8px; padding: 1rem; max-width: 250px;">
            <div style="color: var(--mc-primary); font-family: 'Orbitron', monospace; font-size: 0.9rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--mc-primary);">
                Legend
            </div>
            <div id="viewerLegend">Loading...</div>
        </div>
        
        <!-- Info overlay -->
        <div style="position: absolute; bottom: 1rem; left: 1rem; background: rgba(0,0,0,0.9); border: 1px solid var(--mc-primary); border-radius: 8px; padding: 1rem; max-width: 300px;">
            <div style="color: var(--mc-primary); font-family: 'Orbitron', monospace; font-size: 0.9rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--mc-primary);">
                BMP Info
            </div>
            <div id="entityInfo" style="color: var(--mc-text); font-family: 'Rajdhani', sans-serif; font-size: 0.85rem;">
                Click or hover on a BMP
            </div>
        </div>
    </div>
</div>

<!-- Resizer -->
<div class="tool-resizer" id="resizer"></div>

<!-- Bottom Area: Data Tables -->
<div class="tool-bottom-area">
    <div class="tool-data-tabs">
        <button class="tool-data-tab active" data-tab="properties" data-tab-group="bmp" onclick="switchTab('properties', 'bmp')">
            <i class="fas fa-info-circle"></i> BMP Properties
        </button>
        <button class="tool-data-tab" data-tab="connections" data-tab-group="bmp" onclick="switchTab('connections', 'bmp')">
            <i class="fas fa-project-diagram"></i> Connections
        </button>
        <button class="tool-data-tab" data-tab="maintenance" data-tab-group="bmp" onclick="switchTab('maintenance', 'bmp')">
            <i class="fas fa-tools"></i> Maintenance
        </button>
    </div>
    
    <div class="tool-data-content">
        <!-- Properties Tab -->
        <div class="tool-tab-content" data-tab="properties" data-tab-group="bmp">
            <table class="tool-data-table" id="propertiesTable">
                <thead>
                    <tr>
                        <th>BMP Name</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Treatment Vol (CF)</th>
                        <th>Storage Vol (CF)</th>
                        <th>Infiltration Rate (in/hr)</th>
                        <th>Bypass Elev (ft)</th>
                        <th>Drainage Area (ac)</th>
                        <th>Design Storm</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="9" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No BMP data loaded</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Connections Tab -->
        <div class="tool-tab-content" data-tab="connections" data-tab-group="bmp" style="display:none;">
            <table class="tool-data-table" id="connectionsTable">
                <thead>
                    <tr>
                        <th>Connection Type</th>
                        <th>Connected Structure</th>
                        <th>Connected Line</th>
                        <th>Invert Elevation (ft)</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No connections found</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Maintenance Tab -->
        <div class="tool-tab-content" data-tab="maintenance" data-tab-group="bmp" style="display:none;">
            <div style="padding: 1rem;">
                <h4 style="color: var(--mc-accent); margin-bottom: 1rem;">Maintenance Schedule</h4>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem;">
                    Track maintenance activities, inspections, and recommended actions for BMP performance.
                </p>
                <table class="tool-data-table" id="maintenanceTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Activity</th>
                            <th>Performed By</th>
                            <th>Notes</th>
                            <th>Next Due</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No maintenance records</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
let currentBMP = null;
let bmpsData = [];
let changedData = {};
let viewer = null;

document.addEventListener('DOMContentLoaded', function() {
    loadBMPs();
    setupResizer();
    // Load tool info from database
    loadToolInfoCard('BIOR', 'toolInfoCard');
});

async function loadBMPs() {
    try {
        const projectId = sessionStorage.getItem('active_project_id');
        if (!projectId) {
            showStatus('Please select a project first', true);
            return;
        }
        
        const response = await fetch(`/api/projects/${projectId}/bmps`);
        const data = await response.json();
        
        const select = document.getElementById('bmpSelect');
        select.innerHTML = '<option value="">Select a BMP...</option>';
        
        if (data.bmps && data.bmps.length > 0) {
            bmpsData = data.bmps;
            data.bmps.forEach(bmp => {
                const option = document.createElement('option');
                option.value = bmp.bmp_id;
                option.textContent = `${bmp.bmp_name} (${bmp.bmp_type})`;
                select.appendChild(option);
            });
        } else {
            select.innerHTML = '<option value="">No BMPs found - import a DXF or create new</option>';
        }
    } catch (error) {
        console.error('Error loading BMPs:', error);
        showStatus('Error loading BMPs', true);
    }
}

async function loadBMP() {
    const bmpId = document.getElementById('bmpSelect').value;
    
    if (!bmpId) {
        document.getElementById('bmpViewer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('bmpStats').style.display = 'none';
        document.getElementById('bmpActions').style.display = 'none';
        return;
    }
    
    document.getElementById('loadingMessage').style.display = 'block';
    document.getElementById('emptyState').style.display = 'none';
    
    try {
        currentBMP = bmpsData.find(b => b.bmp_id === bmpId);
        
        displayStats();
        displayProperties();
        displayConnections();
        
        document.getElementById('bmpStats').style.display = 'block';
        document.getElementById('bmpActions').style.display = 'block';
        document.getElementById('bmpViewer').style.display = 'block';
        document.getElementById('loadingMessage').style.display = 'none';
        
        setTimeout(() => renderViewer(), 50);
    } catch (error) {
        console.error('Error loading BMP:', error);
        showStatus('Error loading BMP data', true);
        document.getElementById('loadingMessage').style.display = 'none';
    }
}

function displayStats() {
    if (!currentBMP) return;
    
    document.getElementById('statTotal').textContent = bmpsData.length;
    
    const totalVolume = bmpsData.reduce((sum, bmp) => sum + (parseFloat(bmp.treatment_volume_cf) || 0), 0);
    document.getElementById('statVolume').textContent = totalVolume.toFixed(0) + ' CF';
    
    const totalArea = bmpsData.reduce((sum, bmp) => sum + (parseFloat(bmp.drainage_area_ac) || 0), 0);
    document.getElementById('statArea').textContent = totalArea.toFixed(2) + ' ac';
    
    const activeCount = bmpsData.filter(b => b.bmp_status === 'active').length;
    document.getElementById('statActive').textContent = activeCount;
}

function displayProperties() {
    if (!currentBMP) return;
    
    const tbody = document.querySelector('#propertiesTable tbody');
    tbody.innerHTML = `
        <tr data-entity-id="${currentBMP.bmp_id}" onclick="selectBMP('${currentBMP.bmp_id}')">
            <td><input type="text" value="${currentBMP.bmp_name || ''}" onchange="updateBMP('bmp_name', this.value)" onclick="event.stopPropagation()"></td>
            <td>${currentBMP.bmp_type || ''}</td>
            <td><input type="text" value="${currentBMP.bmp_status || ''}" onchange="updateBMP('bmp_status', this.value)" onclick="event.stopPropagation()"></td>
            <td><input type="number" step="0.1" value="${currentBMP.treatment_volume_cf || ''}" onchange="updateBMP('treatment_volume_cf', this.value)" onclick="event.stopPropagation()"></td>
            <td><input type="number" step="0.1" value="${currentBMP.storage_volume_cf || ''}" onchange="updateBMP('storage_volume_cf', this.value)" onclick="event.stopPropagation()"></td>
            <td><input type="number" step="0.01" value="${currentBMP.infiltration_rate_inhr || ''}" onchange="updateBMP('infiltration_rate_inhr', this.value)" onclick="event.stopPropagation()"></td>
            <td><input type="number" step="0.01" value="${currentBMP.bypass_elevation_ft || ''}" onchange="updateBMP('bypass_elevation_ft', this.value)" onclick="event.stopPropagation()"></td>
            <td><input type="number" step="0.01" value="${currentBMP.drainage_area_ac || ''}" onchange="updateBMP('drainage_area_ac', this.value)" onclick="event.stopPropagation()"></td>
            <td><input type="text" value="${currentBMP.design_storm || ''}" onchange="updateBMP('design_storm', this.value)" onclick="event.stopPropagation()"></td>
        </tr>
    `;
}

function displayConnections() {
    const tbody = document.querySelector('#connectionsTable tbody');
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No connections found</td></tr>';
}

function selectBMP(bmpId) {
    document.querySelectorAll('#propertiesTable tbody tr').forEach(tr => tr.classList.remove('selected'));
    const row = document.querySelector(`#propertiesTable tbody tr[data-entity-id="${bmpId}"]`);
    if (row) {
        row.classList.add('selected');
    }
}

function updateBMP(field, value) {
    if (!currentBMP) return;
    changedData[field] = value;
    showStatus('Changes pending - click Save to apply', false);
}

async function saveChanges() {
    if (!currentBMP || Object.keys(changedData).length === 0) {
        showStatus('No changes to save', false);
        return;
    }
    
    showStatus('Saving changes...', false);
    
    try {
        const response = await fetch(`/api/bmps/${currentBMP.bmp_id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(changedData)
        });
        
        if (response.ok) {
            showStatus('Changes saved successfully', false);
            changedData = {};
            setTimeout(() => showStatus('', false), 3000);
            await loadBMPs();
        } else {
            showStatus('Error saving changes', true);
        }
    } catch (error) {
        console.error('Error saving changes:', error);
        showStatus('Error saving changes: ' + error.message, true);
    }
}

async function renderViewer() {
    if (!currentBMP) return;
    
    const projectId = sessionStorage.getItem('active_project_id');
    
    viewer = new EntityViewerCore({
        svgId: 'bmpCanvas',
        legendId: 'viewerLegend',
        infoId: 'entityInfo',
        loadingId: 'loadingMessage',
        fetchEntitiesUrl: `/api/projects/${projectId}/bmps/viewer-entities`,
        entityTypeColors: {
            'bioretention': '#6a994e',
            'infiltration': '#0096ff',
            'detention': '#f7b801',
            'swale': '#00ff88'
        },
        infoPropertyMap: [
            { key: 'bmp_name', label: 'BMP Name' },
            { key: 'bmp_type', label: 'Type' },
            { key: 'treatment_volume_cf', label: 'Treatment Volume (CF)' },
            { key: 'drainage_area_ac', label: 'Drainage Area (ac)' },
            { key: 'bmp_status', label: 'Status' }
        ],
        onEntitySelect: (entityId, entityType) => {
            selectBMP(entityId);
        },
        enableZoomPan: true,
        showGrid: true,
        showNorthArrow: true,
        showScaleBar: true
    });
    
    await viewer.renderViewer();
}

function applyFilters() {
    console.log('Filters applied');
}

function addBMP() {
    showStatus('Add BMP functionality coming soon...', false);
    setTimeout(() => showStatus('', false), 2000);
}

function exportData() {
    showStatus('Export functionality coming soon...', false);
    setTimeout(() => showStatus('', false), 2000);
}

function showStatus(message, isError) {
    const container = document.getElementById('statusContainer');
    if (!message) {
        container.innerHTML = '';
        return;
    }
    container.innerHTML = `<div class="tool-status-message ${isError ? 'error' : ''}">${message}</div>`;
}

function setupResizer() {
    const resizer = document.getElementById('resizer');
    const bottomArea = document.querySelector('.tool-bottom-area');
    let isResizing = false;
    
    resizer.addEventListener('mousedown', function(e) {
        isResizing = true;
        document.body.style.cursor = 'ns-resize';
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        
        const container = document.querySelector('.main-content-area');
        const containerRect = container.getBoundingClientRect();
        const newHeight = containerRect.bottom - e.clientY;
        
        if (newHeight >= 200 && newHeight <= containerRect.height * 0.8) {
            bottomArea.style.height = newHeight + 'px';
        }
    });
    
    document.addEventListener('mouseup', function() {
        isResizing = false;
        document.body.style.cursor = 'default';
    });
}
{% endblock %}
