{% extends "base_specialized_tool.html" %}

{% block tool_title %}Gravity Pipe Network Manager{% endblock %}
{% block tool_icon %}fas fa-water{% endblock %}
{% block tool_description %}Interactive tool for analyzing, editing, and managing gravity pipe networks with hydraulic calculations{% endblock %}

{% block content_layout_class %}tool-complex-layout{% endblock %}

{% block leaflet_assets %}
<!-- Not using Leaflet, using SVG viewer instead -->
{% endblock %}

{% block extra_head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/specialized-tool-info.js') }}"></script>
<script src="/static/js/entity_viewer_core.js"></script>
{% endblock %}

{% block sidebar_content %}
<!-- Network Selector -->
<div class="tool-filter-section">
    <h4>Network Selection</h4>
    <div class="tool-filter-item">
        <label>Select Network:</label>
        <select id="networkSelect" onchange="loadNetwork()">
            <option value="">Loading networks...</option>
        </select>
    </div>
</div>

<!-- Filters -->
<div class="tool-filter-section">
    <h4>Filters</h4>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="filterStorm" checked onchange="applyFilters()">
        <label for="filterStorm">Storm Drain</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="filterSanitary" checked onchange="applyFilters()">
        <label for="filterSanitary">Sanitary Sewer</label>
    </div>
    <div class="tool-filter-item" style="margin-top: 0.75rem;">
        <label>Phase:</label>
        <select id="filterPhase" onchange="applyFilters()">
            <option value="all">All Phases</option>
            <option value="existing">Existing</option>
            <option value="proposed">Proposed</option>
        </select>
    </div>
</div>

<!-- Quick Stats -->
<div class="tool-stats-section" id="networkStats" style="display:none;">
    <h4>Network Stats</h4>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total Pipes:</span>
        <span class="tool-stat-value" id="statPipes">0</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Structures:</span>
        <span class="tool-stat-value" id="statStructures">0</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total Length:</span>
        <span class="tool-stat-value" id="statLength">0 ft</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Connected:</span>
        <span class="tool-stat-value" id="statConnected">0%</span>
    </div>
</div>

<!-- Actions -->
<div id="networkActions" style="display:none;">
    <button class="tool-action-btn" id="autoConnectBtn" onclick="autoConnectPipes()">
        <i class="fas fa-link"></i> Auto-Connect Pipes
    </button>
    <button class="tool-action-btn" id="saveBtn" onclick="saveChanges()">
        <i class="fas fa-save"></i> Save Changes
    </button>
    <button class="tool-action-btn secondary" onclick="exportNetwork()">
        <i class="fas fa-download"></i> Export Data
    </button>
</div>

<!-- Status Messages -->
<div id="statusContainer" style="margin-top: 1rem;"></div>
{% endblock %}

{% block main_content %}
<!-- Top Area: Interactive Map -->
<div class="tool-top-area">
    <div class="tool-loading" id="loadingMessage" style="display:none;">
        Loading network...
    </div>
    <div class="tool-empty-state" id="emptyState">
        <i class="fas fa-project-diagram" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
        <p>Select a gravity pipe network to begin</p>
        <p style="font-size: 0.8rem; opacity: 0.7;">Choose a network from the sidebar</p>
    </div>
    
    <!-- SVG Viewer for network visualization -->
    <div id="networkViewer" style="display:none; width: 100%; height: 100%; position: relative;">
        <svg id="networkCanvas" width="100%" height="100%"></svg>
        
        <!-- Legend overlay -->
        <div style="position: absolute; top: 1rem; left: 1rem; background: rgba(0,0,0,0.9); border: 1px solid var(--mc-primary); border-radius: 8px; padding: 1rem; max-width: 250px;">
            <div style="color: var(--mc-primary); font-family: 'Orbitron', monospace; font-size: 0.9rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--mc-primary);">
                Legend
            </div>
            <div id="viewerLegend">Loading...</div>
        </div>
        
        <!-- Info overlay -->
        <div style="position: absolute; bottom: 1rem; left: 1rem; background: rgba(0,0,0,0.9); border: 1px solid var(--mc-primary); border-radius: 8px; padding: 1rem; max-width: 300px;">
            <div style="color: var(--mc-primary); font-family: 'Orbitron', monospace; font-size: 0.9rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--mc-primary);">
                Selected Entity
            </div>
            <div id="entityInfo" style="color: var(--mc-text); font-family: 'Rajdhani', sans-serif; font-size: 0.85rem;">
                Click or hover on an entity
            </div>
        </div>
    </div>
</div>

<!-- Resizer -->
<div class="tool-resizer" id="resizer"></div>

<!-- Bottom Area: Data Tables -->
<div class="tool-bottom-area">
    <div class="tool-data-tabs">
        <button class="tool-data-tab active" data-tab="pipes" data-tab-group="network" onclick="switchTab('pipes', 'network')">
            <i class="fas fa-grip-lines"></i> Pipes (<span id="pipeCount">0</span>)
        </button>
        <button class="tool-data-tab" data-tab="structures" data-tab-group="network" onclick="switchTab('structures', 'network')">
            <i class="fas fa-circle"></i> Structures (<span id="structureCount">0</span>)
        </button>
        <button class="tool-data-tab" data-tab="analysis" data-tab-group="network" onclick="switchTab('analysis', 'network')">
            <i class="fas fa-calculator"></i> Analysis
        </button>
    </div>
    
    <div class="tool-data-content">
        <!-- Pipes Tab -->
        <div class="tool-tab-content" data-tab="pipes" data-tab-group="network">
            <table class="tool-data-table" id="pipesTable">
                <thead>
                    <tr>
                        <th>Pipe #</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Diameter (in)</th>
                        <th>Material</th>
                        <th>Invert Start (ft)</th>
                        <th>Invert End (ft)</th>
                        <th>Slope (%)</th>
                        <th>Length (ft)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="9" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No pipes loaded</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Structures Tab -->
        <div class="tool-tab-content" data-tab="structures" data-tab-group="network" style="display:none;">
            <table class="tool-data-table" id="structuresTable">
                <thead>
                    <tr>
                        <th>Structure #</th>
                        <th>Type</th>
                        <th>Rim Elev (ft)</th>
                        <th>Invert Elev (ft)</th>
                        <th>Depth (ft)</th>
                        <th>Size (in)</th>
                        <th>Condition</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="7" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No structures loaded</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Analysis Tab -->
        <div class="tool-tab-content" data-tab="analysis" data-tab-group="network" style="display:none;">
            <div style="padding: 1rem;">
                <h4 style="color: var(--mc-accent); margin-bottom: 1rem;">Hydraulic Analysis</h4>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem;">
                    Analyze pipe slopes, velocities, and capacities based on network data.
                </p>
                <button class="tool-action-btn" onclick="runAnalysis()">
                    <i class="fas fa-play"></i> Run Hydraulic Analysis
                </button>
                <div id="analysisResults" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
let currentNetwork = null;
let structuresData = [];
let pipesData = [];
let changedData = { structures: {}, pipes: {} };
let viewer = null;

// Load networks on page load
document.addEventListener('DOMContentLoaded', function() {
    loadNetworks();
    setupResizer();
});

async function loadNetworks() {
    try {
        const response = await fetch('/api/pipe-networks?mode=gravity');
        const data = await response.json();
        
        const select = document.getElementById('networkSelect');
        select.innerHTML = '<option value="">Select a network...</option>';
        
        if (data.networks && data.networks.length > 0) {
            data.networks.forEach(network => {
                const option = document.createElement('option');
                option.value = network.network_id;
                option.textContent = `${network.network_name} (${network.line_count || 0} pipes, ${network.structure_count || 0} structures)`;
                select.appendChild(option);
            });
        } else {
            select.innerHTML = '<option value="">No gravity networks found - import a DXF first</option>';
        }
    } catch (error) {
        console.error('Error loading networks:', error);
        showStatus('Error loading networks', true);
    }
}

async function loadNetwork() {
    const networkId = document.getElementById('networkSelect').value;
    
    if (!networkId) {
        document.getElementById('networkViewer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('networkStats').style.display = 'none';
        document.getElementById('networkActions').style.display = 'none';
        return;
    }
    
    document.getElementById('loadingMessage').style.display = 'block';
    document.getElementById('emptyState').style.display = 'none';
    
    try {
        const [networkRes, pipesRes, structsRes] = await Promise.all([
            fetch(`/api/pipe-networks/${networkId}`),
            fetch(`/api/pipe-networks/${networkId}/pipes`),
            fetch(`/api/pipe-networks/${networkId}/structures`)
        ]);
        
        currentNetwork = (await networkRes.json()).network;
        pipesData = (await pipesRes.json()).pipes || [];
        structuresData = (await structsRes.json()).structures || [];
        
        changedData = { structures: {}, pipes: {} };
        
        displayStats();
        displayPipes();
        displayStructures();
        
        document.getElementById('networkStats').style.display = 'block';
        document.getElementById('networkActions').style.display = 'block';
        document.getElementById('networkViewer').style.display = 'block';
        document.getElementById('loadingMessage').style.display = 'none';
        
        setTimeout(() => renderViewer(), 50);
    } catch (error) {
        console.error('Error loading network:', error);
        showStatus('Error loading network data', true);
        document.getElementById('loadingMessage').style.display = 'none';
    }
}

function displayStats() {
    document.getElementById('statPipes').textContent = pipesData.length;
    document.getElementById('statStructures').textContent = structuresData.length;
    
    const totalLength = pipesData.reduce((sum, pipe) => sum + (parseFloat(pipe.length) || 0), 0);
    document.getElementById('statLength').textContent = totalLength.toFixed(1) + ' ft';
    
    const connectedPipes = pipesData.filter(p => p.from_structure_id && p.to_structure_id).length;
    const connectPercent = pipesData.length > 0 ? ((connectedPipes / pipesData.length) * 100).toFixed(0) : 0;
    document.getElementById('statConnected').textContent = connectPercent + '%';
    
    document.getElementById('pipeCount').textContent = pipesData.length;
    document.getElementById('structureCount').textContent = structuresData.length;
}

function displayPipes() {
    const tbody = document.querySelector('#pipesTable tbody');
    
    if (pipesData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No pipes found</td></tr>';
        return;
    }
    
    tbody.innerHTML = pipesData.map(pipe => `
        <tr data-entity-id="${pipe.line_id}" onclick="selectPipe('${pipe.line_id}')">
            <td><input type="text" value="${pipe.line_number || ''}" onchange="updatePipe('${pipe.line_id}', 'line_number', this.value)" onclick="event.stopPropagation()"></td>
            <td>${pipe.from_structure_number || 'N/A'}</td>
            <td>${pipe.to_structure_number || 'N/A'}</td>
            <td><input type="number" value="${pipe.diameter_mm ? Math.round(pipe.diameter_mm / 25.4) : ''}" onchange="updatePipe('${pipe.line_id}', 'diameter_mm', this.value * 25.4)" onclick="event.stopPropagation()"></td>
            <td><input type="text" value="${pipe.material || ''}" onchange="updatePipe('${pipe.line_id}', 'material', this.value)" onclick="event.stopPropagation()"></td>
            <td><input type="number" step="0.01" value="${pipe.invert_elevation_start || ''}" onchange="updatePipe('${pipe.line_id}', 'invert_elevation_start', this.value)" onclick="event.stopPropagation()"></td>
            <td><input type="number" step="0.01" value="${pipe.invert_elevation_end || ''}" onchange="updatePipe('${pipe.line_id}', 'invert_elevation_end', this.value)" onclick="event.stopPropagation()"></td>
            <td>${pipe.slope || ''}</td>
            <td>${pipe.length ? parseFloat(pipe.length).toFixed(1) : ''}</td>
        </tr>
    `).join('');
}

function displayStructures() {
    const tbody = document.querySelector('#structuresTable tbody');
    
    if (structuresData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">No structures found</td></tr>';
        return;
    }
    
    tbody.innerHTML = structuresData.map(struct => `
        <tr data-entity-id="${struct.structure_id}" onclick="selectStructure('${struct.structure_id}')">
            <td><input type="text" value="${struct.structure_number || ''}" onchange="updateStructure('${struct.structure_id}', 'structure_number', this.value)" onclick="event.stopPropagation()"></td>
            <td>${struct.structure_type || ''}</td>
            <td><input type="number" step="0.01" value="${struct.rim_elevation || ''}" onchange="updateStructure('${struct.structure_id}', 'rim_elevation', this.value)" onclick="event.stopPropagation()"></td>
            <td><input type="number" step="0.01" value="${struct.invert_elevation || ''}" onchange="updateStructure('${struct.structure_id}', 'invert_elevation', this.value)" onclick="event.stopPropagation()"></td>
            <td>${struct.manhole_depth_ft || ''}</td>
            <td><input type="number" value="${struct.size_mm ? Math.round(struct.size_mm / 25.4) : ''}" onchange="updateStructure('${struct.structure_id}', 'size_mm', this.value * 25.4)" onclick="event.stopPropagation()"></td>
            <td><input type="text" value="${struct.condition || ''}" onchange="updateStructure('${struct.structure_id}', 'condition', this.value)" onclick="event.stopPropagation()"></td>
        </tr>
    `).join('');
}

function selectPipe(pipeId) {
    document.querySelectorAll('#pipesTable tbody tr').forEach(tr => tr.classList.remove('selected'));
    const row = document.querySelector(`#pipesTable tbody tr[data-entity-id="${pipeId}"]`);
    if (row) {
        row.classList.add('selected');
        row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    if (viewer) viewer.selectEntity(pipeId, 'pipe');
}

function selectStructure(structureId) {
    document.querySelectorAll('#structuresTable tbody tr').forEach(tr => tr.classList.remove('selected'));
    const row = document.querySelector(`#structuresTable tbody tr[data-entity-id="${structureId}"]`);
    if (row) {
        row.classList.add('selected');
        row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    if (viewer) viewer.selectEntity(structureId, 'structure');
}

function updatePipe(pipeId, field, value) {
    if (!changedData.pipes[pipeId]) {
        changedData.pipes[pipeId] = {};
    }
    changedData.pipes[pipeId][field] = value;
    showStatus('Changes pending - click Save to apply', false);
}

function updateStructure(structureId, field, value) {
    if (!changedData.structures[structureId]) {
        changedData.structures[structureId] = {};
    }
    changedData.structures[structureId][field] = value;
    showStatus('Changes pending - click Save to apply', false);
}

async function saveChanges() {
    if (!currentNetwork) return;
    
    let savedCount = 0;
    let errorCount = 0;
    const networkId = currentNetwork.network_id;
    
    showStatus('Saving changes...', false);
    
    try {
        for (const [structId, changes] of Object.entries(changedData.structures)) {
            const response = await fetch(`/api/pipe-networks/${networkId}/structures/${structId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(changes)
            });
            
            if (response.ok) savedCount++;
            else errorCount++;
        }
        
        for (const [pipeId, changes] of Object.entries(changedData.pipes)) {
            const response = await fetch(`/api/pipe-networks/${networkId}/pipes/${pipeId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(changes)
            });
            
            if (response.ok) savedCount++;
            else errorCount++;
        }
        
        changedData = { structures: {}, pipes: {} };
        
        if (errorCount > 0) {
            showStatus(`Saved ${savedCount} changes, ${errorCount} failed`, true);
        } else {
            showStatus(`Saved ${savedCount} changes successfully`, false);
            setTimeout(() => showStatus('', false), 3000);
        }
        
        await loadNetwork();
    } catch (error) {
        console.error('Error saving changes:', error);
        showStatus('Error saving changes: ' + error.message, true);
    }
}

async function autoConnectPipes() {
    if (!currentNetwork) return;
    
    if (!confirm('This will automatically connect pipes to nearby structures (within 5 feet). Continue?')) {
        return;
    }
    
    try {
        showStatus('Connecting pipes to structures...', false);
        
        const response = await fetch(`/api/pipe-networks/${currentNetwork.network_id}/auto-connect`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tolerance_feet: 5.0 })
        });
        
        const results = await response.json();
        
        if (results.success) {
            showStatus(`Connected ${results.fully_connected} of ${results.total_pipes} pipes!`, false);
            setTimeout(() => showStatus('', false), 3000);
            await loadNetwork();
        } else {
            showStatus(`Error: ${results.error}`, true);
        }
    } catch (error) {
        console.error('Error auto-connecting pipes:', error);
        showStatus('Error connecting pipes: ' + error.message, true);
    }
}

async function renderViewer() {
    if (!currentNetwork) return;
    
    viewer = new EntityViewerCore({
        svgId: 'networkCanvas',
        legendId: 'viewerLegend',
        infoId: 'entityInfo',
        loadingId: 'loadingMessage',
        fetchEntitiesUrl: `/api/pipe-networks/${currentNetwork.network_id}/viewer-entities`,
        entityTypeColors: {
            'storm_pipe': '#f7b801',
            'sanitary_pipe': '#0096ff',
            'structure': '#6a994e',
            'pipe': '#00ffff'
        },
        infoPropertyMap: [
            { key: 'line_number', label: 'Pipe #' },
            { key: 'structure_number', label: 'Structure #' },
            { key: 'from_structure_number', label: 'From' },
            { key: 'to_structure_number', label: 'To' },
            { key: 'diameter_mm', label: 'Diameter (mm)' },
            { key: 'material', label: 'Material' },
            { key: 'structure_type', label: 'Type' },
            { key: 'rim_elevation', label: 'Rim Elev (ft)' },
            { key: 'invert_elevation', label: 'Invert Elev (ft)' },
            { key: 'manhole_depth_ft', label: 'Depth (ft)' },
            { key: 'length', label: 'Length' },
            { key: 'slope', label: 'Slope' }
        ],
        onEntitySelect: (entityId, entityType) => {
            if (entityType === 'structure') {
                selectStructure(entityId);
            } else if (entityType.includes('pipe')) {
                selectPipe(entityId);
            }
        },
        enableZoomPan: true,
        showGrid: true,
        showNorthArrow: true,
        showScaleBar: true
    });
    
    await viewer.renderViewer();
}

function applyFilters() {
    // Placeholder for filter logic
    console.log('Filters applied');
}

function exportNetwork() {
    showStatus('Export functionality coming soon...', false);
    setTimeout(() => showStatus('', false), 2000);
}

function runAnalysis() {
    showStatus('Analysis functionality coming soon...', false);
    setTimeout(() => showStatus('', false), 2000);
}

function showStatus(message, isError) {
    const container = document.getElementById('statusContainer');
    if (!message) {
        container.innerHTML = '';
        return;
    }
    container.innerHTML = `<div class="tool-status-message ${isError ? 'error' : ''}">${message}</div>`;
}

function setupResizer() {
    const resizer = document.getElementById('resizer');
    const bottomArea = document.querySelector('.tool-bottom-area');
    let isResizing = false;
    
    resizer.addEventListener('mousedown', function(e) {
        isResizing = true;
        document.body.style.cursor = 'ns-resize';
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        
        const container = document.querySelector('.main-content-area');
        const containerRect = container.getBoundingClientRect();
        const newHeight = containerRect.bottom - e.clientY;
        
        if (newHeight >= 200 && newHeight <= containerRect.height * 0.8) {
            bottomArea.style.height = newHeight + 'px';
        }
    });
    
    document.addEventListener('mouseup', function() {
        isResizing = false;
        document.body.style.cursor = 'default';
    });
}
{% endblock %}

{% block about_tool_description %}
Interactive tool for analyzing, editing, and managing gravity pipe networks with hydraulic calculations. Supports storm drain and sanitary sewer systems with automatic slope validation, invert elevation management, and network connectivity analysis.
{% endblock %}

{% block about_tool_tags %}
<span class="about-tool-tag">STORM</span>
<span class="about-tool-tag">SANIT</span>
<span class="about-tool-tag">MH</span>
<span class="about-tool-tag">INLET</span>
<span class="about-tool-tag">GRAV</span>
{% endblock %}

{% block about_tool_examples %}
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-STM-STORM-PROP-LN</div>
    <div class="about-tool-example-desc">→ Proposed Storm Drain Pipes - Civil/Storm Drainage</div>
</div>
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-SAN-SANIT-EXST-LN</div>
    <div class="about-tool-example-desc">→ Existing Sanitary Sewer Pipes - Civil/Sanitary</div>
</div>
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-STM-MH-PROP-PT</div>
    <div class="about-tool-example-desc">→ Proposed Manholes - Civil/Storm Drainage</div>
</div>
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-STM-INLET-PROP-PT</div>
    <div class="about-tool-example-desc">→ Proposed Storm Inlets - Civil/Storm Drainage</div>
</div>
{% endblock %}
