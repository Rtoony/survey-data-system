{% extends "base_specialized_tool.html" %}

{% block tool_title %}Material Volume Calculator{% endblock %}
{% block tool_icon %}fas fa-cube{% endblock %}
{% block tool_description %}Calculate material volumes for earthwork and construction quantity takeoffs{% endblock %}

{% block content_layout_class %}tool-complex-layout{% endblock %}

{% block sidebar_content %}
<div class="tool-info-box">
    <div class="tool-name">
        <i class="fas fa-cube"></i>
        <span>Material Volume Calculator</span>
    </div>
    <div class="tool-description">
        Calculate material volumes based on area and depth/thickness specifications
    </div>
</div>

<div class="tool-filter-section">
    <h4>Material Type</h4>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="filterEarthwork" checked onchange="applyFilters()">
        <label for="filterEarthwork">Earthwork (Cut/Fill)</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="filterPavement" checked onchange="applyFilters()">
        <label for="filterPavement">Pavement Sections</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="filterAggregate" checked onchange="applyFilters()">
        <label for="filterAggregate">Aggregate/Base</label>
    </div>
    <div class="tool-checkbox-item">
        <input type="checkbox" id="filterBMP" checked onchange="applyFilters()">
        <label for="filterBMP">BMP Storage</label>
    </div>
</div>

<div class="tool-filter-section">
    <h4>Units</h4>
    <div class="tool-filter-item">
        <label>Volume Units:</label>
        <select id="unitSelect" onchange="updateUnits()">
            <option value="cy">Cubic Yards (CY)</option>
            <option value="cf">Cubic Feet (CF)</option>
            <option value="tons">Tons (est.)</option>
        </select>
    </div>
</div>

<div class="tool-stats-section">
    <h4>Quick Stats</h4>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total Items:</span>
        <span class="tool-stat-value" id="sidebarTotalItems">0</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total Volume:</span>
        <span class="tool-stat-value" id="sidebarTotalVolume">0 CY</span>
    </div>
    <div class="tool-stat-item">
        <span class="tool-stat-label">Total Area:</span>
        <span class="tool-stat-value" id="sidebarTotalArea">0 SF</span>
    </div>
</div>

<button class="tool-action-btn" onclick="calculateVolumes()">
    <i class="fas fa-calculator"></i> Calculate Volumes
</button>
<button class="tool-action-btn secondary" onclick="exportReport()">
    <i class="fas fa-file-export"></i> Export Report
</button>
{% endblock %}

{% block main_content %}
<div class="tool-top-area">
    <div id="volumeVisualContainer" style="height: 100%; width: 100%; background: #0a1929; position: relative; display: flex; align-items: center; justify-content: center; flex-direction: column;">
        <i class="fas fa-cube" style="font-size: 64px; color: var(--mc-primary); opacity: 0.3; margin-bottom: 1rem;"></i>
        <p style="color: var(--mc-text); font-size: 18px; opacity: 0.6;">Material Volume Visualization</p>
        <p style="color: var(--mc-muted); font-size: 14px; opacity: 0.4; margin-top: 0.5rem;">Load project data to begin calculations</p>
    </div>
</div>

<div class="tool-resizer"></div>

<div class="tool-bottom-area">
    <div class="tool-data-tabs">
        <button class="tool-data-tab active" onclick="showTab('volumes')">
            <i class="fas fa-cube"></i> Volumes (<span id="volumesTabCount">0</span>)
        </button>
        <button class="tool-data-tab" onclick="showTab('breakdown')">
            <i class="fas fa-chart-pie"></i> Material Breakdown
        </button>
        <button class="tool-data-tab" onclick="showTab('summary')">
            <i class="fas fa-calculator"></i> Summary
        </button>
    </div>

    <div class="tool-data-content">
        <!-- Volumes Tab -->
        <div id="volumesTab" class="tab-content">
            <table class="tool-data-table" id="volumesTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Material Type</th>
                        <th>Area (SF)</th>
                        <th>Depth/Thickness</th>
                        <th>Volume (CY)</th>
                        <th>Unit Cost</th>
                        <th>Total Cost</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="volumesTableBody"></tbody>
            </table>
            <div id="volumesEmpty" style="text-align: center; padding: 3rem; color: var(--mc-text);">
                <i class="fas fa-inbox" style="font-size: 48px; opacity: 0.3; margin-bottom: 1rem;"></i>
                <p>No volume calculations available</p>
                <p style="color: var(--mc-muted); font-size: 0.9rem; margin-top: 0.5rem;">
                    Load project data and click "Calculate Volumes" to begin
                </p>
            </div>
        </div>

        <!-- Material Breakdown Tab -->
        <div id="breakdownTab" class="tab-content" style="display: none;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-label">Earthwork</div>
                    <div class="stat-value" id="statEarthwork">0 CY</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pavement</div>
                    <div class="stat-value" id="statPavement">0 CY</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Aggregate</div>
                    <div class="stat-value" id="statAggregate">0 CY</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">BMP Storage</div>
                    <div class="stat-value" id="statBMP">0 CY</div>
                </div>
            </div>

            <h4 style="color: var(--mc-accent); margin: 2rem 0 1rem 0;">By Material Type</h4>
            <div id="byMaterialType"></div>
        </div>

        <!-- Summary Tab -->
        <div id="summaryTab" class="tab-content" style="display: none;">
            <div style="background: rgba(0,255,255,0.1); border: 2px solid rgba(0,255,255,0.3); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
                <h3 style="color: var(--mc-primary); margin: 0 0 1.5rem 0;">
                    <i class="fas fa-file-invoice-dollar"></i> Cost Summary
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <div style="color: var(--mc-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">Total Volume</div>
                        <div style="color: var(--mc-accent); font-size: 2rem; font-weight: bold;" id="summaryTotalVolume">0 CY</div>
                    </div>
                    <div>
                        <div style="color: var(--mc-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">Estimated Cost</div>
                        <div style="color: var(--mc-accent); font-size: 2rem; font-weight: bold;" id="summaryTotalCost">$0</div>
                    </div>
                </div>
            </div>

            <div id="calculationMethod" style="background: rgba(0,40,80,0.4); border-radius: 8px; padding: 1.5rem;">
                <h4 style="color: var(--mc-primary); margin: 0 0 1rem 0;">
                    <i class="fas fa-info-circle"></i> Calculation Method
                </h4>
                <p style="color: var(--mc-text); margin: 0; line-height: 1.6;">
                    <strong>Volume =</strong> Area (SF) × Depth/Thickness (ft) ÷ 27 = <strong>Cubic Yards (CY)</strong>
                </p>
                <p style="color: var(--mc-muted); margin: 1rem 0 0 0; font-size: 0.9rem; line-height: 1.6;">
                    For multi-layer sections (e.g., pavement with base and subbase), each layer is calculated separately and summed.
                    Earthwork calculations use 3D surface models when available.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
.tab-content { padding: 1rem; }
.stat-card {
    background: rgba(0,255,255,0.05);
    border: 1px solid rgba(0,255,255,0.2);
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
}
.stat-label {
    color: var(--mc-muted);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}
.stat-value {
    color: var(--mc-primary);
    font-size: 1.8rem;
    font-weight: bold;
}
</style>
{% endblock %}

{% block about_tool_description %}
<p>
    The <strong>Material Volume Calculator</strong> is a specialized tool for calculating accurate material volumes
    based on surface areas, material depths, and 3D elevation models. This tool provides quantity takeoffs for
    earthwork, pavement sections, aggregate materials, and BMP storage volumes.
</p>
<p style="margin-top: 1rem;">
    This tool integrates with the Area Calculator for surface area data and uses project-specific material depth
    specifications to generate comprehensive volume calculations for cost estimation and material ordering.
</p>
{% endblock %}

{% block about_tool_tags %}
<span class="about-tool-tag">VOL</span>
<span class="about-tool-tag">MATERIAL</span>
<span class="about-tool-tag">EARTHWORK</span>
<span class="about-tool-tag">PAVEMENT</span>
<span class="about-tool-tag">AGGREGATE</span>
<span class="about-tool-tag">BMP</span>
{% endblock %}

{% block about_tool_examples %}
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-GRAD-PAD-BLDG-NEW-3D</div>
    <div class="about-tool-example-desc">→ Building pad earthwork volume</div>
</div>
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-PVMT-ASPH-2IN-NEW-PL</div>
    <div class="about-tool-example-desc">→ Asphalt pavement volume (2" depth)</div>
</div>
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-GRAD-BASE-6IN-NEW-PL</div>
    <div class="about-tool-example-desc">→ Aggregate base volume (6" depth)</div>
</div>
<div class="about-tool-example">
    <div class="about-tool-example-layer">CIV-BMP-BASIN-DETENT-NEW-3D</div>
    <div class="about-tool-example-desc">→ Detention basin storage volume</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize the tool
let volumeData = [];
let currentUnit = 'cy';

function applyFilters() {
    // Filter logic for material types
    console.log('Filters applied');
    renderVolumeData();
}

function updateUnits() {
    currentUnit = document.getElementById('unitSelect').value;
    renderVolumeData();
}

async function calculateVolumes() {
    console.log('Calculating volumes...');

    const emptyDiv = document.getElementById('volumesEmpty');
    emptyDiv.innerHTML = `
        <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--mc-primary); margin-bottom: 1rem;"></i>
        <p>Calculating volumes...</p>
    `;

    try {
        const activeProject = window.projectContext ?
            await window.projectContext.getActiveProject() : null;

        if (!activeProject) {
            emptyDiv.innerHTML = `
                <i class="fas fa-inbox" style="font-size: 48px; opacity: 0.3; margin-bottom: 1rem;"></i>
                <p>No active project selected</p>
            `;
            return;
        }

        const response = await fetch(`/api/specialized-tools/material-volume?project_id=${activeProject.project_id}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();

        if (!data.success || !data.volumes || data.volumes.length === 0) {
            return;
        }

        volumeData = data.volumes;
        renderVolumeData();
        updateStats(data.stats);

    } catch (error) {
        console.error('Error:', error);
        emptyDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--danger); margin-bottom: 1rem;"></i>
            <p>Error loading volume data</p>
        `;
    }
}

function updateStats(stats) {
    if (!stats) return;

    document.getElementById('sidebarTotalItems').textContent = stats.total_count || 0;
    document.getElementById('sidebarTotalVolume').textContent = `${stats.total_volume_cy?.toFixed(1) || 0} CY`;

    document.getElementById('summaryTotalVolume').textContent = `${stats.total_volume_cy?.toFixed(1) || 0} CY`;
    document.getElementById('summaryTotalCost').textContent = `$${stats.total_cost?.toFixed(2) || 0}`;

    const byType = stats.by_type || {};
    document.getElementById('statEarthwork').textContent = `${byType['Earthwork']?.toFixed(1) || 0} CY`;
    document.getElementById('statPavement').textContent = `${byType['Pavement']?.toFixed(1) || 0} CY`;
    document.getElementById('statAggregate').textContent = `${byType['Aggregate']?.toFixed(1) || 0} CY`;
    document.getElementById('statBMP').textContent = `${byType['BMP']?.toFixed(1) || 0} CY`;
}

function renderVolumeData() {
    const tbody = document.getElementById('volumesTableBody');
    const table = document.getElementById('volumesTable');
    const emptyDiv = document.getElementById('volumesEmpty');

    if (!volumeData || volumeData.length === 0) {
        table.style.display = 'none';
        emptyDiv.style.display = 'block';
        return;
    }

    tbody.innerHTML = volumeData.map(vol => `
        <tr>
            <td>${vol.item_name || 'N/A'}</td>
            <td>${vol.material_type || 'Unknown'}</td>
            <td>${vol.area_sqft?.toFixed(0) || 'N/A'}</td>
            <td>${vol.depth_inches?.toFixed(1) || 'N/A'}"</td>
            <td>${vol.volume_cy?.toFixed(2) || 'N/A'}</td>
            <td>$${vol.unit_cost?.toFixed(2) || '0.00'}</td>
            <td>$${vol.total_cost?.toFixed(2) || '0.00'}</td>
            <td><button class="tool-action-btn" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Edit</button></td>
        </tr>
    `).join('');

    table.style.display = 'table';
    emptyDiv.style.display = 'none';

    document.getElementById('volumesTabCount').textContent = volumeData.length;
}

function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });

    // Remove active class from all tab buttons
    document.querySelectorAll('.tool-data-tab').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    const selectedTab = document.getElementById(tabName + 'Tab');
    if (selectedTab) {
        selectedTab.style.display = 'block';
    }

    // Add active class to clicked button
    event.target.closest('.tool-data-tab').classList.add('active');
}

function exportReport() {
    console.log('Exporting volume report...');
    alert('Volume report export functionality will be implemented here');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Material Volume Calculator loaded');
    renderVolumeData();
});
</script>
{% endblock %}
