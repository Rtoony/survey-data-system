{% extends "base.html" %}

{% block title %}Drawings Manager{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-file-image"></i>
            Drawings Manager
        </h2>
        <div style="display: flex; gap: 10px;">
            <button onclick="openCreateModal()" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Drawing
            </button>
            <button id="bulkDeleteBtn" onclick="bulkDelete()" class="btn btn-danger" style="display: none;">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
            <button onclick="location.reload()" class="btn btn-ghost">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
    </div>

    <div class="card-body">
        <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search drawings by name, number, or project..." 
                style="flex: 1; min-width: 300px; padding: 10px; border: 2px solid rgba(0,255,255,0.3); background: rgba(0,0,0,0.3); color: var(--text-primary); border-radius: 8px; font-family: 'Rajdhani', sans-serif;"
                oninput="filterDrawings()"
            >
            <select 
                id="projectFilter" 
                onchange="filterDrawings()"
                style="padding: 10px; border: 2px solid rgba(0,255,255,0.3); background: rgba(0,0,0,0.3); color: var(--text-primary); border-radius: 8px; font-family: 'Rajdhani', sans-serif; min-width: 200px;"
            >
                <option value="">All Projects</option>
            </select>
        </div>

        <div id="loading" style="text-align: center; padding: 3rem;">
            <div class="spinner" style="margin: 0 auto;"></div>
            <p class="loading-text">Loading drawings...</p>
        </div>

        <div id="drawings" style="display: none;"></div>
    </div>
</div>

<div id="createModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-file-plus"></i> Create New Drawing</h2>
            <button class="modal-close" onclick="closeCreateModal()">&times;</button>
        </div>
        <form id="createForm" onsubmit="createDrawing(event)">
            <div class="form-group">
                <label for="drawing_name">Drawing Name <span style="color: #ff6b6b;">*</span></label>
                <input type="text" id="drawing_name" name="drawing_name" required placeholder="e.g., Site Plan">
            </div>
            <div class="form-group">
                <label for="drawing_number">Drawing Number</label>
                <input type="text" id="drawing_number" name="drawing_number" placeholder="e.g., A-001">
            </div>
            <div class="form-group">
                <label for="project_id">Project (Optional)</label>
                <select id="project_id" name="project_id">
                    <option value="">No Project</option>
                </select>
            </div>
            <div class="form-group">
                <label for="cad_units">CAD Units</label>
                <select id="cad_units" name="cad_units">
                    <option value="Feet">Feet</option>
                    <option value="Inches">Inches</option>
                    <option value="Meters">Meters</option>
                    <option value="Centimeters">Centimeters</option>
                    <option value="Millimeters">Millimeters</option>
                </select>
            </div>
            <div class="form-group">
                <label for="scale_factor">Scale Factor</label>
                <input type="number" id="scale_factor" name="scale_factor" value="1.0" step="0.1" min="0.1">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Create Drawing
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: linear-gradient(135deg, #1a2332 0%, #0d1117 100%);
    margin: 5% auto;
    padding: 0;
    border: 2px solid var(--accent-cyan);
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 10px 50px rgba(0,255,255,0.3);
    animation: slideDown 0.3s;
    max-height: 90vh;
    overflow-y: auto;
}

@keyframes slideDown {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    padding: 25px 30px;
    border-bottom: 2px solid rgba(0,255,255,0.2);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    color: var(--accent-cyan);
    font-size: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 32px;
    cursor: pointer;
    transition: all 0.3s;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
}

.modal-close:hover {
    color: var(--accent-cyan);
    transform: rotate(90deg);
}

.modal-content form {
    padding: 30px;
}

.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: var(--accent-cyan);
    font-weight: 600;
    font-size: 14px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px 15px;
    background: rgba(0,0,0,0.3);
    border: 2px solid rgba(0,255,255,0.3);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    transition: all 0.3s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--accent-cyan);
    box-shadow: 0 0 15px rgba(0,255,255,0.3);
}

.modal-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    padding-top: 20px;
    border-top: 2px solid rgba(0,255,255,0.2);
}

table input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--accent-cyan);
}

.highlighted-row {
    background: rgba(0,255,255,0.1) !important;
}
</style>

<script>
let allDrawings = [];
let allProjects = [];
let selectedDrawings = new Set();

async function loadProjects() {
    try {
        const response = await fetch('/api/projects');
        allProjects = await response.json();
        
        if (!allProjects.error) {
            const projectSelect = document.getElementById('project_id');
            const projectFilter = document.getElementById('projectFilter');
            
            allProjects.forEach(p => {
                const option1 = document.createElement('option');
                option1.value = p.project_id;
                option1.textContent = `${p.project_name}${p.client_name ? ' - ' + p.client_name : ''}`;
                projectSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = p.project_id;
                option2.textContent = `${p.project_name}${p.client_name ? ' - ' + p.client_name : ''}`;
                projectFilter.appendChild(option2);
            });
        }
    } catch (error) {
        console.error('Error loading projects:', error);
    }
}

async function loadDrawings() {
    try {
        const response = await fetch('/api/drawings');
        allDrawings = await response.json();

        const drawingsDiv = document.getElementById('drawings');
        const loadingDiv = document.getElementById('loading');

        if (allDrawings.error) {
            drawingsDiv.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--color-accent-red);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p>Error loading drawings: ${allDrawings.error}</p>
                </div>
            `;
            loadingDiv.style.display = 'none';
            drawingsDiv.style.display = 'block';
            return;
        }

        renderDrawings(allDrawings);

        loadingDiv.style.display = 'none';
        drawingsDiv.style.display = 'block';

    } catch (error) {
        console.error('Error:', error);
        document.getElementById('drawings').innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--color-accent-red);">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>Failed to load drawings: ${error.message}</p>
            </div>
        `;
        document.getElementById('loading').style.display = 'none';
        document.getElementById('drawings').style.display = 'block';
    }
}

function renderDrawings(drawings) {
    const drawingsDiv = document.getElementById('drawings');
    
    if (drawings.length === 0) {
        drawingsDiv.innerHTML = `
            <div style="text-align: center; padding: 3rem; opacity: 0.5;">
                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>No drawings found</p>
            </div>
        `;
        return;
    }

    drawingsDiv.innerHTML = `
        <div style="margin-bottom: var(--spacing-md); color: var(--color-text-muted); display: flex; justify-content: space-between; align-items: center;">
            <span>Showing ${drawings.length} drawing${drawings.length !== 1 ? 's' : ''}</span>
            ${selectedDrawings.size > 0 ? `<span style="color: var(--accent-cyan);">${selectedDrawings.size} selected</span>` : ''}
        </div>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)">
                        </th>
                        <th>Drawing Name</th>
                        <th>Number</th>
                        <th>Project</th>
                        <th>Units</th>
                        <th>Has Content</th>
                        <th>Created</th>
                        <th style="text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${drawings.map(d => `
                        <tr class="${selectedDrawings.has(d.drawing_id) ? 'highlighted-row' : ''}">
                            <td>
                                <input 
                                    type="checkbox" 
                                    ${selectedDrawings.has(d.drawing_id) ? 'checked' : ''} 
                                    onchange="toggleSelect('${d.drawing_id}')"
                                >
                            </td>
                            <td><strong>${d.drawing_name || '-'}</strong></td>
                            <td>${d.drawing_number || '-'}</td>
                            <td>${d.project_name || d.project_number || '-'}</td>
                            <td>${d.cad_units || 'Feet'}</td>
                            <td>${d.has_content ? '<span class="badge-success badge">YES</span>' : '<span class="badge badge">NO</span>'}</td>
                            <td>${formatDate(d.created_at)}</td>
                            <td style="text-align: center;">
                                <button 
                                    class="btn btn-icon btn-danger" 
                                    onclick="deleteItem('/api/drawings', '${d.drawing_id}', '${d.drawing_name}')"
                                    title="Delete drawing"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function filterDrawings() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const projectFilter = document.getElementById('projectFilter').value;
    
    let filtered = allDrawings;

    if (searchTerm) {
        filtered = filtered.filter(d => 
            (d.drawing_name && d.drawing_name.toLowerCase().includes(searchTerm)) ||
            (d.drawing_number && d.drawing_number.toLowerCase().includes(searchTerm)) ||
            (d.project_name && d.project_name.toLowerCase().includes(searchTerm))
        );
    }

    if (projectFilter) {
        filtered = filtered.filter(d => d.project_id === projectFilter);
    }

    renderDrawings(filtered);
}

function toggleSelect(drawingId) {
    if (selectedDrawings.has(drawingId)) {
        selectedDrawings.delete(drawingId);
    } else {
        selectedDrawings.add(drawingId);
    }
    
    const bulkBtn = document.getElementById('bulkDeleteBtn');
    bulkBtn.style.display = selectedDrawings.size > 0 ? 'block' : 'none';
    
    filterDrawings();
}

function toggleSelectAll(checked) {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const projectFilter = document.getElementById('projectFilter').value;
    
    let visibleDrawings = allDrawings;
    
    if (searchTerm) {
        visibleDrawings = visibleDrawings.filter(d => 
            (d.drawing_name && d.drawing_name.toLowerCase().includes(searchTerm)) ||
            (d.drawing_number && d.drawing_number.toLowerCase().includes(searchTerm)) ||
            (d.project_name && d.project_name.toLowerCase().includes(searchTerm))
        );
    }
    
    if (projectFilter) {
        visibleDrawings = visibleDrawings.filter(d => d.project_id === projectFilter);
    }

    if (checked) {
        visibleDrawings.forEach(d => selectedDrawings.add(d.drawing_id));
    } else {
        selectedDrawings.clear();
    }
    
    const bulkBtn = document.getElementById('bulkDeleteBtn');
    bulkBtn.style.display = selectedDrawings.size > 0 ? 'block' : 'none';
    
    renderDrawings(visibleDrawings);
}

async function bulkDelete() {
    const count = selectedDrawings.size;
    if (!confirm(`Are you sure you want to delete ${count} drawing${count !== 1 ? 's' : ''}?`)) {
        return;
    }

    const deletePromises = Array.from(selectedDrawings).map(id => 
        fetch(`/api/drawings/${id}`, { method: 'DELETE' })
    );

    try {
        await Promise.all(deletePromises);
        selectedDrawings.clear();
        document.getElementById('bulkDeleteBtn').style.display = 'none';
        location.reload();
    } catch (error) {
        alert(`Error deleting drawings: ${error.message}`);
    }
}

function openCreateModal() {
    document.getElementById('createModal').style.display = 'block';
    document.getElementById('drawing_name').focus();
}

function closeCreateModal() {
    document.getElementById('createModal').style.display = 'none';
    document.getElementById('createForm').reset();
}

async function createDrawing(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
        drawing_name: formData.get('drawing_name'),
        drawing_number: formData.get('drawing_number') || null,
        project_id: formData.get('project_id') || null,
        cad_units: formData.get('cad_units'),
        scale_factor: parseFloat(formData.get('scale_factor'))
    };

    try {
        const response = await fetch('/api/drawings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            closeCreateModal();
            location.reload();
        } else {
            const error = await response.json();
            alert(`Error: ${error.error || 'Failed to create drawing'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

window.onclick = function(event) {
    const modal = document.getElementById('createModal');
    if (event.target == modal) {
        closeCreateModal();
    }
}

loadProjects();
loadDrawings();
</script>
{% endblock %}
